<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>KTT 통합 리텐션 대시보드 (Premium)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- LIB -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY" defer></script>

<style>
:root {
  --primary:#2563eb; --bg:#f1f5f9; --card:#fff; --border:#e2e8f0;
}
body {margin:0; font-family:Pretendard,system-ui; background:var(--bg);}
.content {padding:32px;}
.chart-card {
  background:var(--card);
  border-radius:12px;
  padding:24px;
  margin-bottom:24px;
  box-shadow:0 4px 6px rgba(0,0,0,.05);
}
.card-header {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:16px;
}
#vocMap {width:100%; height:420px; border-radius:12px;}
</style>
</head>

<body>

<div class="content">

  <h2>관리고객(VOC) 활동 현황</h2>

  <!-- ✅ VOC MAP -->
  <div class="chart-card" style="height:480px;">
    <div class="card-header">
      <h3><i class="ph ph-map-pin"></i> 고객 위치 현황 (VOC)</h3>
      <span>필터 연동</span>
    </div>
    <div id="vocMap"></div>
  </div>

  <!-- 지사별 차트 -->
  <div class="chart-card">
    <canvas id="vocBranchChart"></canvas>
  </div>

</div>

<script>
/* ======================
   CONFIG
====================== */
const VOC_CSV_URL =
"https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv";

Chart.register(ChartDataLabels);

/* ======================
   STATE
====================== */
const state = {
  voc: { data: [], filtered: [] }
};

/* ======================
   UTIL
====================== */
function normalizeBranch(v){
  return String(v||"").replace("지사","").trim();
}

/* ======================
   MAP
====================== */
let vocMap, vocMarkers=[], vocInfo;

function initVocMap(){
  vocMap = new google.maps.Map(document.getElementById("vocMap"),{
    center:{lat:37.5665,lng:126.9780},
    zoom:9,
    mapTypeControl:false,
    streetViewControl:false,
    fullscreenControl:false
  });
  vocInfo = new google.maps.InfoWindow();
}

function renderVocMarkers(){
  if(!vocMap) return;

  vocMarkers.forEach(m=>m.setMap(null));
  vocMarkers=[];
  const bounds=new google.maps.LatLngBounds();

  state.voc.filtered.forEach(r=>{
    const lat=parseFloat(r["위도"]);
    const lng=parseFloat(r["경도"]);
    if(isNaN(lat)||isNaN(lng)) return;

    const marker=new google.maps.Marker({
      position:{lat,lng},
      map:vocMap,
      title:r["상호"]||"고객"
    });

    marker.addListener("click",()=>{
      vocInfo.setContent(`
        <div style="font-size:12px; line-height:1.5">
          <strong>${r["상호"]||"-"}</strong><br/>
          지사: ${r["관리지사"]||"-"}<br/>
          담당자: ${r["담당자"]||"-"}<br/>
          상태: ${r["상태"]||"-"}<br/>
          월정료: ${r["합산월정료"]||"-"}
        </div>
      `);
      vocInfo.open(vocMap,marker);
    });

    vocMarkers.push(marker);
    bounds.extend(marker.getPosition());
  });

  if(vocMarkers.length) vocMap.fitBounds(bounds);
}

/* ======================
   CHART
====================== */
function drawVocBranchChart(){
  const br={};
  state.voc.filtered.forEach(r=>{
    const b=normalizeBranch(r["관리지사"]);
    if(!b) return;
    br[b]=(br[b]||0)+1;
  });

  new Chart(document.getElementById("vocBranchChart"),{
    type:"bar",
    data:{
      labels:Object.keys(br),
      datasets:[{
        data:Object.values(br),
        backgroundColor:"#2563eb",
        borderRadius:6
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{y:{beginAtZero:true}}
    }
  });
}

/* ======================
   DATA
====================== */
async function loadVoc(){
  const t = await (await fetch(VOC_CSV_URL)).text();
  Papa.parse(t,{
    header:true,
    skipEmptyLines:true,
    complete:r=>{
      state.voc.data=r.data;
      state.voc.filtered=r.data;
      drawVocBranchChart();
      renderVocMarkers();
    }
  });
}

/* ======================
   INIT
====================== */
window.addEventListener("load", async ()=>{
  initVocMap();
  await loadVoc();
});
</script>

</body>
</html>
