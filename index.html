<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>KTT í†µí•© ë¦¬í…ì…˜ ëŒ€ì‹œë³´ë“œ (Pro)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* :root ë³€ìˆ˜ ì„¤ì • (ìƒ‰ìƒ í…Œë§ˆ) */
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            margin: 0;
            display: flex;
            background: var(--bg-body);
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--primary-light);
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 300px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
            z-index: 10;
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        .sidebar-header h2 {
            margin: 0; font-size: 18px; font-weight: 700; color: var(--text-main);
            display: flex; align-items: center; gap: 8px;
        }
        .sidebar-content {
            flex: 1; overflow-y: auto; padding: 20px;
        }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            position: relative;
        }

        /* ë·° ìŠ¤ìœ„ì²˜ (íƒ­ ìŠ¤íƒ€ì¼) */
        .view-switcher {
            display: flex; background: var(--bg-body); padding: 4px;
            border-radius: 8px; margin-bottom: 24px;
        }
        .view-switcher button {
            flex: 1; padding: 10px; border: none; background: transparent;
            font-size: 14px; font-weight: 600; color: var(--text-sub);
            cursor: pointer; border-radius: 6px; transition: all 0.2s;
        }
        .view-switcher button.active {
            background: var(--bg-card); color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        /* í•„í„° ê³µí†µ ìŠ¤íƒ€ì¼ */
        .filter-panel label {
            display: block; font-size: 13px; font-weight: 600; color: var(--text-sub);
            margin: 16px 0 8px;
        }
        select {
            width: 100%; padding: 10px; border: 1px solid var(--border);
            border-radius: 6px; font-size: 14px; background: #fff;
            outline: none; transition: border 0.2s;
        }
        select:focus { border-color: var(--primary); }

        .filter-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
        .filter-btn {
            padding: 6px 12px; font-size: 12px; border: 1px solid var(--border);
            border-radius: 20px; background: #fff; color: var(--text-sub);
            cursor: pointer; transition: all 0.2s;
        }
        .filter-btn:hover { background: var(--bg-body); }
        .filter-btn.active {
            background: var(--primary); color: #fff; border-color: var(--primary);
            font-weight: 600;
        }

        /* ë¼ë””ì˜¤ ë²„íŠ¼ ê·¸ë£¹ */
        .radio-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .radio-group label {
            margin: 0 !important; padding: 6px 10px; border: 1px solid var(--border);
            border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer;
            display: flex; align-items: center; background: #fff; transition: 0.2s;
        }
        .radio-group label:hover { background: var(--bg-body); }
        .radio-group input { margin-right: 6px; accent-color: var(--primary); }

        /* ëŒ€ì‹œë³´ë“œ ë·° */
        .dashboard-view { display: none; animation: fadeIn 0.3s ease; }
        .dashboard-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .view-header {
            margin-bottom: 24px; display: flex; justify-content: space-between; align-items: end;
        }
        .view-header h2 { margin: 0; font-size: 24px; font-weight: 800; color: var(--text-main); }
        .view-header p { margin: 6px 0 0; color: var(--text-sub); font-size: 14px; }

        /* KPI ê·¸ë¦¬ë“œ */
        .kpi-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .kpi-card {
            background: var(--bg-card); padding: 24px; border-radius: 12px;
            box-shadow: var(--shadow-sm); border-left: 4px solid var(--primary);
            position: relative; overflow: hidden;
            
            /* ê°€ìš´ë° ì •ë ¬ Flexbox */
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
        .kpi-card h3 { margin: 0 0 10px; font-size: 14px; color: var(--text-sub); font-weight: 500; }
        .kpi-card .value { font-size: 32px; font-weight: 700; color: var(--text-main); line-height: 1.2; }
        .kpi-card .icon {
            position: absolute; right: 20px; top: 20px; font-size: 24px; opacity: 0.2;
        }

        /* AI ë¦¬ë·° ë°•ìŠ¤ */
        .review-box {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            padding: 24px; border-radius: 12px; margin-bottom: 30px;
            border: 1px solid #bfdbfe;
        }
        .review-box h4 {
            margin: 0 0 12px; color: #1e40af; font-size: 16px; display: flex; align-items: center; gap: 8px;
        }
        .review-box p { margin: 0; color: #1e3a8a; line-height: 1.6; font-size: 14px; }

        /* ì°¨íŠ¸ ê·¸ë¦¬ë“œ */
        .chart-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 30px;
        }
        @media (max-width: 1200px) { .chart-grid { grid-template-columns: 1fr; } }

        .chart-card {
            background: var(--bg-card); border-radius: 12px; padding: 24px;
            box-shadow: var(--shadow-sm); height: 400px; display: flex; flex-direction: column;
        }
        .card-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: start; }
        .card-header h3 { margin: 0; font-size: 18px; font-weight: 700; color: var(--text-main); }
        .card-header span { font-size: 12px; color: var(--text-sub); }
        .chart-wrapper { flex: 1; position: relative; width: 100%; overflow: hidden; }

        /* ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ & í…Œì´ë¸” */
        .list-card {
            background: var(--bg-card); border-radius: 12px; padding: 24px; box-shadow: var(--shadow-sm);
        }
        .table-container { overflow-x: auto; min-height: 300px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
        .data-table th {
            background: #f8fafc; padding: 12px 16px; 
            font-weight: 600; color: var(--text-sub); border-bottom: 1px solid var(--border);
            cursor: pointer; user-select: none;
            text-align: center; /* í…Œì´ë¸” í—¤ë” ê°€ìš´ë° ì •ë ¬ */
        }
        .data-table th:hover { background: #f1f5f9; }
        .data-table td {
            padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-main);
            vertical-align: middle;
            text-align: center; /* ê¸°ë³¸ í…Œì´ë¸” ë‚´ìš© ê°€ìš´ë° ì •ë ¬ */
        }
        .data-table tr:hover td { background: #f8fafc; }

        /* ê¸´ í…ìŠ¤íŠ¸ìš© í´ë˜ìŠ¤ (ì¢Œì¸¡ ì •ë ¬ + ì¤„ë°”ê¿ˆ) */
        .long-text {
            text-align: left !important;
            white-space: normal !important;
            min-width: 250px;
            line-height: 1.5;
        }

        /* ì§€ë„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-map {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 8px; background: #fff; border: 1px solid #dbeafe;
            color: #2563eb; border-radius: 6px; font-size: 12px; font-weight: 600;
            text-decoration: none; transition: all 0.2s;
        }
        .btn-map:hover { background: #eff6ff; border-color: #2563eb; }

        /* í˜ì´ì§€ë„¤ì´ì…˜ ë° ì•¡ì…˜ ë²„íŠ¼ */
        .list-footer {
            margin-top: 15px; display: flex; justify-content: space-between; align-items: center;
        }
        .pagination { display: flex; gap: 5px; align-items: center; }
        .pagination button {
            padding: 6px 12px; border: 1px solid var(--border); background: #fff;
            border-radius: 6px; cursor: pointer; font-size: 13px;
        }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-action {
            padding: 8px 16px; background: var(--success); color: white; border: none;
            border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer;
            display: flex; align-items: center; gap: 5px; transition: background 0.2s;
        }
        .btn-action:hover { background: #059669; }

        /* ìœ í‹¸ë¦¬í‹° */
        .badge {
            display: inline-block; padding: 4px 8px; border-radius: 6px;
            font-size: 11px; font-weight: 600;
        }
        .badge.risk-high { background: #fee2e2; color: #991b1b; }
        .badge.risk-mid { background: #ffedd5; color: #9a3412; }
        .badge.risk-low { background: #dcfce7; color: #166534; }
        .badge.voc-done { background: #dbeafe; color: #1e40af; }
        .badge.voc-receipt { background: #fef3c7; color: #92400e; }
        .badge.voc-yet { background: #fee2e2; color: #991b1b; }
        .badge.stage-success { background: #dcfce7; color: #166534; }
        .badge.stage-fail { background: #fee2e2; color: #991b1b; }
        .badge.stage-ing { background: #ffedd5; color: #9a3412; }
    </style>
</head>

<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="font-weight: 600; color: #333;">ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>
</div>

<div class="sidebar">
    <div class="sidebar-header">
        <h2><i class="ph ph-chart-polar"></i> KTT Dashboard</h2>
    </div>

    <div class="sidebar-content">
        <div class="view-switcher">
            <button id="showVocBtn" class="active" onclick="switchView('voc')">VOC í˜„í™©</button>
            <button id="showPipelineBtn" onclick="switchView('pipeline')">í•´ì§€ ë°©ì–´</button>
        </div>

        <div id="vocFilters" class="filter-panel">
            <label>VOC ìœ í˜• (ëŒ€ë¶„ë¥˜)</label>
            <select id="vocTypeFilter"></select>

            <label>ì²˜ë¦¬ ìƒíƒœ</label>
            <div id="vocStatusButtons" class="filter-buttons">
                <button class="filter-btn active" data-value="ALL" onclick="setVocStatus('ALL', this)">ì „ì²´</button>
                <button class="filter-btn" data-value="ì²˜ë¦¬ì™„ë£Œ" onclick="setVocStatus('ì²˜ë¦¬ì™„ë£Œ', this)">ì™„ë£Œ</button>
                <button class="filter-btn" data-value="ì ‘ìˆ˜" onclick="setVocStatus('ì ‘ìˆ˜', this)">ì ‘ìˆ˜</button>
                <button class="filter-btn" data-value="ë¯¸ì ‘ìˆ˜" onclick="setVocStatus('ë¯¸ì ‘ìˆ˜', this)">ë¯¸ì ‘ìˆ˜</button>
            </div>

            <hr style="border: 0; border-top: 1px dashed #ddd; margin: 20px 0;">
            <label>ê´€ë¦¬ ì§€ì‚¬</label>
            <div id="vocBranchButtons" class="filter-buttons"></div>
            
            <label>ë‹´ë‹¹ì</label>
            <div id="vocAgentButtons" class="filter-buttons"></div>
        </div>

        <div id="pipelineFilters" class="filter-panel" style="display:none;">
            <label>ì˜ì—… ì±„ë„</label>
            <select id="channelFilter">
                <option value="ALL">ì „ì²´ ì±„ë„</option>
                <option value="SP">SP</option>
                <option value="SC">SC</option>
                <option value="AM">AM</option>
            </select>

            <label>í•´ì§€ ìœ„í—˜ë„ êµ¬ê°„</label>
            <div class="radio-group">
                <label><input type="radio" name="risk" value="ALL" checked>ì „ì²´</label>
                <label><input type="radio" name="risk" value="0">0-25%</label>
                <label><input type="radio" name="risk" value="25">25-50%</label>
                <label><input type="radio" name="risk" value="50">50-75%</label>
                <label><input type="radio" name="risk" value="75">75% ì´ìƒ</label>
            </div>

            <label>ë°ì´í„° ê¸°ì¤€</label>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="setMode('count', this)">ê±´ìˆ˜</button>
                <button class="filter-btn" onclick="setMode('amount', this)">ê¸ˆì•¡</button>
            </div>

            <hr style="border: 0; border-top: 1px dashed #ddd; margin: 20px 0;">

            <label>ê´€ë¦¬ ë³¸ë¶€</label>
            <div id="pipelineHqButtons" class="filter-buttons"></div>

            <label>ê´€ë¦¬ ì§€ì‚¬</label>
            <div id="pipelineBranchButtons" class="filter-buttons"></div>

            <label>ë‹´ë‹¹ì</label>
            <div id="pipelineAgentButtons" class="filter-buttons"></div>
        </div>
    </div>
</div>

<div class="content">

    <div id="vocView" class="dashboard-view active">
        <div class="view-header">
            <div>
                <h2>ê³ ê°ì˜ ì†Œë¦¬ (VOC) í™œë™ í˜„í™©</h2>
                <p>ì¬ê³„ì•½ ê´€ë ¨ ê³ ê° ë¬¸ì˜ ë° ì²˜ë¦¬ í˜„í™©ì„ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.</p>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card" style="border-left-color: #3b82f6;">
                <h3>ì´ VOC ì ‘ìˆ˜</h3>
                <div id="kpi-voc-total" class="value">0</div>
                <i class="ph ph-chat-text icon"></i>
            </div>
            <div class="kpi-card" style="border-left-color: #10b981;">
                <h3>ì²˜ë¦¬ ì™„ë£Œ</h3>
                <div id="kpi-voc-complete" class="value">0</div>
                <i class="ph ph-check-circle icon"></i>
            </div>
            <div class="kpi-card" style="border-left-color: #f59e0b;">
                <h3>ì²˜ë¦¬ìœ¨</h3>
                <div id="kpi-voc-complete-rate" class="value">0%</div>
                <i class="ph ph-chart-pie-slice icon"></i>
            </div>
            <div class="kpi-card" style="border-left-color: #ef4444;">
                <h3>ë¯¸ì ‘ìˆ˜ ê±´</h3>
                <div id="kpi-voc-unassigned" class="value">0</div>
                <i class="ph ph-warning-circle icon"></i>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <div class="card-header">
                    <h3>ğŸ“‰ ì¡°ì¹˜ í•„ìš” ë‹´ë‹¹ì í˜„í™©</h3>
                    <span>(ë¯¸ì ‘ìˆ˜/ì ‘ìˆ˜ ë³´ìœ  Top 10 í™œë™ ë…ë ¤)</span>
                </div>
                <div class="chart-wrapper"><canvas id="vocActivityChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="card-header">
                    <h3>ì§€ì‚¬ë³„ ì²˜ë¦¬ í˜„í™©</h3>
                    <span>(ê±´ìˆ˜ ê¸°ì¤€)</span>
                </div>
                <div class="chart-wrapper"><canvas id="vocBranchChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="card-header">
                    <h3>ë‹´ë‹¹ìë³„ ì²˜ë¦¬ ì‹¤ì  (Top 20)</h3>
                    <span>(ì²˜ë¦¬ì™„ë£Œ ê¸°ì¤€)</span>
                </div>
                <div class="chart-wrapper"><canvas id="vocAgentChart"></canvas></div>
            </div>
        </div>

        <div class="list-card">
            <div class="card-header">
                <h3>ìƒì„¸ ë°ì´í„° ë¦¬ìŠ¤íŠ¸</h3>
                <button class="btn-action" onclick="exportToCSV('voc')"><i class="ph ph-download-simple"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <div class="table-container">
                <table id="vocListTable" class="data-table">
                    <thead>
                        <tr>
                            <th data-field="ê´€ë¦¬ì§€ì‚¬">ì§€ì‚¬</th>
                            <th data-field="ë‹´ë‹¹ì">ë‹´ë‹¹ì</th>
                            <th data-field="ê³„ì•½ë²ˆí˜¸">ê³„ì•½ë²ˆí˜¸</th>
                            <th data-field="ìƒí˜¸">ìƒí˜¸ëª…</th>
                            <th data-field="ìƒíƒœ">ìƒíƒœ</th>
                            <th data-field="VOCìœ í˜•ì†Œ">ì„œë¹„ìŠ¤(ì†Œ)</th>
                            <th data-field="í•©ì‚°ì›”ì •ë£Œ">í•©ì‚°ì›”ì •ë£Œ</th>
                            <th data-field="ì§€ë„">ì§€ë„</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="list-footer">
                <div id="vocPaginationInfo" style="font-size:13px; color:#666;"></div>
                <div class="pagination">
                    <button onclick="changePage('voc', -1)">ì´ì „</button>
                    <button onclick="changePage('voc', 1)">ë‹¤ìŒ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="pipelineView" class="dashboard-view">
        <div class="view-header">
            <div>
                <h2>í•´ì§€ íŒŒì´í”„ë¼ì¸ ê´€ë¦¬ í˜„í™©</h2>
                <p>í•´ì§€ ê³ ìœ„í—˜ ê³ ê°ì— ëŒ€í•œ ì„ ì œì  ë°©ì–´ í™œë™ ë° ì„±ê³¼ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card" style="border-left-color: #2563eb;">
                <h3>íŒŒì´í”„ë¼ì¸ ì´ ê±´ìˆ˜</h3>
                <div id="kpi-pipeline-count" class="value">0</div>
                <i class="ph ph-funnel icon"></i>
            </div>
            <div class="kpi-card" style="border-left-color: #10b981;">
                <h3>ì›”ì •ë£Œ ê·œëª¨ (ì²œì›)</h3>
                <div id="kpi-pipeline-amount" class="value">0</div>
                <i class="ph ph-currency-krw icon"></i>
            </div>
            <div class="kpi-card" style="border-left-color: #ef4444;">
                <h3>ê³ ìœ„í—˜êµ° (75%â†‘)</h3>
                <div id="kpi-high-risk-count" class="value">0</div>
                <i class="ph ph-siren icon"></i>
            </div>
            <div class="kpi-card" style="border-left-color: #f59e0b;">
                <h3>ë°©ì–´ ì„±ê³µë¥ </h3>
                <div id="kpi-defense-success-rate" class="value">0%</div>
                <i class="ph ph-shield-check icon"></i>
            </div>
        </div>

        <div class="review-box">
            <h4><i class="ph ph-robot"></i> AI ë¶„ì„ ì¸ì‚¬ì´íŠ¸</h4>
            <p id="ai-pipeline-review">ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <div class="card-header">
                    <h3>ì§€ì‚¬ë³„ ë°©ì–´ ë‹¨ê³„ ì§„í–‰ (Top 10)</h3>
                    <span>(ì„±ê³µ/ì‹¤íŒ¨/ì§„í–‰ì¤‘ êµ¬ì„±ë¹„)</span>
                </div>
                <div class="chart-wrapper"><canvas id="pipelineBranchStageChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="card-header">
                    <h3>ìœ„í—˜ë„ vs ì›”ì •ë£Œ ë¶„í¬</h3>
                    <span>(ì› í¬ê¸°: ì›”ì •ë£Œ ê·œëª¨)</span>
                </div>
                <div class="chart-wrapper"><canvas id="pipelineRiskBubbleChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="card-header">
                    <h3>ìƒìœ„ ì§€ì‚¬ ë°©ì–´ ì„±ê³µë¥  ì¶”ì´</h3>
                </div>
                <div class="chart-wrapper"><canvas id="pipelineDefenseSuccessRateChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="card-header">
                    <h3>ë‹´ë‹¹ìë³„ ë°©ì–´ ì‹¤íŒ¨ ê±´ìˆ˜ (Top 10)</h3>
                </div>
                <div class="chart-wrapper"><canvas id="pipelineAgentFailChart"></canvas></div>
            </div>
        </div>

        <div class="list-card">
            <div class="card-header">
                <h3>ìƒì„¸ íŒŒì´í”„ë¼ì¸ ë¦¬ìŠ¤íŠ¸</h3>
                <button class="btn-action" onclick="exportToCSV('pipeline')"><i class="ph ph-download-simple"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <div class="table-container">
                <table id="pipelineListTable" class="data-table">
                    <thead>
                        <tr>
                            <th data-field="ê´€ë¦¬ë³¸ë¶€">ë³¸ë¶€</th>
                            <th data-field="ê´€ë¦¬ì§€ì‚¬">ì§€ì‚¬</th>
                            <th data-field="ë‹´ë‹¹ì">ë‹´ë‹¹ì</th>
                            <th data-field="ê³„ì•½ë²ˆí˜¸" data-sort="asc">ê³„ì•½ë²ˆí˜¸</th>
                            <th data-field="ìƒí˜¸">ìƒí˜¸ëª…</th>
                            <th data-field="ë‹´ë‹¹ì˜ì—…ì±„ë„">ì±„ë„</th>
                            <th data-field="KTTì›”ì •ë£Œ(ì¡°ì •)" data-sort="none">ì›”ì •ë£Œ(ì²œì›)</th>
                            <th data-field="ì¬ê³„ì•½ì—¬ë¶€">ì¬ê³„ì•½ì—¬ë¶€</th>
                            <th data-field="ë°©ì–´ì§„í–‰ë‹¨ê³„">ë°©ì–´ì§„í–‰ë‹¨ê³„</th>
                            <th data-field="ì´ìŠˆìœ í˜•">ì´ìŠˆìœ í˜•</th>
                            <th data-field="í•´ì§€ì‚¬ìœ ">í•´ì§€ì‚¬ìœ </th>
                            <th data-field="í•´ì§€ì˜ˆì •ì¼">í•´ì§€ì˜ˆì •ì¼</th>
                            <th data-field="ë“±ë¡ì¼ì">ë“±ë¡ì¼ì</th>
                            <th data-field="ì§€ì›ìš”ì²­ë‚´ìš©">ì§€ì›ìš”ì²­ë‚´ìš©</th>
                            <th data-field="ì„¸ë¶€ë‚´ìš©">ì„¸ë¶€ë‚´ìš© ë° ê³µìœ ì‚¬í•­</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="list-footer">
                <div id="pipelinePaginationInfo" style="font-size:13px; color:#666;"></div>
                <div class="pagination">
                    <button onclick="changePage('pipeline', -1)">ì´ì „</button>
                    <button onclick="changePage('pipeline', 1)">ë‹¤ìŒ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ì„¤ì • ---
    const VOC_CSV_URL = "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv";
    const PIPELINE_CSV_URL = "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv";
    
    Chart.register(ChartDataLabels);
    Chart.defaults.font.family = "'Pretendard', sans-serif";
    Chart.defaults.color = "#64748b";

    // --- ìƒíƒœ ë³€ìˆ˜ ---
    const state = {
        currentView: 'voc', // ì´ˆê¸° ë·° ì„¤ì •
        voc: { 
            data: [], filtered: [], page: 1, limit: 15, 
            sortField: 'VOCìœ í˜•ëŒ€', sortDir: 'desc',
            branch: 'ALL', agent: 'ALL' 
        },
        pipeline: { 
            data: [], filtered: [], page: 1, limit: 15, 
            sortField: 'KTTì›”ì •ë£Œ(ì¡°ì •)', sortDir: 'desc',
            mode: 'count', hq: 'ALL', branch: 'ALL', agent: 'ALL'
        }
    };

    const chartInstances = {};

    // --- ìœ í‹¸ë¦¬í‹° ---
    const util = {
        normalizeBranch: (name) => String(name || "").replace("ì§€ì‚¬", "").trim(),
        cleanContract: (raw) => String(raw || "").replace(/\D/g, "").slice(0, 8),
        toThousand: (raw) => {
            const num = parseFloat(String(raw).replace(/,/g, ""));
            return isNaN(num) ? 0 : Math.round(num / 1000);
        },
        formatNum: (num) => num.toLocaleString(),
        excelDateToJSDate: (serial) => {
            if (!serial) return "-";
            // Check if already a date string or text
            if(isNaN(serial) && String(serial).includes('-')) return serial;
            
            // Clean string (e.g. 45,993 -> 45993)
            const cleaned = parseFloat(String(serial).replace(/,/g, ''));
            if(isNaN(cleaned)) return serial;

            // Excel date to JS Date (Epoch diff: 25569 days)
            const date = new Date((cleaned - 25569) * 86400 * 1000);
            if(isNaN(date.getTime())) return serial;

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        },
        sortBranches: (a, b) => {
            const order = ["ì¤‘ì•™", "ê°•ë¶", "ì„œëŒ€ë¬¸", "ê³ ì–‘", "ì˜ì •ë¶€", "ë‚¨ì–‘ì£¼", "ê°•ë¦‰", "ì›ì£¼"];
            const idxA = order.indexOf(a);
            const idxB = order.indexOf(b);
            if (idxA === -1 && idxB === -1) return a.localeCompare(b);
            if (idxA === -1) return 1;
            if (idxB === -1) return -1;
            return idxA - idxB;
        }
    };

    // --- ì´ˆê¸°í™” ---
    window.addEventListener("load", async () => {
        try {
            const [vocData, pipeData] = await Promise.all([
                loadCsv(VOC_CSV_URL),
                loadCsv(PIPELINE_CSV_URL)
            ]);
            
            state.voc.data = vocData;
            state.pipeline.data = pipeData;

            // Pipeline ê¸°ë³¸ ë³¸ë¶€ ì„¤ì •
            const availableHQs = [...new Set(pipeData.map(r => (r["ê´€ë¦¬ë³¸ë¶€"]||"").trim()).filter(Boolean))];
            state.pipeline.hq = availableHQs.includes('ê°•ë¶/ê°•ì›') ? 'ê°•ë¶/ê°•ì›' : 'ALL';

            initFilters();
            updateDashboard('voc');
            updateDashboard('pipeline');
            
            switchView('voc'); // ì´ˆê¸°í™”ë©´ VOCë¡œ ì„¤ì •
        } catch (e) {
            alert("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            console.error(e);
        } finally {
            document.getElementById("loadingOverlay").style.display = "none";
        }
    });

    async function loadCsv(url) {
        const res = await fetch(url);
        const text = await res.text();
        return new Promise(resolve => {
            Papa.parse(text, { header: true, skipEmptyLines: true, complete: r => resolve(r.data) });
        });
    }

    // --- í•„í„° ë Œë”ë§ ---
    function initFilters() {
        const vocTypes = [...new Set(state.voc.data.map(r => (r["VOCìœ í˜•ëŒ€"]||"").trim()).filter(Boolean))].sort();
        const vocSelect = document.getElementById("vocTypeFilter");
        vocSelect.innerHTML = '<option value="ALL">ì „ì²´ ìœ í˜•</option>' + vocTypes.map(t => `<option value="${t}">${t}</option>`).join('');
        vocSelect.addEventListener('change', () => updateDashboard('voc'));

        renderVocFilters('branch');
        renderVocFilters('agent');

        renderPipelineFilters('hq');
        renderPipelineFilters('branch');
        renderPipelineFilters('agent');
        
        document.getElementById("channelFilter").addEventListener("change", () => updateDashboard('pipeline'));
        document.querySelectorAll('input[name="risk"]').forEach(el => el.addEventListener("change", () => updateDashboard('pipeline')));
        
        setupSortEvents('pipelineListTable', 'pipeline');
        setupSortEvents('vocListTable', 'voc');
    }

    function renderVocFilters(type) {
        const container = document.getElementById(`voc${type.charAt(0).toUpperCase() + type.slice(1)}Buttons`);
        let source = state.voc.data;

        if (type === 'agent' && state.voc.branch !== 'ALL') {
            source = source.filter(r => util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]) === state.voc.branch);
        }

        let items = [];
        if (type === 'branch') items = [...new Set(source.map(r => util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])).filter(Boolean))].sort(util.sortBranches);
        else if (type === 'agent') items = [...new Set(source.map(r => (r["ë‹´ë‹¹ì"]||"").trim()).filter(Boolean))].sort();

        let html = `<button class="filter-btn ${state.voc[type] === 'ALL' ? 'active' : ''}" onclick="setVocFilter('${type}', 'ALL')">ì „ì²´</button>`;
        items.forEach(item => {
            html += `<button class="filter-btn ${state.voc[type] === item ? 'active' : ''}" onclick="setVocFilter('${type}', '${item.replace(/'/g, "\\'")}')">${item}</button>`;
        });
        container.innerHTML = html;
    }

    function renderPipelineFilters(type) {
        const container = document.getElementById(`pipeline${type.charAt(0).toUpperCase() + type.slice(1)}Buttons`);
        let source = state.pipeline.data;

        if (type !== 'hq' && state.pipeline.hq !== 'ALL') 
            source = source.filter(r => (r["ê´€ë¦¬ë³¸ë¶€"]||"").trim() === state.pipeline.hq);
        if (type === 'agent' && state.pipeline.branch !== 'ALL')
            source = source.filter(r => util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]) === state.pipeline.branch);

        let items = [];
        if (type === 'hq') items = [...new Set(source.map(r => (r["ê´€ë¦¬ë³¸ë¶€"]||"").trim()).filter(Boolean))].sort();
        else if (type === 'branch') items = [...new Set(source.map(r => util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])).filter(Boolean))].sort(util.sortBranches);
        else if (type === 'agent') items = [...new Set(source.map(r => (r["ë‹´ë‹¹ì"]||"").trim()).filter(Boolean))].sort();

        let html = `<button class="filter-btn ${state.pipeline[type] === 'ALL' ? 'active' : ''}" onclick="setPipelineFilter('${type}', 'ALL')">ì „ì²´</button>`;
        items.forEach(item => {
            html += `<button class="filter-btn ${state.pipeline[type] === item ? 'active' : ''}" onclick="setPipelineFilter('${type}', '${item.replace(/'/g, "\\'")}')">${item}</button>`;
        });
        container.innerHTML = html;
    }

    // --- í•„í„° ë™ì‘ ---
    window.switchView = (view) => {
        state.currentView = view;
        document.querySelectorAll('.view-switcher button').forEach(b => b.classList.remove('active'));
        document.getElementById(`show${view.charAt(0).toUpperCase() + view.slice(1)}Btn`).classList.add('active');
        
        document.querySelectorAll('.dashboard-view').forEach(d => d.classList.remove('active'));
        document.getElementById(`${view}View`).classList.add('active');

        document.getElementById('pipelineFilters').style.display = view === 'pipeline' ? 'block' : 'none';
        document.getElementById('vocFilters').style.display = view === 'voc' ? 'block' : 'none';
        
        setTimeout(() => { Object.values(chartInstances).forEach(c => c && c.resize()); }, 100);
    };

    window.setPipelineFilter = (type, val) => {
        state.pipeline[type] = val;
        if (type === 'hq') { state.pipeline.branch = 'ALL'; state.pipeline.agent = 'ALL'; renderPipelineFilters('branch'); renderPipelineFilters('agent'); }
        if (type === 'branch') { state.pipeline.agent = 'ALL'; renderPipelineFilters('agent'); }
        renderPipelineFilters(type);
        updateDashboard('pipeline');
    };

    window.setVocFilter = (type, val) => {
        state.voc[type] = val;
        if (type === 'branch') { state.voc.agent = 'ALL'; renderVocFilters('agent'); }
        renderVocFilters(type);
        updateDashboard('voc');
    };

    window.setVocStatus = (val, btn) => {
        document.querySelectorAll('#vocStatusButtons .filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateDashboard('voc');
    };

    window.setMode = (mode, btn) => {
        state.pipeline.mode = mode;
        document.querySelectorAll('.filter-buttons .filter-btn').forEach(b => {
             if(b.textContent === 'ê±´ìˆ˜' || b.textContent === 'ê¸ˆì•¡') b.classList.remove('active');
        });
        btn.classList.add('active');
        updateDashboard('pipeline');
    };

    // --- ë°ì´í„° ì—…ë°ì´íŠ¸ ---
    function updateDashboard(view) {
        filterData(view);
        if (view === 'pipeline') {
            updatePipelineKPIs();
            generatePipelineReview();
            drawPipelineCharts();
            renderTable('pipeline');
        } else {
            updateVocKPIs();
            drawVocCharts();
            renderTable('voc');
        }
    }

    function filterData(view) {
        if (view === 'pipeline') {
            const channel = document.getElementById("channelFilter").value;
            const riskVal = document.querySelector('input[name="risk"]:checked').value;
            
            state.pipeline.filtered = state.pipeline.data.filter(r => {
                if (channel !== "ALL" && r["ë‹´ë‹¹ì˜ì—…ì±„ë„"] !== channel) return false;
                
                const risk = parseFloat(r["í•´ì§€ìœ„í—˜ë„"]);
                if (riskVal !== "ALL") {
                    const rv = parseInt(riskVal);
                    if (rv === 75 && risk < 75) return false;
                    if (rv !== 75 && (risk < rv || risk >= rv + 25)) return false;
                }

                if (state.pipeline.hq !== "ALL" && (r["ê´€ë¦¬ë³¸ë¶€"]||"").trim() !== state.pipeline.hq) return false;
                if (state.pipeline.branch !== "ALL" && util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]) !== state.pipeline.branch) return false;
                if (state.pipeline.agent !== "ALL" && (r["ë‹´ë‹¹ì"]||"").trim() !== state.pipeline.agent) return false;
                
                return true;
            });
            state.pipeline.page = 1; 
        } else {
            const type = document.getElementById("vocTypeFilter").value;
            const status = document.querySelector('#vocStatusButtons .active').dataset.value;

            state.voc.filtered = state.voc.data.filter(r => {
                if (type !== "ALL" && (r["VOCìœ í˜•ëŒ€"]||"").trim() !== type) return false;
                if (status !== "ALL" && (r["ìƒíƒœ"]||"").trim() !== status) return false;
                if (state.voc.branch !== "ALL" && util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]) !== state.voc.branch) return false;
                if (state.voc.agent !== "ALL" && (r["ë‹´ë‹¹ì"]||"").trim() !== state.voc.agent) return false;
                return true;
            });
            state.voc.page = 1;
        }
    }

    // --- KPI & Charts (VOC) ---
    function updateVocKPIs() {
        const d = state.voc.filtered;
        const complete = d.filter(r => (r["ìƒíƒœ"]||"").trim() === "ì²˜ë¦¬ì™„ë£Œ").length;
        document.getElementById("kpi-voc-total").innerText = util.formatNum(d.length);
        document.getElementById("kpi-voc-complete").innerText = util.formatNum(complete);
        document.getElementById("kpi-voc-complete-rate").innerText = d.length > 0 ? (complete / d.length * 100).toFixed(1) + "%" : "0%";
        document.getElementById("kpi-voc-unassigned").innerText = util.formatNum(d.filter(r => (r["ìƒíƒœ"]||"").trim() === "ë¯¸ì ‘ìˆ˜").length);
    }

    function drawVocCharts() {
        const d = state.voc.filtered;
        
        // 1. ì¡°ì¹˜ í•„ìš” ë‹´ë‹¹ì (0 ì œê±°)
        const activityAgg = {};
        d.forEach(r => {
            const a = (r["ë‹´ë‹¹ì"]||"").trim(); if(!a) return;
            const s = (r["ìƒíƒœ"]||"").trim();
            if(s === 'ë¯¸ì ‘ìˆ˜' || s === 'ì ‘ìˆ˜') {
                if(!activityAgg[a]) activityAgg[a] = { yet: 0, receipt: 0, total: 0 };
                if(s === 'ë¯¸ì ‘ìˆ˜') activityAgg[a].yet++;
                else activityAgg[a].receipt++;
                activityAgg[a].total++;
            }
        });
        const sortedActivity = Object.entries(activityAgg).sort((a,b) => b[1].total - a[1].total).slice(0, 10);
        
        newChart('vocActivityChart', {
            type: 'bar',
            data: {
                labels: sortedActivity.map(e => e[0]),
                datasets: [
                    { label: 'ë¯¸ì ‘ìˆ˜', data: sortedActivity.map(e => e[1].yet), backgroundColor: '#ef4444' },
                    { label: 'ì ‘ìˆ˜', data: sortedActivity.map(e => e[1].receipt), backgroundColor: '#f59e0b' }
                ]
            },
            options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                scales: { x: { stacked: true }, y: { stacked: true } },
                plugins: {
                    legend: { position: 'top' },
                    datalabels: { display: (ctx) => ctx.dataset.data[ctx.dataIndex] > 0, color: '#fff', font: { weight: 'bold' } }
                }
            }
        });

        // 2. ì§€ì‚¬ë³„
        const brAgg = {};
        d.forEach(r => {
            const b = util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]); if(!b)return;
            if(!brAgg[b]) brAgg[b] = {done:0, receipt:0, yet:0};
            const s = (r["ìƒíƒœ"]||"").trim();
            if(s==='ì²˜ë¦¬ì™„ë£Œ') brAgg[b].done++; else if(s==='ì ‘ìˆ˜') brAgg[b].receipt++; else brAgg[b].yet++;
        });
        const labels = Object.keys(brAgg).sort(util.sortBranches);

        newChart('vocBranchChart', {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {label:'ì™„ë£Œ', data:labels.map(l=>brAgg[l].done), backgroundColor:'#3b82f6', stack:'s'},
                    {label:'ì ‘ìˆ˜', data:labels.map(l=>brAgg[l].receipt), backgroundColor:'#f59e0b', stack:'s'},
                    {label:'ë¯¸ì ‘ìˆ˜', data:labels.map(l=>brAgg[l].yet), backgroundColor:'#ef4444', stack:'s'}
                ]
            },
            options: { responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true},y:{stacked:true}}, plugins:{legend:{position:'bottom'}, datalabels:{display:false}} }
        });

        // 3. ë‹´ë‹¹ìë³„
        const agAgg = {};
        d.forEach(r=>{
            const a = (r["ë‹´ë‹¹ì"]||"").trim(); if(!a)return;
            if(!agAgg[a]) agAgg[a] = 0;
            if(r["ìƒíƒœ"]==='ì²˜ë¦¬ì™„ë£Œ') agAgg[a]++;
        });
        const sortedAg = Object.entries(agAgg).sort((a,b)=>b[1]-a[1]).slice(0,20);

        newChart('vocAgentChart', {
            type: 'bar',
            data: {
                labels: sortedAg.map(e=>e[0]),
                datasets: [{label:'ì²˜ë¦¬ì™„ë£Œ', data:sortedAg.map(e=>e[1]), backgroundColor:'#3b82f6'}]
            },
            options: { indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
        });
    }

    // --- KPI & Charts (Pipeline) ---
    function updatePipelineKPIs() {
        const d = state.pipeline.filtered;
        const totalAmount = d.reduce((s, r) => s + util.toThousand(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]), 0);
        const success = d.filter(r => r["ë°©ì–´ì§„í–‰ë‹¨ê³„"] === "ë°©ì–´ì„±ê³µ").length;
        const attempts = d.filter(r => ["ë°©ì–´ì„±ê³µ", "ë°©ì–´ì‹¤íŒ¨", "ì§„í–‰ì¤‘"].includes(r["ë°©ì–´ì§„í–‰ë‹¨ê³„"])).length;
        const highRisk = d.filter(r => parseFloat(r["í•´ì§€ìœ„í—˜ë„"]) >= 75).length;

        document.getElementById("kpi-pipeline-count").innerText = util.formatNum(d.length);
        document.getElementById("kpi-pipeline-amount").innerText = util.formatNum(totalAmount);
        document.getElementById("kpi-high-risk-count").innerText = util.formatNum(highRisk);
        document.getElementById("kpi-defense-success-rate").innerText = attempts > 0 ? (success / attempts * 100).toFixed(1) + "%" : "0%";
    }

    function generatePipelineReview() {
        const failures = state.pipeline.filtered.filter(r => r["ë°©ì–´ì§„í–‰ë‹¨ê³„"] === "ë°©ì–´ì‹¤íŒ¨");
        const el = document.getElementById("ai-pipeline-review");
        
        if (failures.length === 0) {
            el.innerHTML = "ğŸ‰ í•´ë‹¹ ê¸°ê°„/ì¡°ê±´ì—ì„œ ë°©ì–´ ì‹¤íŒ¨ ê±´ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ë§¤ìš° ìš°ìˆ˜í•œ ì„±ê³¼ì…ë‹ˆë‹¤!";
            return;
        }

        const countBy = (arr, key) => arr.reduce((acc, r) => {
            const k = key(r); acc[k] = (acc[k]||0)+1; return acc;
        }, {});
        
        const branchFail = countBy(failures, r => util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]));
        const topBranch = Object.entries(branchFail).sort((a,b)=>b[1]-a[1])[0];
        const agentFail = countBy(failures, r => (r["ë‹´ë‹¹ì"]||"ë¯¸ì§€ì •").trim());
        const topAgent = Object.entries(agentFail).sort((a,b)=>b[1]-a[1])[0];

        el.innerHTML = `í˜„ì¬ <b>ì´ ${failures.length}ê±´</b>ì˜ ë°©ì–´ ì‹¤íŒ¨ê°€ ì‹ë³„ë˜ì—ˆìŠµë‹ˆë‹¤.<br>` +
            (topBranch ? `â€¢ <b>${topBranch[0]}ì§€ì‚¬</b>ì—ì„œ ê°€ì¥ ë§ì€ ì‹¤íŒ¨(${topBranch[1]}ê±´)ê°€ ë°œìƒí•˜ì—¬ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>` : '') +
            (topAgent ? `â€¢ ë‹´ë‹¹ì ì¤‘ <b>${topAgent[0]}</b>ë‹˜ì˜ ì‹¤íŒ¨ ê±´ìˆ˜(${topAgent[1]}ê±´)ê°€ ìƒìœ„ê¶Œìœ¼ë¡œ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.` : '');
    }

    function drawPipelineCharts() {
        const d = state.pipeline.filtered;
        const mode = state.pipeline.mode;
        
        const branchAgg = {};
        d.forEach(r => {
            const b = util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]); if(!b) return;
            if(!branchAgg[b]) branchAgg[b] = { suc:0, fail:0, ing:0, total:0 };
            const val = mode === 'amount' ? util.toThousand(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]) : 1;
            const st = r["ë°©ì–´ì§„í–‰ë‹¨ê³„"];
            if(st==='ë°©ì–´ì„±ê³µ') branchAgg[b].suc += val; else if(st==='ë°©ì–´ì‹¤íŒ¨') branchAgg[b].fail += val; else if(st==='ì§„í–‰ì¤‘') branchAgg[b].ing += val;
            if(['ë°©ì–´ì„±ê³µ','ë°©ì–´ì‹¤íŒ¨','ì§„í–‰ì¤‘'].includes(st)) branchAgg[b].total += val;
        });
        
        const sortedBranch = Object.entries(branchAgg).filter(e=>e[1].total>0).sort((a,b)=>b[1].total - a[1].total).slice(0,10);
        const labels = sortedBranch.map(e=>e[0]);
        
        newChart('pipelineBranchStageChart', {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'ë°©ì–´ì„±ê³µ', data: sortedBranch.map(e=>e[1].suc), backgroundColor: '#10b981', stack: 's' },
                    { label: 'ì§„í–‰ì¤‘', data: sortedBranch.map(e=>e[1].ing), backgroundColor: '#f59e0b', stack: 's' },
                    { label: 'ë°©ì–´ì‹¤íŒ¨', data: sortedBranch.map(e=>e[1].fail), backgroundColor: '#ef4444', stack: 's' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { x: { stacked: true }, y: { stacked: true } },
                plugins: { legend: { position:'bottom' }, datalabels: { display: false } }
            }
        });

        const bubbleData = Object.entries(branchAgg).map(([br, val]) => {
            const subset = d.filter(r => util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]) === br);
            const avgRisk = subset.reduce((s,r)=>s+parseFloat(r["í•´ì§€ìœ„í—˜ë„"]||0),0) / subset.length;
            const totalAmt = subset.reduce((s,r)=>s+util.toThousand(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]),0);
            return {
                label: br,
                data: [{ x: avgRisk, y: totalAmt / subset.length, r: Math.sqrt(totalAmt)*0.4 }],
                backgroundColor: 'rgba(59, 130, 246, 0.6)', borderColor: '#2563eb'
            };
        }).filter(b => b.data[0].r > 0);

        newChart('pipelineRiskBubbleChart', {
            type: 'bubble',
            data: { datasets: bubbleData },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ìœ„í—˜ë„ ${ctx.raw.x.toFixed(1)}% / í‰ê·  ${Math.round(ctx.raw.y).toLocaleString()}ì²œì›` } },
                    datalabels: { formatter: (v, ctx) => ctx.dataset.label, font: {size:10, weight:'bold'}, color:'#1e3a8a', align:'top', offset: -2 }
                },
                scales: { x: { title: {display:true, text:'í‰ê·  í•´ì§€ ìœ„í—˜ë„ (%)'}, min:0, max:100 }, y: { title: {display:true, text:'í‰ê·  ì›”ì •ë£Œ (ì²œì›)'} } }
            }
        });

        const rates = sortedBranch.map(([br, val]) => ({ br, rate: val.total > 0 ? (val.suc / val.total * 100) : 0 })).sort((a,b) => b.rate - a.rate).slice(0,5);

        newChart('pipelineDefenseSuccessRateChart', {
            type: 'line',
            data: {
                labels: rates.map(r=>r.br),
                datasets: [{ label: 'ì„±ê³µë¥ (%)', data: rates.map(r=>r.rate), borderColor: '#059669', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3 }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { min:0, max:100 } }, plugins: { legend:{display:false} } }
        });

        const agentFail = {};
        d.filter(r=>r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]==='ë°©ì–´ì‹¤íŒ¨').forEach(r => { const ag = (r["ë‹´ë‹¹ì"]||"ë¯¸ì§€ì •").trim(); agentFail[ag] = (agentFail[ag]||0)+1; });
        const sortedAgent = Object.entries(agentFail).sort((a,b)=>b[1]-a[1]).slice(0,10);
        
        newChart('pipelineAgentFailChart', {
            type: 'bar',
            data: { labels: sortedAgent.map(e=>e[0]), datasets: [{ label: 'ì‹¤íŒ¨ ê±´ìˆ˜', data: sortedAgent.map(e=>e[1]), backgroundColor: '#ef4444' }] },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend:{display:false} } }
        });
    }

    // --- ì°¨íŠ¸ ìƒì„± Helper ---
    function newChart(id, config) {
        if (chartInstances[id]) chartInstances[id].destroy();
        chartInstances[id] = new Chart(document.getElementById(id), config);
    }

    // --- í…Œì´ë¸” ë Œë”ë§ ---
    function renderTable(type) {
        const s = state[type];
        const tbody = document.querySelector(`#${type}ListTable tbody`);
        tbody.innerHTML = "";

        const sorted = [...s.filtered].sort((a, b) => {
            let va = a[s.sortField], vb = b[s.sortField];
            if (s.sortField.includes('ì›”ì •ë£Œ') || s.sortField.includes('ìœ„í—˜ë„')) {
                va = parseFloat(String(va).replace(/,/g,'')) || 0;
                vb = parseFloat(String(vb).replace(/,/g,'')) || 0;
            }
            if (va < vb) return s.sortDir === 'asc' ? -1 : 1;
            if (va > vb) return s.sortDir === 'asc' ? 1 : -1;
            return 0;
        });

        const start = (s.page - 1) * s.limit;
        const pageData = sorted.slice(start, start + s.limit);
        const totalPages = Math.ceil(sorted.length / s.limit);

        document.getElementById(`${type}PaginationInfo`).innerText = 
            `ì´ ${util.formatNum(sorted.length)}ê±´ ì¤‘ ${start+1} - ${Math.min(start+s.limit, sorted.length)}`;

        pageData.forEach(r => {
            const tr = document.createElement("tr");
            if(type === 'pipeline') {
                let badgeClass = '';
                const stage = (r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]||"").trim();
                if(stage === 'ë°©ì–´ì„±ê³µ') badgeClass = 'stage-success';
                else if(stage === 'ë°©ì–´ì‹¤íŒ¨') badgeClass = 'stage-fail';
                else badgeClass = 'stage-ing';

                tr.innerHTML = `
                    <td>${r["ê´€ë¦¬ë³¸ë¶€"] || '-'}</td>
                    <td>${util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])}</td>
                    <td>${r["ë‹´ë‹¹ì"]}</td>
                    <td>${util.cleanContract(r["ê³„ì•½ë²ˆí˜¸"])}</td>
                    <td>${r["ìƒí˜¸"] || '-'}</td>
                    <td>${r["ë‹´ë‹¹ì˜ì—…ì±„ë„"]}</td>
                    <td>${util.formatNum(util.toThousand(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]))}</td>
                    <td>${r["ì¬ê³„ì•½ì—¬ë¶€"] || '-'}</td>
                    <td><span class="badge ${badgeClass}">${stage}</span></td>
                    <td>${r["ì´ìŠˆìœ í˜•"] || '-'}</td>
                    <td>${r["í•´ì§€ì‚¬ìœ "] || '-'}</td>
                    <td>${r["í•´ì§€ì˜ˆì •ì¼"] || '-'}</td>
                    <td>${util.excelDateToJSDate(r["ë“±ë¡ì¼ì"])}</td>
                    <td class="long-text">${r["ì§€ì›ìš”ì²­ë‚´ìš©"] || '-'}</td>
                    <td class="long-text">${r["ì„¸ë¶€ë‚´ìš© ë° ê³µìœ ì‚¬í•­"] || '-'}</td>`;
            } else {
                let badgeClass = '';
                const status = (r["ìƒíƒœ"]||"").trim();
                if(status === 'ì²˜ë¦¬ì™„ë£Œ') badgeClass = 'voc-done';
                else if(status === 'ì ‘ìˆ˜') badgeClass = 'voc-receipt';
                else if(status === 'ë¯¸ì ‘ìˆ˜') badgeClass = 'voc-yet';

                const mapLink = r["ì§€ë„ë§í¬"] ? `<a href="${r["ì§€ë„ë§í¬"]}" target="_blank" class="btn-map"><i class="ph ph-map-pin"></i> ì§€ë„í™•ì¸</a>` : '-';
                const amount = r["í•©ì‚°ì›”ì •ë£Œ"] ? util.formatNum(util.toThousand(r["í•©ì‚°ì›”ì •ë£Œ"])) : '-';
                
                tr.innerHTML = `
                    <td>${util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])}</td>
                    <td>${r["ë‹´ë‹¹ì"]}</td>
                    <td>${util.cleanContract(r["ê³„ì•½ë²ˆí˜¸"])}</td>
                    <td>${r["ìƒí˜¸"] || '-'}</td>
                    <td><span class="badge ${badgeClass}">${status}</span></td>
                    <td>${r["VOCìœ í˜•ì†Œ"] || '-'}</td>
                    <td>${amount}</td>
                    <td>${mapLink}</td>`;
            }
            tbody.appendChild(tr);
        });

        const btns = document.querySelectorAll(`#${type}View .pagination button`);
        btns[0].disabled = s.page === 1;
        btns[1].disabled = s.page >= totalPages || totalPages === 0;
    }

    window.changePage = (type, delta) => {
        state[type].page += delta;
        renderTable(type);
    };

    function setupSortEvents(tableId, type) {
        document.querySelectorAll(`#${tableId} th[data-field]`).forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.field;
                if(state[type].sortField === field) {
                    state[type].sortDir = state[type].sortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    state[type].sortField = field;
                    state[type].sortDir = 'desc';
                }
                document.querySelectorAll(`#${tableId} th`).forEach(t => t.innerText = t.innerText.replace(/ [â–²â–¼]/, ''));
                th.innerText += state[type].sortDir === 'asc' ? ' â–²' : ' â–¼';
                renderTable(type);
            });
        });
    }

    window.exportToCSV = (type) => {
        const data = state[type].filtered;
        if(!data.length) return alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        const csv = Papa.unparse(data);
        const blob = new Blob(["\uFEFF"+csv], {type: 'text/csv;charset=utf-8;'});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `ktt_dashboard_${type}_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    };
</script>
</body>
</html>
