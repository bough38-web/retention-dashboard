<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>KTT Premium Retention Dashboard (v20.0 Layout)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbmyeJMsApj38SRzWvaQGrZmpqUQTooMw" defer></script>
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<style>
    :root {
        --primary: #4f46e5; --bg: #f1f5f9; --surface: #ffffff;
        --text: #1e293b; --border: #cbd5e1;
    }
    body { margin:0; font-family:'Pretendard', sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; overflow:hidden; }
    * { box-sizing:border-box; outline:none; }
    
    /* Layout */
    .sidebar { width:260px; background:var(--surface); border-right:1px solid var(--border); display:flex; flex-direction:column; z-index:20; }
    .logo { padding:20px; border-bottom:1px solid var(--border); font-size:18px; font-weight:800; color:var(--primary); display:flex; align-items:center; gap:8px; }
    .scroll-area { flex:1; overflow-y:auto; padding:16px; }
    
    .main-content { flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; }
    .view-panel { display:none; flex-direction:column; gap:16px; width: 100%; height: 100%; }
    .view-panel.active { display:flex; }

    /* Cards & Charts */
    .card { background:var(--surface); border-radius:8px; padding:16px; box-shadow:0 1px 3px rgba(0,0,0,0.1); display:flex; flex-direction:column; border:1px solid var(--border); }
    .card-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; font-size:15px; font-weight:700; color:#334155; }
    
    /* Pipeline Specific Layout (2x2 Grid) */
    .pipe-section { display:flex; flex-direction:column; gap:10px; flex:1; min-height: 0; }
    .pipe-row { display:flex; gap:10px; height: 50%; min-height: 280px; }
    .pipe-left { flex: 0 0 300px; display:flex; flex-direction:column; } /* HQ Chart Width */
    .pipe-right { flex: 1; display:flex; flex-direction:column; min-width: 0; } /* Branch Chart Width */
    
    .chart-box { flex:1; position:relative; min-height: 0; }

    /* UI Elements */
    .upload-box { background:#f8fafc; border:1px dashed #94a3b8; border-radius:8px; padding:12px; text-align:center; cursor:pointer; margin-bottom:16px; }
    .nav-tabs { display:flex; background:#e2e8f0; padding:4px; border-radius:8px; margin-bottom:16px; }
    .nav-tab { flex:1; padding:6px; border:none; background:none; font-size:12px; font-weight:700; color:#64748b; cursor:pointer; border-radius:6px; }
    .nav-tab.active { background:var(--surface); color:var(--primary); box-shadow:0 1px 2px rgba(0,0,0,0.05); }
    
    /* Filters */
    .chip { padding:4px 8px; border:1px solid #e2e8f0; background:var(--surface); border-radius:12px; font-size:11px; cursor:pointer; display:inline-block; margin:2px; }
    .chip.active { background:var(--primary); color:#fff; border-color:var(--primary); }
    
    /* Map */
    #voc-map { flex:1; border-radius:8px; background:#e2e8f0; min-height:400px; }

    /* Table */
    .table-wrapper { overflow:auto; flex:1; border:1px solid var(--border); border-radius:8px; }
    table { width:100%; border-collapse:collapse; font-size:12px; white-space:nowrap; }
    th { background:#f8fafc; padding:10px; text-align:left; border-bottom:1px solid var(--border); position:sticky; top:0; }
    td { padding:8px 10px; border-bottom:1px solid #f1f5f9; }
    
    #loading { position:fixed; inset:0; background:rgba(255,255,255,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; }
    .spinner { width:40px; height:40px; border:4px solid #e0e7ff; border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { 100%{transform:rotate(360deg);} }
</style>
</head>
<body>

<div id="loading"><div class="spinner"></div></div>

<div class="sidebar">
    <div class="logo"><i class="ph ph-chart-polar"></i> KTT Dashboard</div>
    <div class="scroll-area">
        <div class="upload-box" onclick="triggerUpload()">
            <i class="ph ph-file-csv"></i> <span>데이터 파일 교체</span>
            <input type="file" id="fileInput" accept=".csv" style="display:none" />
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchView('voc')">VOC 현황</button>
            <button class="nav-tab" onclick="switchView('pipe')">파이프라인</button>
        </div>
        <div id="filter-container"></div>
    </div>
</div>

<div class="main-content">
    <div id="view-voc" class="view-panel active">
        <div class="card" style="flex:none;">
            <div class="card-head">지사별/담당자별 VOC 현황</div>
            <div style="display:flex; gap:16px; height:200px;">
                <div style="flex:1; position:relative;"><canvas id="chart-voc-branch"></canvas></div>
                <div style="flex:1; position:relative;"><canvas id="chart-voc-agent"></canvas></div>
            </div>
        </div>
        <div class="card" style="flex:1; min-height:0;">
            <div class="card-head">고객 위치 및 상세 리스트</div>
            <div style="display:flex; gap:16px; height:100%;">
                <div id="voc-map" style="flex:1;"></div>
                <div class="table-wrapper" style="flex:1;">
                    <table id="table-voc">
                        <thead><tr><th>지사</th><th>담당자</th><th>계약번호</th><th>상호</th><th>상태</th><th>월정료</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="view-pipe" class="view-panel">
        <div class="card-head" style="flex:none; margin-bottom:0;">
            <span><i class="ph ph-presentation-chart"></i> 해지 방어 파이프라인 분석</span>
            <span style="font-size:12px; font-weight:400; color:#64748b; margin-left:10px;">* 금액 단위: 천원</span>
        </div>

        <div class="pipe-section">
            <div class="pipe-row">
                <div class="card pipe-left">
                    <div class="card-head">관리본부별 건수 (단위: 건)</div>
                    <div class="chart-box"><canvas id="chart-hq-count"></canvas></div>
                </div>
                <div class="card pipe-right">
                    <div class="card-head">지사별 건수</div>
                    <div class="chart-box"><canvas id="chart-branch-count"></canvas></div>
                </div>
            </div>

            <div class="pipe-row">
                <div class="card pipe-left">
                    <div class="card-head">관리본부별 금액 (단위: 천원)</div>
                    <div class="chart-box"><canvas id="chart-hq-amt"></canvas></div>
                </div>
                <div class="card pipe-right">
                    <div class="card-head">지사별 금액</div>
                    <div class="chart-box"><canvas id="chart-branch-amt"></canvas></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/* === CONFIG & INIT === */
// 요청하신 본부 정렬 순서
const HQ_ORDER = ['강남/서부', '강북/강원', '충남/충북', '전남/전북', '대구/경북', '부산/경남'];
// 지사 정렬 순서 (기존 유지)
const BRANCH_ORDER = ['중앙', '강북', '서대문', '의정부', '남양주', '강릉', '원주'];

// 상태별 색상 (파란색: 성공, 주황색: 실패, 회색: 진행/기타)
const COLORS = {
    '방어성공': '#3b82f6', // Blue
    '방어실패': '#f97316', // Orange
    '진행중': '#94a3b8',   // Gray
    '기타': '#cbd5e1'
};

const URLS = {
    voc: "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv",
    pipe: "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv"
};

let App = {
    view: 'voc',
    data: { voc:[], pipe:[] },
    filtered: [],
    filters: { hq:'ALL', branch:'ALL', agent:'ALL', status:'ALL', channel:'SP' },
    map: null, clusterer: null, markers: [], charts: {}
};

Chart.register(ChartDataLabels);
Chart.defaults.font.family = "'Pretendard', sans-serif";
Chart.defaults.color = '#475569';

window.onload = async () => {
    try {
        const [v, p] = await Promise.all([fetchCsv(URLS.voc), fetchCsv(URLS.pipe)]);
        App.data.voc = parseVoc(v.data);
        App.data.pipe = parsePipe(p.data);
        
        initMap();
        initFilters();
        updateDashboard();
    } catch(e) { console.error(e); alert("데이터 로드 실패"); }
    document.getElementById('loading').style.display = 'none';
};

/* === DATA PROCESSING === */
async function fetchCsv(url) {
    const r = await fetch(url); const t = await r.text();
    return Papa.parse(t.replace(/^\uFEFF/, ''), {header:true, skipEmptyLines:true});
}

function parseVoc(data) {
    if(!data.length) return [];
    return data.map(r => ({
        ...r,
        _branch: (r["관리지사"]||"기타").replace("지사","").trim(),
        _agent: (r["담당자"]||"미지정").trim(),
        _status: (r["상태"]||"").trim(),
        _lat: parseFloat(r["위도"])||null, _lng: parseFloat(r["경도"])||null,
        _fee: parseInt((r["합산월정료"]||"0").replace(/,/g,''))||0
    }));
}

function parsePipe(data) {
    if(!data.length) return [];
    const kFee = Object.keys(data[0]).find(k=>k.includes("월정료")) || "월정료";
    return data.map(r => {
        let step = (r["방어진행단계"]||"").trim();
        // 상태 매핑 (데이터에 따라 다를 수 있으니 표준화)
        if(step.includes("성공")) step = "방어성공";
        else if(step.includes("실패") || step.includes("해지완료")) step = "방어실패";
        else step = "진행중";

        return {
            ...r,
            _hq: (r["관리본부"]||"기타").trim(),
            _branch: (r["관리지사"]||"기타").replace("지사","").trim(),
            _step: step,
            _fee: parseInt((r[kFee]||"0").replace(/,/g,''))||0
        };
    });
}

/* === FILTERS === */
function initFilters() {
    const area = document.getElementById('filter-container');
    area.innerHTML = `
        <div class="filter-box" id="fb-channel"><div class="filter-head">영업채널</div><div id="chips-channel"></div></div>
    `;
    // 채널 필터만 생성 (나머지는 자동 집계라 불필요할 수 있으나 필요시 추가 가능)
    const channels = ['전체', 'SP', 'SC', 'AM'];
    const box = document.getElementById('chips-channel');
    channels.forEach(c => {
        const btn = document.createElement('div');
        btn.className = `chip ${App.filters.channel===(c==='전체'?'ALL':c) ? 'active' : ''}`;
        btn.innerText = c;
        btn.onclick = () => {
            App.filters.channel = c==='전체'?'ALL':c;
            updateDashboard();
            // UI 업데이트
            Array.from(box.children).forEach(ch=>ch.classList.remove('active'));
            btn.classList.add('active');
        };
        box.appendChild(btn);
    });
}

function updateDashboard() {
    // 1. Data Filtering
    const src = App.view === 'voc' ? App.data.voc : App.data.pipe;
    App.filtered = src.filter(d => {
        if(App.view === 'pipe' && App.filters.channel !== 'ALL') {
            const ch = d["담당영업채널"] || "SP"; // 기본값 SP
            if(ch !== App.filters.channel) return false;
        }
        return true;
    });

    if(App.view === 'voc') renderVoc();
    else renderPipe();
}

/* === RENDERING: VOC === */
function renderVoc() {
    const data = App.filtered;
    // Map Update
    if(App.map) {
        if(App.clusterer) App.clusterer.clearMarkers();
        App.markers = [];
        const bounds = new google.maps.LatLngBounds();
        data.filter(d=>d._lat).forEach(d => {
            const m = new google.maps.Marker({
                position:{lat:d._lat, lng:d._lng},
                title: d["상호"]
            });
            bounds.extend(m.getPosition());
            App.markers.push(m);
        });
        App.clusterer = new markerClusterer.MarkerClusterer({ map: App.map, markers: App.markers });
        if(App.markers.length) App.map.fitBounds(bounds);
    }
    
    // Table Update
    const tbody = document.querySelector('#table-voc tbody');
    tbody.innerHTML = data.slice(0, 50).map(d => `
        <tr><td>${d._branch}</td><td>${d._agent}</td><td>${d["계약번호"]}</td>
        <td>${d["상호"]}</td><td>${d._status}</td><td>${d._fee.toLocaleString()}</td></tr>
    `).join('');

    // Simple Bar Chart Example (VOC)
    drawSimpleBar('chart-voc-branch', data, '_branch');
    drawSimpleBar('chart-voc-agent', data, '_agent');
}

function drawSimpleBar(id, data, key) {
    const counts = {};
    data.forEach(d => counts[d[key]] = (counts[d[key]]||0)+1);
    const labels = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]).slice(0,10);
    const ctx = document.getElementById(id).getContext('2d');
    if(App.charts[id]) App.charts[id].destroy();
    App.charts[id] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{ data: labels.map(l=>counts[l]), backgroundColor: '#6366f1' }]
        },
        options: { indexAxis: 'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
}

/* === RENDERING: PIPELINE (NEW LAYOUT) === */
function renderPipe() {
    const data = App.filtered;

    // 1. 데이터 집계 (HQ별, Branch별)
    const agg = {
        hq: {},     // { '강남/서부': { '방어성공': {cnt:10, amt:1000}, ... }, ... }
        branch: {}  // { '강남지사': { '방어성공': {cnt:5, amt:500}, _hq: '강남/서부' }, ... }
    };

    // HQ 초기화 (정렬 순서 보장)
    HQ_ORDER.forEach(hq => agg.hq[hq] = { _total:0 });

    data.forEach(d => {
        const hq = d._hq || '기타';
        const br = d._branch || '기타';
        const st = d._step; // 방어성공, 방어실패, 진행중
        const fee = d._fee / 1000; // 천원 단위 변환

        // HQ Agg
        if(!agg.hq[hq]) agg.hq[hq] = { _total:0 };
        if(!agg.hq[hq][st]) agg.hq[hq][st] = { cnt:0, amt:0 };
        agg.hq[hq][st].cnt += 1;
        agg.hq[hq][st].amt += fee;
        agg.hq[hq]._total += 1;

        // Branch Agg
        if(!agg.branch[br]) agg.branch[br] = { _hq: hq, _total:0 };
        if(!agg.branch[br][st]) agg.branch[br][st] = { cnt:0, amt:0 };
        agg.branch[br][st].cnt += 1;
        agg.branch[br][st].amt += fee;
        agg.branch[br]._total += 1;
    });

    // 2. 차트 그리기
    drawPipelineChart('chart-hq-count', 'hq', 'cnt', agg.hq, HQ_ORDER);
    drawPipelineChart('chart-hq-amt', 'hq', 'amt', agg.hq, HQ_ORDER);
    
    // 지사 정렬: 본부 순서 -> 지사 이름 순서
    const sortedBranches = Object.keys(agg.branch).sort((a,b) => {
        const hqA = agg.branch[a]._hq;
        const hqB = agg.branch[b]._hq;
        const idxA = HQ_ORDER.indexOf(hqA);
        const idxB = HQ_ORDER.indexOf(hqB);
        if(idxA !== idxB) return idxA - idxB;
        return a.localeCompare(b);
    });

    drawPipelineChart('chart-branch-count', 'branch', 'cnt', agg.branch, sortedBranches);
    drawPipelineChart('chart-branch-amt', 'branch', 'amt', agg.branch, sortedBranches);
}

function drawPipelineChart(id, type, metric, aggData, labels) {
    const ctx = document.getElementById(id).getContext('2d');
    if(App.charts[id]) App.charts[id].destroy();

    const datasets = ['방어성공', '방어실패', '진행중'].map(status => {
        return {
            label: status,
            data: labels.map(label => {
                const item = aggData[label];
                if(!item || !item[status]) return 0;
                return Math.round(item[status][metric]); // 소수점 제거
            }),
            backgroundColor: COLORS[status],
            barPercentage: 0.6,
            categoryPercentage: 0.8
        };
    });

    // 왼쪽(HQ)은 가로 막대(y), 오른쪽(Branch)은 세로 막대(x)
    const isHorizontal = (type === 'hq'); 

    App.charts[id] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            indexAxis: isHorizontal ? 'y' : 'x',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    display: true, position: 'top', align: 'end',
                    labels: { boxWidth: 10, font: { size: 11 } }
                },
                tooltip: {
                    mode: 'index', intersect: false,
                    callbacks: {
                        footer: (items) => {
                            const sum = items.reduce((a, b) => a + b.raw, 0);
                            return `합계: ${sum.toLocaleString()}`;
                        }
                    }
                },
                datalabels: {
                    color: '#000', // 잘 보이게 검정색
                    font: { size: 10, weight: 'bold' },
                    formatter: (val) => val > 0 ? val.toLocaleString() : '',
                    anchor: 'center', align: 'center'
                }
            },
            scales: {
                x: { 
                    stacked: true, 
                    grid: { display: false },
                    ticks: { autoSkip: false, font: { size: 11 } }
                },
                y: { 
                    stacked: true, 
                    grid: { borderDash: [2, 4] },
                    ticks: { font: { size: 11, weight: 'bold' } }
                }
            }
        }
    });
}

/* === UTILS === */
function switchView(v) {
    App.view = v;
    document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active'));
    document.getElementById('view-'+v).classList.add('active');
    
    document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
    document.querySelector(`button[onclick="switchView('${v}')"]`).classList.add('active');

    // 필터 표시 여부
    document.getElementById('fb-channel').style.display = (v === 'pipe') ? 'block' : 'none';

    setTimeout(() => {
        if(v==='voc' && App.map) google.maps.event.trigger(App.map, 'resize');
        Object.values(App.charts).forEach(c => c.resize());
        if(v==='pipe') renderPipe(); // 뷰 전환시 강제 리렌더링
    }, 100);
}

function triggerUpload() { document.getElementById('fileInput').click(); }
function initMap() {
    App.map = new google.maps.Map(document.getElementById('voc-map'), {
        center: {lat: 36.5, lng: 127.5}, zoom: 7, disableDefaultUI: true
    });
}
</script>
</body>
</html>
