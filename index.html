<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>KTT í†µí•© ë¦¬í…ì…˜ ëŒ€ì‹œë³´ë“œ (Premium)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* :root ë””ìì¸ ë³€ìˆ˜ */
        :root {
            --primary: #2563eb; --primary-dark: #1e40af; --bg-body: #f1f5f9; --bg-card: #ffffff;
            --text-main: #0f172a; --text-sub: #64748b; --border: #e2e8f0; --radius: 12px;
        }

        /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
        body { margin: 0; display: flex; background: var(--bg-body); font-family: 'Pretendard', sans-serif; color: var(--text-main); height: 100vh; overflow: hidden; }
        * { box-sizing: border-box; }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 300px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; z-index: 10; }
        .sidebar-header { padding: 24px; border-bottom: 1px solid var(--border); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* ë©”ì¸ ì»¨í…ì¸  */
        .content { flex: 1; padding: 32px; overflow-y: auto; position: relative; }

        /* íŒŒì¼ ì—…ë¡œë“œ & ë·° ìŠ¤ìœ„ì²˜ */
        .file-upload-area { margin-bottom: 20px; padding: 15px; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; }
        .file-upload-area:hover { border-color: var(--primary); background: #eff6ff; }
        
        .view-switcher { display: flex; background: #f8fafc; padding: 4px; border-radius: 8px; margin-bottom: 24px; border: 1px solid var(--border); }
        .view-switcher button { flex: 1; padding: 10px; border: none; background: transparent; font-weight: 600; color: var(--text-sub); cursor: pointer; border-radius: 6px; }
        .view-switcher button.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .dashboard-view { display: none; }
        .dashboard-view.active { display: block; animation: slideUp 0.4s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* KPI & Chart Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--bg-card); padding: 24px; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-left: 4px solid var(--primary); }
        .kpi-card h3 { margin: 0 0 8px; font-size: 13px; color: var(--text-sub); font-weight: 600; text-transform: uppercase; }
        .kpi-card .value { font-size: 28px; font-weight: 800; color: var(--text-main); }
        
        .chart-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 30px; }
        .chart-card { background: var(--bg-card); border-radius: var(--radius); padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); height: 420px; display: flex; flex-direction: column; }
        .chart-card h3 { margin: 0 0 20px; font-size: 16px; font-weight: 700; }
        .chart-wrapper { flex: 1; position: relative; width: 100%; overflow: hidden; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .list-card { background: var(--bg-card); border-radius: var(--radius); padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .table-container { overflow-x: auto; min-height: 300px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        .data-table th { background: #f8fafc; padding: 12px; position: sticky; top: 0; text-align: center; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--text-sub); cursor: pointer; }
        .data-table th:hover { background: #f1f5f9; color: var(--primary); }
        .data-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: center; vertical-align: middle; max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
        .data-table tr:hover td { background: #f8fafc; }
        
        /* ë±ƒì§€ & ë²„íŠ¼ */
        .badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .badge.success { background: #dcfce7; color: #166534; }
        .badge.fail { background: #fee2e2; color: #991b1b; }
        .badge.ing { background: #ffedd5; color: #9a3412; }

        .btn-mail { background: #fff; border: 1px solid #e2e8f0; padding: 4px 8px; border-radius: 6px; cursor: pointer; color: #475569; display: inline-flex; align-items: center; gap: 4px; transition: 0.2s; font-size: 11px; font-weight: 600; }
        .btn-mail:hover { border-color: var(--primary); color: var(--primary); background: #eff6ff; }

        /* í•„í„° íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .filter-panel label { display: block; margin: 15px 0 8px; font-size: 13px; font-weight: 600; color: var(--text-main); }
        .filter-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
        
        /* â˜… ë‹´ë‹¹ì ë²„íŠ¼ ì „ìš© ìŠ¤íƒ€ì¼ (ìŠ¤í¬ë¡¤ ì§€ì›) */
        .filter-buttons.scrollable { max-height: 180px; overflow-y: auto; padding-right: 5px; border: 1px solid #f1f5f9; padding: 8px; border-radius: 8px; background: #fcfcfc; }
        .filter-buttons.scrollable::-webkit-scrollbar { width: 4px; }
        .filter-buttons.scrollable::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        .filter-btn { padding: 6px 12px; border: 1px solid #e2e8f0; background: #fff; border-radius: 12px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .filter-btn:hover { background: #f8fafc; }
        .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 4px rgba(37,99,235,0.2); font-weight: 600; }
        
        select { width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px; background: #fff; outline: none; }
    </style>
</head>
<body>

<div id="loadingOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction: column;">
    <div style="width:40px; height:40px; border:4px solid #eff6ff; border-top:4px solid #2563eb; border-radius:50%; animation:spin 1s linear infinite;"></div>
    <div style="margin-top:15px; font-weight:600; color:#475569;">ë°ì´í„° ë¶„ì„ ì¤‘...</div>
</div>
<style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>

<div class="sidebar">
    <div class="sidebar-header">
        <h2 style="margin:0; font-size:18px; display:flex; align-items:center; gap:8px;">
            <i class="ph ph-chart-polar" style="color:var(--primary);"></i> KTT Premium
        </h2>
    </div>
    <div class="sidebar-content">
        <label class="file-upload-area">
            <i class="ph ph-upload-simple" style="font-size:20px; color:var(--primary);"></i><br>
            <span style="font-size:12px; font-weight:600;">íŒŒì¼ ì—…ë¡œë“œ (CSV)</span>
            <input type="file" id="localFileInput" accept=".csv" style="display:none;" />
        </label>

        <div class="view-switcher">
            <button id="showVocBtn" class="active" onclick="switchView('voc')">VOC í˜„í™©</button>
            <button id="showPipelineBtn" onclick="switchView('pipeline')">í•´ì§€ ë°©ì–´</button>
        </div>

        <div id="pipelineFilters" class="filter-panel" style="display:none;">
            <label>ì˜ì—… ì±„ë„</label>
            <select id="channelFilter">
                <option value="SP">SP</option><option value="SC">SC</option><option value="ALL">ì „ì²´</option>
            </select>

            <label>ì§€ì‚¬ í•„í„°</label>
            <div id="pipelineBranchButtons" class="filter-buttons"></div>

            <label>ë‹´ë‹¹ì ì„ íƒ</label>
            <div id="pipelineManagerButtons" class="filter-buttons scrollable"></div>
        </div>
        
        <div id="vocFilters" class="filter-panel">
             <label>ì§€ì‚¬ í•„í„°</label>
             <div id="vocBranchButtons" class="filter-buttons"></div>
        </div>
    </div>
</div>

<div class="content">
    
    <div id="vocView" class="dashboard-view active">
        <div style="margin-bottom:20px;">
            <h2 style="margin:0;">ê³ ê°ì˜ ì†Œë¦¬ (VOC) í™œë™ í˜„í™©</h2>
            <p style="margin:5px 0 0; font-size:14px; color:var(--text-sub);">ì¬ê³„ì•½ ê´€ë ¨ VOC ì ‘ìˆ˜ ë° ì²˜ë¦¬ í˜„í™© ëª¨ë‹ˆí„°ë§</p>
        </div>
        <div class="kpi-grid">
            <div class="kpi-card" style="border-left-color:#3b82f6;"><h3>ì´ ì ‘ìˆ˜</h3><div id="kpi-voc-total" class="value">0</div></div>
            <div class="kpi-card" style="border-left-color:#10b981;"><h3>ì²˜ë¦¬ ì™„ë£Œ</h3><div id="kpi-voc-complete" class="value">0</div></div>
            <div class="kpi-card" style="border-left-color:#f59e0b;"><h3>ì²˜ë¦¬ìœ¨</h3><div id="kpi-voc-complete-rate" class="value">0%</div></div>
            <div class="kpi-card" style="border-left-color:#ef4444;"><h3>ë¯¸ì ‘ìˆ˜</h3><div id="kpi-voc-unassigned" class="value">0</div></div>
        </div>
        <div class="chart-grid">
            <div class="chart-card"><h3>ì¡°ì¹˜ í•„ìš” ë‹´ë‹¹ì (Top 10)</h3><div class="chart-wrapper"><canvas id="vocActivityChart"></canvas></div></div>
            <div class="chart-card"><h3>ì§€ì‚¬ë³„ ì²˜ë¦¬ í˜„í™©</h3><div class="chart-wrapper"><canvas id="vocBranchChart"></canvas></div></div>
        </div>
        <div class="list-card">
            <h3 style="margin-bottom:15px; padding:24px 24px 0 24px;">VOC ìƒì„¸ ë¦¬ìŠ¤íŠ¸</h3>
            <div class="table-container" style="padding:0 24px 24px 24px;">
                <table id="vocListTable" class="data-table">
                    <thead><tr><th>ì§€ì‚¬</th><th>ë‹´ë‹¹ì</th><th>ìƒíƒœ</th><th>ìœ í˜•</th><th>ì›”ì •ë£Œ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="pipelineView" class="dashboard-view">
        <div style="margin-bottom:20px;">
            <h2 style="margin:0;">í•´ì§€ íŒŒì´í”„ë¼ì¸ ë¶„ì„</h2>
            <p style="margin:5px 0 0; font-size:14px; color:var(--text-sub);">ê³ ìœ„í—˜ ê³ ê° ë°©ì–´ ì„±ê³¼ ë° í•´ì§€ ì‚¬ìœ  ì‹¬ì¸µ ë¶„ì„</p>
        </div>
        <div class="kpi-grid">
            <div class="kpi-card" style="border-left-color:#2563eb;"><h3>ëŒ€ìƒ ê±´ìˆ˜</h3><div id="kpi-pipeline-count" class="value">0</div></div>
            <div class="kpi-card" style="border-left-color:#10b981;"><h3>ì›”ì •ë£Œ ê·œëª¨</h3><div id="kpi-pipeline-amount" class="value">0</div></div>
            <div class="kpi-card" style="border-left-color:#ef4444;"><h3>ê³ ìœ„í—˜êµ° (75%â†‘)</h3><div id="kpi-high-risk-count" class="value">0</div></div>
            <div class="kpi-card" style="border-left-color:#f59e0b;"><h3>ë°©ì–´ ì„±ê³µë¥ </h3><div id="kpi-defense-success-rate" class="value">0%</div></div>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <h3>ì§€ì‚¬ë³„ ë°©ì–´ ë‹¨ê³„</h3>
                <div class="chart-wrapper"><canvas id="pipelineBranchStageChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3>ì›”ë³„ ë“±ë¡ ë° ë°©ì–´ ì¶”ì´ (Upgraded)</h3>
                <div class="chart-wrapper"><canvas id="pipelineTrendChart"></canvas></div>
            </div>
        </div>

        <div class="chart-grid">
             <div class="chart-card">
                <h3>ìœ„í—˜ë„ vs ì›”ì •ë£Œ (4ë¶„ë©´)</h3>
                <div class="chart-wrapper"><canvas id="pipelineRiskBubbleChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3>í•´ì§€ ì‚¬ìœ  ë¶„ì„ (Top 5)</h3>
                <div class="chart-wrapper"><canvas id="pipelineReasonChart"></canvas></div>
            </div>
        </div>

        <div class="list-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding:24px 24px 0 24px;">
                <h3 style="margin:0;">ìƒì„¸ íŒŒì´í”„ë¼ì¸ ë¦¬ìŠ¤íŠ¸</h3>
                <button onclick="exportToCSV('pipeline')" class="btn-mail" style="background:#10b981; color:white; border:none; font-size:13px; padding:8px 16px;">
                    <i class="ph ph-download-simple"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </button>
            </div>
            <div class="table-container" style="padding:0 24px;">
                <table id="pipelineListTable" class="data-table">
                    <thead>
                        <tr>
                            <th>ì§€ì‚¬</th><th>ë‹´ë‹¹ì</th><th>ê³„ì•½ë²ˆí˜¸</th>
                            <th>ìƒí˜¸ëª…</th>
                            <th>ì›”ì •ë£Œ</th><th>ì¬ê³„ì•½</th><th>ë‹¨ê³„</th>
                            <th>í•´ì§€ì‚¬ìœ </th>
                            <th>ì§€ì›ìš”ì²­</th>
                            <th>ìœ„í—˜ë„</th><th>ë“±ë¡ì¼</th><th>ë©”ì¼</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="list-footer" style="margin-top:15px; display:flex; justify-content:space-between; align-items:center; padding:0 24px 24px 24px;">
                <div id="pipelinePaginationInfo" style="font-size:13px; color:var(--text-sub);"></div>
                <div class="pagination"><button onclick="changePage('pipeline',-1)">ì´ì „</button><button onclick="changePage('pipeline',1)">ë‹¤ìŒ</button></div>
            </div>
        </div>
    </div>
</div>

<script>
    // === [ì„¤ì •] ===
    const ADMIN_PW = "3867";
    const VOC_CSV_URL = "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv";
    const PIPELINE_CSV_URL = "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv";

    // Chart.js ì„¤ì •
    Chart.register(ChartDataLabels);
    Chart.defaults.font.family = "'Pretendard', sans-serif";
    Chart.defaults.color = "#64748b";

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    const util = {
        normalizeBranch: (n) => String(n||"").replace("ì§€ì‚¬","").trim(),
        cleanContract: (r) => String(r||"").replace(/\D/g,"").slice(0,8),
        toThousand: (r) => { const n=parseFloat(String(r).replace(/,/g,"")); return isNaN(n)?0:Math.round(n/1000); },
        formatNum: (n) => n.toLocaleString(),
        excelDateToJSDate: (s) => {
            if(!s) return "-";
            if (String(s).match(/^\d{4}-\d{2}-\d{2}$/)) return s; 
            const c=parseFloat(String(s).replace(/,/g,'')); 
            if(isNaN(c)) return s;
            const d=new Date((c-25569)*86400*1000);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        },
        sortBranches: (a,b)=>{ const o=["ì¤‘ì•™","ê°•ë¶","ì„œëŒ€ë¬¸","ê³ ì–‘","ì˜ì •ë¶€","ë‚¨ì–‘ì£¼","ê°•ë¦‰","ì›ì£¼"]; const ia=o.indexOf(a),ib=o.indexOf(b); if(ia===-1&&ib===-1)return a.localeCompare(b); if(ia===-1)return 1; if(ib===-1)return -1; return ia-ib; }
    };

    // ìƒíƒœ ê´€ë¦¬
    const state = {
        currentView: 'voc',
        voc: { data: [], filtered: [], page: 1, limit: 15, sortField: 'VOCìœ í˜•ëŒ€', sortDir: 'desc', branch: 'ALL' },
        pipeline: { 
            data: [], filtered: [], page: 1, limit: 15, 
            sortField: 'KTTì›”ì •ë£Œ(ì¡°ì •)', sortDir: 'desc', 
            mode: 'count', hq: 'ALL', branch: 'ALL', channel: 'SP', manager: 'ALL' 
        }
    };
    const chartInstances = {};

    // â˜… ë°ì´í„° ì „ì²˜ë¦¬
    function preprocessPipelineData(data) {
        return data.map(row => {
            if (row["KTTì›”ì •ë£Œ(ì¡°ì •)"]) {
                const val = parseFloat(String(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]).replace(/,/g, ""));
                if (!isNaN(val)) row["KTTì›”ì •ë£Œ(ì¡°ì •)"] = String(Math.round(val));
            }
            let risk = row['í•´ì§€ìœ„í—˜ë„'];
            if (risk) {
                let riskNum = parseFloat(risk);
                if (!isNaN(riskNum) && riskNum <= 1.0 && riskNum > 0) {
                    row['í•´ì§€ìœ„í—˜ë„'] = (riskNum * 100).toFixed(0);
                }
            }
            return row;
        });
    }

    // â˜… ë©”ì¼ ì „ì†¡ (ë¹„ë°€ë²ˆí˜¸ ì¸ì¦)
    window.sendMail = function(name, contractId, email) {
        const inputPw = prompt("ğŸ”’ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (inputPw !== ADMIN_PW) {
            alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }
        const subject = `[í•´ì§€ë°©ì–´ ìš”ì²­] ${name} ë‹´ë‹¹ìë‹˜ (ê³„ì•½ë²ˆí˜¸: ${contractId})`;
        const body = `ë‹´ë‹¹ìë‹˜,\n\nê³„ì•½ë²ˆí˜¸ ${contractId} ê±´ì— ëŒ€í•´ í•´ì§€ ë°©ì–´ í™œë™ ì—…ë°ì´íŠ¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤.\n\nê°ì‚¬í•©ë‹ˆë‹¤.`;
        window.location.href = `mailto:${email||''}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    };

    // ì´ˆê¸°í™”
    window.addEventListener("load", async () => {
        try {
            await loadDefaultData();
        } catch(e) { console.error(e); }
        finally { document.getElementById("loadingOverlay").style.display = "none"; }
    });

    async function loadDefaultData() {
        const [v, p] = await Promise.all([loadCsv(VOC_CSV_URL), loadCsv(PIPELINE_CSV_URL)]);
        state.voc.data = v; 
        state.pipeline.data = preprocessPipelineData(p);
        initializeApp();
    }

    async function loadCsv(url) {
        const res = await fetch(url); const text = await res.text();
        return new Promise(r => Papa.parse(text, { header: true, skipEmptyLines: true, complete: res => r(res.data) }));
    }

    function initializeApp() {
        document.getElementById("channelFilter").value = "SP";
        document.getElementById("channelFilter").addEventListener("change", (e)=>{ state.pipeline.channel=e.target.value; updateDashboard('pipeline'); });
        
        renderFilters('voc'); renderFilters('pipeline');
        filterData('voc'); filterData('pipeline');
        updateDashboard('voc'); updateDashboard('pipeline');
        switchView('voc');
    }

    // íŒŒì¼ ì—…ë¡œë“œ
    document.getElementById('localFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            Papa.parse(evt.target.result, {
                header: true, skipEmptyLines: true,
                complete: function(results) {
                    state.pipeline.data = preprocessPipelineData(results.data);
                    initializeApp();
                    switchView('pipeline');
                    alert("âœ… ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            });
        };
        reader.readAsText(file, 'UTF-8');
    });

    // â˜… í•„í„° ë Œë”ë§ (ë²„íŠ¼ì‹)
    function renderFilters(type) {
        // 1. ì§€ì‚¬ ë²„íŠ¼
        const brContainer = document.getElementById(`${type}BranchButtons`);
        let s = (type==='voc') ? state.voc.data : state.pipeline.data;
        let branches = [...new Set(s.map(r=>util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])).filter(Boolean))].sort(util.sortBranches);
        
        brContainer.innerHTML = `<button class="filter-btn active" onclick="setFilter('${type}','branch','ALL',this)">ì „ì²´</button>` +
            branches.map(i=>`<button class="filter-btn" onclick="setFilter('${type}','branch','${i}',this)">${i}</button>`).join('');
            
        // 2. â˜… ë‹´ë‹¹ì ë²„íŠ¼ (íŒŒì´í”„ë¼ì¸) - ìŠ¤í¬ë¡¤ ì˜ì—­ì— ë Œë”ë§
        if(type === 'pipeline') {
            const mgrContainer = document.getElementById('pipelineManagerButtons');
            const managers = [...new Set(s.map(r => r['ë‹´ë‹¹ì']).filter(Boolean))].sort();
            
            mgrContainer.innerHTML = `<button class="filter-btn active" onclick="setFilter('${type}','manager','ALL',this)">ì „ì²´ ë‹´ë‹¹ì</button>` +
                managers.map(m => `<button class="filter-btn" onclick="setFilter('${type}','manager','${m}',this)">${m}</button>`).join('');
        }
    }

    // í•„í„° ê³µí†µ í•¸ë“¤ëŸ¬
    window.setFilter = (type, field, val, btn) => {
        state[type][field] = val;
        btn.parentElement.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        updateDashboard(type);
    };

    window.switchView = (v) => {
        state.currentView = v;
        document.getElementById('showVocBtn').className = v==='voc'?'active':'';
        document.getElementById('showPipelineBtn').className = v==='pipeline'?'active':'';
        document.getElementById('vocView').className = v==='voc'?'dashboard-view active':'dashboard-view';
        document.getElementById('pipelineView').className = v==='pipeline'?'dashboard-view active':'dashboard-view';
        
        document.getElementById('vocFilters').style.display = v==='voc'?'block':'none';
        document.getElementById('pipelineFilters').style.display = v==='pipeline'?'block':'none';
        
        setTimeout(()=>Object.values(chartInstances).forEach(c=>c&&c.resize()), 100);
    };

    function updateDashboard(t) {
        filterData(t);
        if(t==='pipeline') { updatePipelineKPIs(); drawPipelineCharts(); renderTable('pipeline'); }
        else { updateVocKPIs(); drawVocCharts(); renderTable('voc'); }
    }

    function filterData(t) {
        let raw = state[t].data;
        if(t==='pipeline') {
            const ch = state.pipeline.channel;
            const mgr = state.pipeline.manager;
            state.pipeline.filtered = raw.filter(r => {
                if(ch!=='ALL' && r['ë‹´ë‹¹ì˜ì—…ì±„ë„']!==ch) return false;
                if(mgr!=='ALL' && r['ë‹´ë‹¹ì']!==mgr) return false;
                if(state.pipeline.branch!=='ALL' && util.normalizeBranch(r['ê´€ë¦¬ì§€ì‚¬'])!==state.pipeline.branch) return false;
                return true;
            });
        } else {
            state.voc.filtered = raw.filter(r => {
                if(state.voc.branch!=='ALL' && util.normalizeBranch(r['ê´€ë¦¬ì§€ì‚¬'])!==state.voc.branch) return false;
                return true;
            });
        }
        state[t].page = 1;
    }

    // --- KPI & Chart ---
    function updatePipelineKPIs() {
        const d = state.pipeline.filtered;
        const amt = d.reduce((s,r)=>s+util.toThousand(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]),0);
        const suc = d.filter(r=>r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]==='ë°©ì–´ì„±ê³µ').length;
        const total = d.length;
        const high = d.filter(r=>parseFloat(r["í•´ì§€ìœ„í—˜ë„"])>=75).length;
        
        document.getElementById("kpi-pipeline-count").innerText = util.formatNum(total);
        document.getElementById("kpi-pipeline-amount").innerText = util.formatNum(amt);
        document.getElementById("kpi-high-risk-count").innerText = util.formatNum(high);
        document.getElementById("kpi-defense-success-rate").innerText = total>0 ? (suc/total*100).toFixed(1)+'%' : '0%';
    }
    
    function updateVocKPIs() {
        const d = state.voc.filtered;
        const comp = d.filter(r=>r["ìƒíƒœ"]==='ì²˜ë¦¬ì™„ë£Œ').length;
        document.getElementById("kpi-voc-total").innerText = util.formatNum(d.length);
        document.getElementById("kpi-voc-complete").innerText = util.formatNum(comp);
        document.getElementById("kpi-voc-complete-rate").innerText = d.length>0 ? (comp/d.length*100).toFixed(1)+'%' : '0%';
        document.getElementById("kpi-voc-unassigned").innerText = util.formatNum(d.filter(r=>r["ìƒíƒœ"]==='ë¯¸ì ‘ìˆ˜').length);
    }

    function newChart(id, conf) {
        if(chartInstances[id]) chartInstances[id].destroy();
        chartInstances[id] = new Chart(document.getElementById(id), conf);
    }

    function drawPipelineCharts() {
        const d = state.pipeline.filtered;
        
        // 1. Branch Stage Bar
        const br={};
        d.forEach(r=>{
            const b = util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]); if(!b)return;
            if(!br[b]) br[b]={suc:0,fail:0,ing:0,tot:0};
            const s = r["ë°©ì–´ì§„í–‰ë‹¨ê³„"];
            if(s==='ë°©ì–´ì„±ê³µ')br[b].suc++; else if(s==='ë°©ì–´ì‹¤íŒ¨')br[b].fail++; else br[b].ing++;
        });
        const lBr = Object.keys(br).sort(util.sortBranches);
        newChart('pipelineBranchStageChart', {
            type:'bar',
            data:{
                labels:lBr,
                datasets:[
                    {label:'ì„±ê³µ',data:lBr.map(k=>br[k].suc),backgroundColor:'#34d399',stack:'s'},
                    {label:'ì§„í–‰',data:lBr.map(k=>br[k].ing),backgroundColor:'#fbbf24',stack:'s'},
                    {label:'ì‹¤íŒ¨',data:lBr.map(k=>br[k].fail),backgroundColor:'#f87171',stack:'s'}
                ]
            },
            options:{
                responsive:true,maintainAspectRatio:false,
                scales:{x:{stacked:true,grid:{display:false}},y:{stacked:true}},
                plugins:{legend:{position:'bottom'},datalabels:{display:false}}
            }
        });

        // 2. Trend Chart (Stack + Line)
        const trend = {};
        d.forEach(r => {
            let dateStr = util.excelDateToJSDate(r["ë“±ë¡ì¼ì"]);
            let month = dateStr.slice(0, 7); 
            if(month.length < 7) return;
            if(!trend[month]) trend[month] = { tot: 0, suc: 0, done: 0, plan: 0, none: 0 };
            
            trend[month].tot += 1;
            if(r["ë°©ì–´ì§„í–‰ë‹¨ê³„"] === 'ë°©ì–´ì„±ê³µ') trend[month].suc += 1;
            const contract = (r['ì¬ê³„ì•½ì—¬ë¶€']||'').trim();
            if(['ì¬ê³„ì•½ ì™„ë£Œ','ì¬ê³„ì•½ì™„ë£Œ'].includes(contract)) trend[month].done += 1;
            else if(['ì¬ê³„ì•½ ì˜ˆì •','ì¬ê³„ì•½ì˜ˆì •'].includes(contract)) trend[month].plan += 1;
            else trend[month].none += 1;
        });

        const labels = Object.keys(trend).sort();
        
        newChart('pipelineTrendChart', {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        type: 'line', label: 'ì„±ê³µë¥ (%)',
                        data: labels.map(m => (trend[m].tot===0 ? 0 : (trend[m].suc/trend[m].tot*100).toFixed(1))),
                        borderColor: '#10b981', borderWidth: 2, pointBackgroundColor:'#fff', pointRadius:4, fill: false, 
                        yAxisID: 'y_rate', order: 0
                    },
                    {
                        label: 'ì¬ê³„ì•½ ì™„ë£Œ', data: labels.map(m => trend[m].done),
                        backgroundColor: '#3b82f6', stack: 'combined', yAxisID: 'y_count', order: 1
                    },
                    {
                        label: 'ì¬ê³„ì•½ ì˜ˆì •', data: labels.map(m => trend[m].plan),
                        backgroundColor: '#93c5fd', stack: 'combined', yAxisID: 'y_count', order: 1
                    },
                    {
                        label: 'ì¬ê³„ì•½ ì—†ìŒ', data: labels.map(m => trend[m].none),
                        backgroundColor: '#e5e7eb', stack: 'combined', yAxisID: 'y_count', order: 1,
                        borderRadius: {topLeft:4, topRight:4}
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { grid: {display: false} },
                    y_count: { position: 'left', stacked:true, title: {display: true, text: 'ê±´ìˆ˜'}, grid:{borderDash:[4,4]} },
                    y_rate: { position: 'right', min: 0, max: 100, grid: {drawOnChartArea: false}, title: {display: true, text: 'ì„±ê³µë¥ (%)'} }
                },
                plugins: { legend: {display: true}, datalabels: {display: false} }
            }
        });

        // 3. Bubble Chart
        const bub = Object.entries(br).map(([b,v])=>{
            const sub = d.filter(r=>util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])===b);
            const risk = sub.reduce((s,r)=>s+parseFloat(r["í•´ì§€ìœ„í—˜ë„"]||0),0)/sub.length;
            const amtTotal = sub.reduce((s,r)=>s+util.toThousand(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]),0);
            const amtAvg = sub.length > 0 ? amtTotal/sub.length : 0;
            return { label:b, data:[{x:risk, y:Math.round(amtAvg), r:Math.sqrt(amtTotal)*0.4}], backgroundColor:'rgba(37,99,235,0.6)', borderColor:'#2563eb' };
        }).filter(b=>b.data[0].r>0);
        
        newChart('pipelineRiskBubbleChart', {
            type: 'bubble', data: { datasets: bub },
            options: {
                responsive:true, maintainAspectRatio:false,
                plugins: { 
                    legend:{display:false}, 
                    tooltip:{callbacks:{label:c=>`${c.dataset.label}: ìœ„í—˜ ${c.raw.x.toFixed(1)}% / ${c.raw.y.toLocaleString()}ì²œì›`}},
                    datalabels: { display: true, align: 'top', color: '#475569', font: {weight: 'bold', size: 10}, formatter: function(value) { return Math.round(value.y).toLocaleString() + 'ì²œì›'; } }
                },
                scales: { x:{title:{display:true,text:'ìœ„í—˜ë„ (%)'}, min:0, max:100}, y:{title:{display:true,text:'í‰ê·  ì›”ì •ë£Œ'}} }
            },
            plugins: [{
                id: 'quadrants', beforeDraw: (chart) => {
                    const {ctx, chartArea:{left, top, right, bottom}, scales:{x, y}} = chart;
                    const midX = x.getPixelForValue(50); const midY = y.getPixelForValue((y.max+y.min)/2);
                    ctx.save(); ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 1; ctx.setLineDash([5, 5]);
                    ctx.beginPath(); ctx.moveTo(midX, top); ctx.lineTo(midX, bottom); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(left, midY); ctx.lineTo(right, midY); ctx.stroke();
                    ctx.fillStyle = 'rgba(239, 68, 68, 0.05)'; ctx.fillRect(midX, top, right-midX, midY-top); 
                    ctx.restore();
                }
            }]
        });

        // 4. Reason Chart
        const reasons = {}; d.forEach(r => { let reason = (r["í•´ì§€ì‚¬ìœ "] || "ë¯¸ì…ë ¥").trim(); reasons[reason] = (reasons[reason] || 0) + 1; });
        const sortedReasons = Object.entries(reasons).sort((a,b) => b[1] - a[1]);
        const top5 = sortedReasons.slice(0, 5);
        const others = sortedReasons.slice(5).reduce((acc, curr) => acc + curr[1], 0);
        if(others > 0) top5.push(["ê¸°íƒ€", others]);

        newChart('pipelineReasonChart', {
            type: 'doughnut',
            data: { labels: top5.map(e => e[0]), datasets: [{ data: top5.map(e => e[1]), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#cbd5e1'] }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: {boxWidth: 12} },
                    datalabels: { color: '#fff', font: {weight: 'bold'}, formatter: (v, c) => {
                        let sum = c.chart._metasets[c.datasetIndex].total;
                        let val = c.chart.data.datasets[c.datasetIndex].data[c.dataIndex];
                        return (val/sum*100).toFixed(0) + "%";
                    }}
                }
            }
        });
    }

    function drawVocCharts() {
        const d = state.voc.filtered;
        const act={}; d.forEach(r=>{ const a=r['ë‹´ë‹¹ì']; if(a) act[a]=(act[a]||0)+1; });
        const sAct = Object.entries(act).sort((a,b)=>b[1]-a[1]).slice(0,10);
        newChart('vocActivityChart', {
            type:'bar', data:{labels:sAct.map(e=>e[0]),datasets:[{label:'ê±´ìˆ˜',data:sAct.map(e=>e[1]),backgroundColor:'#f59e0b'}]},
            options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},datalabels:{display:false}}}
        });
        const br={}; d.forEach(r=>{ const b=util.normalizeBranch(r['ê´€ë¦¬ì§€ì‚¬']); if(b) br[b]=(br[b]||0)+1; });
        const lBr = Object.keys(br).sort(util.sortBranches);
        newChart('vocBranchChart', {
            type:'bar', data:{labels:lBr,datasets:[{label:'ê±´ìˆ˜',data:lBr.map(k=>br[k]),backgroundColor:'#3b82f6'}]},
            options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},datalabels:{display:false}}}
        });
    }

    // --- Table & Pagination ---
    function renderTable(t) {
        const s = state[t];
        const tb = document.querySelector(`#${t}ListTable tbody`);
        tb.innerHTML = "";
        
        const start = (s.page-1)*s.limit;
        const end = start + s.limit;
        const pageData = s.filtered.slice(start, end);

        document.getElementById(`${t}PaginationInfo`).innerText = `ì´ ${util.formatNum(s.filtered.length)}ê±´ (${s.page}í˜ì´ì§€)`;

        pageData.forEach(r => {
            const tr = document.createElement("tr");
            if(t === 'pipeline') {
                const st = (r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]||"").trim();
                let bc = 'ing';
                if(st==='ë°©ì–´ì„±ê³µ') bc='success'; else if(st==='ë°©ì–´ì‹¤íŒ¨') bc='fail';
                
                // â˜… ìƒí˜¸ëª… í‘œì‹œ ìˆ˜ì • (ë‹¤ì–‘í•œ í—¤ë” ëŒ€ì‘)
                const company = r["ìƒí˜¸"] || r["ìƒí˜¸ëª…"] || r["ê³ ê°ëª…"] || r["ë²•ì¸ëª…"] || "-";

                tr.innerHTML = `
                    <td>${util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])}</td>
                    <td>${r["ë‹´ë‹¹ì"]}</td>
                    <td>${util.cleanContract(r["ê³„ì•½ë²ˆí˜¸"])}</td>
                    <td style="font-weight:600; color:#1e293b;">${company}</td>
                    <td>${util.formatNum(util.toThousand(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]))}</td>
                    <td>${r["ì¬ê³„ì•½ì—¬ë¶€"]||'-'}</td>
                    <td><span class="badge ${bc}">${st}</span></td>
                    <td title="${r['í•´ì§€ì‚¬ìœ ']}">${r['í•´ì§€ì‚¬ìœ ']||'-'}</td>
                    <td title="${r['ì§€ì›ìš”ì²­ë‚´ìš©']}">${r['ì§€ì›ìš”ì²­ë‚´ìš©']||'-'}</td>
                    <td>${r["í•´ì§€ìœ„í—˜ë„"]}%</td>
                    <td>${util.excelDateToJSDate(r["ë“±ë¡ì¼ì"])}</td>
                    <td>
                        <button class="btn-mail" onclick="sendMail('${r['ë‹´ë‹¹ì']}','${r['ê³„ì•½ë²ˆí˜¸']}','')">
                            <i class="ph ph-envelope-simple"></i>
                        </button>
                    </td>`;
            } else {
                tr.innerHTML = `<td>${util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])}</td><td>${r["ë‹´ë‹¹ì"]}</td><td>${r["ìƒíƒœ"]}</td><td>${r["VOCìœ í˜•ì†Œ"]||'-'}</td><td>${util.formatNum(util.toThousand(r["í•©ì‚°ì›”ì •ë£Œ"]))}</td>`;
            }
            tb.appendChild(tr);
        });
    }

    // ì •ë ¬ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    function setupSortEvents(tableId, type) {
        document.querySelectorAll(`#${tableId} th[data-field]`).forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.field;
                if(state[type].sortField === field) {
                    state[type].sortDir = state[type].sortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    state[type].sortField = field;
                    state[type].sortDir = 'desc';
                }
                renderTable(type);
            });
        });
    }

    window.changePage = (t, d) => {
        const s = state[t];
        const max = Math.ceil(s.filtered.length/s.limit);
        if(s.page+d > 0 && s.page+d <= max) { s.page += d; renderTable(t); }
    };
    
    // â˜… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ í¬í•¨)
    window.exportToCSV = (t) => {
        const inputPw = prompt("ğŸ”’ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (inputPw !== ADMIN_PW) {
            alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        const d = state[t].filtered; 
        if(!d.length) return alert("ë°ì´í„° ì—†ìŒ");
        const blob = new Blob(["\uFEFF"+Papa.unparse(d)], {type:'text/csv;charset=utf-8;'});
        const link = document.createElement("a"); link.href=URL.createObjectURL(blob); link.download=`ktt_${t}_${new Date().toISOString().slice(0,10)}.csv`; link.click();
    };

</script>
</body>
</html>
