<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>KTT Premium Retention Dashboard (Refactored)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<!-- ⚠️ 반드시 본인 API KEY로 교체 -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAP_KEY" defer></script>
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<style>
/* ===============================
   GLOBAL CONFIG
================================ */
:root {
  --primary:#4f46e5; --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
  --bg:#f8fafc; --surface:#fff; --text:#1e293b; --text-sub:#64748b;
  --border:#e2e8f0; --radius:12px; --shadow:0 4px 6px -1px rgb(0 0 0 / 0.1);
  --fail-bg:#fef2f2; --fail-text:#b91c1c;
}

*{box-sizing:border-box}
body{
  margin:0;font-family:Pretendard,sans-serif;
  background:var(--bg);color:var(--text);
  display:flex;height:100vh;overflow:hidden;
}

/* ===============================
   LAYOUT
================================ */
.sidebar{
  width:300px;background:var(--surface);
  border-right:1px solid var(--border);
  box-shadow:var(--shadow);display:flex;flex-direction:column;
}
.logo{
  padding:20px;font-size:20px;font-weight:800;
  color:var(--primary);border-bottom:1px solid var(--border);
}
.scroll-area{flex:1;overflow:auto;padding:20px}
.main{flex:1;padding:24px;overflow:auto}

/* ===============================
   UI
================================ */
.upload-box{
  border:1px dashed #94a3b8;border-radius:var(--radius);
  padding:14px;text-align:center;margin-bottom:16px;
  cursor:pointer;background:#f1f5f9
}
.upload-box:hover{background:#eef2ff;border-color:var(--primary)}

.nav-tabs{display:flex;background:#f1f5f9;border-radius:10px;padding:4px;margin-bottom:16px}
.nav-tab{
  flex:1;border:none;background:none;
  font-weight:700;padding:8px;border-radius:8px;cursor:pointer
}
.nav-tab.active{background:#fff;color:var(--primary)}

.card{
  background:var(--surface);border-radius:12px;
  box-shadow:var(--shadow);border:1px solid var(--border);
  padding:16px;margin-bottom:20px
}

/* ===============================
   TABLE
================================ */
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:10px;border-bottom:1px solid #e5e7eb}
th{background:#f8fafc;position:sticky;top:0}
tr.row-fail td{background:var(--fail-bg);color:var(--fail-text);font-weight:600}

/* ===============================
   KPI
================================ */
.kpi-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px;margin-bottom:20px
}
.kpi-card{
  padding:20px;border-left:5px solid var(--primary);
  background:#fff;border-radius:12px
}
.kpi-label{font-size:12px;color:var(--text-sub);font-weight:700}
.kpi-val{font-size:32px;font-weight:800;margin-top:6px}

/* ===============================
   MAP
================================ */
#map{height:360px;border-radius:10px;overflow:hidden}
</style>
</head>

<body>

<div class="sidebar">
  <div class="logo">KTT Dashboard</div>
  <div class="scroll-area">
    <div class="upload-box" onclick="triggerUpload()">CSV 파일 업로드</div>
    <input type="file" id="fileInput" hidden />
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchView('voc')">VOC</button>
      <button class="nav-tab" onclick="switchView('pipe')">Pipeline</button>
    </div>
  </div>
</div>

<div class="main">
  <div id="view-voc">
    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">총 계약</div><div class="kpi-val" id="voc-total">0</div></div>
      <div class="kpi-card"><div class="kpi-label">처리완료</div><div class="kpi-val" id="voc-done">0</div></div>
      <div class="kpi-card"><div class="kpi-label">미접수</div><div class="kpi-val" id="voc-wait">0</div></div>
    </div>

    <div class="card">
      <h3>고객 위치</h3>
      <div id="map"></div>
    </div>

    <div class="card">
      <h3>상세 리스트 <small style="color:#64748b">* 상위 100건 표시</small></h3>
      <table id="voc-table">
        <thead><tr><th>지사</th><th>담당자</th><th>상호</th><th>상태</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="view-pipe" style="display:none">
    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">전체</div><div class="kpi-val" id="pipe-total">0</div></div>
      <div class="kpi-card"><div class="kpi-label">고위험</div><div class="kpi-val" id="pipe-high">0</div></div>
      <div class="kpi-card"><div class="kpi-label">방어실패</div><div class="kpi-val" id="pipe-fail">0</div></div>
    </div>

    <div class="card">
      <canvas id="pipe-chart"></canvas>
    </div>
  </div>
</div>

<script>
/* ===============================
   CONSTANTS
================================ */
const UI = { TABLE_LIMIT:100, MAP_ZOOM:10 };

/* ===============================
   APP STATE
================================ */
const App = {
  view:'voc',
  data:{ voc:[], pipe:[] },
  map:null, markers:[], chart:null
};

/* ===============================
   VIEW SWITCH
================================ */
function switchView(v){
  App.view=v;
  document.getElementById('view-voc').style.display = v==='voc'?'block':'none';
  document.getElementById('view-pipe').style.display = v==='pipe'?'block':'none';
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
  document.querySelector(`button[onclick="switchView('${v}')"]`).classList.add('active');
}

/* ===============================
   MAP
================================ */
function initMap(){
  App.map = new google.maps.Map(document.getElementById('map'),{
    center:{lat:37.5665,lng:126.9780},zoom:UI.MAP_ZOOM
  });
}

function updateMap(data){
  App.markers.forEach(m=>m.setMap(null));
  App.markers=[];
  data.forEach(d=>{
    if(!d.lat) return;
    const m=new google.maps.Marker({
      map:App.map,
      position:{lat:d.lat,lng:d.lng},
      icon:'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
    });
    App.markers.push(m);
  });
}

/* ===============================
   TABLE
================================ */
function renderTable(data){
  const tbody=document.querySelector('#voc-table tbody');
  tbody.innerHTML='';
  data.slice(0,UI.TABLE_LIMIT).forEach(d=>{
    const tr=document.createElement('tr');
    if(d.risk===100) tr.classList.add('row-fail');
    tr.innerHTML=`<td>${d.branch}</td><td>${d.agent}</td><td>${d.name}</td><td>${d.status}</td>`;
    tbody.appendChild(tr);
  });
}

/* ===============================
   FILE UPLOAD
================================ */
function triggerUpload(){
  if(prompt('비밀번호')==='3867') document.getElementById('fileInput').click();
}

document.getElementById('fileInput').onchange=e=>{
  Papa.parse(e.target.files[0],{
    header:true,
    complete:r=>{
      App.data.voc=r.data.map(d=>({
        branch:d.관리지사,agent:d.담당자,name:d.상호,status:d.상태,
        lat:parseFloat(d.위도),lng:parseFloat(d.경도)
      }));
      document.getElementById('voc-total').innerText=App.data.voc.length;
      document.getElementById('voc-done').innerText=App.data.voc.filter(d=>d.status==='처리완료').length;
      document.getElementById('voc-wait').innerText=App.data.voc.filter(d=>d.status==='미접수').length;
      renderTable(App.data.voc);
      updateMap(App.data.voc);
    }
  });
};

window.onload=initMap;
</script>
</body>
</html>
