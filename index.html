<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>KTT í†µí•© ë¦¬í…ì…˜ ëŒ€ì‹œë³´ë“œ (Final Fix)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* 2. ë””ìì¸ ì‹œìŠ¤í…œ (Expert Theme) */
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8; --primary-light: #eff6ff;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --text-main: #0f172a; --text-sub: #64748b; --bg-body: #f8fafc; --bg-card: #ffffff;
            --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        body { margin: 0; display: flex; background: var(--bg-body); font-family: 'Pretendard', -apple-system, sans-serif; color: var(--text-main); height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* ë¡œë”© í™”ë©´ */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 280px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; z-index: 50; transition: width 0.3s; flex-shrink: 0; }
        .sidebar.collapsed { width: 70px; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .sidebar-title { font-size: 18px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px; white-space: nowrap; overflow: hidden; }
        .sidebar-toggle { cursor: pointer; padding: 6px; border-radius: 6px; color: var(--text-sub); transition: 0.2s; }
        .sidebar-toggle:hover { background: var(--bg-body); color: var(--primary); }
        .sidebar.collapsed .sidebar-title span, .sidebar.collapsed .filter-panel { display: none; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .content { flex: 1; padding: 0; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .dashboard-body { padding: 20px 30px 50px 30px; }

        /* ìƒë‹¨ ê³ ì • í—¤ë” */
        .sticky-header { position: sticky; top: 0; z-index: 40; background: rgba(248,250,252,0.95); backdrop-filter: blur(8px); padding: 20px 30px 10px 30px; border-bottom: 1px solid transparent; transition: 0.3s; }
        .content.scrolled .sticky-header { border-bottom-color: var(--border); box-shadow: var(--shadow); }

        /* ë·° ìŠ¤ìœ„ì²˜ */
        .view-switcher { display: flex; background: #e2e8f0; padding: 4px; border-radius: 8px; margin-bottom: 20px; }
        .view-switcher button { flex: 1; padding: 10px; border: none; background: transparent; font-size: 13px; font-weight: 600; color: var(--text-sub); cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .view-switcher button.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* í•„í„° íŒ¨ë„ */
        .filter-group { margin-bottom: 20px; }
        .filter-label { display: block; font-size: 12px; font-weight: 700; color: var(--text-main); margin-bottom: 8px; }
        select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; outline: none; }
        .filter-btns { display: flex; flex-wrap: wrap; gap: 6px; }
        .filter-btn { padding: 6px 12px; font-size: 12px; border: 1px solid var(--border); border-radius: 20px; background: var(--bg-card); color: var(--text-sub); cursor: pointer; transition: 0.2s; white-space: nowrap; }
        .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: 600; }
        .radio-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .radio-group label { margin: 0; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; background: #fff; }
        .radio-group input { margin-right: 6px; }

        /* KPI ì¹´ë“œ */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 10px; }
        .kpi-card { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border-left: 4px solid var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; position: relative; overflow: hidden; }
        .kpi-card h3 { margin: 0 0 5px; font-size: 12px; color: var(--text-sub); font-weight: 600; }
        .kpi-card .value { font-size: 28px; font-weight: 800; color: var(--text-main); }
        .kpi-card .icon { position: absolute; right: 15px; top: 15px; font-size: 24px; opacity: 0.1; }

        /* ì°¨íŠ¸ ì¹´ë“œ */
        .chart-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px; margin-top: 20px; }
        @media (max-width: 1200px) { .chart-grid { grid-template-columns: 1fr; } }
        .card { background: var(--bg-card); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); display: flex; flex-direction: column; transition: 0.3s; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-header h3 { margin: 0; font-size: 16px; font-weight: 700; color: var(--text-main); }
        .toggle-btn { background: none; border: none; cursor: pointer; color: var(--text-sub); font-size: 20px; padding: 4px; border-radius: 4px; }
        .toggle-btn:hover { background: #f1f5f9; color: var(--text-main); }
        .card-body { flex: 1; overflow: hidden; transition: max-height 0.3s ease; }
        .card.collapsed .card-body { max-height: 0; margin: 0; padding: 0; opacity: 0; }
        .chart-wrapper { height: 300px; width: 100%; position: relative; }

        /* í…Œì´ë¸” */
        .table-container { overflow-x: auto; margin-top: 10px; border: 1px solid var(--border); border-radius: 8px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        .data-table th { background: #f8fafc; padding: 12px; font-weight: 600; color: var(--text-sub); border-bottom: 1px solid #e2e8f0; text-align: center; position: sticky; top: 0; z-index: 5; cursor: pointer; }
        .data-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); text-align: center; vertical-align: middle; }
        .data-table tr:hover td { background: #f8fafc; }
        .long-text { text-align: left !important; white-space: normal !important; min-width: 200px; max-width: 400px; line-height: 1.4; }
        
        .list-footer { margin-top: 15px; display: flex; justify-content: space-between; align-items: center; }
        .pagination button { padding: 6px 12px; border: 1px solid var(--border); background: #fff; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: 4px; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-action { padding: 6px 12px; background: var(--success); color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; }

        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge.success { background: #dcfce7; color: #166534; } .badge.fail { background: #fee2e2; color: #991b1b; } .badge.ing { background: #fff7ed; color: #9a3412; }
        .btn-map { color: var(--primary); text-decoration: none; font-weight: 600; font-size: 11px; background: var(--primary-light); padding: 3px 6px; border-radius: 4px; }

        /* ë·° ì „í™˜ */
        .dashboard-view { display: none; opacity: 0; animation: fadeIn 0.4s forwards; }
        .dashboard-view.active { display: block; }
        @keyframes fadeIn { to { opacity: 1; } }
        
        .view-header h2 { margin: 0; font-size: 24px; font-weight: 700; color: var(--text-main); }
        .view-header p { margin: 6px 0 0; color: var(--text-sub); font-size: 14px; }
    </style>
</head>

<body>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-title">
            <i class="ph ph-chart-polar" style="font-size:24px; color:var(--primary);"></i> <span>KTT Dashboard</span>
        </div>
        <div class="sidebar-toggle" onclick="toggleSidebar()"><i class="ph ph-list"></i></div>
    </div>
    <div class="sidebar-content">
        <div class="view-switcher">
            <button id="showVocBtn" class="active" onclick="switchView('voc')">VOC í˜„í™©</button>
            <button id="showPipelineBtn" onclick="switchView('pipeline')">í•´ì§€ ë°©ì–´</button>
        </div>

        <div id="vocFilters" class="filter-panel">
            <div class="filter-group">
                <label class="filter-label">VOC ìœ í˜•</label>
                <select id="vocTypeFilter"></select>
            </div>
            <div class="filter-group">
                <label class="filter-label">ì²˜ë¦¬ ìƒíƒœ</label>
                <div id="vocStatusButtons" class="filter-btns">
                    <button class="filter-btn active" onclick="setVocStatus('ALL', this)">ì „ì²´</button>
                    <button class="filter-btn" onclick="setVocStatus('ì²˜ë¦¬ì™„ë£Œ', this)">ì™„ë£Œ</button>
                    <button class="filter-btn" onclick="setVocStatus('ì ‘ìˆ˜', this)">ì ‘ìˆ˜</button>
                    <button class="filter-btn" onclick="setVocStatus('ë¯¸ì ‘ìˆ˜', this)">ë¯¸ì ‘ìˆ˜</button>
                </div>
            </div>
            <hr style="border:0; border-top:1px dashed #e2e8f0; margin:20px 0;">
            <div class="filter-group"><label class="filter-label">ê´€ë¦¬ ì§€ì‚¬</label><div id="vocBranchButtons" class="filter-btns"></div></div>
            <div class="filter-group"><label class="filter-label">ë‹´ë‹¹ì</label><div id="vocAgentButtons" class="filter-btns"></div></div>
        </div>

        <div id="pipelineFilters" class="filter-panel" style="display:none;">
            <div class="filter-group">
                <label class="filter-label">ì˜ì—… ì±„ë„ (Default: SP)</label>
                <select id="channelFilter">
                    <option value="ALL">ì „ì²´ ì±„ë„</option>
                    <option value="SP" selected>SP</option>
                    <option value="SC">SC</option>
                    <option value="AM">AM</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">í•´ì§€ ìœ„í—˜ë„</label>
                <div class="radio-group">
                    <label><input type="radio" name="risk" value="ALL" checked>ì „ì²´</label>
                    <label><input type="radio" name="risk" value="0">0~25%</label>
                    <label><input type="radio" name="risk" value="25">25~50%</label>
                    <label><input type="radio" name="risk" value="50">50~75%</label>
                    <label><input type="radio" name="risk" value="75">75%~</label>
                </div>
            </div>
            <div class="filter-group">
                <label class="filter-label">ë°ì´í„° ê¸°ì¤€</label>
                <div class="filter-btns">
                    <button class="filter-btn active" onclick="setMode('count', this)">ê±´ìˆ˜</button>
                    <button class="filter-btn" onclick="setMode('amount', this)">ê¸ˆì•¡</button>
                </div>
            </div>
            <hr style="border:0; border-top:1px dashed #e2e8f0; margin:20px 0;">
            <div class="filter-group"><label class="filter-label">ê´€ë¦¬ ë³¸ë¶€</label><div id="pipelineHqButtons" class="filter-btns"></div></div>
            <div class="filter-group"><label class="filter-label">ê´€ë¦¬ ì§€ì‚¬</label><div id="pipelineBranchButtons" class="filter-btns"></div></div>
            <div class="filter-group"><label class="filter-label">ë‹´ë‹¹ì</label><div id="pipelineAgentButtons" class="filter-btns"></div></div>
        </div>
    </div>
</div>

<div class="content" id="mainContent">
    
    <div id="vocView" class="dashboard-view active">
        <div class="sticky-header">
            <div class="view-header">
                <div><h2>ê³ ê°ì˜ ì†Œë¦¬ (VOC) í™œë™ í˜„í™©</h2><p>ì¬ê³„ì•½ ê´€ë ¨ VOC ì ‘ìˆ˜ ë° ì²˜ë¦¬ í˜„í™© ëª¨ë‹ˆí„°ë§</p></div>
            </div>
            <div class="kpi-grid">
                <div class="kpi-card" style="border-left-color:#3b82f6;"><h3>ì´ ì ‘ìˆ˜</h3><div id="kpi-voc-total" class="value">0</div><i class="ph ph-chat-text icon"></i></div>
                <div class="kpi-card" style="border-left-color:#10b981;"><h3>ì²˜ë¦¬ ì™„ë£Œ</h3><div id="kpi-voc-complete" class="value">0</div><i class="ph ph-check-circle icon"></i></div>
                <div class="kpi-card" style="border-left-color:#f59e0b;"><h3>ì²˜ë¦¬ìœ¨</h3><div id="kpi-voc-complete-rate" class="value">0%</div><i class="ph ph-chart-pie-slice icon"></i></div>
                <div class="kpi-card" style="border-left-color:#ef4444;"><h3>ë¯¸ì ‘ìˆ˜</h3><div id="kpi-voc-unassigned" class="value">0</div><i class="ph ph-warning-circle icon"></i></div>
            </div>
        </div>

        <div class="dashboard-body">
            <div class="chart-grid">
                <div class="card">
                    <div class="card-header"><h3>ğŸ“‰ ì¡°ì¹˜ í•„ìš” ë‹´ë‹¹ì (í™œë™ ë…ë ¤)</h3><button class="toggle-btn" onclick="toggleCard(this)"><i class="ph ph-caret-up"></i></button></div>
                    <div class="card-body"><div class="chart-wrapper"><canvas id="vocActivityChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>ğŸ¢ ì§€ì‚¬ë³„ ì²˜ë¦¬ í˜„í™© (ê±´ìˆ˜)</h3><button class="toggle-btn" onclick="toggleCard(this)"><i class="ph ph-caret-up"></i></button></div>
                    <div class="card-body"><div class="chart-wrapper"><canvas id="vocBranchChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>ğŸ‘¨â€ğŸ’¼ ë‹´ë‹¹ìë³„ ì²˜ë¦¬ ì‹¤ì  (Top 20)</h3><button class="toggle-btn" onclick="toggleCard(this)"><i class="ph ph-caret-up"></i></button></div>
                    <div class="card-body"><div class="chart-wrapper"><canvas id="vocAgentChart"></canvas></div></div>
                </div>
            </div>

            <div class="card list-card">
                <div class="card-header">
                    <h3>ìƒì„¸ ë°ì´í„° ë¦¬ìŠ¤íŠ¸</h3>
                    <div style="display:flex; gap:8px;">
                        <button class="toggle-btn" onclick="toggleCard(this)"><i class="ph ph-caret-up"></i></button>
                        <button class="btn-action" onclick="exportToCSV('voc')"><i class="ph ph-download-simple"></i> ì—‘ì…€</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="vocListTable" class="data-table">
                            <thead>
                                <tr>
                                    <th data-field="ê´€ë¦¬ì§€ì‚¬">ì§€ì‚¬</th><th data-field="ë‹´ë‹¹ì">ë‹´ë‹¹ì</th><th data-field="ê³„ì•½ë²ˆí˜¸">ê³„ì•½ë²ˆí˜¸</th>
                                    <th data-field="ìƒí˜¸">ìƒí˜¸ëª…</th><th data-field="ìƒíƒœ">ìƒíƒœ</th><th data-field="VOCìœ í˜•ì†Œ">ì„œë¹„ìŠ¤(ì†Œ)</th>
                                    <th data-field="í•©ì‚°ì›”ì •ë£Œ">í•©ì‚°ì›”ì •ë£Œ</th><th data-field="ì§€ë„">ì§€ë„</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="list-footer">
                        <div id="vocPaginationInfo" style="font-size:12px; color:#64748b;"></div>
                        <div class="pagination"><button onclick="changePage('voc', -1)">ì´ì „</button><button onclick="changePage('voc', 1)">ë‹¤ìŒ</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="pipelineView" class="dashboard-view">
        <div class="sticky-header">
            <div class="view-header">
                <div><h2>í•´ì§€ íŒŒì´í”„ë¼ì¸ ê´€ë¦¬ í˜„í™©</h2><p>ê³ ìœ„í—˜ ê³ ê° ì„ ì œì  ë°©ì–´ í™œë™ ë° ì„±ê³¼ ë¶„ì„</p></div>
            </div>
            <div class="kpi-grid">
                <div class="kpi-card" style="border-left-color:#2563eb;"><h3>ëŒ€ìƒ ê±´ìˆ˜</h3><div id="kpi-pipeline-count" class="value">0</div><i class="ph ph-funnel icon"></i></div>
                <div class="kpi-card" style="border-left-color:#10b981;"><h3>ì›”ì •ë£Œ(ì²œì›)</h3><div id="kpi-pipeline-amount" class="value">0</div><i class="ph ph-currency-krw icon"></i></div>
                <div class="kpi-card" style="border-left-color:#ef4444;"><h3>ê³ ìœ„í—˜(75%â†‘)</h3><div id="kpi-high-risk-count" class="value">0</div><i class="ph ph-siren icon"></i></div>
                <div class="kpi-card" style="border-left-color:#f59e0b;"><h3>ë°©ì–´ ì„±ê³µë¥ </h3><div id="kpi-defense-success-rate" class="value">0%</div><i class="ph ph-shield-check icon"></i></div>
            </div>
        </div>

        <div class="dashboard-body">
            <div class="review-box">
                <h4><i class="ph ph-robot"></i> AI ë¶„ì„ ì¸ì‚¬ì´íŠ¸</h4>
                <p id="ai-pipeline-review">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
            </div>

            <div class="chart-grid">
                <div class="card">
                    <div class="card-header"><h3>ğŸ“Š ì§€ì‚¬ë³„ ë°©ì–´ ë‹¨ê³„</h3><button class="toggle-btn" onclick="toggleCard(this)"><i class="ph ph-caret-up"></i></button></div>
                    <div class="card-body"><div class="chart-wrapper"><canvas id="pipelineBranchStageChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>âš ï¸ ìœ„í—˜ë„ vs ì›”ì •ë£Œ (4ë¶„ë©´)</h3><button class="toggle-btn" onclick="toggleCard(this)"><i class="ph ph-caret-up"></i></button></div>
                    <div class="card-body"><div class="chart-wrapper"><canvas id="pipelineRiskBubbleChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>ğŸ“ˆ ìƒìœ„ ì§€ì‚¬ ë°©ì–´ ì„±ê³µë¥ </h3><button class="toggle-btn" onclick="toggleCard(this)"><i class="ph ph-caret-up"></i></button></div>
                    <div class="card-body"><div class="chart-wrapper"><canvas id="pipelineDefenseSuccessRateChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>ğŸš¨ ë‹´ë‹¹ìë³„ ë°©ì–´ ì‹¤íŒ¨ (Top 10)</h3><button class="toggle-btn" onclick="toggleCard(this)"><i class="ph ph-caret-up"></i></button></div>
                    <div class="card-body"><div class="chart-wrapper"><canvas id="pipelineAgentFailChart"></canvas></div></div>
                </div>
            </div>

            <div class="card list-card">
                <div class="card-header">
                    <h3>ìƒì„¸ íŒŒì´í”„ë¼ì¸ ë¦¬ìŠ¤íŠ¸</h3>
                    <div style="display:flex; gap:8px;">
                        <button class="toggle-btn" onclick="toggleCard(this)"><i class="ph ph-caret-up"></i></button>
                        <button class="btn-action" onclick="exportToCSV('pipeline')"><i class="ph ph-download-simple"></i> ì—‘ì…€</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="pipelineListTable" class="data-table">
                            <thead>
                                <tr>
                                    <th data-field="ê´€ë¦¬ë³¸ë¶€">ë³¸ë¶€</th><th data-field="ê´€ë¦¬ì§€ì‚¬">ì§€ì‚¬</th><th data-field="ë‹´ë‹¹ì">ë‹´ë‹¹ì</th>
                                    <th data-field="ê³„ì•½ë²ˆí˜¸">ê³„ì•½ë²ˆí˜¸</th><th data-field="ìƒí˜¸">ìƒí˜¸ëª…</th><th data-field="ë‹´ë‹¹ì˜ì—…ì±„ë„">ì±„ë„</th>
                                    <th data-field="KTTì›”ì •ë£Œ(ì¡°ì •)">ì›”ì •ë£Œ(ì²œì›)</th><th data-field="ì¬ê³„ì•½ì—¬ë¶€">ì¬ê³„ì•½</th>
                                    <th data-field="ë°©ì–´ì§„í–‰ë‹¨ê³„">ë‹¨ê³„</th><th data-field="ì´ìŠˆìœ í˜•">ì´ìŠˆìœ í˜•</th><th data-field="í•´ì§€ì‚¬ìœ ">í•´ì§€ì‚¬ìœ </th>
                                    <th data-field="í•´ì§€ì˜ˆì •ì¼">í•´ì§€ì˜ˆì •ì¼</th><th data-field="ë“±ë¡ì¼ì">ë“±ë¡ì¼ì</th>
                                    <th data-field="ì§€ì›ìš”ì²­ë‚´ìš©">ì§€ì›ìš”ì²­ë‚´ìš©</th><th data-field="ì„¸ë¶€ë‚´ìš©">ì„¸ë¶€ë‚´ìš©</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="list-footer">
                        <div id="pipelinePaginationInfo" style="font-size:12px; color:#64748b;"></div>
                        <div class="pagination"><button onclick="changePage('pipeline', -1)">ì´ì „</button><button onclick="changePage('pipeline', 1)">ë‹¤ìŒ</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // [1] ë¡œì§ ë° ë°ì´í„° ì²˜ë¦¬
    const state = {
        currentView: 'voc',
        voc: { data: [], filtered: [], page: 1, limit: 15, sortField: 'VOCìœ í˜•ëŒ€', sortDir: 'desc', branch: 'ALL', agent: 'ALL', status: 'ALL' },
        pipeline: { data: [], filtered: [], page: 1, limit: 15, sortField: 'KTTì›”ì •ë£Œ(ì¡°ì •)', sortDir: 'desc', mode: 'count', hq: 'ALL', branch: 'ALL', agent: 'ALL', channel: 'SP', risk: 'ALL' }
    };
    let chartInstances = {};

    // ìœ í‹¸ë¦¬í‹°
    const util = {
        clean: v => String(v||"").trim(),
        branch: v => String(v||"").replace("ì§€ì‚¬","").trim(),
        contract: v => String(v||"").replace(/\D/g,"").slice(0,8),
        num: v => { const n = parseFloat(String(v).replace(/,/g,"")); return isNaN(n)?0:n; },
        thous: v => Math.round(util.num(v)/1000),
        fmt: v => v.toLocaleString(),
        date: v => {
            if(!v) return "-";
            if(String(v).match(/^\d{4}-\d{2}-\d{2}$/)) return v; // ì´ë¯¸ ë‚ ì§œ í˜•ì‹ì´ë©´ ë¦¬í„´
            const sn = parseFloat(String(v).replace(/,/g,''));
            if(!isNaN(sn) && sn > 10000 && sn < 60000) {
                const d = new Date((sn - 25569) * 86400 * 1000);
                return d.toISOString().slice(0,10);
            }
            return v;
        },
        sortBr: (a,b) => {
            const o = ["ì¤‘ì•™","ê°•ë¶","ì„œëŒ€ë¬¸","ê³ ì–‘","ì˜ì •ë¶€","ë‚¨ì–‘ì£¼","ê°•ë¦‰","ì›ì£¼"];
            const ia=o.indexOf(a), ib=o.indexOf(b);
            if(ia<0 && ib<0) return a.localeCompare(b);
            if(ia<0) return 1; if(ib<0) return -1; return ia-ib;
        }
    };

    // ìƒ˜í”Œ ë°ì´í„° ìƒì„± (ì•ˆì „ ëª¨ë“œ)
    function generateSampleVoc() {
        const brs = ["ì¤‘ì•™", "ê°•ë¶", "ì„œëŒ€ë¬¸", "ê³ ì–‘", "ì˜ì •ë¶€", "ë‚¨ì–‘ì£¼", "ê°•ë¦‰", "ì›ì£¼"];
        const ags = ["ê¹€ì² ìˆ˜", "ì´ì˜í¬", "ë°•ë¯¼ìˆ˜", "ìµœì§€ìš°", "ì •ìˆ˜ì§„", "í™ê¸¸ë™"];
        const sts = ["ì²˜ë¦¬ì™„ë£Œ", "ì ‘ìˆ˜", "ë¯¸ì ‘ìˆ˜"];
        const typs = ["ì„œë¹„ìŠ¤ë¬¸ì˜", "ìš”ê¸ˆë¬¸ì˜", "í’ˆì§ˆë¶ˆë§Œ", "í•´ì§€ë°©ì–´"];
        return Array.from({length: 200}, (_, i) => ({
            "ê´€ë¦¬ì§€ì‚¬": brs[Math.floor(Math.random()*brs.length)]+"ì§€ì‚¬",
            "ë‹´ë‹¹ì": ags[Math.floor(Math.random()*ags.length)],
            "ê³„ì•½ë²ˆí˜¸": "1000"+(1000+i),
            "ìƒí˜¸": "í…ŒìŠ¤íŠ¸ìƒí˜¸"+i,
            "ìƒíƒœ": sts[Math.floor(Math.random()*sts.length)],
            "VOCìœ í˜•ëŒ€": typs[Math.floor(Math.random()*typs.length)],
            "VOCìœ í˜•ì†Œ": "ìƒì„¸ ë¬¸ì˜ ë‚´ìš©ì…ë‹ˆë‹¤.",
            "í•©ì‚°ì›”ì •ë£Œ": Math.floor(Math.random()*500000)+30000,
            "ì§€ë„ë§í¬": Math.random()>0.5 ? "https://map.kakao.com" : ""
        }));
    }
    function generateSamplePipeline() {
        const brs = ["ì¤‘ì•™", "ê°•ë¶", "ì„œëŒ€ë¬¸", "ê³ ì–‘", "ì˜ì •ë¶€", "ë‚¨ì–‘ì£¼", "ê°•ë¦‰", "ì›ì£¼"];
        const ags = ["ê¹€ì² ìˆ˜", "ì´ì˜í¬", "ë°•ë¯¼ìˆ˜", "ìµœì§€ìš°", "ì •ìˆ˜ì§„", "í™ê¸¸ë™"];
        const stgs = ["ë°©ì–´ì„±ê³µ", "ë°©ì–´ì‹¤íŒ¨", "ì§„í–‰ì¤‘"];
        const chs = ["SP", "SC", "AM"];
        return Array.from({length: 200}, (_, i) => ({
            "ê´€ë¦¬ë³¸ë¶€": "ê°•ë¶/ê°•ì›",
            "ê´€ë¦¬ì§€ì‚¬": brs[Math.floor(Math.random()*brs.length)]+"ì§€ì‚¬",
            "ë‹´ë‹¹ì": ags[Math.floor(Math.random()*ags.length)],
            "ê³„ì•½ë²ˆí˜¸": "2000"+(1000+i),
            "ìƒí˜¸": "íŒŒì´í”„ë¼ì¸ìƒí˜¸"+i,
            "ë‹´ë‹¹ì˜ì—…ì±„ë„": chs[Math.floor(Math.random()*chs.length)],
            "KTTì›”ì •ë£Œ(ì¡°ì •)": Math.floor(Math.random()*1000000)+50000,
            "í•´ì§€ìœ„í—˜ë„": Math.floor(Math.random()*100),
            "ë°©ì–´ì§„í–‰ë‹¨ê³„": stgs[Math.floor(Math.random()*stgs.length)],
            "ì¬ê³„ì•½ì—¬ë¶€": Math.random()>0.5?"Y":"N",
            "ì´ìŠˆìœ í˜•": "ê°€ê²©ê²½ìŸ", "í•´ì§€ì‚¬ìœ ": "íƒ€ì‚¬ì œì•ˆ", "í•´ì§€ì˜ˆì •ì¼": "45993", "ë“±ë¡ì¼ì": "45993",
            "ì§€ì›ìš”ì²­ë‚´ìš©": "ìš”ê¸ˆ í• ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "ì„¸ë¶€ë‚´ìš©": "ê³ ê° ê°•ë ¥ í•´ì§€ ìš”ì²­ ì¤‘, íŒ€ì¥ë‹˜ ì§€ì› ë°”ëŒ."
        }));
    }

    // ì´ˆê¸°í™” í•¨ìˆ˜
    window.addEventListener("load", () => {
        // í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬
        if (typeof Chart === 'undefined' || typeof Papa === 'undefined') {
            alert("ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            return;
        }

        // ì°¨íŠ¸ ê¸€ë¡œë²Œ ì„¤ì •
        Chart.register(ChartDataLabels);
        Chart.defaults.font.family = "'Pretendard', sans-serif";
        Chart.defaults.color = "#64748b";

        // ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ (ì¦‰ì‹œ ì‹¤í–‰ ë³´ì¥)
        state.voc.data = generateSampleVoc();
        state.pipeline.data = generateSamplePipeline();
        
        // ê¸°ë³¸ê°’ ì„¤ì •
        const hqs = [...new Set(state.pipeline.data.map(r=>util.clean(r["ê´€ë¦¬ë³¸ë¶€"]))).filter(Boolean)];
        state.pipeline.hq = hqs.includes('ê°•ë¶/ê°•ì›') ? 'ê°•ë¶/ê°•ì›' : 'ALL';
        document.getElementById("channelFilter").value = "SP";

        initUI();
        
        // ë¡œë”© ì œê±°
        setTimeout(() => document.getElementById("loadingOverlay").style.opacity = 0, 500);
        setTimeout(() => document.getElementById("loadingOverlay").style.display = "none", 1000);

        // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸
        document.getElementById("mainContent").addEventListener('scroll', (e) => {
            const h = document.querySelector('.dashboard-view.active .sticky-header');
            if(h) h.style.borderBottomColor = e.target.scrollTop > 5 ? 'var(--border)' : 'transparent';
        });
    });

    function initUI() {
        // VOC UI ì´ˆê¸°í™”
        const vt = [...new Set(state.voc.data.map(r=>util.clean(r["VOCìœ í˜•ëŒ€"]))).filter(Boolean)].sort();
        const vs = document.getElementById("vocTypeFilter");
        vs.innerHTML = '<option value="ALL">ì „ì²´ ìœ í˜•</option>' + vt.map(t=>`<option value="${t}">${t}</option>`).join('');
        vs.addEventListener('change', runVoc);

        renderBtns('voc','branch'); renderBtns('voc','agent');
        
        // Pipeline UI ì´ˆê¸°í™”
        renderBtns('pipeline','hq'); renderBtns('pipeline','branch'); renderBtns('pipeline','agent');
        document.getElementById("channelFilter").addEventListener("change", (e)=>{ state.pipeline.channel=e.target.value; runPipe(); });
        document.querySelectorAll('input[name="risk"]').forEach(e=>e.addEventListener("change", ()=>runPipe()));
        
        setupTableSort('voc'); setupTableSort('pipeline');
        runVoc(); runPipe();
        switchView('voc'); 
    }

    // UI ë Œë”ë§ í•¨ìˆ˜ë“¤
    function renderBtns(view, type) {
        const c = document.getElementById(`${view}${type.charAt(0).toUpperCase()+type.slice(1)}Buttons`);
        let d = state[view].data;
        const s = state[view];

        // ì¢…ì†ì„± í•„í„°
        if(view==='voc') {
            if(type==='agent' && s.branch!=='ALL') d = d.filter(r=>util.branch(r["ê´€ë¦¬ì§€ì‚¬"])===s.branch);
        } else {
            if(type!=='hq' && s.hq!=='ALL') d = d.filter(r=>util.clean(r["ê´€ë¦¬ë³¸ë¶€"])===s.hq);
            if(type==='agent' && s.branch!=='ALL') d = d.filter(r=>util.branch(r["ê´€ë¦¬ì§€ì‚¬"])===s.branch);
        }

        let items = [];
        if(type==='hq') items = [...new Set(d.map(r=>util.clean(r["ê´€ë¦¬ë³¸ë¶€"])).filter(Boolean))].sort();
        else if(type==='branch') items = [...new Set(d.map(r=>util.branch(r["ê´€ë¦¬ì§€ì‚¬"])).filter(Boolean))].sort(util.sortBr);
        else items = [...new Set(d.map(r=>util.clean(r["ë‹´ë‹¹ì"])).filter(Boolean))].sort();

        c.innerHTML = `<button class="filter-btn ${s[type]==='ALL'?'active':''}" onclick="setFilter('${view}','${type}','ALL')">ì „ì²´</button>` +
            items.map(i=>`<button class="filter-btn ${s[type]===i?'active':''}" onclick="setFilter('${view}','${type}','${i.replace(/'/g,"\\'")}')">${i}</button>`).join('');
    }

    // ì¸í„°ë™ì…˜ í•¸ë“¤ëŸ¬
    window.toggleSidebar = () => document.getElementById("sidebar").classList.toggle("collapsed");
    window.toggleCard = (btn) => {
        const card = btn.closest('.card');
        card.classList.toggle('collapsed');
        const i = btn.querySelector('i');
        i.classList.toggle('ph-caret-up'); i.classList.toggle('ph-caret-down');
    };
    
    window.switchView = (v) => {
        state.currentView = v;
        document.querySelectorAll('.view-switcher button').forEach(b=>b.classList.remove('active'));
        document.getElementById(v==='voc'?'showVocBtn':'showPipelineBtn').classList.add('active');
        document.querySelectorAll('.dashboard-view').forEach(e=>e.classList.remove('active'));
        document.getElementById(v+'View').classList.add('active');
        document.getElementById('pipelineFilters').style.display = v==='pipeline'?'block':'none';
        document.getElementById('vocFilters').style.display = v==='voc'?'block':'none';
        setTimeout(()=>Object.values(chartInstances).forEach(c=>c&&c.resize()), 100);
    };

    window.setFilter = (v,t,val) => {
        state[v][t] = val;
        if(v==='pipeline' && t==='hq') { state[v].branch='ALL'; state[v].agent='ALL'; renderBtns(v,'branch'); renderBtns(v,'agent'); }
        if(t==='branch') { state[v].agent='ALL'; renderBtns(v,'agent'); }
        renderBtns(v,t); 
        v==='voc' ? runVoc() : runPipe();
    };

    window.setVocStatus = (val, btn) => {
        state.voc.status = val;
        btn.parentNode.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        runVoc();
    };
    window.setRisk = (val, btn) => {
        state.pipeline.risk = val;
        btn.parentNode.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        runPipe();
    };
    window.setMode = (val, btn) => {
        state.pipeline.mode = val;
        btn.parentNode.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        runPipe();
    };

    // ë¡œì§ ì‹¤í–‰
    function runVoc() {
        const s = state.voc;
        const type = document.getElementById("vocTypeFilter").value;
        s.filtered = s.data.filter(r => {
            if(type!=='ALL' && util.clean(r["VOCìœ í˜•ëŒ€"])!==type) return false;
            if(s.status!=='ALL' && util.clean(r["ìƒíƒœ"])!==s.status) return false;
            if(s.branch!=='ALL' && util.branch(r["ê´€ë¦¬ì§€ì‚¬"])!==s.branch) return false;
            if(s.agent!=='ALL' && util.clean(r["ë‹´ë‹¹ì"])!==s.agent) return false;
            return true;
        });
        s.page = 1;
        updateVocKPIs(); drawVocCharts(); renderTable('voc');
    }

    function runPipe() {
        const s = state.pipeline;
        const rValStr = document.querySelector('input[name="risk"]:checked').value;
        s.risk = rValStr;

        s.filtered = s.data.filter(r => {
            if(s.channel!=='ALL' && r["ë‹´ë‹¹ì˜ì—…ì±„ë„"]!==s.channel) return false;
            const rVal = parseFloat(r["í•´ì§€ìœ„í—˜ë„"])||0;
            if(s.risk!=='ALL') {
                const rv = parseInt(s.risk);
                if(rv===75 && rVal<75) return false;
                if(rv!==75 && (rVal<rv || rVal>=rv+25)) return false;
            }
            if(s.hq!=='ALL' && util.clean(r["ê´€ë¦¬ë³¸ë¶€"])!==s.hq) return false;
            if(s.branch!=='ALL' && util.branch(r["ê´€ë¦¬ì§€ì‚¬"])!==s.branch) return false;
            if(s.agent!=='ALL' && util.clean(r["ë‹´ë‹¹ì"])!==s.agent) return false;
            return true;
        });
        s.page = 1;
        updatePipeKPIs(); drawPipeCharts(); renderTable('pipeline');
    }

    // ì‹œê°í™” (VOC)
    function updateVocKPIs() {
        const d = state.voc.filtered;
        const comp = d.filter(r=>util.clean(r["ìƒíƒœ"])==='ì²˜ë¦¬ì™„ë£Œ').length;
        document.getElementById("kpi-voc-total").innerText = util.fmt(d.length);
        document.getElementById("kpi-voc-complete").innerText = util.fmt(comp);
        document.getElementById("kpi-voc-complete-rate").innerText = d.length ? (comp/d.length*100).toFixed(1)+'%' : '0%';
        document.getElementById("kpi-voc-unassigned").innerText = util.fmt(d.filter(r=>util.clean(r["ìƒíƒœ"])==='ë¯¸ì ‘ìˆ˜').length);
    }

    function drawVocCharts() {
        const d = state.voc.filtered;
        const createGradient = (ctx, c1, c2) => { const g = ctx.createLinearGradient(0, 0, 0, 300); g.addColorStop(0, c1); g.addColorStop(1, c2); return g; };
        
        // Activity
        const act={};
        d.forEach(r=>{
            const a = util.clean(r["ë‹´ë‹¹ì"]); if(!a)return;
            const s = util.clean(r["ìƒíƒœ"]);
            if(s==='ë¯¸ì ‘ìˆ˜'||s==='ì ‘ìˆ˜') {
                if(!act[a]) act[a]={yet:0, rcpt:0, sum:0};
                if(s==='ë¯¸ì ‘ìˆ˜') act[a].yet++; else act[a].rcpt++;
                act[a].sum++;
            }
        });
        const sAct = Object.entries(act).sort((a,b)=>b[1].sum-a[1].sum).slice(0,10);
        newChart('vocActivityChart', { type:'bar', data:{
            labels: sAct.map(e=>e[0]),
            datasets:[
                {label:'ë¯¸ì ‘ìˆ˜', data:sAct.map(e=>e[1].yet), backgroundColor:'#ef4444', borderRadius:4},
                {label:'ì ‘ìˆ˜', data:sAct.map(e=>e[1].rcpt), backgroundColor:'#f59e0b', borderRadius:4}
            ]
        }, options:{ indexAxis:'y', plugins:{datalabels:{display:c=>c.dataset.data[c.dataIndex]>0, color:'#fff', font:{weight:'bold'}}}, scales:{x:{stacked:true, display:false}, y:{stacked:true, grid:{display:false}}} }});

        // Branch
        const br={};
        d.forEach(r=>{
            const b = util.branch(r["ê´€ë¦¬ì§€ì‚¬"]); if(!b)return;
            if(!br[b]) br[b]={done:0,rcpt:0,yet:0};
            const s=util.clean(r["ìƒíƒœ"]);
            if(s==='ì²˜ë¦¬ì™„ë£Œ') br[b].done++; else if(s==='ì ‘ìˆ˜') br[b].rcpt++; else br[b].yet++;
        });
        const lBr = Object.keys(br).sort(util.sortBr);
        const ctxB = document.getElementById("vocBranchChart").getContext("2d");
        newChart('vocBranchChart', { type:'bar', data:{
            labels:lBr,
            datasets:[
                {label:'ì™„ë£Œ', data:lBr.map(k=>br[k].done), backgroundColor:createGradient(ctxB,'#60a5fa','#3b82f6'), borderRadius:4, stack:'1'},
                {label:'ì ‘ìˆ˜', data:lBr.map(k=>br[k].rcpt), backgroundColor:'#fbbf24', borderRadius:4, stack:'1'},
                {label:'ë¯¸ì ‘ìˆ˜', data:lBr.map(k=>br[k].yet), backgroundColor:'#f87171', borderRadius:4, stack:'1'}
            ]
        }, options:{ scales:{x:{stacked:true},y:{stacked:true}}, plugins:{datalabels:{display:false}} }});

        // Agent
        const ag={};
        d.forEach(r=>{ const a=util.clean(r["ë‹´ë‹¹ì"]); if(a && util.clean(r["ìƒíƒœ"])==='ì²˜ë¦¬ì™„ë£Œ') ag[a]=(ag[a]||0)+1; });
        const sAg = Object.entries(ag).sort((a,b)=>b[1]-a[1]).slice(0,20);
        const ctxA = document.getElementById("vocAgentChart").getContext("2d");
        newChart('vocAgentChart', { type:'bar', data:{
            labels:sAg.map(e=>e[0]),
            datasets:[{label:'ì²˜ë¦¬ì™„ë£Œ', data:sAg.map(e=>e[1]), backgroundColor:createGradient(ctxA,'#60a5fa','#2563eb'), borderRadius:4}]
        }, options:{ indexAxis:'y', plugins:{legend:{display:false}} }});
    }

    // ì‹œê°í™” (Pipeline)
    function updatePipeKPIs() {
        const d = state.pipeline.filtered;
        const amt = d.reduce((s,r)=>s+util.thous(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]),0);
        const suc = d.filter(r=>r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]==='ë°©ì–´ì„±ê³µ').length;
        const tot = d.filter(r=>['ë°©ì–´ì„±ê³µ','ë°©ì–´ì‹¤íŒ¨','ì§„í–‰ì¤‘'].includes(r["ë°©ì–´ì§„í–‰ë‹¨ê³„"])).length;
        const high = d.filter(r=>parseFloat(r["í•´ì§€ìœ„í—˜ë„"])>=75).length;
        
        document.getElementById("kpi-pipeline-count").innerText = util.fmt(d.length);
        document.getElementById("kpi-pipeline-amount").innerText = util.fmt(amt);
        document.getElementById("kpi-high-risk-count").innerText = util.fmt(high);
        document.getElementById("kpi-defense-success-rate").innerText = tot ? (suc/tot*100).toFixed(1)+'%' : '0%';

        const fail = d.filter(r=>r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]==='ë°©ì–´ì‹¤íŒ¨');
        const el = document.getElementById("ai-pipeline-review");
        if(fail.length===0) { el.innerHTML = "ğŸ‰ ì¡°íšŒëœ ê¸°ê°„ ë° ì¡°ê±´ì—ì„œ <b>ë°©ì–´ ì‹¤íŒ¨ ê±´ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</b>"; return; }
        
        const brCnt={}; const agCnt={};
        fail.forEach(r=>{ 
            const b=util.branch(r["ê´€ë¦¬ì§€ì‚¬"]); brCnt[b]=(brCnt[b]||0)+1;
            const a=util.clean(r["ë‹´ë‹¹ì"]); agCnt[a]=(agCnt[a]||0)+1;
        });
        const topBr = Object.entries(brCnt).sort((a,b)=>b[1]-a[1])[0]||['-',0];
        const topAg = Object.entries(agCnt).sort((a,b)=>b[1]-a[1])[0]||['-',0];
        el.innerHTML = `ì´ <b>${fail.length}ê±´</b> ë°©ì–´ ì‹¤íŒ¨. <span style="color:#ef4444; font-weight:700;">${topBr[0]}ì§€ì‚¬</span>(${topBr[1]}ê±´), <span style="color:#ef4444; font-weight:700;">${topAg[0]} ë‹´ë‹¹ì</span>(${topAg[1]}ê±´) ì§‘ì¤‘ ê´€ë¦¬ í•„ìš”.`;
    }

    function drawPipeCharts() {
        const d = state.pipeline.filtered;
        const m = state.pipeline.mode;
        
        // Branch Stage
        const br={};
        d.forEach(r=>{
            const b = util.branch(r["ê´€ë¦¬ì§€ì‚¬"]); if(!b) return;
            if(!br[b]) br[b]={suc:0, fail:0, ing:0, tot:0};
            const v = m==='amount'?util.thous(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]):1;
            const st = r["ë°©ì–´ì§„í–‰ë‹¨ê³„"];
            if(st==='ë°©ì–´ì„±ê³µ') br[b].suc+=v; else if(st==='ë°©ì–´ì‹¤íŒ¨') br[b].fail+=v; else if(st==='ì§„í–‰ì¤‘') br[b].ing+=v;
            if(['ë°©ì–´ì„±ê³µ','ë°©ì–´ì‹¤íŒ¨','ì§„í–‰ì¤‘'].includes(st)) br[b].tot+=v;
        });
        const sBr = Object.entries(br).filter(e=>e[1].tot>0).sort((a,b)=>b[1].tot-a[1].tot).slice(0,10);
        newChart('pipelineBranchStageChart', { type:'bar', data:{
            labels: sBr.map(e=>e[0]),
            datasets:[
                {label:'ì„±ê³µ', data:sBr.map(e=>e[1].suc), backgroundColor:'#34d399', borderRadius:4, stack:'1'},
                {label:'ì§„í–‰', data:sBr.map(e=>e[1].ing), backgroundColor:'#fbbf24', borderRadius:4, stack:'1'},
                {label:'ì‹¤íŒ¨', data:sBr.map(e=>e[1].fail), backgroundColor:'#f87171', borderRadius:4, stack:'1'}
            ]
        }, options:{ scales:{x:{stacked:true}, y:{stacked:true}}, plugins:{datalabels:{display:false}} }});

        // Bubble
        const bub = Object.entries(br).map(([b,v])=>{
            const sub = d.filter(r=>util.branch(r["ê´€ë¦¬ì§€ì‚¬"])===b);
            const rAvg = sub.reduce((s,r)=>s+(parseFloat(r["í•´ì§€ìœ„í—˜ë„"])||0),0)/sub.length;
            const aAvg = sub.reduce((s,r)=>s+util.thous(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]),0);
            return { label:b, data:[{x:rAvg, y:aAvg/sub.length, r:Math.sqrt(aAvg)*0.5}], backgroundColor:'rgba(59,130,246,0.6)', borderColor:'#2563eb' };
        }).filter(b=>b.data[0].r>0);
        
        newChart('pipelineRiskBubbleChart', { type:'bubble', data: { datasets: bub }, 
            options: {
                plugins: { 
                    legend:{display:false}, 
                    tooltip:{callbacks:{label:c=>`${c.dataset.label}: ìœ„í—˜ ${c.raw.x.toFixed(1)}% / ${Math.round(c.raw.y)}ì²œì›`}},
                    datalabels: { formatter: (v,c)=>c.dataset.label, align:'top', offset:-2, font:{weight:'bold', size:10}, color:'#1e40af' }
                },
                scales: { x:{title:{display:true, text:'í‰ê·  ìœ„í—˜ë„ (%)'}, min:0, max:100}, y:{title:{display:true, text:'í‰ê·  ì›”ì •ë£Œ (ì²œì›)'}} }
            },
            plugins: [{
                id: 'quadrant', beforeDraw: (chart) => {
                    const {ctx, chartArea:{left,top,right,bottom}, scales:{x,y}} = chart;
                    const midX=x.getPixelForValue(50), midY=y.getPixelForValue((y.max+y.min)/2);
                    ctx.save(); ctx.strokeStyle='#cbd5e1'; ctx.setLineDash([5,5]);
                    ctx.beginPath(); ctx.moveTo(midX,top); ctx.lineTo(midX,bottom); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(left,midY); ctx.lineTo(right,midY); ctx.stroke();
                    ctx.fillStyle='rgba(239,68,68,0.03)'; ctx.fillRect(midX,top,right-midX,midY-top); 
                    ctx.restore();
                }
            }]
        });

        // Success Rate
        const rates = sBr.map(e=>({b:e[0], r:e[1].tot?e[1].suc/e[1].tot*100:0})).sort((a,b)=>b.r-a.r).slice(0,5);
        const ctxL = document.getElementById("pipelineDefenseSuccessRateChart").getContext("2d");
        const gradL = ctxL.createLinearGradient(0,0,0,300);
        gradL.addColorStop(0, 'rgba(16,185,129,0.3)'); gradL.addColorStop(1, 'rgba(16,185,129,0.0)');
        newChart('pipelineDefenseSuccessRateChart', { type:'line', data:{
            labels: rates.map(e=>e.b),
            datasets: [{label:'ì„±ê³µë¥ ', data:rates.map(e=>e.r), borderColor:'#10b981', backgroundColor:gradL, fill:true, tension:0.4}]
        }, options:{ scales:{y:{min:0, max:100}}, plugins:{legend:{display:false}} }});

        // Fail (Top 10)
        const af={};
        d.filter(r=>r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]==='ë°©ì–´ì‹¤íŒ¨').forEach(r=>{ const a=util.clean(r["ë‹´ë‹¹ì"]); af[a]=(af[a]||0)+1; });
        const sAf = Object.entries(af).sort((a,b)=>b[1]-a[1]).slice(0,10);
        newChart('pipelineAgentFailChart', { type:'bar', data: {
            labels: sAf.map(e=>e[0]),
            datasets: [{label:'ì‹¤íŒ¨', data:sAf.map(e=>e[1]), backgroundColor:'#ef4444', borderRadius:4}]
        }, options:{ indexAxis:'y', scales:{x:{grid:{display:false}}}, plugins:{legend:{display:false}} }});
    }

    function newChart(id, conf) {
        if(chartInstances[id]) chartInstances[id].destroy();
        conf.options = { ...conf.options, maintainAspectRatio:false, responsive:true };
        chartInstances[id] = new Chart(document.getElementById(id), conf);
    }

    // í…Œì´ë¸” ë Œë”ë§
    function setupTableSort(type) {
        document.querySelectorAll(`#${type}ListTable th[data-field]`).forEach(th => {
            th.addEventListener('click', () => {
                const f = th.dataset.field;
                const s = state[type];
                if(s.sortField === f) s.sortDir = s.sortDir==='asc'?'desc':'asc';
                else { s.sortField = f; s.sortDir = 'desc'; }
                document.querySelectorAll(`#${type}ListTable th`).forEach(h => h.innerText = h.innerText.replace(/ [â–²â–¼]/g, ''));
                th.innerText += s.sortDir==='asc' ? ' â–²' : ' â–¼';
                renderTable(type);
            });
        });
    }

    function renderTable(t) {
        const s = state[t];
        const tb = document.querySelector(`#${t}ListTable tbody`);
        tb.innerHTML = "";
        
        const sorted = [...s.filtered].sort((a,b)=>{
            let va=a[s.sortField], vb=b[s.sortField];
            if(s.sortField.includes('ì›”ì •ë£Œ')||s.sortField.includes('ìœ„í—˜ë„')) { va=parseFloat(String(va).replace(/,/g,''))||0; vb=parseFloat(String(vb).replace(/,/g,''))||0; }
            if(va<vb) return s.sortDir==='asc'?-1:1; if(va>vb) return s.sortDir==='asc'?1:-1; return 0;
        });

        const start = (s.page-1)*s.limit;
        const pageData = sorted.slice(start, start+s.limit);
        const total = Math.ceil(sorted.length/s.limit);

        const btns = document.querySelectorAll(`#${t}View .pagination button`);
        btns[0].disabled = s.page <= 1;
        btns[1].disabled = s.page >= total;
        
        document.getElementById(`${t}PaginationInfo`).innerText = `ì´ ${util.fmt(sorted.length)}ê±´ ì¤‘ ${start+1} - ${Math.min(start+s.limit, sorted.length)}`;

        pageData.forEach(r => {
            const tr = document.createElement("tr");
            if (t === 'pipeline') {
                const st = util.clean(r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]);
                let badge = st==='ë°©ì–´ì„±ê³µ'?'success':(st==='ë°©ì–´ì‹¤íŒ¨'?'fail':'ing');
                tr.innerHTML = `<td>${util.clean(r["ê´€ë¦¬ë³¸ë¶€"])}</td><td>${util.branch(r["ê´€ë¦¬ì§€ì‚¬"])}</td><td>${util.clean(r["ë‹´ë‹¹ì"])}</td><td>${util.contract(r["ê³„ì•½ë²ˆí˜¸"])}</td><td>${util.clean(r["ìƒí˜¸"])||'-'}</td><td>${util.clean(r["ë‹´ë‹¹ì˜ì—…ì±„ë„"])}</td><td>${util.fmt(util.thous(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]))}</td><td>${util.clean(r["ì¬ê³„ì•½ì—¬ë¶€"])||'-'}</td><td><span class="badge ${badge}">${st}</span></td><td>${util.clean(r["ì´ìŠˆìœ í˜•"])||'-'}</td><td>${util.clean(r["í•´ì§€ì‚¬ìœ "])||'-'}</td><td>${util.date(r["í•´ì§€ì˜ˆì •ì¼"])}</td><td>${util.date(r["ë“±ë¡ì¼ì"])}</td><td class="long-text">${util.clean(r["ì§€ì›ìš”ì²­ë‚´ìš©"])||'-'}</td><td class="long-text">${util.clean(r["ì„¸ë¶€ë‚´ìš©"])||'-'}</td>`;
            } else {
                const st = util.clean(r["ìƒíƒœ"]);
                let badge = st==='ì²˜ë¦¬ì™„ë£Œ'?'voc-done':(st==='ì ‘ìˆ˜'?'voc-receipt':'voc-yet');
                const map = r["ì§€ë„ë§í¬"] ? `<a href="${r["ì§€ë„ë§í¬"]}" target="_blank" class="btn-map"><i class="ph ph-map-pin"></i> ì§€ë„</a>` : '-';
                tr.innerHTML = `<td>${util.branch(r["ê´€ë¦¬ì§€ì‚¬"])}</td><td>${util.clean(r["ë‹´ë‹¹ì"])}</td><td>${util.contract(r["ê³„ì•½ë²ˆí˜¸"])}</td><td>${util.clean(r["ìƒí˜¸"])||'-'}</td><td><span class="badge ${badge}">${st}</span></td><td>${util.clean(r["VOCìœ í˜•ì†Œ"])||'-'}</td><td>${r["í•©ì‚°ì›”ì •ë£Œ"]?util.fmt(util.thous(r["í•©ì‚°ì›”ì •ë£Œ"])):'-'}</td><td>${map}</td>`;
            }
            tb.appendChild(tr);
        });
    }

    window.changePage = (t, d) => { state[t].page += d; renderTable(t); };
    window.exportToCSV = (t) => {
        const d = state[t].filtered; if(!d.length) return alert("ë°ì´í„° ì—†ìŒ");
        const blob = new Blob(["\uFEFF"+Papa.unparse(d)], {type:'text/csv;charset=utf-8;'});
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `ktt_${t}_${new Date().toISOString().slice(0,10)}.csv`; link.click();
    };
</script>
</body>
</html>
