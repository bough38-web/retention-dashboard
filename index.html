<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>KTT í†µí•© ëŒ€ì‹œë³´ë“œ (VOC + í•´ì§€íŒŒì´í”„ë¼ì¸)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse (CSV íŒŒì„œ) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Kakao ì§€ë„ SDK (ê¶Œí•œ ì—†ìœ¼ë©´ initMapSafeì—ì„œ ê·¸ëƒ¥ ë„˜ì–´ê°) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=198152a8a99d3e64203e26f2871068d0"></script>

  <style>
    body {
      margin: 0;
      display: flex;
      background: #f5f5f7;
      font-family: "Segoe UI", "Apple SD Gothic Neo", sans-serif;
    }

    /* ì¢Œì¸¡ í•„í„° íŒ¨ë„ */
    .sidebar {
      width: 260px;
      background: #ffffff;
      padding: 20px;
      border-right: 1px solid #ddd;
      height: 100vh;
      overflow-y: auto;
    }

    .sidebar h2 {
      font-size: 18px;
      margin-bottom: 10px;
      border-bottom: 2px solid #eee;
      padding-bottom: 6px;
    }

    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .chart-box {
      background: #fff;
      padding: 15px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }

    #map {
      width: 100%;
      height: 420px;
      border-radius: 12px;
    }

    button, select {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fafafa;
      font-size: 14px;
      cursor: pointer;
    }

    label {
      display: block;
      padding: 5px 0;
      font-size: 13px;
    }

    h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }

    /* ë²„íŠ¼ì‹ í•„í„°ìš© */
    .filter-group {
      margin-top: 14px;
      margin-bottom: 6px;
    }

    .filter-group-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .filter-btn {
      flex: 0 0 auto;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fafafa;
      font-size: 12px;
      cursor: pointer;
      width: auto;
    }

    .filter-btn.active {
      background: #2563eb;
      color: #fff;
      border-color: #1d4ed8;
    }
  </style>
</head>

<body>

<div class="sidebar">
  <h2>ğŸ“Œ í•„í„°</h2>

  <label>ë‹´ë‹¹ì˜ì—…ì±„ë„</label>
  <select id="channelFilter">
      <option value="ALL">ì „ì²´</option>
      <option value="SP">SP</option>
      <option value="SC">SC</option>
      <option value="AM">AM</option>
  </select>

  <label>í•´ì§€ìœ„í—˜ë„ (%)</label>
  <label><input type="radio" name="risk" value="ALL" checked> ì „ì²´</label>
  <label><input type="radio" name="risk" value="0"> 0 ~ 25%</label>
  <label><input type="radio" name="risk" value="25"> 25 ~ 50%</label>
  <label><input type="radio" name="risk" value="50"> 50 ~ 75%</label>
  <label><input type="radio" name="risk" value="75"> 75 ~ 100%</label>

  <label>í‘œì‹œ ê¸°ì¤€ (í•´ì§€íŒŒì´í”„ë¼ì¸)</label>
  <button onclick="setMode('count')">ê±´ìˆ˜</button>
  <button onclick="setMode('amount')">ê¸ˆì•¡(ì²œì›)</button>

  <!-- ê´€ë¦¬ë³¸ë¶€ / ê´€ë¦¬ì§€ì‚¬ ë²„íŠ¼ì‹ í•„í„° -->
  <div class="filter-group">
    <div class="filter-group-title">ê´€ë¦¬ë³¸ë¶€</div>
    <div id="hqButtons" class="filter-buttons">
      <!-- JSì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„± -->
    </div>
  </div>

  <div class="filter-group">
    <div class="filter-group-title">ê´€ë¦¬ì§€ì‚¬</div>
    <div id="branchButtons" class="filter-buttons">
      <!-- JSì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„± -->
    </div>
  </div>
</div>

<div class="content">

  <div class="chart-box">
      <h3>ğŸ“ VOC ì„¤ì¹˜ ì£¼ì†Œ ì§€ë„</h3>
      <div id="map"></div>
  </div>

  <div class="chart-box">
      <h3>ğŸ“Š ê´€ë¦¬ë³¸ë¶€ / ê´€ë¦¬ì§€ì‚¬ë³„ í•´ì§€ í˜„í™© (ê±´ìˆ˜ ë˜ëŠ” ê¸ˆì•¡)</h3>
      <canvas id="pipelineBranchChart"></canvas>
  </div>

  <div class="chart-box">
      <h3>ğŸ“Š ë°©ì–´ì§„í–‰ë‹¨ê³„ (ì§„í–‰ì¤‘ / ë°©ì–´ì‹¤íŒ¨ / ë°©ì–´ì„±ê³µ)</h3>
      <canvas id="pipelineStageChart"></canvas>
  </div>

  <div class="chart-box">
      <h3>ğŸ“Š VOC ê´€ë¦¬ì§€ì‚¬ë³„ ìƒíƒœ (ì ì¸µ ë§‰ëŒ€)</h3>
      <canvas id="vocBranchChart"></canvas>
  </div>

  <div class="chart-box">
      <h3>ğŸ“Š VOC ë‹´ë‹¹ìë³„ ìƒíƒœ (Top 20, ì ì¸µ ë§‰ëŒ€)</h3>
      <canvas id="vocAgentChart"></canvas>
  </div>

</div>

<script>
/* ---------------------------------------------------------
   ğŸ“Œ CSV ë°ì´í„° ê²½ë¡œ
--------------------------------------------------------- */
const VOC_CSV_URL =
  "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv";

const PIPELINE_CSV_URL =
  "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv";

/* ---------------------------------------------------------
   ğŸ“Œ ì „ì—­ ìƒíƒœê°’
--------------------------------------------------------- */
let mode = "count"; 
let vocData = [];
let pipelineData = [];

// ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
let pipelineBranchChart = null;
let pipelineStageChart = null;
let vocBranchChart = null;
let vocAgentChart = null;

// ì¹´ì¹´ì˜¤ë§µ
let map;
let markers = [];

// ê´€ë¦¬ë³¸ë¶€ / ê´€ë¦¬ì§€ì‚¬ ë²„íŠ¼ ìƒíƒœ
let selectedHQ = "ALL";
let selectedBranch = "ALL";

/* ---------------------------------------------------------
   ğŸ“Œ ê³µí†µ í•¨ìˆ˜ë“¤
--------------------------------------------------------- */

// ì§€ì‚¬ëª… ì •ê·œí™”
function normalizeBranch(name) {
  if (!name) return "";
  return String(name).replace("ì§€ì‚¬", "").trim();
}

// ê³„ì•½ë²ˆí˜¸ ì •ê·œí™”
function cleanContractNumber(raw) {
  if (!raw) return "";
  return String(raw).replace(/\D/g, "").slice(0, 8);
}

// ê¸ˆì•¡ â†’ ì²œì›
function toThousandWon(raw) {
  if (!raw) return 0;
  const num = parseFloat(String(raw).replace(/,/g, ""));
  return isNaN(num) ? 0 : Math.round(num / 1000);
}

// í•´ì§€ìœ„í—˜ë„ ì²´í¬
function checkRisk(value, selected) {
  if (selected === "ALL") return true;
  const v = parseFloat(value);
  if (isNaN(v)) return false;

  const s = parseInt(selected);
  if (s === 0) return v >= 0 && v < 25;
  if (s === 25) return v >= 25 && v < 50;
  if (s === 50) return v >= 50 && v < 75;
  if (s === 75) return v >= 75 && v <= 100;
  return true;
}

// CSVë¡œë“œ
async function loadCsv(url) {
  const res = await fetch(url);
  const text = await res.text();
  return new Promise(resolve => {
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      complete: r => resolve(r.data)
    });
  });
}

/* ---------------------------------------------------------
   ğŸ“Œ Kakao ì§€ë„ (SDKê°€ ì—†ì–´ë„ ì—ëŸ¬ ì•ˆ ë‚˜ê²Œ)
--------------------------------------------------------- */
function initMapSafe() {
  try {
    if (!window.kakao || !window.kakao.maps) {
      console.warn("Kakao ì§€ë„ SDKë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì§€ë„ëŠ” ë¹„í‘œì‹œ, ì°¨íŠ¸ë§Œ ë™ì‘í•©ë‹ˆë‹¤.");
      return;
    }
    const container = document.getElementById("map");
    map = new kakao.maps.Map(container, {
      center: new kakao.maps.LatLng(37.5665, 126.9780),
      level: 7,
    });
  } catch (e) {
    console.warn("Kakao ì§€ë„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:", e);
  }
}

function extractLatLng(url) {
  if (!url || !url.includes("q=")) return null;
  try {
    const coords = url.split("q=")[1].split(",");
    return { lat: parseFloat(coords[0]), lng: parseFloat(coords[1]) };
  } catch {
    return null;
  }
}

function drawVocMarkers() {
  if (!map) return;

  markers.forEach(m => m.setMap(null));
  markers = [];

  vocData.forEach(row => {
    const pos = extractLatLng(row["ì§€ë„ë§í¬"]);
    if (!pos) return;

    const marker = new kakao.maps.Marker({
      position: new kakao.maps.LatLng(pos.lat, pos.lng),
      map
    });

    markers.push(marker);
  });
}

/* ---------------------------------------------------------
   ğŸ“Œ í•„í„° ê°’
--------------------------------------------------------- */
function getSelectedChannel() {
  return document.getElementById("channelFilter").value;
}

function getSelectedRisk() {
  return document.querySelector('input[name="risk"]:checked').value;
}

function setMode(m) {
  mode = m;
  updatePipelineCharts();
}

/* ---------------------------------------------------------
   ğŸ“Œ ê´€ë¦¬ë³¸ë¶€ / ê´€ë¦¬ì§€ì‚¬ ë²„íŠ¼ ìƒì„±
--------------------------------------------------------- */
function renderHQButtons() {
  const container = document.getElementById("hqButtons");
  if (!container || !pipelineData.length) return;

  const heads = Array.from(new Set(
    pipelineData
      .map(r => (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim())
      .filter(Boolean)
  )).sort();

  let html = "";
  html += `<button type="button" class="filter-btn ${selectedHQ === "ALL" ? "active" : ""}" data-value="ALL">ì „ì²´</button>`;
  heads.forEach(hq => {
    html += `<button type="button" class="filter-btn ${selectedHQ === hq ? "active" : ""}" data-value="${hq}">${hq}</button>`;
  });
  container.innerHTML = html;

  container.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const val = btn.getAttribute("data-value");
      selectedHQ = val;
      // ë³¸ë¶€ê°€ ë°”ë€Œë©´ ì§€ì‚¬ ì„ íƒì€ ì „ì²´ë¡œ ì´ˆê¸°í™”
      selectedBranch = "ALL";
      renderHQButtons();
      renderBranchButtons();
      updatePipelineCharts();
    });
  });
}

function renderBranchButtons() {
  const container = document.getElementById("branchButtons");
  if (!container || !pipelineData.length) return;

  let filtered = pipelineData;
  if (selectedHQ !== "ALL") {
    filtered = filtered.filter(r => (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim() === selectedHQ);
  }

  const branches = Array.from(new Set(
    filtered
      .map(r => normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]))
      .filter(Boolean)
  )).sort();

  let html = "";
  html += `<button type="button" class="filter-btn ${selectedBranch === "ALL" ? "active" : ""}" data-value="ALL">ì „ì²´</button>`;
  branches.forEach(br => {
    html += `<button type="button" class="filter-btn ${selectedBranch === br ? "active" : ""}" data-value="${br}">${br}</button>`;
  });
  container.innerHTML = html;

  container.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const val = btn.getAttribute("data-value");
      selectedBranch = val;
      renderBranchButtons();
      updatePipelineCharts();
    });
  });
}

/* ---------------------------------------------------------
   ğŸ“Œ í•´ì§€íŒŒì´í”„ë¼ì¸ â€” ë³¸ë¶€/ì§€ì‚¬ ì§‘ê³„
--------------------------------------------------------- */
function getPipelineBranchAgg() {
  const channel = getSelectedChannel();
  const risk = getSelectedRisk();

  const agg = {};

  pipelineData.forEach(row => {
    if (channel !== "ALL" && row["ë‹´ë‹¹ì˜ì—…ì±„ë„"] !== channel) return;
    if (!checkRisk(row["í•´ì§€ìœ„í—˜ë„"], risk)) return;

    const head = (row["ê´€ë¦¬ë³¸ë¶€"] || "").trim();
    const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
    if (!head || !branch) return;

    if (selectedHQ !== "ALL" && head !== selectedHQ) return;
    if (selectedBranch !== "ALL" && branch !== selectedBranch) return;

    const key = `${head} / ${branch}`;
    if (!agg[key]) agg[key] = { count: 0, amount: 0 };

    if (cleanContractNumber(row["ê³„ì•½ë²ˆí˜¸"])) {
      agg[key].count++;
    }

    agg[key].amount += toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
  });

  const entries = Object.entries(agg);
  entries.sort((a, b) => {
    const av = mode === "count" ? a[1].count : a[1].amount;
    const bv = mode === "count" ? b[1].count : b[1].amount;
    return bv - av;
  });

  return {
    labels: entries.map(e => e[0]),
    counts: entries.map(e => e[1].count),
    amounts: entries.map(e => e[1].amount)
  };
}

function drawPipelineBranchChart() {
  const ctx = document.getElementById("pipelineBranchChart").getContext("2d");
  const { labels, counts, amounts } = getPipelineBranchAgg();

  if (pipelineBranchChart) pipelineBranchChart.destroy();

  const dataArray = mode === "count" ? counts : amounts;

  pipelineBranchChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: mode === "count" ? "ê±´ìˆ˜" : "ê¸ˆì•¡(ì²œì›)",
        data: dataArray
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
}

/* ---------------------------------------------------------
   ğŸ“Œ í•´ì§€íŒŒì´í”„ë¼ì¸ â€” ë°©ì–´ì§„í–‰ë‹¨ê³„ ì ì¸µ
--------------------------------------------------------- */
function getPipelineStageAgg() {
  const channel = getSelectedChannel();
  const risk = getSelectedRisk();
  const stages = ["ì§„í–‰ì¤‘", "ë°©ì–´ì‹¤íŒ¨", "ë°©ì–´ì„±ê³µ"];

  const agg = {};

  pipelineData.forEach(row => {
    if (channel !== "ALL" && row["ë‹´ë‹¹ì˜ì—…ì±„ë„"] !== channel) return;
    if (!checkRisk(row["í•´ì§€ìœ„í—˜ë„"], risk)) return;

    const head = (row["ê´€ë¦¬ë³¸ë¶€"] || "").trim();
    const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
    if (!branch) return;

    if (selectedHQ !== "ALL" && head !== selectedHQ) return;
    if (selectedBranch !== "ALL" && branch !== selectedBranch) return;

    const stage = (row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] || "").trim();

    if (!agg[branch]) {
      agg[branch] = { ì§„í–‰ì¤‘: 0, ë°©ì–´ì‹¤íŒ¨: 0, ë°©ì–´ì„±ê³µ: 0 };
    }

    if (stages.includes(stage)) agg[branch][stage]++;
  });

  const labels = Object.keys(agg);

  return {
    labels,
    ì§„í–‰ì¤‘: labels.map(b => agg[b]["ì§„í–‰ì¤‘"]),
    ë°©ì–´ì‹¤íŒ¨: labels.map(b => agg[b]["ë°©ì–´ì‹¤íŒ¨"]),
    ë°©ì–´ì„±ê³µ: labels.map(b => agg[b]["ë°©ì–´ì„±ê³µ"]),
  };
}

function drawPipelineStageChart() {
  const ctx = document.getElementById("pipelineStageChart").getContext("2d");
  const { labels, ì§„í–‰ì¤‘, ë°©ì–´ì‹¤íŒ¨, ë°©ì–´ì„±ê³µ } = getPipelineStageAgg();

  if (pipelineStageChart) pipelineStageChart.destroy();

  pipelineStageChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "ì§„í–‰ì¤‘", data: ì§„í–‰ì¤‘, stack: "s" },
        { label: "ë°©ì–´ì‹¤íŒ¨", data: ë°©ì–´ì‹¤íŒ¨, stack: "s" },
        { label: "ë°©ì–´ì„±ê³µ", data: ë°©ì–´ì„±ê³µ, stack: "s" },
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { stacked: true },
        y: { stacked: true, beginAtZero: true }
      }
    }
  });
}

/* ---------------------------------------------------------
   ğŸ“Œ VOC ì‹œê°í™”
--------------------------------------------------------- */
function aggregateVocBy(field, limit = 20) {
  const agg = {};
  const statuses = ["ì²˜ë¦¬ì™„ë£Œ", "ì ‘ìˆ˜", "ë¯¸ì ‘ìˆ˜"];

  vocData.forEach(row => {
    let key = field === "ê´€ë¦¬ì§€ì‚¬"
      ? normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"])
      : (row[field] || "").trim();

    if (!key) return;

    const st = (row["ìƒíƒœ"] || "").trim();

    if (!agg[key]) agg[key] = { ì²˜ë¦¬ì™„ë£Œ: 0, ì ‘ìˆ˜: 0, ë¯¸ì ‘ìˆ˜: 0 };
    if (statuses.includes(st)) agg[key][st]++;
  });

  const entries = Object.entries(agg);
  entries.sort((a, b) =>
    (b[1].ì²˜ë¦¬ì™„ë£Œ + b[1].ì ‘ìˆ˜ + b[1].ë¯¸ì ‘ìˆ˜) -
    (a[1].ì²˜ë¦¬ì™„ë£Œ + a[1].ì ‘ìˆ˜ + a[1].ë¯¸ì ‘ìˆ˜)
  );

  const sliced = entries.slice(0, limit);

  return {
    labels: sliced.map(e => e[0]),
    ì²˜ë¦¬ì™„ë£Œ: sliced.map(e => e[1].ì²˜ë¦¬ì™„ë£Œ),
    ì ‘ìˆ˜: sliced.map(e => e[1].ì ‘ìˆ˜),
    ë¯¸ì ‘ìˆ˜: sliced.map(e => e[1].ë¯¸ì ‘ìˆ˜),
  };
}

function drawVocBranchChart() {
  const ctx = document.getElementById("vocBranchChart").getContext("2d");
  const { labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜ } = aggregateVocBy("ê´€ë¦¬ì§€ì‚¬", 30);

  if (vocBranchChart) vocBranchChart.destroy();

  vocBranchChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "ì²˜ë¦¬ì™„ë£Œ", data: ì²˜ë¦¬ì™„ë£Œ, stack: "v" },
        { label: "ì ‘ìˆ˜", data: ì ‘ìˆ˜, stack: "v" },
        { label: "ë¯¸ì ‘ìˆ˜", data: ë¯¸ì ‘ìˆ˜, stack: "v" },
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { stacked: true },
        y: { stacked: true, beginAtZero: true }
      }
    }
  });
}

function drawVocAgentChart() {
  const ctx = document.getElementById("vocAgentChart").getContext("2d");
  const { labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜ } = aggregateVocBy("ë‹´ë‹¹ì", 20);

  if (vocAgentChart) vocAgentChart.destroy();

  vocAgentChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "ì²˜ë¦¬ì™„ë£Œ", data: ì²˜ë¦¬ì™„ë£Œ, stack: "va" },
        { label: "ì ‘ìˆ˜", data: ì ‘ìˆ˜, stack: "va" },
        { label: "ë¯¸ì ‘ìˆ˜", data: ë¯¸ì ‘ìˆ˜, stack: "va" },
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { stacked: true },
        y: { stacked: true, beginAtZero: true }
      }
    }
  });
}

/* ---------------------------------------------------------
   ğŸ“Œ ì „ì²´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
--------------------------------------------------------- */
function updatePipelineCharts() {
  drawPipelineBranchChart();
  drawPipelineStageChart();
}

/* ---------------------------------------------------------
   ğŸ“Œ ì´ˆê¸° ë¡œë“œ
--------------------------------------------------------- */
async function initDashboard() {
  initMapSafe();

  vocData = await loadCsv(VOC_CSV_URL);
  pipelineData = await loadCsv(PIPELINE_CSV_URL);

  drawVocMarkers();

  // ê´€ë¦¬ë³¸ë¶€/ì§€ì‚¬ ë²„íŠ¼ ìƒì„±
  renderHQButtons();
  renderBranchButtons();

  // ì°¨íŠ¸ë“¤
  drawPipelineBranchChart();
  drawPipelineStageChart();
  drawVocBranchChart();
  drawVocAgentChart();

  // í•„í„° ì´ë²¤íŠ¸
  document.getElementById("channelFilter")
    .addEventListener("change", updatePipelineCharts);

  document.querySelectorAll('input[name="risk"]')
    .forEach(r => r.addEventListener("change", updatePipelineCharts));
}

window.addEventListener("load", initDashboard);
</script>

</body>
</html>
