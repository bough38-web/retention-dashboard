<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>KTT Premium Retention Dashboard (v22.0)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- LIB -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbmyeJMsApj38SRzWvaQGrZmpqUQTooMw" defer></script>
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<style>
/* ===== THEME ===== */
:root{
 --primary:#4f46e5;--bg:#f8fafc;--surface:#fff;
 --text:#1e293b;--sub:#64748b;--border:#e2e8f0;
 --success:#10b981;--warning:#f59e0b;--danger:#ef4444;
 --fail-bg:#fef2f2;
}
body{margin:0;font-family:Pretendard,sans-serif;background:var(--bg);height:100vh;display:flex;overflow:hidden}
*{box-sizing:border-box}

/* ===== LAYOUT ===== */
.sidebar{width:300px;background:#fff;border-right:1px solid var(--border)}
.main{flex:1;padding:24px;overflow:auto}
.logo{padding:20px;font-weight:800;color:var(--primary);border-bottom:1px solid var(--border)}
.nav-tabs{display:flex;padding:10px;gap:6px}
.nav-tab{flex:1;border:none;padding:8px;font-weight:700;cursor:pointer}
.nav-tab.active{background:var(--primary);color:#fff;border-radius:6px}

/* ===== KPI ===== */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px}
.kpi{background:#fff;border-left:5px solid var(--c);padding:20px;border-radius:10px}
.kpi .v{font-size:32px;font-weight:800}

/* ===== TABLE ===== */
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:10px;border-bottom:1px solid #e5e7eb}
th{background:#f8fafc;position:sticky;top:0}
tr:hover td{background:#f1f5f9}
tr.fail td{background:var(--fail-bg);color:#dc2626;font-weight:700}

/* ===== SIDE PANEL ===== */
#sidePanel{
 position:fixed;top:0;right:-420px;width:420px;height:100%;
 background:#fff;border-left:1px solid var(--border);
 box-shadow:-4px 0 10px rgba(0,0,0,.1);
 transition:.3s;z-index:999
}
#sidePanel.open{right:0}
.side-head{padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between}
.side-body{padding:16px;overflow:auto}
.side-row{margin-bottom:12px;font-size:14px}
.side-row span{color:var(--sub);display:block;font-size:12px}

/* ===== MAP ===== */
#map{height:320px;border-radius:10px;margin-top:20px}

/* ===== LOADING ===== */
#loading{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;z-index:9999}
.spin{width:40px;height:40px;border:4px solid #e0e7ff;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{100%{transform:rotate(360deg)}}
</style>
</head>

<body>

<div id="loading"><div class="spin"></div></div>

<!-- SIDEBAR -->
<div class="sidebar">
 <div class="logo">KTT Dashboard</div>
 <div class="nav-tabs">
  <button class="nav-tab active" onclick="switchView('voc')">VOC</button>
  <button class="nav-tab" onclick="switchView('pipe')">Pipeline</button>
 </div>
</div>

<!-- MAIN -->
<div class="main">
 <div id="vocView"></div>
 <div id="pipeView" style="display:none"></div>
 <div id="map"></div>
</div>

<!-- SIDE PANEL -->
<div id="sidePanel">
 <div class="side-head">
  <strong>상세 정보</strong>
  <button onclick="closePanel()">✕</button>
 </div>
 <div class="side-body" id="sideContent"></div>
</div>

<script>
const URLS={
 voc:"https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv",
 pipe:"https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv"
};
let App={view:'voc',data:{voc:[],pipe:[]},filtered:[],selected:null,map:null};

window.onload=async()=>{
 const [v,p]=await Promise.all([load(URLS.voc),load(URLS.pipe)]);
 App.data.voc=v;App.data.pipe=p;
 initMap();render();document.getElementById('loading').style.display='none';
};

async function load(u){
 const r=await fetch(u);const t=await r.text();
 return Papa.parse(t,{header:true}).data;
}

function switchView(v){
 App.view=v;
 document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
 event.target.classList.add('active');
 render();
 closePanel();
}

function render(){
 App.view==='voc'?renderVoc():renderPipe();
}

function renderVoc(){
 document.getElementById('vocView').innerHTML=`
 <h2>VOC 리스트</h2>
 <table>
  <thead><tr><th>지사</th><th>담당자</th><th>상호</th><th>상태</th></tr></thead>
  <tbody>
   ${App.data.voc.slice(0,100).map(d=>`
    <tr onclick='openPanel(${JSON.stringify(d)})'>
     <td>${d.관리지사}</td>
     <td>${d.담당자}</td>
     <td>${d.상호명}</td>
     <td>${d.상태}</td>
    </tr>`).join('')}
  </tbody>
 </table>`;
}

function renderPipe(){
 document.getElementById('pipeView').innerHTML=`
 <h2>파이프라인 리스트</h2>
 <table>
  <thead><tr><th>지사</th><th>상호</th><th>위험도</th><th>단계</th></tr></thead>
  <tbody>
   ${App.data.pipe.slice(0,100).map(d=>`
    <tr class='${d.방어진행단계==="방어실패"?"fail":""}'
        onclick='openPanel(${JSON.stringify(d)})'>
     <td>${d.관리지사}</td>
     <td>${d.상호명}</td>
     <td>${d.해지위험도}%</td>
     <td>${d.방어진행단계}</td>
    </tr>`).join('')}
  </tbody>
 </table>`;
}

function openPanel(d){
 App.selected=d;
 const c=document.getElementById('sideContent');
 c.innerHTML=Object.entries(d).map(([k,v])=>
  `<div class='side-row'><span>${k}</span>${v||'-'}</div>`
 ).join('');
 document.getElementById('sidePanel').classList.add('open');
}

function closePanel(){
 document.getElementById('sidePanel').classList.remove('open');
 App.selected=null;
}

function initMap(){
 App.map=new google.maps.Map(document.getElementById('map'),{
  center:{lat:37.5,lng:127},zoom:7
 });
}
</script>
</body>
</html>
