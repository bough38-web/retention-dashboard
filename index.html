<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>KTT Premium Retention Dashboard (v19.1 Final)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbmyeJMsApj38SRzWvaQGrZmpqUQTooMw" defer></script>
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<style>
    :root {
        --primary: #4f46e5; --primary-light: #e0e7ff; --bg: #f8fafc; --surface: #ffffff;
        --text: #1e293b; --text-sub: #64748b; --border: #e2e8f0;
        --radius: 12px; --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
        --fail-bg: #fef2f2; /* 방어실패 배경색 */
        --fail-text: #b91c1c;
    }
    body { margin:0; font-family:'Pretendard', sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; overflow:hidden; }
    * { box-sizing:border-box; outline:none; }
    
    /* Sidebar */
    .sidebar { width:300px; background:var(--surface); border-right:1px solid var(--border); display:flex; flex-direction:column; z-index:20; box-shadow:var(--shadow); }
    .logo { padding:20px; border-bottom:1px solid var(--border); font-size:20px; font-weight:800; color:var(--primary); display:flex; align-items:center; gap:8px; }
    .scroll-area { flex:1; overflow-y:auto; padding:20px; }
    
    /* Upload & Tabs */
    .upload-box { 
        background:var(--bg); border:1px dashed #94a3b8; border-radius:var(--radius); padding:14px; 
        text-align:center; margin-bottom:20px; cursor:pointer; transition:0.2s; 
    }
    .upload-box:hover { border-color:var(--primary); background:#eef2ff; }
    .upload-box span { font-size:12px; font-weight:600; color:var(--text); display:block; }
    #fileInput { display:none; }

    .nav-tabs { display:flex; background:var(--bg); padding:4px; border-radius:10px; margin-bottom:20px; }
    .nav-tab { flex:1; padding:8px; border:none; background:none; font-size:13px; font-weight:700; color:var(--text-sub); cursor:pointer; border-radius:8px; transition:0.2s; }
    .nav-tab.active { background:var(--surface); color:var(--primary); box-shadow:0 1px 2px rgba(0,0,0,0.05); }

    /* Filters */
    .filter-box { margin-bottom:20px; }
    .filter-head { display:flex; justify-content:space-between; font-size:12px; font-weight:700; color:var(--text-sub); margin-bottom:8px; }
    .reset-btn { cursor:pointer; color:var(--primary); display:none; font-size:11px; }
    .reset-btn.show { display:inline; }
    .chips { display:flex; flex-wrap:wrap; gap:6px; max-height:180px; overflow-y:auto; align-content:flex-start; }
    .chip { 
        padding:5px 10px; border:1px solid var(--border); background:var(--surface); 
        border-radius:20px; font-size:11px; color:var(--text); cursor:pointer; transition:0.15s; 
    }
    .chip:hover { border-color:var(--text-sub); }
    .chip.active { background:var(--primary); color:#fff; border-color:var(--primary); font-weight:600; box-shadow:0 2px 4px rgba(79, 70, 229, 0.3); }

    /* Main Content */
    .main-content { flex:1; padding:24px; overflow-y:auto; display:flex; flex-direction:column; }
    .view-panel { display:none; flex-direction:column; gap:20px; animation:fadeIn 0.4s ease-out; flex:1; }
    .view-panel.active { display:flex; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }

    /* Header & KPI */
    .header { display:flex; justify-content:space-between; align-items:center; flex:none; }
    .header h2 { margin:0; font-size:24px; font-weight:800; }
    .action-btn { padding:8px 16px; background:#10b981; color:#fff; border:none; border-radius:8px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; }
    
    .kpi-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; flex:none; }
    .kpi-card { background:var(--surface); padding:24px; border-radius:12px; box-shadow:var(--shadow); position:relative; overflow:hidden; border-left:5px solid var(--c); }
    .kpi-label { font-size:13px; font-weight:600; color:var(--text-sub); text-transform:uppercase; letter-spacing:0.5px; }
    .kpi-val { font-size:36px; font-weight:800; margin-top:10px; color:var(--text); letter-spacing:-1px; }
    .kpi-icon { position:absolute; right:20px; top:20px; font-size:48px; opacity:0.1; color:var(--c); }
    .kpi-sub { font-size:14px; color:var(--text-sub); font-weight:500; margin-left:5px; }

    /* Grids */
    .voc-layout { display:flex; gap:20px; height:380px; flex:none; }
    .voc-left { flex:1; display:flex; flex-direction:column; gap:20px; }
    .voc-right { flex:1.5; display:flex; flex-direction:column; }
    .pipeline-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; flex:1; min-height:0; }

    .card { background:var(--surface); border-radius:12px; padding:16px; box-shadow:var(--shadow); display:flex; flex-direction:column; height:100%; border:1px solid var(--border); }
    .card.full { flex:1; min-height:0; }
    .card-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex:none; }
    .card-title { font-size:16px; font-weight:700; display:flex; align-items:center; gap:8px; color:var(--text); }

    .map-wrapper { flex:1; border-radius:8px; overflow:hidden; position:relative; background:#e2e8f0; }
    .chart-wrapper { flex:1; position:relative; min-height:0; }

    /* Table */
    .table-section { flex:1; min-height:300px; display:flex; flex-direction:column; }
    .table-wrapper { flex:1; overflow:auto; border:1px solid var(--border); border-radius:8px; }
    table { width:100%; border-collapse:collapse; font-size:13px; white-space:nowrap; }
    th { background:#f8fafc; padding:12px 14px; text-align:left; font-weight:700; color:var(--text-sub); position:sticky; top:0; z-index:10; border-bottom:1px solid var(--border); }
    td { padding:10px 14px; border-bottom:1px solid #f1f5f9; cursor:pointer; color:var(--text); transition:0.1s; }
    tr:hover td { background:#f1f5f9; }
    tr.active-row td { background:#e0e7ff !important; font-weight:600; color:var(--primary); }
    
    /* Fail Row Highlight */
    tr.row-fail td { background:var(--fail-bg); color:var(--fail-text); font-weight:600; }
    tr.row-fail:hover td { background:#fee2e2; }

    /* Utils */
    .badge { padding:3px 8px; border-radius:6px; font-size:11px; font-weight:700; display:inline-block; min-width:60px; text-align:center; }
    .bd-done { background:#dcfce7; color:#166534; }
    .bd-ing { background:#fef3c7; color:#92400e; }
    .bd-wait { background:#fee2e2; color:#991b1b; }
    .btn-map { padding:4px 8px; background:#e0e7ff; color:var(--primary); border-radius:6px; font-weight:700; font-size:11px; text-decoration:none; display:inline-flex; align-items:center; gap:4px; }

    #loading { position:fixed; inset:0; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; }
    .spinner { width:40px; height:40px; border:4px solid #e0e7ff; border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { 100%{transform:rotate(360deg);} }
</style>
</head>
<body>

<div id="loading"><div class="spinner"></div></div>

<div class="sidebar">
    <div class="logo"><i class="ph ph-chart-polar"></i> KTT Dashboard</div>
    <div class="scroll-area">
        <div class="upload-box" onclick="triggerUpload()">
            <i class="ph ph-file-csv"></i> <span>파일 교체 (보안)</span>
            <input type="file" id="fileInput" accept=".csv" />
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchView('voc')">VOC 현황</button>
            <button class="nav-tab" onclick="switchView('pipe')">파이프라인</button>
        </div>
        <div id="filter-container"></div>
    </div>
</div>

<div class="main-content">

    <div id="view-voc" class="view-panel active">
        <div class="header">
            <div>
                <h2>관리고객(VOC) 현황</h2>
                <p>실시간 위치 기반 모니터링</p>
            </div>
            <button class="action-btn" onclick="exportData('voc')"><i class="ph ph-download-simple"></i> 엑셀 저장</button>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card" style="--c:var(--primary)">
                <div class="kpi-label">총 계약 (Unique)</div>
                <div class="kpi-val counter" id="voc-total">0</div>
            </div>
            <div class="kpi-card" style="--c:var(--success)">
                <div class="kpi-label">처리 완료</div>
                <div><span class="kpi-val" id="voc-done">0</span> <span class="kpi-sub" id="voc-rate-done">(0%)</span></div>
            </div>
            <div class="kpi-card" style="--c:var(--warning)">
                <div class="kpi-label">접수(진행)</div>
                <div><span class="kpi-val" id="voc-ing">0</span> <span class="kpi-sub" id="voc-rate-ing">(0%)</span></div>
            </div>
            <div class="kpi-card" style="--c:var(--danger)">
                <div class="kpi-label">미접수</div>
                <div><span class="kpi-val" id="voc-wait">0</span> <span class="kpi-sub" id="voc-rate-wait">(0%)</span></div>
            </div>
        </div>

        <div class="voc-layout">
            <div class="voc-left">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; height:100%;">
                    <div class="card">
                        <div class="card-head"><h3 class="card-title">지사별 처리 현황</h3></div>
                        <div class="chart-wrapper"><canvas id="chart-voc-branch"></canvas></div>
                    </div>
                    <div class="card">
                        <div class="card-head"><h3 class="card-title">미처리 담당자 Top 10</h3></div>
                        <div class="chart-wrapper"><canvas id="chart-voc-agent"></canvas></div>
                    </div>
                </div>
            </div>
            <div class="voc-right">
                <div class="card full" style="padding:0; overflow:hidden;">
                    <div style="padding:12px 16px; border-bottom:1px solid var(--border); background:#fff; display:flex; justify-content:space-between; align-items:center;">
                        <h3 class="card-title"><i class="ph ph-map-trifold"></i> 고객 위치 현황</h3>
                        <span style="font-size:12px; color:var(--text-sub);">* 클릭 시 자동 줌인</span>
                    </div>
                    <div id="voc-map" class="map-wrapper"></div>
                </div>
            </div>
        </div>

        <div class="card table-section">
            <div class="card-head"><h3 class="card-title">상세 리스트</h3></div>
            <div class="table-wrapper">
                <table id="table-voc">
                    <thead><tr>
                        <th>지사</th><th>담당자</th><th>계약번호</th><th>상호명</th><th>상태</th><th>서비스</th><th>합산월정료</th><th>등록내용</th><th>주소</th><th>위치</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-pipe" class="view-panel">
        <div class="header">
            <div>
                <h2>해지 파이프라인 분석</h2>
                <p>고위험군 및 방어 성과 집중 관리</p>
            </div>
            <button class="action-btn" onclick="exportData('pipe')"><i class="ph ph-download-simple"></i> 엑셀 저장</button>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card" style="--c:var(--primary)"><div class="kpi-label">대상 건수 (<span id="pipe-channel-label">SP</span>)</div><div class="kpi-val" id="pipe-total">0</div></div>
            <div class="kpi-card" style="--c:var(--warning)"><div class="kpi-label">고위험군 (60~90%)</div><div class="kpi-val" id="pipe-high">0</div></div>
            <div class="kpi-card" style="--c:var(--danger)"><div class="kpi-label">방어실패 (100%)</div><div class="kpi-val" id="pipe-fail">0</div></div>
            <div class="kpi-card" style="--c:var(--success)"><div class="kpi-label">방어성공</div><div class="kpi-val" id="pipe-success">0</div></div>
        </div>

        <div class="pipeline-grid">
            <div class="card full">
                <div class="card-head"><h3 class="card-title">방어 단계별 현황</h3></div>
                <div class="chart-wrapper"><canvas id="chart-pipe-step"></canvas></div>
            </div>
            <div class="card full">
                <div class="card-head"><h3 class="card-title">주요 해지 사유</h3></div>
                <div class="chart-wrapper"><canvas id="chart-pipe-reason"></canvas></div>
            </div>
        </div>

        <div class="card table-section" style="height:450px;">
            <div class="card-head"><h3 class="card-title">상세 파이프라인 리스트</h3></div>
            <div class="table-wrapper">
                <table id="table-pipe">
                    <thead><tr>
                        <th>본부</th><th>지사</th><th>담당자</th><th>계약번호</th><th>상호명</th><th>채널</th><th>위험도</th><th>방어단계</th><th>해지예정일</th><th>월정료(천원)</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
/* CONFIG */
const BRANCH_ORDER = ['중앙', '강북', '서대문', '의정부', '남양주', '강릉', '원주'];
const URLS = {
    voc: "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv",
    pipe: "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv"
};

let App = {
    view: 'voc',
    data: { voc:[], pipe:[] },
    filtered: [],
    filters: { hq:'강북/강원', branch:'ALL', agent:'ALL', status:'ALL', channel:'SP', risk:'ALL' }, // Default Filters
    map: null, clusterer: null, markers: [], charts: {}
};

Chart.register(ChartDataLabels);
Chart.defaults.font.family = "'Pretendard', sans-serif";
Chart.defaults.color = '#64748b';
Chart.defaults.scale.grid.color = '#f1f5f9';

/* INIT */
window.onload = async () => {
    try {
        const [v, p] = await Promise.all([fetchCsv(URLS.voc), fetchCsv(URLS.pipe)]);
        App.data.voc = parseVoc(v.data);
        App.data.pipe = parsePipe(p.data);
        
        initMap();
        initFiltersHTML();
        updateDashboard();
    } catch(e) { console.error(e); alert("데이터 로드 실패"); }
    document.getElementById('loading').style.display = 'none';
};

async function fetchCsv(url) {
    const r = await fetch(url); const t = await r.text();
    return Papa.parse(t.replace(/^\uFEFF/, ''), {header:true, skipEmptyLines:true});
}

/* PARSING */
const findKey = (r, k) => Object.keys(r).find(key => key.includes(k));

function parseVoc(data) {
    if(!data.length) return [];
    const kCoord = findKey(data[0], "위치좌표") || "위치좌표(위도,경도)";
    return data.map(r => {
        let lat=null, lng=null;
        if(r[kCoord] && r[kCoord].includes(',')) {
            const p = r[kCoord].split(','); lat = parseFloat(p[0]); lng = parseFloat(p[1]);
        } else if (r["위도"]) { lat = parseFloat(r["위도"]); lng = parseFloat(r["경도"]); }
        
        return {
            ...r,
            _branch: normStr(r["관리지사"]), _agent: (r["담당자"]||"미지정").trim(),
            _status: (r["상태"]||"").trim(), _lat: (!isNaN(lat)&&lat)?lat:null, _lng: (!isNaN(lng)&&lng)?lng:null,
            _fee: parseMoney(r["합산월정료"]), _desc: r["등록내용"]||"-",
            _addr: (r["시"]||"")+" "+(r["군구"]||"")+" "+(r["읍면동"]||""),
            _link: r["지도링크_URL"]
        };
    });
}

function parsePipe(data) {
    if(!data.length) return [];
    const kRisk = findKey(data[0], "위험도"); const kDate = findKey(data[0], "해지예정일");
    const kFee = findKey(data[0], "월정료"); const kHQ = findKey(data[0], "관리본부");
    const kName = findKey(data[0], "상호"); const kCont = findKey(data[0], "계약번호");
    const kChan = findKey(data[0], "담당영업채널") || "담당영업채널";

    return data.map(r => {
        let risk = parseFloat(r[kRisk]||0); if(risk>0 && risk<=1) risk*=100;
        let dStr = r[kDate];
        if(dStr) {
            let cln = String(dStr).replace(/,/g,'').trim();
            if(!isNaN(cln)&&Number(cln)>20000) dStr = new Date((Number(cln)-25569)*86400000).toISOString().slice(0,10);
        }
        return {
            ...r,
            "계약번호": String(r[kCont]||"").replace(/\.0$/,''),
            "상호": r[kName]||"-",
            _hq: (r[kHQ]||"기타").trim(), _branch: normStr(r["관리지사"]),
            _agent: (r["담당자"]||"미지정").trim(), _risk: Math.round(risk),
            _step: (r["방어진행단계"]||"").trim(), _fee: parseMoney(r[kFee]), _date: dStr,
            _channel: (r[kChan]||"SP").trim()
        };
    });
}

function normStr(s) { return (s||"기타").replace("지사","").trim(); }
function parseMoney(s) { return parseInt(String(s).replace(/,/g,''))||0; }
function fmtMoney(n) { return Math.round(n/1000).toLocaleString() + "천원"; }

/* FILTERS */
function initFiltersHTML() {
    const area = document.getElementById('filter-container');
    area.innerHTML = `
        <div class="filter-box" id="fb-hq" style="display:none;"><div class="filter-head">관리본부 <span class="reset-btn" onclick="resetFilter('hq')">초기화</span></div><div id="chips-hq" class="chips"></div></div>
        <div class="filter-box" id="fb-channel" style="display:none;"><div class="filter-head">영업채널</div><div id="chips-channel" class="chips"></div></div>
        <div class="filter-box"><div class="filter-head">관리지사 <span class="reset-btn" onclick="resetFilter('branch')">초기화</span></div><div id="chips-branch" class="chips"></div></div>
        <div class="filter-box"><div class="filter-head">담당자 <span class="reset-btn" onclick="resetFilter('agent')">초기화</span></div><div id="chips-agent" class="chips"></div></div>
        <div class="filter-box" id="fb-status"><div class="filter-head">처리 상태</div><div id="chips-status" class="chips"></div></div>
    `;
    renderChips('chips-status', ['전체','처리완료','접수','미접수'], 'status');
    renderChips('chips-channel', ['전체','SP','SC','AM'], 'channel'); 
}

function updateDashboard() {
    const isVoc = App.view === 'voc';
    const src = isVoc ? App.data.voc : App.data.pipe;
    
    App.filtered = src.filter(d => {
        if(App.filters.branch!=='ALL' && d._branch!==App.filters.branch) return false;
        if(App.filters.agent!=='ALL' && d._agent!==App.filters.agent) return false;
        if(isVoc) { 
            if(App.filters.status!=='ALL' && d._status!==App.filters.status) return false; 
        } else {
            if(App.filters.hq!=='ALL' && d._hq!==App.filters.hq) return false;
            if(App.filters.channel!=='ALL' && d._channel!==App.filters.channel) return false;
        }
        return true;
    });

    updateDynamicFilters(src);
    if(isVoc) renderVocView(); else renderPipeView();
}

function updateDynamicFilters(src) {
    const isVoc = App.view === 'voc';
    if(!isVoc) {
        const hqs = [...new Set(src.map(d=>d._hq))].sort();
        renderChips('chips-hq', ['전체',...hqs], 'hq', true);
    }
    let bSrc = src;
    if(!isVoc && App.filters.hq!=='ALL') bSrc = src.filter(d=>d._hq===App.filters.hq);
    let branches = [...new Set(bSrc.map(d=>d._branch))];
    branches.sort((a,b) => {
        const ia=BRANCH_ORDER.indexOf(a), ib=BRANCH_ORDER.indexOf(b);
        if(ia!==-1 && ib!==-1) return ia-ib; return a.localeCompare(b);
    });
    renderChips('chips-branch', ['전체',...branches], 'branch', true);

    let aSrc = bSrc;
    if(App.filters.branch!=='ALL') aSrc = bSrc.filter(d=>d._branch===App.filters.branch);
    const agents = [...new Set(aSrc.map(d=>d._agent))].sort();
    renderChips('chips-agent', ['전체',...agents], 'agent', true);

    toggleReset('hq', App.filters.hq!=='ALL');
    toggleReset('branch', App.filters.branch!=='ALL');
    toggleReset('agent', App.filters.agent!=='ALL');
}

function renderChips(id, items, type, isDynamic=false) {
    const box = document.getElementById(id);
    if(isDynamic) box.innerHTML = '';
    items.forEach(val => {
        if(!isDynamic && Array.from(box.children).some(c=>c.innerText===val)) return;
        const btn = document.createElement('div');
        const isAll = val==='전체' || val==='ALL';
        // Set default active
        let isActive = App.filters[type] === (isAll?'ALL':val);
        
        btn.className = `chip ${isActive ? 'active' : ''}`;
        btn.innerText = val;
        btn.onclick = () => {
            App.filters[type] = isAll ? 'ALL' : val;
            if(type==='hq') { App.filters.branch='ALL'; App.filters.agent='ALL'; }
            if(type==='branch') { App.filters.agent='ALL'; }
            updateDashboard();
        };
        box.appendChild(btn);
    });
}

function toggleReset(type, show) {
    const el = document.querySelector(`#fb-${type} .reset-btn`) || document.querySelector(`#chips-${type}`).previousElementSibling.querySelector('.reset-btn');
    if(el) el.style.display = show ? 'inline' : 'none';
}
function resetFilter(type) { App.filters[type] = 'ALL'; updateDashboard(); }

/* --- RENDER --- */
function renderVocView() {
    const data = App.filtered;
    const unique = new Set(data.map(d=>d["계약번호"])).size;
    const done = data.filter(d=>d._status==='처리완료').length;
    const ing = data.filter(d=>d._status==='접수').length;
    const wait = data.filter(d=>d._status==='미접수').length;

    animateNum('voc-total', unique);
    animateNum('voc-done', done);
    document.getElementById('voc-rate-done').innerText = unique ? `(${((done/unique)*100).toFixed(1)}%)` : '(0%)';
    animateNum('voc-ing', ing);
    document.getElementById('voc-rate-ing').innerText = unique ? `(${((ing/unique)*100).toFixed(1)}%)` : '(0%)';
    animateNum('voc-wait', wait);
    document.getElementById('voc-rate-wait').innerText = unique ? `(${((wait/unique)*100).toFixed(1)}%)` : '(0%)';

    updateMap(data);
    drawBar('chart-voc-branch', data, '_branch', '건수', '#6366f1', 'branch');
    drawBar('chart-voc-agent', data.filter(d=>d._status!=='처리완료'), '_agent', '미처리', '#ef4444', 'agent');
    
    renderTable('table-voc', data, [
        {k:'_branch'}, {k:'_agent'}, {k:'계약번호'}, {k:'상호'}, 
        {k:'_status', badge:true}, {k:'VOC유형소'}, {k:'_fee', fmt:fmtMoney}, 
        {k:'_desc'}, {k:'_addr'}, {k:'_link', btn:true}
    ]);
}

function renderPipeView() {
    const data = App.filtered;
    // KPI Logic Update
    const highRisk = data.filter(d => d._risk >= 60 && d._risk < 100); // 60~90%
    const fail = data.filter(d => d._risk === 100 || d._step === '방어실패'); // 100% or Failed
    const success = data.filter(d => d._step === '방어성공');
    
    // Total is based on current filter (Channel SP default)
    animateNum('pipe-total', data.length);
    document.getElementById('pipe-channel-label').innerText = App.filters.channel==='ALL'?'전체':App.filters.channel;

    animateNum('pipe-high', highRisk.length);
    animateNum('pipe-fail', fail.length);
    animateNum('pipe-success', success.length);

    drawBar('chart-pipe-step', data, '_step', '방어단계', '#10b981', null);
    drawBar('chart-pipe-reason', data, '해지사유', '해지사유', '#f59e0b', null);
    
    renderTable('table-pipe', data, [
        {k:'_hq'}, {k:'_branch'}, {k:'_agent'}, {k:'계약번호'}, {k:'상호'}, 
        {k:'_channel'}, {k:'_risk', suffix:'%'}, {k:'_step'}, {k:'_date'}, {k:'_fee', fmt:fmtMoney}
    ]);
}

/* --- MAP & CHARTS --- */
function initMap() {
    App.map = new google.maps.Map(document.getElementById('voc-map'), {
        center: {lat: 37.5665, lng: 126.9780}, zoom: 10, disableDefaultUI: true, zoomControl: true
    });
    App.map.addListener('zoom_changed', () => {
        const z = App.map.getZoom();
        App.markers.forEach(m => m.setLabel(z>=12 ? { text: m.getTitle(), color: "#222", fontWeight: "bold", fontSize: "11px" } : null));
    });
}

function updateMap(data) {
    if(!App.map) return;
    if(App.clusterer) App.clusterer.clearMarkers();
    App.markers = [];
    
    const valid = data.filter(d => d._lat);
    const bounds = new google.maps.LatLngBounds();
    const isFiltered = App.filters.branch !== 'ALL' || App.filters.agent !== 'ALL' || App.filters.status !== 'ALL';

    valid.forEach(d => {
        const color = d._status === '처리완료' ? 'blue' : 'red';
        const m = new google.maps.Marker({
            position: {lat: d._lat, lng: d._lng},
            title: `${d["상호"]}(${d._agent})`,
            icon: `http://googleusercontent.com/maps.google.com/mapfiles/ms/icons/${color}-dot.png`
        });
        
        const info = new google.maps.InfoWindow({
            content: `
            <div class="info-window">
                <div class="info-title">${d["상호"]}</div>
                <div class="info-row"><span>지사</span> <span class="info-val">${d._branch}</span></div>
                <div class="info-row"><span>담당자</span> <span class="info-val">${d._agent}</span></div>
                <span class="info-status" style="background:${d._status==='처리완료'?'#dbeafe':'#fee2e2'}; color:${d._status==='처리완료'?'#1e40af':'#991b1b'}">${d._status}</span>
            </div>`
        });
        
        m.addListener('click', () => {
            info.open(App.map, m);
            m.setAnimation(google.maps.Animation.BOUNCE);
            setTimeout(()=>m.setAnimation(null), 1500);
        });
        
        d._marker = m;
        bounds.extend(m.getPosition());
        App.markers.push(m);
    });

    App.clusterer = new markerClusterer.MarkerClusterer({ map: App.map, markers: App.markers });
    
    if(isFiltered && valid.length > 0) App.map.fitBounds(bounds);
    else { App.map.setCenter({lat: 37.5665, lng: 126.9780}); App.map.setZoom(10); }
}

/* --- [최종 수정] 상단 공백 제거 (막대가 차트 영역을 가득 채움) --- */
function drawBar(id, data, key, label, color, fType) {
    // 1. 데이터 집계
    const counts = {};
    data.forEach(d => {
        let k = d[key];
        if (!k || (typeof k === 'string' && k.trim() === '')) {
            k = '미입력';
        }
        counts[k] = (counts[k] || 0) + 1;
    });
    
    // 2. 정렬 로직
    let keys = Object.keys(counts);
    if(key === '_branch') {
        keys.sort((a,b) => {
            const ia = BRANCH_ORDER.indexOf(a), ib = BRANCH_ORDER.indexOf(b);
            if(ia!==-1 && ib!==-1) return ia-ib;
            return b.localeCompare(a); 
        });
    } else {
        keys.sort((a,b) => counts[b] - counts[a]);
    }
    
    keys = keys.slice(0, 15);
    
    // 원본 데이터와 시각화용 데이터 분리
    const rawValues = keys.map(k => counts[k]);
    
    // 파이프라인 차트 여부 확인
    const isPipeChart = (id === 'chart-pipe-step' || id === 'chart-pipe-reason');
    
    // [제곱근 적용] 값 격차 완화
    const chartValues = isPipeChart ? rawValues.map(v => Math.sqrt(v)) : rawValues;
    
    // 최대값 계산
    const maxPlotValue = Math.max(...chartValues);

    // 3. 차트 그리기
    const ctx = document.getElementById(id).getContext('2d');
    if(App.charts[id]) App.charts[id].destroy();

    App.charts[id] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: keys,
            datasets: [{ 
                label: label, 
                data: chartValues, // 시각화용 값
                backgroundColor: color, 
                borderRadius: 4,
                // 막대 너비 설정
                maxBarThickness: isPipeChart ? 120 : 35,
                barPercentage: isPipeChart ? 0.95 : 0.8,
                categoryPercentage: isPipeChart ? 0.95 : 0.8
            }]
        },
        options: {
            indexAxis: 'x',
            responsive: true, 
            maintainAspectRatio: false,
            layout: { padding: 0 },
            plugins: { 
                legend: { display: false }, 
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return label + ': ' + rawValues[context.dataIndex] + '건';
                        }
                    }
                },
                datalabels: { 
                    color: '#4b5563', 
                    anchor: 'end', 
                    align: 'top', 
                    font: { weight: 'bold', size: 12 },
                    offset: 4,
                    formatter: (val, ctx) => rawValues[ctx.dataIndex]
                } 
            },
            scales: { 
                x: { 
                    grid: { display: false, drawBorder: false },
                    ticks: { font: { size: 11, weight: 'bold' } }
                }, 
                y: { 
                    display: !isPipeChart, 
                    grid: { display: !isPipeChart, drawBorder: false },
                    beginAtZero: true, 
                    // [핵심 수정] 최대 높이를 데이터의 1.1배로 타이트하게 설정 -> 상단 공백 제거
                    max: isPipeChart ? Math.ceil(maxPlotValue * 1.1) : undefined,
                    grace: isPipeChart ? 0 : '10%' 
                } 
            },
            onClick: (e, els) => {
                if(els.length > 0 && fType) toggleFilter(fType, keys[els[0].index], null);
            },
            onHover: (e, els) => e.native.target.style.cursor = els.length ? 'pointer' : 'default'
        }
    });
}
    
function renderTable(id, data, cols) {
    const tbody = document.querySelector(`#${id} tbody`);
    tbody.innerHTML = '';
    if(!data.length) { tbody.innerHTML = `<tr><td colspan="${cols.length}" style="text-align:center;">데이터 없음</td></tr>`; return; }

    data.slice(0, 100).forEach(d => {
        const tr = document.createElement('tr');
        if(d._risk===100 || d._step==='방어실패') tr.classList.add('row-fail');
        cols.forEach(def => {
            let val = d[def.k] || '';
            if(def.fmt) val = def.fmt(val);
            if(def.suffix) val += def.suffix;
            if(def.badge) val = `<span class="badge ${val==='처리완료'?'bd-done':'bd-wait'}">${val}</span>`;
            if(def.btn && val) val = `<a href="${val}" target="_blank" class="btn-map">지도확인</a>`;
            const td = document.createElement('td');
            td.innerHTML = val || '-';
            tr.appendChild(td);
        });
        if(id==='table-voc' && d._lat) {
            tr.onclick = () => { App.map.panTo({lat:d._lat, lng:d._lng}); App.map.setZoom(15); google.maps.event.trigger(d._marker, 'click'); };
        }
        tbody.appendChild(tr);
    });
}

function animateNum(id, target) {
    const el = document.getElementById(id);
    const start = parseInt(el.innerText.replace(/,/g,'')) || 0;
    if(start === target) return;
    let current = start;
    const step = Math.ceil((target - start) / 20);
    const timer = setInterval(() => {
        current += step;
        if ((step > 0 && current >= target) || (step < 0 && current <= target)) {
            current = target;
            clearInterval(timer);
        }
        el.innerText = current.toLocaleString();
    }, 20);
}

function switchView(v) {
    App.view = v;
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    const btns = document.querySelectorAll(`button[onclick="switchView('${v}')"]`);
    btns.forEach(b => b.classList.add('active'));

    document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
    document.getElementById(`view-${v}`).classList.add('active');

    const isPipe = v === 'pipe';
    document.getElementById('fb-hq').style.display = isPipe ? 'block' : 'none';
    document.getElementById('fb-channel').style.display = isPipe ? 'block' : 'none';
    document.getElementById('fb-status').style.display = isPipe ? 'none' : 'block';
    
    setTimeout(() => {
        if(v==='voc' && App.map) google.maps.event.trigger(App.map, 'resize');
        Object.values(App.charts).forEach(c => c.resize());
    }, 200);
    updateDashboard();
}

function triggerUpload() {
    const p = prompt("관리자 비밀번호 입력:");
    if(p==="3867") document.getElementById('fileInput').click();
    else if(p!==null) alert("비밀번호 오류");
}

document.getElementById('fileInput').addEventListener('change', (e) => {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (evt) => {
        const res = Papa.parse(evt.target.result, {header:true, skipEmptyLines:true});
        const h = res.meta.fields || [];
        if(h.some(x=>x.includes('위치좌표'))) {
            App.data.voc = parseVoc(res.data);
            alert("VOC 데이터 갱신 완료");
            switchView('voc');
        } else if(h.some(x=>x.includes('위험도'))) {
            App.data.pipe = parsePipe(res.data);
            alert("파이프라인 데이터 갱신 완료");
            switchView('pipe');
        } else {
            alert("알 수 없는 파일 형식입니다.");
        }
    };
    r.readAsText(f, 'UTF-8');
});
</script>
</body>
</html>
