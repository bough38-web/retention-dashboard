<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>KTT 통합 리텐션 대시보드 (Improved Version)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* 디자인 기본 설정 */
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8; --primary-light: #eff6ff;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --text-main: #0f172a; --text-sub: #64748b; --bg-body: #f8fafc; --bg-card: #ffffff;
            --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        body { margin: 0; display: flex; background: var(--bg-body); font-family: Pretendard, sans-serif; }

        /* 스크롤 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* 로딩 오버레이 추가 */
        #loadingOverlay {
            position: fixed; inset: 0; background: #ffffff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; transition: opacity .5s;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid var(--primary-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin .8s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 사이드바 */
        .sidebar { width: 280px; background: var(--bg-card); border-right: 1px solid var(--border); height: 100vh; display: flex; flex-direction: column; transition: .3s; }
        .sidebar.collapsed { width: 70px; }

        .sidebar-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .sidebar-title { display: flex; gap: 10px; align-items: center; font-size: 18px; font-weight: 800; }
        .sidebar-toggle { cursor: pointer; padding: 6px; color: var(--text-sub); }
        .sidebar-toggle:hover { background: var(--bg-body); border-radius: 6px; color: var(--primary); }

        .sidebar.collapsed .sidebar-title span,
        .sidebar.collapsed .filter-panel { display: none; }

        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* 상단 고정 */
        .sticky-header {
            position: sticky; top: 0; z-index: 40;
            background: rgba(248,250,252,0.95); backdrop-filter: blur(8px);
            padding: 20px 30px 10px; border-bottom: 1px solid transparent; transition: .3s;
        }

        /* KPI 카드 */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 16px; margin-bottom: 20px; }
        .kpi-card {
            background: var(--bg-card); padding: 18px; border-radius: 12px;
            box-shadow: var(--shadow); text-align: center; position: relative;
            border-left: 4px solid var(--primary);
        }
        .kpi-card h3 { font-size: 12px; color: var(--text-sub); margin: 0 0 5px; }
        .kpi-card .value { font-size: 28px; font-weight: 800; color: var(--text-main); }

        /* VOC 상태 배지 추가 */
        .badge.voc-done { background: #dcfce7; color: #166534; }
        .badge.voc-receipt { background: #fff7ed; color: #9a3412; }
        .badge.voc-yet { background: #fee2e2; color: #991b1b; }

        .badge.success { background: #dcfce7; color: #166534; }
        .badge.fail { background: #fee2e2; color: #991b1b; }
        .badge.ing { background: #fff7ed; color: #9a3412; }

        /* 카드 */
        .card { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .toggle-btn { border: none; background: none; cursor: pointer; font-size: 20px; color: var(--text-sub); }
        .card-body { max-height: 800px; transition: max-height .3s ease; overflow: hidden; }
        .card.collapsed .card-body { max-height: 0; padding: 0; }

        /* 차트 */
        .chart-wrapper { height: 300px; }

        /* 테이블 */
        .data-table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        .data-table th { background: #f8fafc; padding: 12px; border-bottom: 1px solid #e2e8f0; cursor: pointer; font-size: 12px; }
        .data-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 12px; }

        .long-text { white-space: normal; text-align: left; }

        .pagination button { padding: 6px 12px; border: 1px solid var(--border); background: #fff; border-radius: 6px; }

    </style>
</head>

<body>

<!-- 로딩 오버레이 추가 -->
<div id="loadingOverlay">
    <div class="spinner"></div>
    <div>데이터 불러오는 중...</div>
</div>

<!-- --------------------------
     사이드바
--------------------------- -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-title">
            <i class="ph ph-chart-polar" style="font-size:24px;color:var(--primary)"></i>
            <span>KTT Dashboard</span>
        </div>
        <div class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="ph ph-list"></i>
        </div>
    </div>

    <div class="sidebar-content">
        <div class="view-switcher">
            <button id="showVocBtn" class="active" onclick="switchView('voc')">VOC 현황</button>
            <button id="showPipelineBtn" onclick="switchView('pipeline')">해지 방어</button>
        </div>

        <!-- VOC 필터 -->
        <div id="vocFilters" class="filter-panel">
            <div class="filter-group">
                <label class="filter-label">VOC 유형</label>
                <select id="vocTypeFilter"></select>
            </div>

            <div class="filter-group">
                <label class="filter-label">처리 상태</label>
                <div id="vocStatusButtons" class="filter-btns">
                    <button class="filter-btn active" onclick="setVocStatus('ALL',this)">전체</button>
                    <button class="filter-btn" onclick="setVocStatus('처리완료',this)">완료</button>
                    <button class="filter-btn" onclick="setVocStatus('접수',this)">접수</button>
                    <button class="filter-btn" onclick="setVocStatus('미접수',this)">미접수</button>
                </div>
            </div>

            <hr>

            <div class="filter-group">
                <label class="filter-label">관리 지사</label>
                <div id="vocBranchButtons" class="filter-btns"></div>
            </div>
            <div class="filter-group">
                <label class="filter-label">담당자</label>
                <div id="vocAgentButtons" class="filter-btns"></div>
            </div>
        </div>

        <!-- Pipeline 필터 -->
        <div id="pipelineFilters" class="filter-panel" style="display:none;">
            <div class="filter-group">
                <label class="filter-label">영업 채널</label>
                <select id="channelFilter">
                    <option value="ALL">전체</option>
                    <option value="SP" selected>SP</option>
                    <option value="SC">SC</option>
                    <option value="AM">AM</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">해지 위험도</label>
                <div class="radio-group">
                    <label><input type="radio" name="risk" value="ALL" checked>전체</label>
                    <label><input type="radio" name="risk" value="0">0~25%</label>
                    <label><input type="radio" name="risk" value="25">25~50%</label>
                    <label><input type="radio" name="risk" value="50">50~75%</label>
                    <label><input type="radio" name="risk" value="75">75%~</label>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">데이터 기준</label>
                <div class="filter-btns">
                    <button class="filter-btn active" onclick="setMode('count',this)">건수</button>
                    <button class="filter-btn" onclick="setMode('amount',this)">금액</button>
                </div>
            </div>

            <hr>

            <div class="filter-group">
                <label>관리 본부</label>
                <div id="pipelineHqButtons" class="filter-btns"></div>
            </div>
            <div class="filter-group">
                <label>관리 지사</label>
                <div id="pipelineBranchButtons" class="filter-btns"></div>
            </div>
            <div class="filter-group">
                <label>담당자</label>
                <div id="pipelineAgentButtons" class="filter-btns"></div>
            </div>
        </div>
    </div>
</div>

<!-- --------------------------
     메인 컨텐츠
--------------------------- -->
<div class="content" id="mainContent">

    <!-- VOC VIEW -->
    <div id="vocView" class="dashboard-view active">
        <div class="sticky-header">
            <h2>고객의 소리 (VOC) 현황</h2>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card"><h3>총 접수</h3><div id="kpi-voc-total" class="value">0</div></div>
            <div class="kpi-card"><h3>처리 완료</h3><div id="kpi-voc-complete" class="value">0</div></div>
            <div class="kpi-card"><h3>처리율</h3><div id="kpi-voc-complete-rate" class="value">0%</div></div>
            <div class="kpi-card"><h3>미접수</h3><div id="kpi-voc-unassigned" class="value">0</div></div>
        </div>

        <div class="chart-grid">
            <div class="card">
                <div class="card-header"><h3>조치 필요 담당자</h3><button class="toggle-btn" onclick="toggleCard(this)">⌃</button></div>
                <div class="card-body"><div class="chart-wrapper"><canvas id="vocActivityChart"></canvas></div></div>
            </div>

            <div class="card">
                <div class="card-header"><h3>지사별 처리 현황</h3><button class="toggle-btn" onclick="toggleCard(this)">⌃</button></div>
                <div class="card-body"><div class="chart-wrapper"><canvas id="vocBranchChart"></canvas></div></div>
            </div>

            <div class="card">
                <div class="card-header"><h3>담당자별 처리 실적</h3><button class="toggle-btn" onclick="toggleCard(this)">⌃</button></div>
                <div class="card-body"><div class="chart-wrapper"><canvas id="vocAgentChart"></canvas></div></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>상세 목록</h3>
                <button class="toggle-btn" onclick="toggleCard(this)">⌃</button>
            </div>
            <div class="card-body">
                <table id="vocListTable" class="data-table">
                    <thead>
                        <tr>
                            <th data-field="관리지사">지사</th>
                            <th data-field="담당자">담당자</th>
                            <th data-field="계약번호">계약번호</th>
                            <th data-field="상호">상호명</th>
                            <th data-field="상태">상태</th>
                            <th data-field="VOC유형소">서비스(소)</th>
                            <th data-field="합산월정료">합산월정료</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="pagination">
                    <button onclick="changePage('voc',-1)">이전</button>
                    <button onclick="changePage('voc',1)">다음</button>
                </div>
                <div id="vocPaginationInfo"></div>
            </div>
        </div>
    </div>

    <!-- PIPELINE VIEW -->
    <div id="pipelineView" class="dashboard-view">
        <div class="sticky-header">
            <h2>해지 파이프라인 현황</h2>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card"><h3>대상 건수</h3><div id="kpi-pipeline-count" class="value">0</div></div>
            <div class="kpi-card"><h3>월정료(천원)</h3><div id="kpi-pipeline-amount" class="value">0</div></div>
            <div class="kpi-card"><h3>고위험</h3><div id="kpi-high-risk-count" class="value">0</div></div>
            <div class="kpi-card"><h3>방어 성공률</h3><div id="kpi-defense-success-rate" class="value">0%</div></div>
        </div>

        <div class="chart-grid">
            <div class="card">
                <div class="card-header"><h3>지사별 단계</h3><button class="toggle-btn" onclick="toggleCard(this)">⌃</button></div>
                <div class="card-body"><div class="chart-wrapper"><canvas id="pipelineBranchStageChart"></canvas></div></div>
            </div>

            <div class="card">
                <div class="card-header"><h3>위험도 / 월정료</h3><button class="toggle-btn" onclick="toggleCard(this)">⌃</button></div>
                <div class="card-body"><div class="chart-wrapper"><canvas id="pipelineRiskBubbleChart"></canvas></div></div>
            </div>

            <div class="card">
                <div class="card-header"><h3>방어 성공률 TOP</h3><button class="toggle-btn" onclick="toggleCard(this)">⌃</button></div>
                <div class="card-body"><div class="chart-wrapper"><canvas id="pipelineDefenseSuccessRateChart"></canvas></div></div>
            </div>

            <div class="card">
                <div class="card-header"><h3>담당자별 실패 TOP</h3><button class="toggle-btn" onclick="toggleCard(this)">⌃</button></div>
                <div class="card-body"><div class="chart-wrapper"><canvas id="pipelineAgentFailChart"></canvas></div></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>상세 목록</h3>
                <button class="toggle-btn" onclick="toggleCard(this)">⌃</button>
            </div>
            <div class="card-body">
                <table id="pipelineListTable" class="data-table">
                    <thead>
                        <tr>
                            <th data-field="관리본부">본부</th>
                            <th data-field="관리지사">지사</th>
                            <th data-field="담당자">담당자</th>
                            <th data-field="계약번호">계약번호</th>
                            <th data-field="상호">상호명</th>
                            <th data-field="담당영업채널">채널</th>
                            <th data-field="KTT월정료(조정)">월정료</th>
                            <th data-field="재계약여부">재계약</th>
                            <th data-field="방어진행단계">단계</th>
                            <th data-field="해지위험도">위험도</th>
                            <th data-field="해지예정일">해지예정일</th>
                            <th data-field="등록일자">등록일자</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="pagination">
                    <button onclick="changePage('pipeline',-1)">이전</button>
                    <button onclick="changePage('pipeline',1)">다음</button>
                </div>
                <div id="pipelinePaginationInfo"></div>
            </div>
        </div>
    </div>

</div>

<script>
/* ------------------------------------------------------------------
   유틸리티 함수
------------------------------------------------------------------ */
const util = {
    clean: v => String(v || "").trim(),
    branch: v => String(v || "").replace("지사","").trim(),
    num: v => parseFloat(String(v).replace(/,/g,"")) || 0,
    thous: v => Math.round(util.num(v)/1000),
    fmt: v => v.toLocaleString(),

    /* 날짜 변환 */
    date: v => {
        if (!v) return null;
        if (String(v).match(/^\d{4}-\d{2}-\d{2}$/)) return new Date(v);

        const sn = parseFloat(v);
        if (!isNaN(sn) && sn > 10000 && sn < 60000) {
            return new Date((sn - 25569) * 86400 * 1000);
        }
        return null;
    }
};

/* ------------------------------------------------------------------
   상태
------------------------------------------------------------------ */
const state = {
    currentView: "voc",

    voc: {
        data: [],
        filtered: [],
        page: 1,
        limit: 15,
        sortField: "VOC유형대",
        sortDir: "desc",
        branch: "ALL",
        agent: "ALL",
        status: "ALL"
    },

    pipeline: {
        data: [],
        filtered: [],
        page: 1,
        limit: 15,
        sortField: "KTT월정료(조정)",
        sortDir: "desc",
        mode: "count",
        hq: "ALL",
        branch: "ALL",
        agent: "ALL",
        channel: "SP",
        risk: "ALL"
    }
};

let chartInstances = {};

/* ------------------------------------------------------------------
   초기화
------------------------------------------------------------------ */
window.onload = () => {
    Chart.register(ChartDataLabels);

    state.voc.data = generateSampleVoc();
    state.pipeline.data = generateSamplePipeline();

    initUI();
    runVoc();
    runPipe();

    setTimeout(() => document.getElementById("loadingOverlay").style.opacity = 0, 200);
    setTimeout(() => document.getElementById("loadingOverlay").remove(), 800);
};

/* ------------------------------------------------------------------
   샘플데이터
------------------------------------------------------------------ */
function generateSampleVoc() {
    const brs = ["중앙","강북","서대문","고양","의정부","남양주","강릉","원주"];
    const ags = ["김철수","이영희","박민수","최지우","정수진","홍길동"];
    const sts = ["처리완료","접수","미접수"];
    const typs = ["요금문의","서비스문의","품질불만","해지문의"];

    return Array.from({length:200},(_,i)=>({
        "관리지사":brs[Math.floor(Math.random()*brs.length)]+"지사",
        "담당자":ags[Math.floor(Math.random()*ags.length)],
        "계약번호":"1000"+(1000+i),
        "상호":"테스트상호"+i,
        "상태":sts[Math.floor(Math.random()*sts.length)],
        "VOC유형대":typs[Math.floor(Math.random()*typs.length)],
        "VOC유형소":"상세문의",
        "합산월정료":Math.floor(Math.random()*400000)+30000
    }));
}

function generateSamplePipeline() {
    const brs = ["중앙","강북","서대문","고양","의정부","남양주","강릉","원주"];
    const ags = ["김철수","이영희","박민수","최지우","정수진","홍길동"];
    const stgs = ["방어성공","방어실패","진행중"];
    const chs = ["SP","SC","AM"];

    return Array.from({length:200},(_,i)=>({
        "관리본부":"강북/강원",
        "관리지사":brs[Math.floor(Math.random()*brs.length)]+"지사",
        "담당자":ags[Math.floor(Math.random()*ags.length)],
        "계약번호":"2000"+(1000+i),
        "상호":"상호"+i,
        "담당영업채널":chs[Math.floor(Math.random()*chs.length)],
        "KTT월정료(조정)":Math.floor(Math.random()*700000)+50000,
        "재계약여부":Math.random()>0.5?"Y":"N",
        "해지위험도":Math.floor(Math.random()*100),
        "방어진행단계":stgs[Math.floor(Math.random()*stgs.length)],
        "해지예정일":"45990",
        "등록일자":"45985"
    }));
}

/* ------------------------------------------------------------------
   UI 초기화
------------------------------------------------------------------ */
function initUI() {
    const vt = [...new Set(state.voc.data.map(r=>util.clean(r["VOC유형대"])))];
    document.getElementById("vocTypeFilter").innerHTML =
        `<option value="ALL">전체</option>` +
        vt.map(v=>`<option value="${v}">${v}</option>`).join("");

    renderBtns("voc","branch");
    renderBtns("voc","agent");

    renderBtns("pipeline","hq");
    renderBtns("pipeline","branch");
    renderBtns("pipeline","agent");

    document.getElementById("channelFilter").onchange = () => {
        state.pipeline.channel = event.target.value;
        runPipe();
    };

    document.querySelectorAll('input[name="risk"]').forEach(r =>
        r.addEventListener("change", () => {
            state.pipeline.risk = r.value;
            runPipe();
        })
    );

    setupTableSort("voc");
    setupTableSort("pipeline");
}

/* ------------------------------------------------------------------
   버튼 렌더링
------------------------------------------------------------------ */
function renderBtns(view,type) {
    const c = document.getElementById(`${view}${capitalize(type)}Buttons`);
    let d = state[view].data;
    const s = state[view];

    if (view === "voc") {
        if (type === "agent" && s.branch !== "ALL")
            d = d.filter(r => util.branch(r["관리지사"]) === s.branch);
    } else {
        if (type !== "hq" && s.hq !== "ALL") d = d.filter(r => util.clean(r["관리본부"]) === s.hq);
        if (type === "agent" && s.branch !== "ALL") d = d.filter(r => util.branch(r["관리지사"]) === s.branch);
    }

    let items = [];
    if (type === "hq") items = [...new Set(d.map(r=>util.clean(r["관리본부"])))];
    else if (type === "branch") items = [...new Set(d.map(r=>util.branch(r["관리지사"])))];
    else items = [...new Set(d.map(r=>util.clean(r["담당자"])))];

    c.innerHTML =
        `<button class="filter-btn ${s[type]==="ALL"?"active":""}" onclick="setFilter('${view}','${type}','ALL')">전체</button>` +
        items.map(i =>
            `<button class="filter-btn ${s[type]===i?"active":""}" onclick="setFilter('${view}','${type}','${i}')">${i}</button>`
        ).join("");
}

function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

/* ------------------------------------------------------------------
   필터 설정
------------------------------------------------------------------ */
function setFilter(view,type,val){
    state[view][type] = val;

    if (view==="pipeline" && type==="hq") {
        state.pipeline.branch="ALL";
        state.pipeline.agent="ALL";
        renderBtns("pipeline","branch");
        renderBtns("pipeline","agent");
    }
    if (type==="branch") {
        state[view].agent="ALL";
        renderBtns(view,"agent");
    }

    renderBtns(view,type);
    view==="voc" ? runVoc() : runPipe();
}

function setVocStatus(val,btn){
    state.voc.status = val;
    btn.parentNode.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    runVoc();
}

function setMode(val,btn){
    state.pipeline.mode = val;
    btn.parentNode.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    runPipe();
}

/* ------------------------------------------------------------------
   뷰 전환
------------------------------------------------------------------ */
function switchView(v){
    state.currentView = v;

    document.querySelectorAll(".dashboard-view").forEach(x=>x.classList.remove("active"));
    document.getElementById(`${v}View`).classList.add("active");

    document.getElementById("vocFilters").style.display = v==="voc" ? "block" : "none";
    document.getElementById("pipelineFilters").style.display = v==="pipeline" ? "block" : "none";

    setTimeout(()=>{
        Object.values(chartInstances).forEach(c=>c && c.resize());
    },150);
}

function toggleSidebar(){
    document.getElementById("sidebar").classList.toggle("collapsed");
}

function toggleCard(btn){
    const card = btn.closest(".card");
    card.classList.toggle("collapsed");
}

/* ------------------------------------------------------------------
   VOC 로직
------------------------------------------------------------------ */
function runVoc(){
    const s = state.voc;
    const type = document.getElementById("vocTypeFilter").value;

    s.filtered = s.data.filter(r=>{
        if (type !== "ALL" && util.clean(r["VOC유형대"]) !== type) return false;
        if (s.status !== "ALL" && util.clean(r["상태"]) !== s.status) return false;
        if (s.branch !== "ALL" && util.branch(r["관리지사"]) !== s.branch) return false;
        if (s.agent !== "ALL" && util.clean(r["담당자"]) !== s.agent) return false;
        return true;
    });

    s.page = 1;

    updateVocKPIs();
    drawVocCharts();
    renderTable("voc");
}

function updateVocKPIs(){
    const d = state.voc.filtered;
    const comp = d.filter(r=>r["상태"]==="처리완료").length;
    const yet = d.filter(r=>r["상태"]==="미접수").length;

    document.getElementById("kpi-voc-total").innerText = d.length;
    document.getElementById("kpi-voc-complete").innerText = comp;
    document.getElementById("kpi-voc-complete-rate").innerText = d.length ? (comp/d.length*100).toFixed(1)+"%" : "0%";
    document.getElementById("kpi-voc-unassigned").innerText = yet;
}

/* VOC 차트 */
function drawVocCharts(){
    const d = state.voc.filtered;

    /* (1) 담당자 활동 */
    const act = {};
    d.forEach(r=>{
        const a = util.clean(r["담당자"]);
        const s = util.clean(r["상태"]);
        if (!act[a]) act[a]={yet:0,rcpt:0,sum:0};
        if (s==="미접수") act[a].yet++;
        if (s==="접수") act[a].rcpt++;
        if (s==="미접수"||s==="접수") act[a].sum++;
    });

    const topAct = Object.entries(act).sort((a,b)=>b[1].sum-a[1].sum).slice(0,10);

    newChart("vocActivityChart",{
        type:"bar",
        data:{
            labels:topAct.map(e=>e[0]),
            datasets:[
                {label:"미접수",data:topAct.map(e=>e[1].yet),backgroundColor:"#ef4444"},
                {label:"접수",data:topAct.map(e=>e[1].rcpt),backgroundColor:"#f59e0b"}
            ]
        },
        options:{ indexAxis:"y", scales:{x:{stacked:true},y:{stacked:true}} }
    });

    /* (2) 지사 */
    const br={};
    d.forEach(r=>{
        const b = util.branch(r["관리지사"]);
        if (!br[b]) br[b]={done:0,rcpt:0,yet:0};
        const s=util.clean(r["상태"]);
        if (s==="처리완료") br[b].done++;
        if (s==="접수") br[b].rcpt++;
        if (s==="미접수") br[b].yet++;
    });

    const brList = Object.keys(br);

    newChart("vocBranchChart",{
        type:"bar",
        data:{
            labels:brList,
            datasets:[
                {label:"완료",data:brList.map(k=>br[k].done),backgroundColor:"#3b82f6"},
                {label:"접수",data:brList.map(k=>br[k].rcpt),backgroundColor:"#fbbf24"},
                {label:"미접수",data:brList.map(k=>br[k].yet),backgroundColor:"#f87171"}
            ]
        },
        options:{ scales:{x:{stacked:true},y:{stacked:true}} }
    });

    /* (3) 담당자 처리완료 */
    const ag={};
    d.forEach(r=>{
        if (r["상태"]==="처리완료") {
            const a = util.clean(r["담당자"]);
            ag[a]=(ag[a]||0)+1;
        }
    });

    const agTop = Object.entries(ag).sort((a,b)=>b[1]-a[1]).slice(0,20);

    newChart("vocAgentChart",{
        type:"bar",
        data:{ labels:agTop.map(e=>e[0]), datasets:[{label:"처리완료",data:agTop.map(e=>e[1]),backgroundColor:"#2563eb"}] },
        options:{ indexAxis:"y" }
    });
}

/* ------------------------------------------------------------------
   Pipeline 로직
------------------------------------------------------------------ */
function runPipe(){
    const s = state.pipeline;

    s.filtered = s.data.filter(r=>{
        const ch = r["담당영업채널"];
        const risk = r["해지위험도"];
        const br = util.branch(r["관리지사"]);

        if (s.channel !== "ALL" && ch !== s.channel) return false;

        if (s.risk !== "ALL") {
            const rv = Number(s.risk);
            if (rv===75 && risk < 75) return false;
            if (rv!==75 && !(risk>=rv && risk<rv+25)) return false;
        }

        if (s.hq !== "ALL" && util.clean(r["관리본부"]) !== s.hq) return false;
        if (s.branch !== "ALL" && br !== s.branch) return false;
        if (s.agent !== "ALL" && util.clean(r["담당자"]) !== s.agent) return false;

        return true;
    });

    s.page = 1;

    updatePipeKPIs();
    drawPipeCharts();
    renderTable("pipeline");
}

function updatePipeKPIs(){
    const d = state.pipeline.filtered;

    const amt = d.reduce((s,r)=>s+util.thous(r["KTT월정료(조정)"]),0);
    const suc = d.filter(r=>r["방어진행단계"]==="방어성공").length;
    const tot = d.filter(r=>["방어성공","방어실패","진행중"].includes(r["방어진행단계"])).length;

    document.getElementById("kpi-pipeline-count").innerText = d.length;
    document.getElementById("kpi-pipeline-amount").innerText = util.fmt(amt);
    document.getElementById("kpi-high-risk-count").innerText = util.fmt(d.filter(r=>r["해지위험도"]>=75).length);
    document.getElementById("kpi-defense-success-rate").innerText = tot ? (suc/tot*100).toFixed(1)+"%" : "0%";
}

function drawPipeCharts(){
    const d = state.pipeline.filtered;
    const mode = state.pipeline.mode;

    /* (1) 지사 단계 */
    const br = {};
    d.forEach(r=>{
        const b = util.branch(r["관리지사"]);
        const v = mode==="amount" ? util.thous(r["KTT월정료(조정)"]) : 1;

        if (!br[b]) br[b]={suc:0,fail:0,ing:0,tot:0};

        if (r["방어진행단계"]==="방어성공") br[b].suc+=v;
        if (r["방어진행단계"]==="방어실패") br[b].fail+=v;
        if (r["방어진행단계"]==="진행중") br[b].ing+=v;

        if (["방어성공","방어실패","진행중"].includes(r["방어진행단계"])) br[b].tot+=v;
    });

    const brSorted = Object.entries(br).sort((a,b)=>b[1].tot-a[1].tot).slice(0,10);

    newChart("pipelineBranchStageChart",{
        type:"bar",
        data:{
            labels:brSorted.map(e=>e[0]),
            datasets:[
                {label:"성공",data:brSorted.map(e=>e[1].suc),backgroundColor:"#10b981"},
                {label:"진행",data:brSorted.map(e=>e[1].ing),backgroundColor:"#fbbf24"},
                {label:"실패",data:brSorted.map(e=>e[1].fail),backgroundColor:"#ef4444"}
            ]
        },
        options:{ scales:{x:{stacked:true},y:{stacked:true}} }
    });

    /* (2) 버블차트 */
    const bubble = Object.keys(br).map(k=>{
        const sub = d.filter(r=>util.branch(r["관리지사"])===k);

        const avgRisk = sub.reduce((s,r)=>s+r["해지위험도"],0)/sub.length;
        const avgAmt = sub.reduce((s,r)=>s+util.thous(r["KTT월정료(조정)"]),0)/sub.length;

        return {
            label:k,
            data:[{x:avgRisk, y:avgAmt, r:Math.sqrt(avgAmt)}],
            backgroundColor:"rgba(59,130,246,0.5)"
        };
    });

    newChart("pipelineRiskBubbleChart",{
        type:"bubble",
        data:{datasets:bubble},
        options:{
            scales:{ x:{min:0,max:100}, y:{} },
            plugins:{legend:{display:false}}
        }
    });

    /* (3) 성공률 */
    const list = brSorted.map(e=>{
        return { name:e[0], rate:e[1].tot? (e[1].suc/e[1].tot*100) : 0 };
    }).sort((a,b)=>b.rate-a.rate).slice(0,5);

    newChart("pipelineDefenseSuccessRateChart",{
        type:"line",
        data:{
            labels:list.map(e=>e.name),
            datasets:[{data:list.map(e=>e.rate),borderColor:"#10b981",tension:0.3}]
        },
        options:{ plugins:{legend:{display:false}}, scales:{y:{min:0,max:100}} }
    });

    /* (4) 실패 top */
    const fail = {};
    d.filter(r=>r["방어진행단계"]==="방어실패").forEach(r=>{
        const a = util.clean(r["담당자"]);
        fail[a]=(fail[a]||0)+1;
    });

    const failTop = Object.entries(fail).sort((a,b)=>b[1]-a[1]).slice(0,10);

    newChart("pipelineAgentFailChart",{
        type:"bar",
        data:{
            labels:failTop.map(e=>e[0]),
            datasets:[{data:failTop.map(e=>e[1]),backgroundColor:"#ef4444"}]
        },
        options:{ indexAxis:"y", plugins:{legend:{display:false}} }
    });
}

/* ------------------------------------------------------------------
   차트 생성 헬퍼
------------------------------------------------------------------ */
function newChart(id,config){
    if (chartInstances[id]) chartInstances[id].destroy();
    chartInstances[id] = new Chart(document.getElementById(id), {
        ...config,
        options:{responsive:true, maintainAspectRatio:false, ...config.options}
    });
}

/* ------------------------------------------------------------------
   테이블 렌더링 & 정렬
------------------------------------------------------------------ */
function setupTableSort(type){
    document.querySelectorAll(`#${type}ListTable th[data-field]`).forEach(th=>{
        th.onclick = () => {
            const f = th.dataset.field;
            const s = state[type];

            if (s.sortField === f) {
                s.sortDir = s.sortDir==="asc" ? "desc" : "asc";
            } else {
                s.sortField = f;
                s.sortDir = "desc";
            }

            document.querySelectorAll(`#${type}ListTable th`).forEach(h=>{
                h.innerText = h.innerText.replace(/ ▲| ▼/g,"");
            });
            th.innerText += s.sortDir==="asc" ? " ▲" : " ▼";

            renderTable(type);
        };
    });
}

function renderTable(type){
    const s = state[type];
    const table = document.querySelector(`#${type}ListTable tbody`);
    table.innerHTML = "";

    const sorted = [...s.filtered].sort((a,b)=>{
        let va = a[s.sortField];
        let vb = b[s.sortField];

        /* 날짜 정렬 */
        if (s.sortField.includes("일자")) {
            va = util.date(va)?.getTime() || 0;
            vb = util.date(vb)?.getTime() || 0;
        }
        /* 숫자 정렬 */
        else if (String(va).match(/^[0-9,]+$/)) {
            va = util.num(va);
            vb = util.num(vb);
        }

        return s.sortDir==="asc" ? va-vb : vb-va;
    });

    const start = (s.page-1)*s.limit;
    const items = sorted.slice(start,start+s.limit);
    const total = Math.ceil(sorted.length/s.limit);

    document.querySelector(`#${type}PaginationInfo`).innerText =
        `총 ${sorted.length}건 중 ${start+1} ~ ${start+items.length}`;

    document.querySelectorAll(`#${type}View .pagination button`)[0].disabled = s.page<=1;
    document.querySelectorAll(`#${type}View .pagination button`)[1].disabled = s.page>=total;

    items.forEach(r=>{
        const tr = document.createElement("tr");

        if (type==="voc") {
            tr.innerHTML = `
                <td>${util.branch(r["관리지사"])}</td>
                <td>${r["담당자"]}</td>
                <td>${r["계약번호"]}</td>
                <td>${r["상호"]}</td>
                <td><span class="badge ${
                    r["상태"]==="처리완료" ? "voc-done" :
                    r["상태"]==="접수" ? "voc-receipt" : "voc-yet"
                }">${r["상태"]}</span></td>
                <td>${r["VOC유형소"]}</td>
                <td>${util.fmt(util.thous(r["합산월정료"]))}</td>
            `;
        } else {
            tr.innerHTML = `
                <td>${r["관리본부"]}</td>
                <td>${util.branch(r["관리지사"])}</td>
                <td>${r["담당자"]}</td>
                <td>${r["계약번호"]}</td>
                <td>${r["상호"]}</td>
                <td>${r["담당영업채널"]}</td>
                <td>${util.fmt(util.thous(r["KTT월정료(조정)"]))}</td>
                <td>${r["재계약여부"]}</td>
                <td><span class="badge ${
                    r["방어진행단계"]==="방어성공" ? "success" :
                    r["방어진행단계"]==="방어실패" ? "fail" : "ing"
                }">${r["방어진행단계"]}</span></td>
                <td>${r["해지위험도"]}%</td>
                <td>${util.date(r["해지예정일"])?.toISOString().slice(0,10) || "-"}</td>
                <td>${util.date(r["등록일자"])?.toISOString().slice(0,10) || "-"}</td>
            `;
        }

        table.appendChild(tr);
    });
}

function changePage(type,delta){
    state[type].page += delta;
    renderTable(type);
}

</script>

</body>
</html>
