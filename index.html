<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>KTT í†µí•© ëŒ€ì‹œë³´ë“œ (ê³ ê¸‰í™” ê°œì„ )</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì • */
        body {
            margin: 0;
            display: flex;
            background: #f5f5f7;
            font-family: "Apple SD Gothic Neo", "Segoe UI", sans-serif;
            color: #333;
        }

        /* ë ˆì´ì•„ì›ƒ */
        .sidebar {
            width: 280px;
            background: #ffffff;
            padding: 20px;
            border-right: 1px solid #ddd;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 6px rgba(0,0,0,0.02);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* ë·° í† ê¸€ ë²„íŠ¼ */
        .view-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            padding: 0 0 10px 0;
            border-bottom: 1px solid #eee;
        }

        .view-switcher button {
            flex: 1;
            padding: 12px 15px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid #ccc; /* í…Œë‘ë¦¬ ì–‡ê²Œ ì¡°ì • */
            border-radius: 8px;
            background: #f9fafb;
            color: #4b5563;
            transition: all 0.2s;
        }

        .view-switcher button.active {
            background: #3b82f6;
            color: #fff;
            border-color: #2563eb;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        /* ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼ */
        .sidebar h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #1f2937;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 5px solid #3b82f6;
            transition: transform 0.3s;
        }
        
        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .kpi-title {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }

        .chart-card, .list-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        /* AI ë¦¬ë·° ë°•ìŠ¤ ì œê±° (ìš”ì²­ ë°˜ì˜) */
        
        .card-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f3f4f6;
        }

        .card-header h3 {
            font-size: 18px;
            margin: 0;
            color: #1f2937;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        /* í¼ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
        select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #ffffff;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        label {
            display: block;
            padding: 8px 0 4px;
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
        }
        
        /* ë¼ë””ì˜¤ ë²„íŠ¼ ê·¸ë£¹ */
        .radio-group label {
            display: inline-flex;
            align-items: center;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin: 2px;
            font-weight: 400;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .radio-group input[type="radio"] {
            margin-right: 5px;
            accent-color: #3b82f6;
        }

        /* ë²„íŠ¼ì‹ í•„í„° ìŠ¤íƒ€ì¼ */
        .filter-group {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px dotted #ddd;
        }

        .filter-group-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .filter-btn {
            flex: 0 0 auto;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            font-size: 12px;
            width: auto;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #e5e7eb;
        }

        .filter-btn.active {
            background: #3b82f6;
            color: #fff;
            border-color: #2563eb;
            font-weight: 600;
        }
        
        .mode-btn.active {
            background: #10b981;
            color: #fff;
            border-color: #059669;
        }

        /* ë°ì´í„° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .data-table th {
            background-color: #f9fafb;
            font-weight: 700;
            color: #4b5563;
            cursor: pointer;
        }
        
        .list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        /* ë·° ìˆ¨ê¸°ê¸° */
        .dashboard-view {
            display: none;
        }
        
        .dashboard-view.active {
            display: block;
        }

    </style>
</head>

<body>

<div class="sidebar">
    <h2>ğŸ“Š í†µí•© ëŒ€ì‹œë³´ë“œ í•„í„°</h2>

    <div class="view-switcher">
        <button id="showVocBtn" onclick="switchView('voc')">VOC í™œë™ í˜„í™©</button>
        <button id="showPipelineBtn" class="active" onclick="switchView('pipeline')">í•´ì§€íŒŒì´í”„ë¼ì¸ í˜„í™©</button>
    </div>
    
    <div id="vocFilters" class="filter-panel" style="display:none;">
        <label for="vocTypeFilter">VOC ìœ í˜• ëŒ€</label>
        <select id="vocTypeFilter">
            <option value="ALL">ì „ì²´</option>
            </select>
        
        <label>VOC ìƒíƒœ</label>
        <div id="vocStatusButtons" class="filter-buttons">
            <button class="filter-btn active" data-value="ALL" onclick="setVocStatus('ALL', this)">ì „ì²´</button>
            <button class="filter-btn" data-value="ì²˜ë¦¬ì™„ë£Œ" onclick="setVocStatus('ì²˜ë¦¬ì™„ë£Œ', this)">ì²˜ë¦¬ì™„ë£Œ</button>
            <button class="filter-btn" data-value="ì ‘ìˆ˜" onclick="setVocStatus('ì ‘ìˆ˜', this)">ì ‘ìˆ˜</button>
            <button class="filter-btn" data-value="ë¯¸ì ‘ìˆ˜" onclick="setVocStatus('ë¯¸ì ‘ìˆ˜', this)">ë¯¸ì ‘ìˆ˜</button>
        </div>
    </div>
    
    <div id="pipelineFilters" class="filter-panel">
        <label for="channelFilter">ë‹´ë‹¹ì˜ì—…ì±„ë„</label>
        <select id="channelFilter">
            <option value="ALL">ì „ì²´</option>
            <option value="SP">SP</option> <option value="SC">SC</option>
            <option value="AM">AM</option>
        </select>

        <label>í•´ì§€ìœ„í—˜ë„ (%)</label>
        <div class="radio-group" style="display: flex; flex-wrap: wrap; gap: 5px;">
            <label><input type="radio" name="risk" value="ALL" checked> ì „ì²´</label>
            <label><input type="radio" name="risk" value="0"> 0 ~ 25%</label>
            <label><input type="radio" name="risk" value="25"> 25 ~ 50%</label>
            <label><input type="radio" name="risk" value="50"> 50 ~ 75%</label>
            <label><input type="radio" name="risk" value="75"> 75 ~ 100%</label>
        </div>

        <label>í‘œì‹œ ê¸°ì¤€</label>
        <div class="filter-buttons">
            <button class="mode-btn active" data-mode="count" onclick="setMode('count', this)">ê±´ìˆ˜</button>
            <button class="mode-btn" data-mode="amount" onclick="setMode('amount', this)">ê¸ˆì•¡(ì²œì›)</button>
        </div>
        
        <div class="filter-group">
            <div class="filter-group-title">ê´€ë¦¬ë³¸ë¶€</div>
            <div id="pipelineHqButtons" class="filter-buttons">
                </div>
        </div>

        <div class="filter-group">
            <div class="filter-group-title">ê´€ë¦¬ì§€ì‚¬</div>
            <div id="pipelineBranchButtons" class="filter-buttons">
                </div>
        </div>

        <div class="filter-group">
            <div class="filter-group-title">ë‹´ë‹¹ì</div>
            <div id="pipelineAgentButtons" class="filter-buttons">
                </div>
        </div>
    </div>
</div>

<div class="content">

    <div id="vocView" class="dashboard-view">
        <h2>ğŸ’¬ ê´€ë¦¬ê³ ê° í•´ì§€ê³ ìœ„í—˜ ì¬ê³„ì•½ í™œë™ í˜„í™©</h2>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">ì´ VOC ê±´ìˆ˜</div>
                <div id="kpi-voc-total" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #10b981;">
                <div class="kpi-title">ì²˜ë¦¬ì™„ë£Œ ê±´ìˆ˜</div>
                <div id="kpi-voc-complete" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #f59e0b;">
                <div class="kpi-title">ì²˜ë¦¬ ì™„ë£Œìœ¨ (%)</div>
                <div id="kpi-voc-complete-rate" class="kpi-value">0%</div>
            </div>
            <div class="kpi-card" style="border-left-color: #ef4444;">
                <div class="kpi-title">ë¯¸ì ‘ìˆ˜ ê±´ìˆ˜</div>
                <div id="kpi-voc-unassigned" class="kpi-value">0</div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <div class="card-header">
                    <h3>ğŸ’¬ VOC ê´€ë¦¬ì§€ì‚¬ë³„ ìƒíƒœ (ì ì¸µ)</h3>
                </div>
                <canvas id="vocBranchChart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="card-header">
                    <h3>ğŸ‘¨â€ğŸ’¼ VOC ë‹´ë‹¹ìë³„ ìƒíƒœ (Top 20)</h3>
                </div>
                <canvas id="vocAgentChart"></canvas>
            </div>
        </div>

        <div class="list-card">
            <div class="card-header">
                <h3>ğŸ“ í•„í„°ë§ëœ VOC ìƒì„¸ ë¦¬ìŠ¤íŠ¸</h3>
                <p style="font-size: 12px; color: #9ca3af; margin: 5px 0 0;">(í…Œì´ë¸” í—¤ë” í´ë¦­ ì‹œ ì •ë ¬)</p>
            </div>
            <div class="list-container">
                <table id="vocListTable" class="data-table">
                    <thead>
                        <tr>
                            <th data-field="ìƒíƒœ">ìƒíƒœ</th>
                            <th data-field="VOCìœ í˜•ëŒ€">ìœ í˜• ëŒ€</th>
                            <th data-field="VOCìœ í˜•ì¤‘">ìœ í˜• ì¤‘</th>
                            <th data-field="VOCìœ í˜•ì†Œ">ìœ í˜• ì†Œ</th>
                            <th data-field="ê´€ë¦¬ë³¸ë¶€">ê´€ë¦¬ë³¸ë¶€</th>
                            <th data-field="ê´€ë¦¬ì§€ì‚¬">ê´€ë¦¬ì§€ì‚¬</th>
                            <th data-field="ë‹´ë‹¹ì">ë‹´ë‹¹ì</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="pipelineView" class="dashboard-view active">
        <h2>ğŸ”¥ í•´ì§€íŒŒì´í”„ë¼ì¸ ë“±ë¡ í˜„í™©</h2>
        
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">í•´ì§€íŒŒì´í”„ë¼ì¸ ì´ ê±´ìˆ˜</div>
                <div id="kpi-pipeline-count" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #10b981;">
                <div class="kpi-title">ì´ ì›”ì •ë£Œ ê¸ˆì•¡ (ì²œì›)</div>
                <div id="kpi-pipeline-amount" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #ef4444;">
                <div class="kpi-title">í•´ì§€ê³ ìœ„í—˜ (75%~) ê±´ìˆ˜</div>
                <div id="kpi-high-risk-count" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #f59e0b;">
                <div class="kpi-title">ë°©ì–´ ì„±ê³µë¥  (%)</div>
                <div id="kpi-defense-success-rate" class="kpi-value">0%</div>
            </div>
        </div>
        
        <div class="chart-grid">
            <div class="chart-card">
                <div class="card-header">
                    <h3>ğŸ“ˆ ì§€ì‚¬ë³„ íŒŒì´í”„ë¼ì¸ ì§„í–‰ ë‹¨ê³„ (ê³„ë‹¨í˜• ëˆ„ì  ë§‰ëŒ€)</h3>
                    <p id="branchChartModeText" style="font-size: 12px; color: #9ca3af; margin: 5px 0 0;">(ê±´ìˆ˜ ê¸°ì¤€, Top 10 ì§€ì‚¬)</p>
                </div>
                <canvas id="pipelineBranchStageChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="card-header">
                    <h3>âš ï¸ í•´ì§€ ìœ„í—˜ë„ vs ì›”ì •ë£Œ ë¶„í¬ (ë²„ë¸” ì°¨íŠ¸)</h3>
                </div>
                <canvas id="pipelineRiskBubbleChart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="card-header">
                    <h3>ğŸ¯ Top 5 ì§€ì‚¬ ë°©ì–´ ì„±ê³µë¥  ë²¤ì¹˜ë§ˆí¬</h3>
                </div>
                <canvas id="pipelineDefenseSuccessRateChart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="card-header">
                    <h3>ğŸ“‰ ë‹´ë‹¹ìë³„ ë°©ì–´ ì‹¤íŒ¨ ê±´ìˆ˜ (Top 10)</h3>
                </div>
                <canvas id="pipelineAgentFailChart"></canvas>
            </div>
        </div>

        <div class="list-card">
            <div class="card-header">
                <h3>ğŸ“ í•„í„°ë§ëœ í•´ì§€íŒŒì´í”„ë¼ì¸ ìƒì„¸ ë¦¬ìŠ¤íŠ¸</h3>
                <p style="font-size: 12px; color: #9ca3af; margin: 5px 0 0;">(í…Œì´ë¸” í—¤ë” í´ë¦­ ì‹œ ì •ë ¬)</p>
            </div>
            <div class="list-container">
                <table id="pipelineListTable" class="data-table">
                    <thead>
                        <tr>
                            <th data-field="ê³„ì•½ë²ˆí˜¸" data-sort="asc">ê³„ì•½ë²ˆí˜¸</th>
                            <th data-field="ê´€ë¦¬ì§€ì‚¬">ê´€ë¦¬ì§€ì‚¬</th>
                            <th data-field="í•´ì§€ìœ„í—˜ë„" data-sort="none">ìœ„í—˜ë„ (%)</th>
                            <th data-field="ë‹´ë‹¹ì˜ì—…ì±„ë„">ì˜ì—…ì±„ë„</th>
                            <th data-field="KTTì›”ì •ë£Œ(ì¡°ì •)" data-sort="none">ì›”ì •ë£Œ (ì²œì›)</th>
                            <th data-field="ë°©ì–´ì§„í–‰ë‹¨ê³„">ë°©ì–´ì§„í–‰ë‹¨ê³„</th>
                            <th data-field="ë°©ì–´ë‹´ë‹¹ì">ë°©ì–´ë‹´ë‹¹ì</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    /* ---------------------------------------------------------
        ğŸ“Œ CSV ë°ì´í„° ê²½ë¡œ
    --------------------------------------------------------- */
    const VOC_CSV_URL = "uploaded:voc.csv";
    const PIPELINE_CSV_URL = "uploaded:pipeline.csv";

    // Chart.js í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
    Chart.register(ChartDataLabels);

    /* ---------------------------------------------------------
        ğŸ“Œ ì „ì—­ ìƒíƒœê°’ ë° ì§€ì‚¬ ì •ë ¬ ê¸°ì¤€
    --------------------------------------------------------- */
    let currentView = "pipeline"; // 'voc' ë˜ëŠ” 'pipeline'
    
    // ì§€ì‚¬ ì •ë ¬ ê¸°ì¤€ (ìš”ì²­í•˜ì‹  ìˆœì„œ)
    const BRANCH_SORT_ORDER = ["ì¤‘ì•™", "ê°•ë¶", "ì„œëŒ€ë¬¸", "ê³ ì–‘", "ì˜ì •ë¶€", "ë‚¨ì–‘ì£¼", "ê°•ë¦‰", "ì›ì£¼"];

    // PIPELINE ìƒíƒœ
    let pipelineMode = "count";
    let pipelineData = [];
    let filteredPipelineData = [];
    let pipelineSelectedChannel = "SP"; // **ë””í´íŠ¸ ë³€ê²½: SP**
    let pipelineSelectedHQ = "ê°•ë¶/ê°•ì›"; // **ê¸°ë³¸ê°’ ìœ ì§€**
    let pipelineSelectedBranch = "ALL";
    let pipelineSelectedAgent = "ALL";
    let pipelineListSortField = "KTTì›”ì •ë£Œ(ì¡°ì •)";
    let pipelineListSortDirection = "desc";
    
    // VOC ìƒíƒœ
    let vocData = [];
    let filteredVocData = [];
    let vocSelectedType = "ë¦¬í…ì…˜"; // **ë””í´íŠ¸ ë³€ê²½: ë¦¬í…ì…˜**
    let vocSelectedStatus = "ALL";
    let vocListSortField = "VOCìœ í˜•ëŒ€";
    let vocListSortDirection = "desc";

    // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
    let chartInstances = {};

    /* ---------------------------------------------------------
        ğŸ“Œ ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    --------------------------------------------------------- */
    function normalizeBranch(name) {
        if (!name) return "";
        return String(name).replace("ì§€ì‚¬", "").trim();
    }
    
    // ì§€ì‚¬ ì •ë ¬ í•¨ìˆ˜
    function sortBranches(a, b) {
        const indexA = BRANCH_SORT_ORDER.indexOf(a);
        const indexB = BRANCH_SORT_ORDER.indexOf(b);

        if (indexA === -1 && indexB === -1) return a.localeCompare(b);
        if (indexA === -1) return 1;
        if (indexB === -1) return -1;

        return indexA - indexB;
    }
    
    function cleanContractNumber(raw) {
        if (!raw) return "";
        return String(raw).replace(/\D/g, "").slice(0, 8);
    }
    function toThousandWon(raw) {
        if (!raw) return 0;
        const num = parseFloat(String(raw).replace(/,/g, ""));
        return isNaN(num) ? 0 : Math.round(num / 1000);
    }
    function formatNumber(num) {
        return num.toLocaleString();
    }
    function checkRisk(value, selected) {
        if (selected === "ALL") return true;
        const v = parseFloat(value);
        if (isNaN(v)) return false;
        const s = parseInt(selected);
        if (s === 0) return v >= 0 && v < 25;
        if (s === 25) return v >= 25 && v < 50;
        if (s === 50) return v >= 50 && v < 75;
        if (s === 75) return v >= 75 && v <= 100;
        return true;
    }

    // **[ìˆ˜ì •] CSV ë¡œë”© í•¨ìˆ˜: voc.csvì˜ í—¤ë”ê°€ 2í–‰ë¶€í„° ì‹œì‘í•˜ë„ë¡ ìˆ˜ì •**
    df = pd.read_csv('voc.csv', header=1)
    async function loadCsv(url) {
        const res = await fetch(url);
        const text = await res.text();

        if (url === VOC_CSV_URL) {
            // VOC_CSV_URLì¼ ê²½ìš°, ì²« ë²ˆì§¸ ì¤„ì„ ê±´ë„ˆë›°ê³  íŒŒì‹±
            const lines = text.split('\n');
            const contentWithoutFirstLine = lines.slice(1).join('\n'); 
            
            return new Promise(resolve => {
                Papa.parse(contentWithoutFirstLine, { 
                    header: true, 
                    skipEmptyLines: true, 
                    complete: r => resolve(r.data) 
                });
            });
        }
        
        // ê·¸ ì™¸ íŒŒì¼ (pipeline.csv)ì€ ê¸°ì¡´ ë°©ì‹ëŒ€ë¡œ ì²« ë²ˆì§¸ ì¤„ì„ í—¤ë”ë¡œ íŒŒì‹±
        return new Promise(resolve => {
            Papa.parse(text, { header: true, skipEmptyLines: true, complete: r => resolve(r.data) });
        });
    }
    // **[ìˆ˜ì • ë]**

    function destroyChart(id) {
        if (chartInstances[id]) {
            chartInstances[id].destroy();
            chartInstances[id] = null;
        }
    }

    /* ---------------------------------------------------------
        ğŸ“Œ ë·° ì „í™˜ ë¡œì§
    --------------------------------------------------------- */
    function switchView(view) {
        currentView = view;

        document.querySelectorAll('.view-switcher button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`show${view.charAt(0).toUpperCase() + view.slice(1)}Btn`).classList.add('active');

        document.querySelectorAll('.dashboard-view').forEach(v => {
            v.classList.remove('active');
        });
        document.getElementById(`${view}View`).classList.add('active');

        document.getElementById('pipelineFilters').style.display = view === 'pipeline' ? 'block' : 'none';
        document.getElementById('vocFilters').style.display = view === 'voc' ? 'block' : 'none';

        if (view === 'pipeline') {
            updatePipelineDashboard();
        } else {
            updateVocDashboard();
        }
    }

    /* ---------------------------------------------------------
        ğŸ“Œ PIPELINE - í•„í„°ë§ ë° ì—…ë°ì´íŠ¸ ë¡œì§
    --------------------------------------------------------- */

    function getPipelineSelectedChannel() { 
        return document.getElementById("channelFilter").value; 
    }
    function getPipelineSelectedRisk() { 
        return document.querySelector('#pipelineFilters input[name="risk"]:checked').value; 
    }

    function setMode(m, button) {
        pipelineMode = m;
        document.querySelectorAll("#pipelineFilters .mode-btn").forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");
        
        // ì°¨íŠ¸ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
        document.getElementById("branchChartModeText").innerText = 
            `(${m === 'count' ? 'ê±´ìˆ˜' : 'ê¸ˆì•¡(ì²œì›)'} ê¸°ì¤€, Top 10 ì§€ì‚¬)`;

        updatePipelineDashboard();
    }
    
    function setPipelineHQ(hq, button) {
        pipelineSelectedHQ = hq;
        document.querySelectorAll("#pipelineHqButtons .filter-btn").forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");
        pipelineSelectedBranch = "ALL";
        pipelineSelectedAgent = "ALL";
        renderPipelineBranchButtons();
        renderPipelineAgentButtons();
        updatePipelineDashboard();
    }
    
    function setPipelineBranch(branch, button) {
        pipelineSelectedBranch = branch;
        document.querySelectorAll("#pipelineBranchButtons .filter-btn").forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");
        pipelineSelectedAgent = "ALL";
        renderPipelineAgentButtons();
        updatePipelineDashboard();
    }
    
    function setPipelineAgent(agent, button) {
        pipelineSelectedAgent = agent;
        document.querySelectorAll("#pipelineAgentButtons .filter-btn").forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");
        updatePipelineDashboard();
    }

    function filterPipelineData() {
        // í•„í„° UIì—ì„œ í˜„ì¬ ì„ íƒëœ ê°’ì„ ê°€ì ¸ì™€ì„œ, ì „ì—­ ìƒíƒœê°’ì—ë„ ë°˜ì˜
        pipelineSelectedChannel = getPipelineSelectedChannel();
        const channel = pipelineSelectedChannel;
        const risk = getPipelineSelectedRisk();

        filteredPipelineData = pipelineData.filter(row => {
            if (!cleanContractNumber(row["ê³„ì•½ë²ˆí˜¸"])) return false;
            
            // ì˜ì—…ì±„ë„ í•„í„°ë§
            if (channel !== "ALL" && row["ë‹´ë‹¹ì˜ì—…ì±„ë„"] !== channel) return false;
            
            // ìœ„í—˜ë„ í•„í„°ë§
            if (!checkRisk(row["í•´ì§€ìœ„í—˜ë„"], risk)) return false;

            const head = (row["ê´€ë¦¬ë³¸ë¶€"] || "").trim();
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            const agent = (row["ë‹´ë‹¹ì"] || "").trim();

            // ê´€ë¦¬ë³¸ë¶€ëŠ” ì‹œê°í™”ì—ì„œëŠ” ì œì™¸ë˜ì§€ë§Œ, í•„í„°ë§ ë¡œì§ì—ì„œëŠ” ì‚¬ìš©ë¨
            if (pipelineSelectedHQ !== "ALL" && head !== pipelineSelectedHQ) return false;
            if (pipelineSelectedBranch !== "ALL" && branch !== pipelineSelectedBranch) return false;
            if (pipelineSelectedAgent !== "ALL" && agent !== pipelineSelectedAgent) return false;
            return true;
        });
    }

    function renderPipelineHQButtons() {
        const container = document.getElementById("pipelineHqButtons");
        const heads = Array.from(new Set(pipelineData.map(r => (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim()).filter(Boolean))).sort();

        let html = "";
        html += `<button type="button" class="filter-btn ${pipelineSelectedHQ === "ALL" ? "active" : ""}" data-value="ALL" onclick="setPipelineHQ('ALL', this)">ì „ì²´</button>`;
        heads.forEach(hq => {
            html += `<button type="button" class="filter-btn ${pipelineSelectedHQ === hq ? "active" : ""}" data-value="${hq}" onclick="setPipelineHQ('${hq}', this)">${hq}</button>`;
        });
        container.innerHTML = html;
        
        // ë‹´ë‹¹ì˜ì—…ì±„ë„ ë””í´íŠ¸ UI ì—…ë°ì´íŠ¸
        document.getElementById("channelFilter").value = pipelineSelectedChannel;
    }

    function renderPipelineBranchButtons() {
        const container = document.getElementById("pipelineBranchButtons");

        let filtered = pipelineData;
        if (pipelineSelectedHQ !== "ALL") {
            filtered = filtered.filter(r => (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim() === pipelineSelectedHQ);
        }

        const branches = Array.from(new Set(
            filtered.map(r => normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])).filter(Boolean)
        )).sort(sortBranches);

        let html = "";
        html += `<button type="button" class="filter-btn ${pipelineSelectedBranch === "ALL" ? "active" : ""}" data-value="ALL" onclick="setPipelineBranch('ALL', this)">ì „ì²´</button>`;
        branches.forEach(br => {
            html += `<button type="button" class="filter-btn ${pipelineSelectedBranch === br ? "active" : ""}" data-value="${br}" onclick="setPipelineBranch('${br}', this)">${br}</button>`;
        });
        container.innerHTML = html;
    }
    
    function renderPipelineAgentButtons() {
        const container = document.getElementById("pipelineAgentButtons");
        
        let filtered = pipelineData;
        if (pipelineSelectedHQ !== "ALL") {
            filtered = filtered.filter(r => (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim() === pipelineSelectedHQ);
        }
        if (pipelineSelectedBranch !== "ALL") {
            filtered = filtered.filter(r => normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]) === pipelineSelectedBranch);
        }

        const agents = Array.from(new Set(
            filtered.map(r => (r["ë‹´ë‹¹ì"] || "").trim()).filter(Boolean)
        )).sort();

        let html = "";
        html += `<button type="button" class="filter-btn ${pipelineSelectedAgent === "ALL" ? "active" : ""}" data-value="ALL" onclick="setPipelineAgent('ALL', this)">ì „ì²´</button>`;
        agents.forEach(agent => {
            // ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬: ì‘ì€ë”°ì˜´í‘œê°€ ì´ë¦„ì— í¬í•¨ëœ ê²½ìš°ë¥¼ ë°©ì§€
            const safeAgent = agent.replace(/'/g, "\\'");
            html += `<button type="button" class="filter-btn ${pipelineSelectedAgent === agent ? "active" : ""}" data-value="${agent}" onclick="setPipelineAgent('${safeAgent}', this)">${agent}</button>`;
        });
        container.innerHTML = html;
    }

    function updatePipelineKPIs() {
        if (!filteredPipelineData.length) {
            document.getElementById("kpi-pipeline-count").innerText = "0";
            document.getElementById("kpi-pipeline-amount").innerText = "0";
            document.getElementById("kpi-defense-success-rate").innerText = "0%";
            document.getElementById("kpi-high-risk-count").innerText = "0";
            return;
        }

        const totalCount = filteredPipelineData.length;
        const totalAmount = filteredPipelineData.reduce((sum, row) => sum + toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]), 0);
        
        const defenseSuccess = filteredPipelineData.filter(row => row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] === "ë°©ì–´ì„±ê³µ").length;
        const totalDefenseAttempt = filteredPipelineData.filter(row => 
            ["ë°©ì–´ì„±ê³µ", "ë°©ì–´ì‹¤íŒ¨", "ì§„í–‰ì¤‘"].includes(row["ë°©ì–´ì§„í–‰ë‹¨ê³„"])
        ).length;
        const defenseSuccessRate = totalDefenseAttempt > 0 ? (defenseSuccess / totalDefenseAttempt) * 100 : 0;
        
        const highRiskCount = filteredPipelineData.filter(row => parseFloat(row["í•´ì§€ìœ„í—˜ë„"]) >= 75).length;

        document.getElementById("kpi-pipeline-count").innerText = formatNumber(totalCount);
        document.getElementById("kpi-pipeline-amount").innerText = formatNumber(totalAmount);
        document.getElementById("kpi-defense-success-rate").innerText = `${defenseSuccessRate.toFixed(1)}%`;
        document.getElementById("kpi-high-risk-count").innerText = formatNumber(highRiskCount);
    }
    
    // **ì‹œê°í™” 1: ì§€ì‚¬ë³„ íŒŒì´í”„ë¼ì¸ ì§„í–‰ ë‹¨ê³„ (ê³„ë‹¨í˜• ëˆ„ì  ë§‰ëŒ€)**
    function drawPipelineBranchStageChart() {
        const stages = ["ì§„í–‰ì¤‘", "ë°©ì–´ì‹¤íŒ¨", "ë°©ì–´ì„±ê³µ"];
        const agg = {};
        
        filteredPipelineData.forEach(row => {
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (!branch) return;
            const stage = (row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] || "").trim();
            const value = pipelineMode === "amount" ? toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]) : 1; // **ê¸ˆì•¡ ë°˜ì˜ ë¡œì§ ìˆ˜ì •**

            if (!agg[branch]) agg[branch] = { ì§„í–‰ì¤‘: 0, ë°©ì–´ì‹¤íŒ¨: 0, ë°©ì–´ì„±ê³µ: 0, total: 0 };
            if (stages.includes(stage)) {
                agg[branch][stage] += value;
                agg[branch].total += value;
            }
        });
        
        const sortedEntries = Object.entries(agg)
            .sort((a, b) => b[1].total - a[1].total)
            .slice(0, 10);

        const labels = sortedEntries.map(e => e[0]);

        destroyChart("pipelineBranchStageChart");

        chartInstances.pipelineBranchStageChart = new Chart(document.getElementById("pipelineBranchStageChart").getContext("2d"), {
            type: "bar",
            data: {
                labels: labels,
                datasets: [
                    { label: "ë°©ì–´ì„±ê³µ", data: sortedEntries.map(e => e[1]["ë°©ì–´ì„±ê³µ"] || 0), stack: "s", backgroundColor: '#10b981' },
                    { label: "ì§„í–‰ì¤‘", data: sortedEntries.map(e => e[1]["ì§„í–‰ì¤‘"] || 0), stack: "s", backgroundColor: '#f59e0b' },
                    { label: "ë°©ì–´ì‹¤íŒ¨", data: sortedEntries.map(e => e[1]["ë°©ì–´ì‹¤íŒ¨"] || 0), stack: "s", backgroundColor: '#ef4444' },
                ]
            },
            options: {
                responsive: true,
                animation: { duration: 1200 },
                layout: {
                    padding: { top: 30 }
                },
                scales: {
                    x: {
                        stacked: true, 
                        ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 },
                    },
                    y: { 
                        stacked: true, 
                        beginAtZero: true, 
                        title: { display: true, text: pipelineMode === "amount" ? "ê¸ˆì•¡ (ì²œì›)" : "ê±´ìˆ˜" }, // **íƒ€ì´í‹€ ë³€ê²½**
                        ticks: { callback: formatNumber }, // **ì¶• í¬ë§·íŒ…**
                        padding: 10
                    }
                },
                plugins: {
                    legend: { position: 'bottom' },
                    datalabels: { 
                        formatter: formatNumber, 
                        color: '#fff',
                        font: { weight: 'bold', size: 10 },
                        display: 'auto'
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // **ì‹œê°í™” 2: í•´ì§€ ìœ„í—˜ë„ vs ì›”ì •ë£Œ ë¶„í¬ (ë²„ë¸” ì°¨íŠ¸)**
    function drawPipelineRiskBubbleChart() {
        // ì§€ì‚¬ë³„ë¡œ ì§‘ê³„ (ë²„ë¸”ì˜ ì¤‘ì‹¬)
        const agg = {};
        filteredPipelineData.forEach(row => {
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            const risk = parseFloat(row["í•´ì§€ìœ„í—˜ë„"]) || 0;
            const amount = toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
            
            if (!agg[branch]) {
                agg[branch] = { count: 0, totalRisk: 0, totalAmount: 0 };
            }
            agg[branch].count++;
            agg[branch].totalRisk += risk;
            agg[branch].totalAmount += amount;
        });

        // ë²„ë¸” ë°ì´í„° ìƒì„±
        const data = Object.entries(agg).map(([branch, val]) => {
            const avgRisk = val.totalRisk / val.count;
            const avgAmount = val.totalAmount / val.count;
            
            // í¬ê¸° ê²°ì • ë¡œì§ (ì´ ì›”ì •ë£Œ ê¸ˆì•¡ì„ ê¸°ë°˜ìœ¼ë¡œ í•¨)
            const sizeBase = pipelineMode === "amount" ? val.totalAmount : val.count; 
            const bubbleSize = Math.sqrt(sizeBase) * (pipelineMode === "amount" ? 0.05 : 2); 
            
            return {
                label: branch,
                data: [{
                    x: avgRisk.toFixed(1), 
                    y: avgAmount.toFixed(0), 
                    r: bubbleSize < 5 ? 5 : (bubbleSize > 40 ? 40 : bubbleSize)
                }],
                backgroundColor: `#${Math.floor(Math.random()*16777215).toString(16)}66`,
                borderColor: '#333',
            };
        });

        destroyChart("pipelineRiskBubbleChart");

        chartInstances.pipelineRiskBubbleChart = new Chart(document.getElementById("pipelineRiskBubbleChart").getContext("2d"), {
            type: "bubble",
            data: { datasets: data },
            options: {
                responsive: true,
                animation: { duration: 1200 },
                layout: { padding: { top: 20 } },
                scales: {
                    x: {
                        title: { display: true, text: 'í‰ê·  í•´ì§€ ìœ„í—˜ë„ (%)' },
                        min: 0,
                        max: 100
                    },
                    y: {
                        title: { display: true, text: 'í‰ê·  ì›”ì •ë£Œ (ì²œì›)' },
                        beginAtZero: true,
                        ticks: { callback: formatNumber }
                    }
                },
                plugins: {
                    legend: { position: 'bottom' },
                    datalabels: {
                        formatter: (value, context) => context.dataset.label,
                        color: '#333',
                        font: { size: 10, weight: 'bold' }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }
    
    // **ì‹œê°í™” 3: Top 5 ì§€ì‚¬ ë°©ì–´ ì„±ê³µë¥  ë²¤ì¹˜ë§ˆí¬**
    function drawPipelineDefenseSuccessRateChart() {
        const agg = {};
        
        filteredPipelineData.forEach(row => {
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (!branch) return;
            if (!agg[branch]) agg[branch] = { success: 0, attempt: 0, rate: 0 };
            
            const stage = (row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] || "").trim();
            // ê±´ìˆ˜ ê¸°ì¤€ì´ ì•„ë‹Œ ì›”ì •ë£Œ ê¸°ì¤€ìœ¼ë¡œ ì„±ê³µë¥ ì„ ê³„ì‚°í•  ìˆ˜ë„ ìˆì§€ë§Œ, ì¼ë°˜ì ì¸ ì„±ê³µë¥ ì€ 'ê±´ìˆ˜' ê¸°ì¤€ì´ë¯€ë¡œ ìœ ì§€.
            const value = 1; 

            if (["ë°©ì–´ì„±ê³µ", "ë°©ì–´ì‹¤íŒ¨", "ì§„í–‰ì¤‘"].includes(stage)) {
                agg[branch].attempt += value;
                if (stage === "ë°©ì–´ì„±ê³µ") {
                    agg[branch].success += value;
                }
            }
        });

        Object.values(agg).forEach(val => {
            val.rate = val.attempt > 0 ? (val.success / val.attempt) * 100 : 0;
        });

        const top5 = Object.entries(agg)
            .filter(([, val]) => val.attempt >= 5) // ìµœì†Œ ì‹œë„ ê±´ìˆ˜
            .sort((a, b) => b[1].rate - a[1].rate)
            .slice(0, 5);
        
        const labels = top5.map(e => e[0]);
        const data = top5.map(e => e[1].rate);

        destroyChart("pipelineDefenseSuccessRateChart");

        chartInstances.pipelineDefenseSuccessRateChart = new Chart(document.getElementById("pipelineDefenseSuccessRateChart").getContext("2d"), {
            type: "line",
            data: {
                labels: labels,
                datasets: [{
                    label: 'ë°©ì–´ ì„±ê³µë¥  (%)',
                    data: data,
                    borderColor: '#059669',
                    backgroundColor: 'rgba(5, 150, 105, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                animation: { duration: 1200 },
                layout: { padding: { top: 30 } },
                scales: {
                    y: {
                        title: { display: true, text: 'ì„±ê³µë¥  (%)' },
                        min: 0,
                        max: 100,
                    },
                    x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        formatter: (value) => `${value.toFixed(1)}%`,
                        color: '#059669',
                        font: { weight: 'bold' }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }


    // **ì‹œê°í™” 4: ë‹´ë‹¹ìë³„ ë°©ì–´ ì‹¤íŒ¨ ê±´ìˆ˜ (Top 10)**
    function drawPipelineAgentFailChart() {
        const failByAgent = filteredPipelineData
            .filter(row => row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] === "ë°©ì–´ì‹¤íŒ¨")
            .reduce((acc, row) => {
                const agent = (row["ë‹´ë‹¹ì"] || "ë¯¸ì§€ì •").trim();
                // í•­ìƒ ê±´ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì§‘ê³„
                acc[agent] = (acc[agent] || 0) + 1;
                return acc;
            }, {});
            
        const top10 = Object.entries(failByAgent)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);

        destroyChart("pipelineAgentFailChart");

        chartInstances.pipelineAgentFailChart = new Chart(document.getElementById("pipelineAgentFailChart").getContext("2d"), {
            type: "bar",
            data: {
                labels: top10.map(e => e[0]),
                datasets: [{
                    label: 'ë°©ì–´ ì‹¤íŒ¨ ê±´ìˆ˜',
                    data: top10.map(e => e[1]),
                    backgroundColor: '#dc2626',
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                animation: { duration: 1200 },
                layout: { padding: { right: 30 } }, 
                scales: {
                    x: { 
                        beginAtZero: true, 
                        title: { display: true, text: "ê±´ìˆ˜" },
                        padding: 10
                    },
                    y: { }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: { 
                        anchor: 'end', 
                        align: 'right', 
                        formatter: formatNumber, 
                        color: '#333',
                        font: { weight: 'bold' }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }


    function renderPipelineList() {
        const tableBody = document.querySelector("#pipelineListTable tbody");
        tableBody.innerHTML = "";
        let sortedData = [...filteredPipelineData];

        const sortField = pipelineListSortField;
        const direction = pipelineListSortDirection === 'asc' ? 1 : -1;
        
        sortedData.sort((a, b) => {
            let valA = a[sortField];
            let valB = b[sortField];
            
            if (sortField === "í•´ì§€ìœ„í—˜ë„" || sortField === "KTTì›”ì •ë£Œ(ì¡°ì •)") {
                valA = parseFloat(String(valA).replace(/,/g, "")) || 0;
                valB = parseFloat(String(valB).replace(/,/g, "")) || 0;
            }
            
            if (valA < valB) return -1 * direction;
            if (valA > valB) return 1 * direction;
            return 0;
        });

        sortedData.slice(0, 100).forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${cleanContractNumber(row["ê³„ì•½ë²ˆí˜¸"])}</td>
                <td>${normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"])}</td>
                <td>${(parseFloat(row["í•´ì§€ìœ„í—˜ë„"]) || 0).toFixed(1)}</td>
                <td>${row["ë‹´ë‹¹ì˜ì—…ì±„ë„"]}</td>
                <td>${formatNumber(toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]))}</td>
                <td>${row["ë°©ì–´ì§„í–‰ë‹¨ê³„"]}</td>
                <td>${row["ë‹´ë‹¹ì"]}</td>
            `;
            tableBody.appendChild(tr);
        });

        document.querySelectorAll("#pipelineListTable th").forEach(th => {
            th.innerHTML = th.getAttribute("data-field");
            if (th.getAttribute("data-field") === pipelineListSortField) {
                const icon = pipelineListSortDirection === 'asc' ? ' â–²' : ' â–¼';
                th.innerHTML += icon;
            }
        });
    }

    function attachPipelineSortEvents() {
        document.querySelectorAll("#pipelineListTable th").forEach(th => {
            th.addEventListener('click', function() {
                const field = this.getAttribute('data-field');
                if (field === pipelineListSortField) {
                    pipelineListSortDirection = pipelineListSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    pipelineListSortField = field;
                    pipelineListSortDirection = 'desc';
                }
                renderPipelineList();
            });
        });
    }

    function updatePipelineDashboard() {
        filterPipelineData();
        updatePipelineKPIs();
        // generatePipelineReview(); // AI ë¶„ì„ ì œì™¸
        drawPipelineBranchStageChart();
        drawPipelineRiskBubbleChart();
        drawPipelineDefenseSuccessRateChart();
        drawPipelineAgentFailChart();
        renderPipelineList();
    }


    /* ---------------------------------------------------------
        ğŸ“Œ VOC - í•„í„°ë§ ë° ì—…ë°ì´íŠ¸ ë¡œì§
    --------------------------------------------------------- */
    
    function setVocType(value) {
        vocSelectedType = value;
        updateVocDashboard();
    }

    function setVocStatus(value, button) {
        vocSelectedStatus = value;
        document.querySelectorAll('#vocStatusButtons .filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        button.classList.add('active');
        updateVocDashboard();
    }

    function filterVocData() {
        // í•„í„° UIì—ì„œ í˜„ì¬ ì„ íƒëœ ê°’ì„ ê°€ì ¸ì™€ì„œ, ì „ì—­ ìƒíƒœê°’ì—ë„ ë°˜ì˜
        vocSelectedType = document.getElementById("vocTypeFilter").value;
        
        filteredVocData = vocData.filter(row => {
            const type = (row["VOCìœ í˜•ëŒ€"] || "").trim();
            const status = (row["ìƒíƒœ"] || "").trim();

            if (vocSelectedType !== "ALL" && type !== vocSelectedType) return false;
            if (vocSelectedStatus !== "ALL" && status !== vocSelectedStatus) return false;
            return true;
        });
    }

    function updateVocKPIs() {
        if (!vocData.length) {
            // ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° 0ìœ¼ë¡œ í‘œì‹œ
            document.getElementById("kpi-voc-total").innerText = "0";
            document.getElementById("kpi-voc-complete").innerText = "0";
            document.getElementById("kpi-voc-complete-rate").innerText = "0%";
            document.getElementById("kpi-voc-unassigned").innerText = "0";
            return;
        }

        const totalVoc = filteredVocData.length;
        const completedVoc = filteredVocData.filter(row => (row["ìƒíƒœ"] || "").trim() === "ì²˜ë¦¬ì™„ë£Œ").length;
        const unassignedVoc = filteredVocData.filter(row => (row["ìƒíƒœ"] || "").trim() === "ë¯¸ì ‘ìˆ˜").length;
        const vocCompleteRate = totalVoc > 0 ? (completedVoc / totalVoc) * 100 : 0;

        document.getElementById("kpi-voc-total").innerText = formatNumber(totalVoc);
        document.getElementById("kpi-voc-complete").innerText = formatNumber(completedVoc);
        document.getElementById("kpi-voc-complete-rate").innerText = `${vocCompleteRate.toFixed(1)}%`;
        document.getElementById("kpi-voc-unassigned").innerText = formatNumber(unassignedVoc);
    }
    
    function renderVocTypeFilter() {
        const select = document.getElementById("vocTypeFilter");
        select.innerHTML = '<option value="ALL">ì „ì²´</option>';
        const types = Array.from(new Set(vocData.map(r => (r["VOCìœ í˜•ëŒ€"] || "").trim()).filter(Boolean))).sort();
        
        // 'ë¦¬í…ì…˜' ë””í´íŠ¸ ì²˜ë¦¬ë¥¼ ìœ„í•´ HTML ìƒì„± ì‹œ ë°˜ì˜
        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            if (type === vocSelectedType) { // ë””í´íŠ¸ 'ë¦¬í…ì…˜' ì„ íƒ
                option.selected = true;
            }
            select.appendChild(option);
        });
        select.addEventListener('change', (e) => setVocType(e.target.value));
    }

    function aggregateVocBy(field, limit = 20) {
        const agg = {};
        const statuses = ["ì²˜ë¦¬ì™„ë£Œ", "ì ‘ìˆ˜", "ë¯¸ì ‘ìˆ˜"];

        filteredVocData.forEach(row => {
            let key = field === "ê´€ë¦¬ì§€ì‚¬"
                ? normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"])
                : (row[field] || "").trim();

            if (!key) return;

            const st = (row["ìƒíƒœ"] || "").trim();

            if (!agg[key]) agg[key] = { ì²˜ë¦¬ì™„ë£Œ: 0, ì ‘ìˆ˜: 0, ë¯¸ì ‘ìˆ˜: 0 };
            if (statuses.includes(st)) agg[key][st]++;
        });

        const entries = Object.entries(agg);
        
        if (field === "ê´€ë¦¬ì§€ì‚¬") {
            entries.sort((a, b) => sortBranches(a[0], b[0]));
        } else {
            entries.sort((a, b) =>
                (b[1].ì²˜ë¦¬ì™„ë£Œ + b[1].ì ‘ìˆ˜ + b[1].ë¯¸ì ‘ìˆ˜) -
                (a[1].ì²˜ë¦¬ì™„ë£Œ + a[1].ì ‘ìˆ˜ + a[1].ë¯¸ì ‘ìˆ˜)
            );
        }

        const sliced = entries.slice(0, limit);

        return {
            labels: sliced.map(e => e[0]),
            ì²˜ë¦¬ì™„ë£Œ: sliced.map(e => e[1].ì²˜ë¦¬ì™„ë£Œ),
            ì ‘ìˆ˜: sliced.map(e => e[1].ì ‘ìˆ˜),
            ë¯¸ì ‘ìˆ˜: sliced.map(e => e[1].ë¯¸ì ‘ìˆ˜),
        };
    }

    function drawVocBranchChart() {
        const { labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜ } = aggregateVocBy("ê´€ë¦¬ì§€ì‚¬", 30);
        destroyChart("vocBranchChart");

        chartInstances.vocBranchChart = new Chart(document.getElementById("vocBranchChart").getContext("2d"), {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "ì²˜ë¦¬ì™„ë£Œ", data: ì²˜ë¦¬ì™„ë£Œ, stack: "v", backgroundColor: '#3b82f6' },
                    { label: "ì ‘ìˆ˜", data: ì ‘ìˆ˜, stack: "v", backgroundColor: '#f59e0b' },
                    { label: "ë¯¸ì ‘ìˆ˜", data: ë¯¸ì ‘ìˆ˜, stack: "v", backgroundColor: '#ef4444' },
                ]
            },
            options: {
                responsive: true,
                animation: { duration: 1000 },
                layout: { padding: { top: 30 } },
                scales: {
                    x: { stacked: true, ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } },
                    y: { stacked: true, beginAtZero: true, title: { display: true, text: "ê±´ìˆ˜" } }
                },
                 plugins: {
                    legend: { position: 'bottom' },
                    datalabels: { 
                        formatter: formatNumber, 
                        color: '#fff',
                        font: { weight: 'bold', size: 10 },
                        display: 'auto'
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    function drawVocAgentChart() {
        const { labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜ } = aggregateVocBy("ë‹´ë‹¹ì", 20);
        destroyChart("vocAgentChart");

        chartInstances.vocAgentChart = new Chart(document.getElementById("vocAgentChart").getContext("2d"), {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "ì²˜ë¦¬ì™„ë£Œ", data: ì²˜ë¦¬ì™„ë£Œ, stack: "va", backgroundColor: '#3b82f6' },
                    { label: "ì ‘ìˆ˜", data: ì ‘ìˆ˜, stack: "va", backgroundColor: '#f59e0b' },
                    { label: "ë¯¸ì ‘ìˆ˜", data: ë¯¸ì ‘ìˆ˜, stack: "va", backgroundColor: '#ef4444' },
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                animation: { duration: 1000 },
                layout: { padding: { right: 30 } },
                scales: {
                    x: { stacked: true, beginAtZero: true, title: { display: true, text: "ê±´ìˆ˜" } },
                    y: { stacked: true, }
                },
                plugins: {
                    legend: { position: 'bottom' },
                    datalabels: { 
                        anchor: 'end', 
                        align: 'right', 
                        formatter: formatNumber, 
                        color: '#333',
                        font: { weight: 'bold' },
                        display: 'auto'
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    function renderVocList() {
        const tableBody = document.querySelector("#vocListTable tbody");
        tableBody.innerHTML = "";
        let sortedData = [...filteredVocData];

        const sortField = vocListSortField;
        const direction = vocListSortDirection === 'asc' ? 1 : -1;
        
        sortedData.sort((a, b) => {
            let valA = a[sortField];
            let valB = b[sortField];
            
            if (valA < valB) return -1 * direction;
            if (valA > valB) return 1 * direction;
            return 0;
        });

        sortedData.slice(0, 100).forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${(row["ìƒíƒœ"] || "-").trim()}</td>
                <td>${(row["VOCìœ í˜•ëŒ€"] || "-").trim()}</td>
                <td>${(row["VOCìœ í˜•ì¤‘"] || "-").trim()}</td>
                <td>${(row["VOCìœ í˜•ì†Œ"] || "-").trim()}</td>
                <td>${(row["ê´€ë¦¬ë³¸ë¶€"] || "-").trim()}</td>
                <td>${normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"])}</td>
                <td>${(row["ë‹´ë‹¹ì"] || "-").trim()}</td>
            `;
            tableBody.appendChild(tr);
        });

        document.querySelectorAll("#vocListTable th").forEach(th => {
            th.innerHTML = th.getAttribute("data-field");
            if (th.getAttribute("data-field") === vocListSortField) {
                const icon = vocListSortDirection === 'asc' ? ' â–²' : ' â–¼';
                th.innerHTML += icon;
            }
        });
    }

    function attachVocSortEvents() {
        document.querySelectorAll("#vocListTable th").forEach(th => {
            th.addEventListener('click', function() {
                const field = this.getAttribute('data-field');
                if (field === vocListSortField) {
                    vocListSortDirection = vocListSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    vocListSortField = field;
                    vocListSortDirection = 'desc';
                }
                renderVocList();
            });
        });
    }

    function updateVocDashboard() {
        filterVocData();
        updateVocKPIs();
        drawVocBranchChart();
        drawVocAgentChart();
        renderVocList();
    }


    /* ---------------------------------------------------------
        ğŸ“Œ ì´ˆê¸° ë¡œë“œ
    --------------------------------------------------------- */
    async function initDashboard() {
        vocData = await loadCsv(VOC_CSV_URL);
        pipelineData = await loadCsv(PIPELINE_CSV_URL);

        // PIPELINE ì´ˆê¸° ì„¤ì • (ë””í´íŠ¸ í•„í„° UI ë°˜ì˜)
        const heads = Array.from(new Set(pipelineData.map(r => (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim()).filter(Boolean))).sort();
        if (!heads.includes(pipelineSelectedHQ)) {
            pipelineSelectedHQ = 'ALL'; 
        }
        
        renderPipelineHQButtons();
        renderPipelineBranchButtons();
        renderPipelineAgentButtons();

        // VOC ì´ˆê¸° ì„¤ì • (ë””í´íŠ¸ í•„í„° UI ë°˜ì˜)
        renderVocTypeFilter();

        // í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.getElementById("channelFilter").addEventListener("change", (e) => {
            pipelineSelectedChannel = e.target.value;
            updatePipelineDashboard();
        });
        document.querySelectorAll('#pipelineFilters input[name="risk"]').forEach(r => r.addEventListener("change", updatePipelineDashboard));
            
        // ë¦¬ìŠ¤íŠ¸ ì •ë ¬ ì´ë²¤íŠ¸ ë“±ë¡
        attachPipelineSortEvents();
        attachVocSortEvents();

        // ì´ˆê¸° ë·° ì—…ë°ì´íŠ¸ (ê¸°ë³¸: Pipeline)
        updatePipelineDashboard();
        // VOC ë°ì´í„°ë„ ë¡œë“œ ì§í›„ í•œ ë²ˆ ì—…ë°ì´íŠ¸í•˜ì—¬ KPI ë° í•„í„° ìƒíƒœ ë°˜ì˜
        updateVocDashboard(); 

        switchView('pipeline');
    }

    window.addEventListener("load", initDashboard);
</script>

</body>
</html>
