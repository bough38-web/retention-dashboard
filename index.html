<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>KTT Premium Retention Dashboard (v24.0 Final Integrated)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbmyeJMsApj38SRzWvaQGrZmpqUQTooMw" defer></script>
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<style>
    :root {
        --primary: #4f46e5; --bg: #f8fafc; --surface: #ffffff;
        --text: #1e293b; --text-sub: #64748b; --border: #e2e8f0;
        --radius: 12px; --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
        --fail-bg: #fef2f2; --fail-text: #b91c1c;
    }
    body { margin:0; font-family:'Pretendard', sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; overflow:hidden; }
    * { box-sizing:border-box; outline:none; }
    
    /* Sidebar */
    .sidebar { width:280px; background:var(--surface); border-right:1px solid var(--border); display:flex; flex-direction:column; z-index:20; box-shadow:var(--shadow); }
    .logo { padding:20px; border-bottom:1px solid var(--border); font-size:20px; font-weight:800; color:var(--primary); display:flex; align-items:center; gap:8px; }
    .scroll-area { flex:1; overflow-y:auto; padding:20px; }
    
    /* Upload & Tabs */
    .upload-box { background:var(--bg); border:1px dashed #94a3b8; border-radius:var(--radius); padding:14px; text-align:center; margin-bottom:20px; cursor:pointer; }
    .nav-tabs { display:flex; background:var(--bg); padding:4px; border-radius:10px; margin-bottom:20px; }
    .nav-tab { flex:1; padding:8px; border:none; background:none; font-size:13px; font-weight:700; color:var(--text-sub); cursor:pointer; border-radius:8px; transition:0.2s; }
    .nav-tab.active { background:var(--surface); color:var(--primary); box-shadow:0 1px 2px rgba(0,0,0,0.05); }

    /* Filters */
    .filter-box { margin-bottom:20px; }
    .filter-head { display:flex; justify-content:space-between; font-size:12px; font-weight:700; color:var(--text-sub); margin-bottom:8px; }
    .chips { display:flex; flex-wrap:wrap; gap:6px; }
    .chip { padding:5px 10px; border:1px solid var(--border); background:var(--surface); border-radius:20px; font-size:11px; color:var(--text); cursor:pointer; }
    .chip.active { background:var(--primary); color:#fff; border-color:var(--primary); font-weight:600; }

    /* Main Content */
    .main-content { flex:1; padding:24px; overflow-y:auto; display:flex; flex-direction:column; }
    .view-panel { display:none; flex-direction:column; gap:20px; flex:1; }
    .view-panel.active { display:flex; }

    /* Header & KPI */
    .header { display:flex; justify-content:space-between; align-items:center; flex:none; }
    .header h2 { margin:0; font-size:24px; font-weight:800; }
    .action-btn { padding:8px 16px; background:#10b981; color:#fff; border:none; border-radius:8px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; }
    
    .kpi-grid { display:grid; grid-template-columns:repeat(4, 1fr); gap:20px; flex:none; }
    .kpi-card { background:var(--surface); padding:24px; border-radius:12px; box-shadow:var(--shadow); border-left:5px solid var(--c); }
    .kpi-label { font-size:13px; font-weight:600; color:var(--text-sub); text-transform:uppercase; }
    .kpi-val { font-size:36px; font-weight:800; margin-top:10px; color:var(--text); letter-spacing:-1px; }
    .kpi-sub { font-size:14px; color:var(--text-sub); font-weight:500; margin-left:5px; }

    /* Layouts */
    .voc-layout { display:flex; gap:20px; height:380px; flex:none; }
    .voc-left { flex:1; display:flex; gap:20px; }
    .voc-right { flex:1; }
    
    .pipe-section { display:flex; flex-direction:column; gap:16px; flex:1; min-height: 0; }
    .pipe-row { display:flex; gap:16px; flex:1; min-height: 320px; } /* 높이 확보 */
    .pipe-left { flex: 0 0 320px; display:flex; flex-direction:column; }
    .pipe-right { flex: 1; display:flex; flex-direction:column; min-width: 0; }

    /* Components */
    .card { background:var(--surface); border-radius:12px; padding:16px; box-shadow:var(--shadow); display:flex; flex-direction:column; height:100%; border:1px solid var(--border); }
    .card.full { flex:1; min-height:0; }
    .card-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex:none; }
    .card-title { font-size:16px; font-weight:700; color:var(--text); }
    .map-wrapper { flex:1; border-radius:8px; overflow:hidden; background:#e2e8f0; }
    .chart-wrapper { flex:1; position:relative; min-height:0; }

    /* Table */
    .table-section { flex:1; min-height:300px; display:flex; flex-direction:column; }
    .table-wrapper { flex:1; overflow:auto; border:1px solid var(--border); border-radius:8px; }
    table { width:100%; border-collapse:collapse; font-size:13px; white-space:nowrap; }
    th { background:#f8fafc; padding:12px 14px; text-align:left; font-weight:700; color:var(--text-sub); position:sticky; top:0; z-index:10; border-bottom:1px solid var(--border); }
    td { padding:10px 14px; border-bottom:1px solid #f1f5f9; cursor:pointer; color:var(--text); transition:0.1s; }
    tr:hover td { background:#f1f5f9; }
    tr.row-fail td { background:var(--fail-bg); color:var(--fail-text); font-weight:600; }

    .badge { padding:3px 8px; border-radius:6px; font-size:11px; font-weight:700; display:inline-block; }
    .bd-done { background:#dcfce7; color:#166534; } .bd-wait { background:#fee2e2; color:#991b1b; }
    
    #loading { position:fixed; inset:0; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; }
    .spinner { width:40px; height:40px; border:4px solid #e0e7ff; border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { 100%{transform:rotate(360deg);} }
</style>
</head>
<body>

<div id="loading"><div class="spinner"></div></div>

<div class="sidebar">
    <div class="logo"><i class="ph ph-chart-polar"></i> KTT Dashboard</div>
    <div class="scroll-area">
        <div class="upload-box" onclick="triggerUpload()">
            <i class="ph ph-file-csv"></i> <span>파일 교체 (보안)</span>
            <input type="file" id="fileInput" accept=".csv" />
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchView('voc')">VOC 현황</button>
            <button class="nav-tab" onclick="switchView('pipe')">파이프라인</button>
        </div>
        <div id="filter-container"></div>
    </div>
</div>

<div class="main-content">

    <div id="view-voc" class="view-panel active">
        <div class="header">
            <div><h2>관리고객(VOC) 현황</h2><p>실시간 위치 기반 모니터링</p></div>
            <button class="action-btn" onclick="exportData('voc')"><i class="ph ph-download-simple"></i> 엑셀 저장</button>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card" style="--c:var(--primary)"><div class="kpi-label">총 계약</div><div class="kpi-val" id="voc-total">0</div></div>
            <div class="kpi-card" style="--c:var(--success)"><div class="kpi-label">처리 완료</div><div><span class="kpi-val" id="voc-done">0</span> <span class="kpi-sub" id="voc-rate-done">(0%)</span></div></div>
            <div class="kpi-card" style="--c:var(--warning)"><div class="kpi-label">진행중</div><div><span class="kpi-val" id="voc-ing">0</span> <span class="kpi-sub" id="voc-rate-ing">(0%)</span></div></div>
            <div class="kpi-card" style="--c:var(--danger)"><div class="kpi-label">미접수</div><div><span class="kpi-val" id="voc-wait">0</span> <span class="kpi-sub" id="voc-rate-wait">(0%)</span></div></div>
        </div>

        <div class="voc-layout">
            <div class="voc-left">
                <div class="card full">
                    <div class="card-head"><h3 class="card-title">지사별 현황</h3></div>
                    <div class="chart-wrapper"><canvas id="chart-voc-branch"></canvas></div>
                </div>
                <div class="card full">
                    <div class="card-head"><h3 class="card-title">담당자 Top 10</h3></div>
                    <div class="chart-wrapper"><canvas id="chart-voc-agent"></canvas></div>
                </div>
            </div>
            <div class="voc-right">
                <div class="card full" style="padding:0;">
                    <div style="padding:12px; border-bottom:1px solid var(--border);"><h3 class="card-title">고객 위치 (수도권)</h3></div>
                    <div id="voc-map" class="map-wrapper"></div>
                </div>
            </div>
        </div>

        <div class="card table-section">
            <div class="card-head"><h3 class="card-title">상세 리스트</h3></div>
            <div class="table-wrapper">
                <table id="table-voc">
                    <thead><tr><th>지사</th><th>담당자</th><th>계약번호</th><th>상호명</th><th>상태</th><th>월정료</th><th>주소</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-pipe" class="view-panel">
        <div class="header">
            <div><h2>해지 파이프라인 분석</h2><p>본부별/지사별 건수 및 금액 현황</p></div>
            <button class="action-btn" onclick="exportData('pipe')"><i class="ph ph-download-simple"></i> 엑셀 저장</button>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card" style="--c:var(--primary)">
                <div class="kpi-label">총 대상 건수</div>
                <div class="kpi-val" id="pipe-total">0</div>
            </div>
            <div class="kpi-card" style="--c:var(--success)">
                <div class="kpi-label">방어성공</div>
                <div><span class="kpi-val" id="pipe-success">0</span> <span class="kpi-sub" id="pipe-rate-success">(0%)</span></div>
            </div>
            <div class="kpi-card" style="--c:var(--danger)">
                <div class="kpi-label">방어실패</div>
                <div><span class="kpi-val" id="pipe-fail">0</span> <span class="kpi-sub" id="pipe-rate-fail">(0%)</span></div>
            </div>
            <div class="kpi-card" style="--c:var(--warning)">
                <div class="kpi-label">진행중</div>
                <div><span class="kpi-val" id="pipe-ing">0</span> <span class="kpi-sub" id="pipe-rate-ing">(0%)</span></div>
            </div>
        </div>

        <div class="pipe-section">
            <div class="pipe-row">
                <div class="card pipe-left">
                    <div class="card-head"><h3 class="card-title">관리본부별 건수 (건)</h3></div>
                    <div class="chart-wrapper"><canvas id="chart-hq-count"></canvas></div>
                </div>
                <div class="card pipe-right">
                    <div class="card-head"><h3 class="card-title">지사별 건수</h3></div>
                    <div class="chart-wrapper"><canvas id="chart-branch-count"></canvas></div>
                </div>
            </div>
            <div class="pipe-row">
                <div class="card pipe-left">
                    <div class="card-head"><h3 class="card-title">관리본부별 금액 (천원)</h3></div>
                    <div class="chart-wrapper"><canvas id="chart-hq-amt"></canvas></div>
                </div>
                <div class="card pipe-right">
                    <div class="card-head"><h3 class="card-title">지사별 금액</h3></div>
                    <div class="chart-wrapper"><canvas id="chart-branch-amt"></canvas></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/* CONFIG */
const BRANCH_ORDER = ['중앙', '강북', '서대문', '의정부', '남양주', '강릉', '원주'];
const HQ_ORDER = ['강남/서부', '강북/강원', '충남/충북', '전남/전북', '대구/경북', '부산/경남'];
const COLORS = { '방어성공': '#3b82f6', '방어실패': '#f97316', '진행중': '#94a3b8', '기타': '#cbd5e1' };

const URLS = {
    voc: "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv",
    pipe: "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv"
};

let App = {
    view: 'voc',
    data: { voc:[], pipe:[] },
    filtered: [],
    filters: { hq:'ALL', branch:'ALL', agent:'ALL', status:'ALL', channel:'SP' },
    map: null, clusterer: null, markers: [], charts: {}
};

Chart.register(ChartDataLabels);
Chart.defaults.font.family = "'Pretendard', sans-serif";
Chart.defaults.color = '#64748b';

/* INIT */
window.onload = async () => {
    try {
        const [v, p] = await Promise.all([fetchCsv(URLS.voc), fetchCsv(URLS.pipe)]);
        App.data.voc = parseVoc(v.data);
        App.data.pipe = parsePipe(p.data);
        
        initMap();
        initFiltersHTML();
        updateDashboard();
    } catch(e) { console.error(e); alert("데이터 로드 실패"); }
    document.getElementById('loading').style.display = 'none';
};

async function fetchCsv(url) {
    const r = await fetch(url); const t = await r.text();
    return Papa.parse(t.replace(/^\uFEFF/, ''), {header:true, skipEmptyLines:true});
}

function parseVoc(data) {
    if(!data.length) return [];
    const kCoord = Object.keys(data[0]).find(k=>k.includes("위치")) || "위도";
    return data.map(r => {
        let lat=null, lng=null;
        if(r["위도"]) { lat=parseFloat(r["위도"]); lng=parseFloat(r["경도"]); }
        else if(r[kCoord] && r[kCoord].includes(',')) {
            const p=r[kCoord].split(','); lat=parseFloat(p[0]); lng=parseFloat(p[1]);
        }
        return {
            ...r,
            _branch: (r["관리지사"]||"기타").replace("지사","").trim(),
            _agent: (r["담당자"]||"미지정").trim(),
            _status: (r["상태"]||"").trim(),
            _lat: lat, _lng: lng,
            _fee: parseInt((r["합산월정료"]||"0").replace(/,/g,''))||0
        };
    });
}

function parsePipe(data) {
    if(!data.length) return [];
    const kFee = Object.keys(data[0]).find(k=>k.includes("월정료")) || "월정료";
    return data.map(r => {
        let step = (r["방어진행단계"]||"").trim();
        if(step.includes("성공")) step = "방어성공";
        else if(step.includes("실패") || step.includes("해지완료")) step = "방어실패";
        else step = "진행중";

        return {
            ...r,
            _hq: (r["관리본부"]||"기타").trim(),
            _branch: (r["관리지사"]||"기타").replace("지사","").trim(),
            _step: step,
            _fee: parseInt((r[kFee]||"0").replace(/,/g,''))||0
        };
    });
}

function initFiltersHTML() {
    const area = document.getElementById('filter-container');
    area.innerHTML = `
        <div class="filter-box" id="fb-channel" style="display:none;">
            <div class="filter-head">영업채널</div><div id="chips-channel" class="chips"></div>
        </div>
        <div class="filter-box" id="fb-voc-filters">
            <div class="filter-head">지사 필터</div><div id="chips-voc-branch" class="chips"></div>
        </div>
    `;
    
    const channels = ['전체', 'SP', 'SC', 'AM'];
    const box = document.getElementById('chips-channel');
    channels.forEach(c => {
        const btn = document.createElement('div');
        btn.className = `chip ${App.filters.channel===(c==='전체'?'ALL':c) ? 'active' : ''}`;
        btn.innerText = c;
        btn.onclick = () => {
            App.filters.channel = c==='전체'?'ALL':c;
            updateDashboard();
            Array.from(box.children).forEach(ch=>ch.classList.remove('active'));
            btn.classList.add('active');
        };
        box.appendChild(btn);
    });

    const vBox = document.getElementById('chips-voc-branch');
    ['전체', ...BRANCH_ORDER].forEach(b => {
        const btn = document.createElement('div');
        btn.className = `chip ${App.filters.branch===(b==='전체'?'ALL':b)?'active':''}`;
        btn.innerText = b;
        btn.onclick = () => {
            App.filters.branch = b==='전체'?'ALL':b;
            updateDashboard();
            Array.from(vBox.children).forEach(ch=>ch.classList.remove('active'));
            btn.classList.add('active');
        };
        vBox.appendChild(btn);
    });
}

function updateDashboard() {
    const isVoc = App.view === 'voc';
    document.getElementById('fb-channel').style.display = isVoc ? 'none' : 'block';
    document.getElementById('fb-voc-filters').style.display = isVoc ? 'block' : 'none';

    const src = isVoc ? App.data.voc : App.data.pipe;
    
    App.filtered = src.filter(d => {
        if(!isVoc && App.filters.channel !== 'ALL') {
            const ch = d["담당영업채널"] || "SP";
            if(ch !== App.filters.channel) return false;
        }
        if(isVoc && App.filters.branch !== 'ALL' && d._branch !== App.filters.branch) return false;
        return true;
    });

    if(isVoc) renderVocView();
    else renderPipeView();
}

/* RENDER VOC */
function renderVocView() {
    const data = App.filtered;
    const unique = new Set(data.map(d=>d["계약번호"])).size;
    const done = data.filter(d=>d._status==='처리완료').length;
    const ing = data.filter(d=>d._status==='접수').length;
    const wait = data.filter(d=>d._status==='미접수').length;

    animateNum('voc-total', unique);
    animateNum('voc-done', done);
    document.getElementById('voc-rate-done').innerText = unique ? `(${((done/unique)*100).toFixed(1)}%)` : '(0%)';
    animateNum('voc-ing', ing);
    document.getElementById('voc-rate-ing').innerText = unique ? `(${((ing/unique)*100).toFixed(1)}%)` : '(0%)';
    animateNum('voc-wait', wait);
    document.getElementById('voc-rate-wait').innerText = unique ? `(${((wait/unique)*100).toFixed(1)}%)` : '(0%)';

    updateMap(data);
    drawVocBar('chart-voc-branch', data, '_branch');
    drawVocBar('chart-voc-agent', data, '_agent');

    const tbody = document.querySelector('#table-voc tbody');
    tbody.innerHTML = data.slice(0, 50).map(d => `
        <tr><td>${d._branch}</td><td>${d._agent}</td><td>${d["계약번호"]}</td>
        <td>${d["상호명"]||d["상호"]}</td><td><span class="badge ${d._status==='처리완료'?'bd-done':'bd-wait'}">${d._status}</span></td>
        <td>${d._fee.toLocaleString()}</td><td>${d._addr||""}</td></tr>
    `).join('');
}

/* RENDER PIPELINE */
function renderPipeView() {
    const data = App.filtered;

    // KPI 집계
    const total = data.length;
    const success = data.filter(d=>d._step==='방어성공').length;
    const fail = data.filter(d=>d._step==='방어실패').length;
    const ing = data.filter(d=>d._step==='진행중').length;

    animateNum('pipe-total', total);
    animateNum('pipe-success', success);
    document.getElementById('pipe-rate-success').innerText = total ? `(${((success/total)*100).toFixed(1)}%)` : '(0%)';
    animateNum('pipe-fail', fail);
    document.getElementById('pipe-rate-fail').innerText = total ? `(${((fail/total)*100).toFixed(1)}%)` : '(0%)';
    animateNum('pipe-ing', ing);
    document.getElementById('pipe-rate-ing').innerText = total ? `(${((ing/total)*100).toFixed(1)}%)` : '(0%)';

    const agg = { hq: {}, branch: {} };
    HQ_ORDER.forEach(hq => agg.hq[hq] = { _total:0 });

    data.forEach(d => {
        const hq = d._hq || '기타';
        const br = d._branch || '기타';
        const st = d._step; 
        const fee = d._fee / 1000;

        if(!agg.hq[hq]) agg.hq[hq] = { _total:0 };
        if(!agg.hq[hq][st]) agg.hq[hq][st] = { cnt:0, amt:0 };
        agg.hq[hq][st].cnt += 1;
        agg.hq[hq][st].amt += fee;
        agg.hq[hq]._total += 1;

        if(!agg.branch[br]) agg.branch[br] = { _hq: hq, _total:0 };
        if(!agg.branch[br][st]) agg.branch[br][st] = { cnt:0, amt:0 };
        agg.branch[br][st].cnt += 1;
        agg.branch[br][st].amt += fee;
        agg.branch[br]._total += 1;
    });

    drawStackedBar('chart-hq-count', 'hq', 'cnt', agg.hq, HQ_ORDER);
    drawStackedBar('chart-hq-amt', 'hq', 'amt', agg.hq, HQ_ORDER);
    
    const sortedBranches = Object.keys(agg.branch).sort((a,b) => {
        const hqA = agg.branch[a]._hq;
        const hqB = agg.branch[b]._hq;
        const idxA = HQ_ORDER.indexOf(hqA);
        const idxB = HQ_ORDER.indexOf(hqB);
        if(idxA !== -1 && idxB !== -1 && idxA !== idxB) return idxA - idxB;
        return a.localeCompare(b);
    });

    drawStackedBar('chart-branch-count', 'branch', 'cnt', agg.branch, sortedBranches);
    drawStackedBar('chart-branch-amt', 'branch', 'amt', agg.branch, sortedBranches);
}

/* CHART FUNCTIONS */
function drawVocBar(id, data, key) {
    const counts = {};
    data.forEach(d => counts[d[key]] = (counts[d[key]]||0)+1);
    let labels = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]).slice(0,15);
    if(key === '_branch') {
        labels = labels.sort((a,b) => {
            const ia=BRANCH_ORDER.indexOf(a), ib=BRANCH_ORDER.indexOf(b);
            if(ia!==-1 && ib!==-1) return ia-ib; return a.localeCompare(b);
        });
    }
    const ctx = document.getElementById(id).getContext('2d');
    if(App.charts[id]) App.charts[id].destroy();
    App.charts[id] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{ label: '건수', data: labels.map(l=>counts[l]), backgroundColor: '#6366f1', borderRadius:4, maxBarThickness:35 }]
        },
        options: { indexAxis: 'x', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}} }
    });
}

function drawStackedBar(id, type, metric, aggData, labels) {
    const ctx = document.getElementById(id).getContext('2d');
    const canvas = document.getElementById(id);
    
    // [수정] 기본 모드를 'linear'(실제비율)로 설정
    let currentMode = canvas.dataset.viewMode || 'linear'; 
    const isCompressed = currentMode === 'compressed';
    const card = canvas.closest('.card');
    const header = card ? card.querySelector('.card-head') : null;
    
    if (header) {
        header.style.flexWrap = 'wrap'; header.style.gap = '8px';
        if (!header.querySelector('.scale-toggle-btn')) {
            const btn = document.createElement('button');
            btn.className = 'scale-toggle-btn';
            btn.style.cssText = `margin-left:auto; padding:3px 8px; font-size:11px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; border-radius:6px; color:#475569; font-weight:700; white-space:nowrap;`;
            btn.innerHTML = `<i class="ph ph-arrows-in-line-vertical"></i> ${isCompressed ? '압축됨' : '원본'}`;
            btn.onclick = () => {
                canvas.dataset.viewMode = canvas.dataset.viewMode==='compressed'?'linear':'compressed';
                renderPipeView(); 
            };
            header.appendChild(btn);
        } else {
            const btn = header.querySelector('.scale-toggle-btn');
            btn.innerHTML = isCompressed ? `<i class="ph ph-arrows-in-line-vertical"></i> 보기보정 ON` : `<i class="ph ph-arrows-out-line-vertical"></i> 실제비율`;
            btn.style.background = isCompressed ? '#e0e7ff' : '#fff';
            btn.style.color = isCompressed ? '#4f46e5' : '#475569';
        }
    }

    if(App.charts[id]) App.charts[id].destroy();

    const statuses = ['방어성공', '방어실패', '진행중'];
    const stackHeights = new Array(labels.length).fill(0);
    const datasets = statuses.map(status => {
        const rawData = labels.map(label => {
            const item = aggData[label];
            return (item && item[status]) ? Math.round(item[status][metric]) : 0;
        });
        const chartData = rawData.map((val, idx) => {
            // 압축 모드일 때만 네제곱근 적용
            const t = isCompressed ? Math.pow(val, 0.25) : val;
            stackHeights[idx] += t;
            return t;
        });
        return {
            label: status,
            data: chartData,
            rawData: rawData,
            backgroundColor: COLORS[status],
            barPercentage: 0.7,
            maxBarThickness: 50,
            borderRadius: 3
        };
    });

    const maxStackHeight = Math.max(...stackHeights);
    const isHorizontal = (type === 'hq'); 

    App.charts[id] = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: datasets },
        options: {
            indexAxis: isHorizontal ? 'y' : 'x',
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 10, right: 15 } },
            animation: {
                duration: 800,
                delay: (c) => c.type === 'data' && c.mode === 'default' ? c.dataIndex * 50 + c.datasetIndex * 30 : 0
            },
            plugins: {
                legend: { display: true, position: 'top', align: 'end', labels:{boxWidth:10, font:{size:11}} },
                tooltip: {
                    mode: 'index', intersect: false,
                    callbacks: {
                        label: (ctx) => `${ctx.dataset.label}: ${ctx.dataset.rawData[ctx.dataIndex].toLocaleString()}`,
                        footer: (items) => `합계: ${items.reduce((a,b)=>a+b.dataset.rawData[b.dataIndex],0).toLocaleString()}`
                    }
                },
                datalabels: {
                    color: '#fff',
                    font: { size: 10, weight: 'bold' },
                    display: (ctx) => {
                        const val = ctx.dataset.data[ctx.dataIndex];
                        // 압축 여부에 따라 라벨 표시 임계값 조정
                        const thres = isCompressed ? 0.3 : (maxStackHeight * 0.05); 
                        return val > thres;
                    },
                    formatter: (val, ctx) => ctx.dataset.rawData[ctx.dataIndex].toLocaleString(),
                    anchor: 'center', align: 'center'
                }
            },
            scales: {
                x: { 
                    stacked: true, 
                    grid: { display: false },
                    ticks: { font: { size: 11, weight:'bold' }, color: '#334155' }
                },
                y: { 
                    stacked: true, 
                    display: !isCompressed, 
                    grid: { display: !isCompressed, borderDash: [2, 4] },
                    ticks: { font: { size: 11 } },
                    beginAtZero: true,
                    max: isCompressed ? maxStackHeight * 1.1 : undefined,
                    grace: 0
                }
            }
        }
    });
}

function switchView(v) {
    App.view = v;
    document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active'));
    document.getElementById('view-'+v).classList.add('active');
    document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
    document.querySelector(`button[onclick="switchView('${v}')"]`).classList.add('active');
    updateDashboard(); 
    setTimeout(() => {
        Object.values(App.charts).forEach(c => c.resize());
        if(v==='voc' && App.map) google.maps.event.trigger(App.map, 'resize');
    }, 100);
}

function triggerUpload() { document.getElementById('fileInput').click(); }
function initMap() {
    // [수정] 서울/수도권 중심 좌표
    App.map = new google.maps.Map(document.getElementById('voc-map'), { 
        center: {lat: 37.5665, lng: 126.9780}, 
        zoom: 10, 
        disableDefaultUI: true 
    });
}
function updateMap(data) {
    if(!App.map) return;
    if(App.clusterer) App.clusterer.clearMarkers();
    App.markers = [];
    const bounds = new google.maps.LatLngBounds();
    data.filter(d=>d._lat).forEach(d => {
        const m = new google.maps.Marker({ position:{lat:d._lat, lng:d._lng}, title: d["상호명"]||d["상호"] });
        bounds.extend(m.getPosition());
        App.markers.push(m);
    });
    App.clusterer = new markerClusterer.MarkerClusterer({ map: App.map, markers: App.markers });
    if(App.markers.length) App.map.fitBounds(bounds);
    else { App.map.setCenter({lat: 37.5665, lng: 126.9780}); App.map.setZoom(10); }
}
function animateNum(id, target) {
    document.getElementById(id).innerText = target.toLocaleString();
}
</script>
</body>
</html>
