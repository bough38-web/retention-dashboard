<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>KTT í†µí•© ëŒ€ì‹œë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>



  <style>
    body {
      margin: 0;
      display: flex;
      background: #f5f5f7;
      font-family: "Apple SD Gothic Neo", "Segoe UI", sans-serif;
    }

    .sidebar {
      width: 260px;
      padding: 20px;
      background: #fff;
      border-right: 1px solid #ddd;
      height: 100vh;
      overflow-y: auto;
    }

    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .chart-box {
      background: #fff;
      border-radius: 16px;
      padding: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    #map {
      width: 100%;
      height: 420px;
      border-radius: 12px;
    }

    select, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 8px;
      border: 1px solid #bbb;
      cursor: pointer;
    }

    label { display:block; padding:4px 0; }
  </style>
</head>

<body>

<!-- --------------------------------------- -->
<!-- ì¢Œì¸¡ í•„í„° íŒ¨ë„ -->
<!-- --------------------------------------- -->

<div class="sidebar">
  <h2>ğŸ“Œ í•„í„°</h2>

  <label>ë‹´ë‹¹ì˜ì—…ì±„ë„</label>
  <select id="channelFilter">
    <option value="ALL">ì „ì²´</option>
    <option value="SP">SP</option>
    <option value="SC">SC</option>
    <option value="AM">AM</option>
  </select>

  <label>í•´ì§€ìœ„í—˜ë„ (%)</label>
  <label><input type="radio" name="risk" value="ALL" checked> ì „ì²´</label>
  <label><input type="radio" name="risk" value="0"> 0~25%</label>
  <label><input type="radio" name="risk" value="25"> 25~50%</label>
  <label><input type="radio" name="risk" value="50"> 50~75%</label>
  <label><input type="radio" name="risk" value="75"> 75~100%</label>

  <label>í‘œì‹œ ê¸°ì¤€</label>
  <button onclick="setMode('count')">ê±´ìˆ˜</button>
  <button onclick="setMode('amount')">ê¸ˆì•¡(ì²œì›)</button>
</div>


<!-- --------------------------------------- -->
<!-- ìš°ì¸¡ ëŒ€ì‹œë³´ë“œ ì˜ì—­ -->
<!-- --------------------------------------- -->

<div class="content">

  <div class="chart-box">
    <h3>ğŸ“ VOC ì„¤ì¹˜ ì£¼ì†Œ ì§€ë„</h3>
    <div id="map"></div>
  </div>

  <div class="chart-box">
    <h3>ğŸ“Š ê´€ë¦¬ë³¸ë¶€/ì§€ì‚¬ë³„ í•´ì§€ í˜„í™©</h3>
    <canvas id="pipelineBranchChart"></canvas>
  </div>

  <div class="chart-box">
    <h3>ğŸ“Š ë°©ì–´ì§„í–‰ë‹¨ê³„ ì ì¸µ</h3>
    <canvas id="pipelineStageChart"></canvas>
  </div>

  <div class="chart-box">
    <h3>ğŸ“Š VOC ê´€ë¦¬ì§€ì‚¬ë³„ ìƒíƒœ</h3>
    <canvas id="vocBranchChart"></canvas>
  </div>

  <div class="chart-box">
    <h3>ğŸ“Š VOC ë‹´ë‹¹ì TOP20</h3>
    <canvas id="vocAgentChart"></canvas>
  </div>

</div>

<script>
/* ------------------------------------------------------
   CSV ê²½ë¡œ (ì˜ë¬¸ íŒŒì¼ë§Œ ì‚¬ìš©í•´ì•¼ ë¡œë”©ë¨)
--------------------------------------------------------- */

const VOC_CSV_URL = "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv";
const PIPELINE_CSV_URL = "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv";

let vocData = [];
let pipelineData = [];
let mode = "count";

let pipelineBranchChart, pipelineStageChart, vocBranchChart, vocAgentChart;
let map, markers = [];


/* ------------------------------------------------------
   ë°ì´í„° ìœ í‹¸ í•¨ìˆ˜
--------------------------------------------------------- */
function normalizeBranch(name) {
  return String(name || "").replace("ì§€ì‚¬", "").trim();
}

function cleanContractNumber(n) {
  return String(n || "").replace(/\D/g, "").slice(0, 8);
}

function toThousand(n) {
  const v = parseFloat(String(n || "").replace(/,/g, ""));
  return isNaN(v) ? 0 : Math.round(v / 1000);
}

function checkRisk(val, mode) {
  if (mode === "ALL") return true;
  const v = parseFloat(val);
  const m = parseFloat(mode);
  if (m === 0) return v < 25;
  if (m === 25) return v >= 25 && v < 50;
  if (m === 50) return v >= 50 && v < 75;
  if (m === 75) return v >= 75;
}

async function loadCsv(url) {
  const res = await fetch(url);
  const text = await res.text();
  return new Promise(ok=>{
    Papa.parse(text, {header:true, skipEmptyLines:true, complete:r=>ok(r.data)});
  });
}


/* ------------------------------------------------------
   ì§€ë„ ê¸°ëŠ¥
--------------------------------------------------------- */
function initMap() {
  map = new kakao.maps.Map(document.getElementById("map"), {
    center: new kakao.maps.LatLng(37.5665,126.9780),
    level: 7
  });
}

function extractCoords(url){
  if (!url || !url.includes("q=")) return null;
  try {
    const p = url.split("q=")[1].split(",");
    return { lat: parseFloat(p[0]), lng: parseFloat(p[1]) };
  } catch { return null; }
}

function drawMarkers(){
  markers.forEach(m=>m.setMap(null));
  markers = [];

  vocData.forEach(r=>{
    const pos = extractCoords(r["ì§€ë„ë§í¬"]);
    if (!pos) return;
    markers.push(new kakao.maps.Marker({
      map,
      position: new kakao.maps.LatLng(pos.lat,pos.lng)
    }));
  });
}


/* ------------------------------------------------------
   í•´ì§€ íŒŒì´í”„ë¼ì¸ - ì§‘ê³„
--------------------------------------------------------- */
function aggPipelineBranch() {
  const ch = document.getElementById("channelFilter").value;
  const risk = document.querySelector("input[name='risk']:checked").value;

  const agg={};

  pipelineData.forEach(r=>{
    if (ch!=="ALL" && r["ë‹´ë‹¹ì˜ì—…ì±„ë„"]!==ch) return;
    if (!checkRisk(r["í•´ì§€ìœ„í—˜ë„"], risk)) return;

    const head = (r["ê´€ë¦¬ë³¸ë¶€"]||"").trim();
    const branch = normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]);
    const key = `${head} / ${branch}`;

    if (!agg[key]) agg[key]={count:0,amount:0};

    if (cleanContractNumber(r["ê³„ì•½ë²ˆí˜¸"])) agg[key].count++;
    agg[key].amount += toThousand(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
  });

  const arr = Object.entries(agg).sort((a,b)=>{
    const av = mode==="count" ? a[1].count : a[1].amount;
    const bv = mode==="count" ? b[1].count : b[1].amount;
    return bv-av;
  });

  return {
    labels: arr.map(e=>e[0]),
    counts: arr.map(e=>e[1].count),
    amounts: arr.map(e=>e[1].amount)
  };
}

function drawPipelineBranch() {
  const ctx=document.getElementById("pipelineBranchChart").getContext("2d");
  const {labels, counts, amounts} = aggPipelineBranch();
  const data = mode==="count" ? counts : amounts;

  if (pipelineBranchChart) pipelineBranchChart.destroy();

  pipelineBranchChart = new Chart(ctx,{
    type:"bar",
    data:{ labels, datasets:[{label:mode==="count"?"ê±´ìˆ˜":"ê¸ˆì•¡(ì²œì›)", data}]},
    options:{responsive:true, scales:{y:{beginAtZero:true}}}
  });
}


/* ------------------------------------------------------
   í•´ì§€ íŒŒì´í”„ë¼ì¸ - ë°©ì–´ ë‹¨ê³„ ì ì¸µ
--------------------------------------------------------- */
function aggStages(){
  const ch = document.getElementById("channelFilter").value;
  const risk = document.querySelector("input[name='risk']:checked").value;

  const agg={}, stages=["ì§„í–‰ì¤‘","ë°©ì–´ì‹¤íŒ¨","ë°©ì–´ì„±ê³µ"];

  pipelineData.forEach(r=>{
    if (ch!=="ALL" && r["ë‹´ë‹¹ì˜ì—…ì±„ë„"]!==ch) return;
    if (!checkRisk(r["í•´ì§€ìœ„í—˜ë„"], risk)) return;

    const br = normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]);
    const st = (r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]||"").trim();

    if (!agg[br]) agg[br]={ì§„í–‰ì¤‘:0,ë°©ì–´ì‹¤íŒ¨:0,ë°©ì–´ì„±ê³µ:0};
    if (stages.includes(st)) agg[br][st]++;
  });

  const labels = Object.keys(agg);

  return {
    labels,
    ì§„í–‰ì¤‘: labels.map(b=>agg[b]["ì§„í–‰ì¤‘"]),
    ë°©ì–´ì‹¤íŒ¨: labels.map(b=>agg[b]["ë°©ì–´ì‹¤íŒ¨"]),
    ë°©ì–´ì„±ê³µ: labels.map(b=>agg[b]["ë°©ì–´ì„±ê³µ"]),
  };
}

function drawPipelineStage(){
  const ctx=document.getElementById("pipelineStageChart").getContext("2d");
  const {labels, ì§„í–‰ì¤‘, ë°©ì–´ì‹¤íŒ¨, ë°©ì–´ì„±ê³µ} = aggStages();

  if (pipelineStageChart) pipelineStageChart.destroy();

  pipelineStageChart = new Chart(ctx,{
    type:"bar",
    data:{
      labels,
      datasets:[
        {label:"ì§„í–‰ì¤‘", data:ì§„í–‰ì¤‘, stack:"s"},
        {label:"ë°©ì–´ì‹¤íŒ¨", data:ë°©ì–´ì‹¤íŒ¨, stack:"s"},
        {label:"ë°©ì–´ì„±ê³µ", data:ë°©ì–´ì„±ê³µ, stack:"s"},
      ]
    },
    options:{
      responsive:true,
      scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}
    }
  });
}


/* ------------------------------------------------------
   VOC ì°¨íŠ¸
--------------------------------------------------------- */
function aggVoc(field, limit=20){
  const agg={};

  vocData.forEach(r=>{
    const key = field==="ê´€ë¦¬ì§€ì‚¬"
      ? normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])
      : (r[field]||"").trim();
    if (!key) return;

    const st = (r["ìƒíƒœ"]||"").trim();
    if (!agg[key]) agg[key]={ì²˜ë¦¬ì™„ë£Œ:0,ì ‘ìˆ˜:0,ë¯¸ì ‘ìˆ˜:0};
    if (["ì²˜ë¦¬ì™„ë£Œ","ì ‘ìˆ˜","ë¯¸ì ‘ìˆ˜"].includes(st)) agg[key][st]++;
  });

  const arr = Object.entries(agg).sort((a,b)=>{
    const at=a[1]["ì²˜ë¦¬ì™„ë£Œ"]+a[1]["ì ‘ìˆ˜"]+a[1]["ë¯¸ì ‘ìˆ˜"];
    const bt=b[1]["ì²˜ë¦¬ì™„ë£Œ"]+b[1]["ì ‘ìˆ˜"]+b[1]["ë¯¸ì ‘ìˆ˜"];
    return bt-at;
  }).slice(0,limit);

  return {
    labels: arr.map(e=>e[0]),
    ì²˜ë¦¬ì™„ë£Œ: arr.map(e=>e[1]["ì²˜ë¦¬ì™„ë£Œ"]),
    ì ‘ìˆ˜: arr.map(e=>e[1]["ì ‘ìˆ˜"]),
    ë¯¸ì ‘ìˆ˜: arr.map(e=>e[1]["ë¯¸ì ‘ìˆ˜"])
  };
}

function drawVocBranch(){
  const ctx=document.getElementById("vocBranchChart").getContext("2d");
  const {labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜} = aggVoc("ê´€ë¦¬ì§€ì‚¬", 30);

  if (vocBranchChart) vocBranchChart.destroy();

  vocBranchChart = new Chart(ctx,{
    type:"bar",
    data:{
      labels,
      datasets:[
        {label:"ì²˜ë¦¬ì™„ë£Œ", data:ì²˜ë¦¬ì™„ë£Œ, stack:"voc"},
        {label:"ì ‘ìˆ˜", data:ì ‘ìˆ˜, stack:"voc"},
        {label:"ë¯¸ì ‘ìˆ˜", data:ë¯¸ì ‘ìˆ˜, stack:"voc"},
      ]
    },
    options:{
      responsive:true,
      scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}
    }
  });
}

function drawVocAgent(){
  const ctx=document.getElementById("vocAgentChart").getContext("2d");
  const {labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜} = aggVoc("ë‹´ë‹¹ì", 20);

  if (vocAgentChart) vocAgentChart.destroy();

  vocAgentChart = new Chart(ctx,{
    type:"bar",
    data:{
      labels,
      datasets:[
        {label:"ì²˜ë¦¬ì™„ë£Œ", data:ì²˜ë¦¬ì™„ë£Œ, stack:"agent"},
        {label:"ì ‘ìˆ˜", data:ì ‘ìˆ˜, stack:"agent"},
        {label:"ë¯¸ì ‘ìˆ˜", data:ë¯¸ì ‘ìˆ˜, stack:"agent"},
      ]
    },
    options:{
      responsive:true,
      scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}
    }
  });
}


/* ------------------------------------------------------
   ì—…ë°ì´íŠ¸ ê¸°ëŠ¥
--------------------------------------------------------- */
function updatePipeline(){
  drawPipelineBranch();
  drawPipelineStage();
}


/* ------------------------------------------------------
   ì´ˆê¸° ë¡œë“œ
--------------------------------------------------------- */
async function initDashboard(){
  initMap();

  vocData = await loadCsv(VOC_CSV_URL);
  pipelineData = await loadCsv(PIPELINE_CSV_URL);

  drawMarkers();
  drawPipeline();
  drawVocBranch();
  drawVocAgent();

  document.getElementById("channelFilter").addEventListener("change", updatePipeline);
  document.querySelectorAll("input[name='risk']").forEach(r=>r.addEventListener("change", updatePipeline));
}

window.addEventListener("load", initDashboard);

</script>

</body>
</html>
