<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>KTT í†µí•© ëŒ€ì‹œë³´ë“œ (VOC / PIPELINE ë¶„ë¦¬)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì • */
        body {
            margin: 0;
            display: flex;
            background: #f5f5f7;
            font-family: "Apple SD Gothic Neo", "Segoe UI", sans-serif;
            color: #333;
        }

        /* ë ˆì´ì•„ì›ƒ */
        .sidebar {
            width: 280px;
            background: #ffffff;
            padding: 20px;
            border-right: 1px solid #ddd;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 6px rgba(0,0,0,0.02);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* ë·° í† ê¸€ ë²„íŠ¼ */
        .view-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .view-switcher button {
            flex: 1;
            padding: 12px 15px;
            font-size: 15px;
            font-weight: 600;
            border: 2px solid #e5e7eb;
            background: #f9fafb;
            color: #4b5563;
        }

        .view-switcher button.active {
            background: #3b82f6;
            color: #fff;
            border-color: #2563eb;
        }

        /* ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼ */
        .sidebar h2 {
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #1f2937;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 5px solid #3b82f6;
        }

        .kpi-title {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }

        .chart-card, .list-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f3f4f6;
        }

        .card-header h3 {
            font-size: 18px;
            margin: 0;
            color: #1f2937;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        /* í¼ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
        button, select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #ffffff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        label {
            display: block;
            padding: 8px 0 4px;
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
        }

        /* ë²„íŠ¼ì‹ í•„í„° ìŠ¤íƒ€ì¼ */
        .filter-group {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px dotted #ddd;
        }

        .filter-group-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .filter-btn {
            flex: 0 0 auto;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            font-size: 12px;
            width: auto;
        }

        .filter-btn.active {
            background: #3b82f6;
            color: #fff;
            border-color: #2563eb;
            font-weight: 600;
        }
        
        .mode-btn.active {
            background: #10b981;
            color: #fff;
            border-color: #059669;
        }

        /* ë°ì´í„° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .data-table th {
            background-color: #f9fafb;
            font-weight: 700;
            color: #4b5563;
            cursor: pointer;
        }
        
        .list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        /* ë·° ìˆ¨ê¸°ê¸° */
        .dashboard-view {
            display: none;
        }
        
        .dashboard-view.active {
            display: block;
        }

    </style>
</head>

<body>

<div class="sidebar">
    <h2>ğŸ“Š í†µí•© ëŒ€ì‹œë³´ë“œ í•„í„°</h2>

    <div class="view-switcher">
        <button id="showPipelineBtn" class="active" onclick="switchView('pipeline')">í•´ì§€íŒŒì´í”„ë¼ì¸ í˜„í™©</button>
        <button id="showVocBtn" onclick="switchView('voc')">VOC í™œë™ í˜„í™©</button>
    </div>
    
    <div id="pipelineFilters" class="filter-panel">
        <label for="channelFilter">ë‹´ë‹¹ì˜ì—…ì±„ë„</label>
        <select id="channelFilter">
            <option value="ALL">ì „ì²´</option>
            <option value="SP">SP</option>
            <option value="SC">SC</option>
            <option value="AM">AM</option>
        </select>

        <label>í•´ì§€ìœ„í—˜ë„ (%)</label>
        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
            <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="ALL" checked> ì „ì²´</label>
            <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="0"> 0 ~ 25%</label>
            <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="25"> 25 ~ 50%</label>
            <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="50"> 50 ~ 75%</label>
            <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="75"> 75 ~ 100%</label>
        </div>

        <label>í‘œì‹œ ê¸°ì¤€</label>
        <div class="filter-buttons">
            <button class="mode-btn active" data-mode="count" onclick="setMode('count', this)">ê±´ìˆ˜</button>
            <button class="mode-btn" data-mode="amount" onclick="setMode('amount', this)">ê¸ˆì•¡(ì²œì›)</button>
        </div>

        <div class="filter-group">
            <div class="filter-group-title">ê´€ë¦¬ë³¸ë¶€</div>
            <div id="hqButtons" class="filter-buttons">
                </div>
        </div>

        <div class="filter-group">
            <div class="filter-group-title">ê´€ë¦¬ì§€ì‚¬</div>
            <div id="branchButtons" class="filter-buttons">
                </div>
        </div>
    </div>
    
    <div id="vocFilters" class="filter-panel" style="display:none;">
        <label for="vocTypeFilter">VOC ìœ í˜• ëŒ€</label>
        <select id="vocTypeFilter">
            <option value="ALL">ì „ì²´</option>
            </select>
        
        <label>VOC ìƒíƒœ</label>
        <div id="vocStatusButtons" class="filter-buttons">
            <button class="filter-btn active" data-value="ALL" onclick="setVocStatus('ALL', this)">ì „ì²´</button>
            <button class="filter-btn" data-value="ì²˜ë¦¬ì™„ë£Œ" onclick="setVocStatus('ì²˜ë¦¬ì™„ë£Œ', this)">ì²˜ë¦¬ì™„ë£Œ</button>
            <button class="filter-btn" data-value="ì ‘ìˆ˜" onclick="setVocStatus('ì ‘ìˆ˜', this)">ì ‘ìˆ˜</button>
            <button class="filter-btn" data-value="ë¯¸ì ‘ìˆ˜" onclick="setVocStatus('ë¯¸ì ‘ìˆ˜', this)">ë¯¸ì ‘ìˆ˜</button>
        </div>
    </div>
</div>

<div class="content">

    <div id="pipelineView" class="dashboard-view active">
        <h2>ğŸ”¥ í•´ì§€íŒŒì´í”„ë¼ì¸ ë“±ë¡ í˜„í™©</h2>
        
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">í•´ì§€íŒŒì´í”„ë¼ì¸ ì´ ê±´ìˆ˜</div>
                <div id="kpi-pipeline-count" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #10b981;">
                <div class="kpi-title">ì´ ì›”ì •ë£Œ ê¸ˆì•¡ (ì²œì›)</div>
                <div id="kpi-pipeline-amount" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #ef4444;">
                <div class="kpi-title">í•´ì§€ê³ ìœ„í—˜ (75%~) ê±´ìˆ˜</div>
                <div id="kpi-high-risk-count" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #f59e0b;">
                <div class="kpi-title">ë°©ì–´ ì„±ê³µë¥  (%)</div>
                <div id="kpi-defense-success-rate" class="kpi-value">0%</div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <div class="card-header">
                    <h3>ğŸ“ˆ ê´€ë¦¬ë³¸ë¶€ / ê´€ë¦¬ì§€ì‚¬ë³„ í•´ì§€ í˜„í™©</h3>
                </div>
                <canvas id="pipelineBranchChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="card-header">
                    <h3>ğŸ“Š ë°©ì–´ì§„í–‰ë‹¨ê³„ (ì§€ì‚¬ë³„ ì ì¸µ)</h3>
                </div>
                <canvas id="pipelineStageChart"></canvas>
            </div>
        </div>

        <div class="list-card">
            <div class="card-header">
                <h3>ğŸ“ í•„í„°ë§ëœ í•´ì§€íŒŒì´í”„ë¼ì¸ ìƒì„¸ ë¦¬ìŠ¤íŠ¸</h3>
                <p style="font-size: 12px; color: #9ca3af; margin: 5px 0 0;">(í…Œì´ë¸” í—¤ë” í´ë¦­ ì‹œ ì •ë ¬)</p>
            </div>
            <div class="list-container">
                <table id="pipelineListTable" class="data-table">
                    <thead>
                        <tr>
                            <th data-field="ê³„ì•½ë²ˆí˜¸" data-sort="asc">ê³„ì•½ë²ˆí˜¸</th>
                            <th data-field="ê´€ë¦¬ë³¸ë¶€">ê´€ë¦¬ë³¸ë¶€</th>
                            <th data-field="ê´€ë¦¬ì§€ì‚¬">ê´€ë¦¬ì§€ì‚¬</th>
                            <th data-field="í•´ì§€ìœ„í—˜ë„" data-sort="none">ìœ„í—˜ë„ (%)</th>
                            <th data-field="ë‹´ë‹¹ì˜ì—…ì±„ë„">ì˜ì—…ì±„ë„</th>
                            <th data-field="KTTì›”ì •ë£Œ(ì¡°ì •)" data-sort="none">ì›”ì •ë£Œ (ì²œì›)</th>
                            <th data-field="ë°©ì–´ì§„í–‰ë‹¨ê³„">ë°©ì–´ì§„í–‰ë‹¨ê³„</th>
                            <th data-field="ë°©ì–´ë‹´ë‹¹ì">ë°©ì–´ë‹´ë‹¹ì</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="vocView" class="dashboard-view">
        <h2>ğŸ’¬ ê´€ë¦¬ê³ ê° í•´ì§€ê³ ìœ„í—˜ VOC í™œë™ í˜„í™©</h2>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">ì´ VOC ê±´ìˆ˜</div>
                <div id="kpi-voc-total" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #10b981;">
                <div class="kpi-title">ì²˜ë¦¬ì™„ë£Œ ê±´ìˆ˜</div>
                <div id="kpi-voc-complete" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #f59e0b;">
                <div class="kpi-title">ì²˜ë¦¬ ì™„ë£Œìœ¨ (%)</div>
                <div id="kpi-voc-complete-rate" class="kpi-value">0%</div>
            </div>
            <div class="kpi-card" style="border-left-color: #ef4444;">
                <div class="kpi-title">ë¯¸ì ‘ìˆ˜ ê±´ìˆ˜</div>
                <div id="kpi-voc-unassigned" class="kpi-value">0</div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <div class="card-header">
                    <h3>ğŸ’¬ VOC ê´€ë¦¬ì§€ì‚¬ë³„ ìƒíƒœ (ì ì¸µ)</h3>
                </div>
                <canvas id="vocBranchChart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="card-header">
                    <h3>ğŸ‘¨â€ğŸ’¼ VOC ë‹´ë‹¹ìë³„ ìƒíƒœ (Top 20)</h3>
                </div>
                <canvas id="vocAgentChart"></canvas>
            </div>
        </div>

        <div class="list-card">
            <div class="card-header">
                <h3>ğŸ“ í•„í„°ë§ëœ VOC ìƒì„¸ ë¦¬ìŠ¤íŠ¸</h3>
                <p style="font-size: 12px; color: #9ca3af; margin: 5px 0 0;">(í…Œì´ë¸” í—¤ë” í´ë¦­ ì‹œ ì •ë ¬)</p>
            </div>
            <div class="list-container">
                <table id="vocListTable" class="data-table">
                    <thead>
                        <tr>
                            <th data-field="ì ‘ìˆ˜ë²ˆí˜¸" data-sort="asc">ì ‘ìˆ˜ë²ˆí˜¸</th>
                            <th data-field="ìƒíƒœ">ìƒíƒœ</th>
                            <th data-field="VOCìœ í˜•ëŒ€">ìœ í˜• ëŒ€</th>
                            <th data-field="VOCìœ í˜•ì¤‘">ìœ í˜• ì¤‘</th>
                            <th data-field="VOCìœ í˜•ì†Œ">ìœ í˜• ì†Œ</th>
                            <th data-field="ê´€ë¦¬ë³¸ë¶€">ê´€ë¦¬ë³¸ë¶€</th>
                            <th data-field="ê´€ë¦¬ì§€ì‚¬">ê´€ë¦¬ì§€ì‚¬</th>
                            <th data-field="ë‹´ë‹¹ì">ë‹´ë‹¹ì</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    /* ---------------------------------------------------------
        ğŸ“Œ CSV ë°ì´í„° ê²½ë¡œ
    --------------------------------------------------------- */
    const VOC_CSV_URL =
        "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv";

    const PIPELINE_CSV_URL =
        "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv";

    // Chart.js í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
    Chart.register(ChartDataLabels);

    /* ---------------------------------------------------------
        ğŸ“Œ ì „ì—­ ìƒíƒœê°’
    --------------------------------------------------------- */
    let currentView = "pipeline"; // 'pipeline' ë˜ëŠ” 'voc'
    
    // PIPELINE ìƒíƒœ
    let pipelineMode = "count";
    let pipelineData = [];
    let filteredPipelineData = [];
    let pipelineSelectedHQ = "ALL";
    let pipelineSelectedBranch = "ALL";
    let pipelineListSortField = "KTTì›”ì •ë£Œ(ì¡°ì •)";
    let pipelineListSortDirection = "desc";
    
    // VOC ìƒíƒœ
    let vocData = [];
    let filteredVocData = [];
    let vocSelectedType = "ALL";
    let vocSelectedStatus = "ALL";
    let vocListSortField = "ì ‘ìˆ˜ë²ˆí˜¸";
    let vocListSortDirection = "desc";

    // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
    let chartInstances = {}; // { pipelineBranchChart: instance, ... }

    /* ---------------------------------------------------------
        ğŸ“Œ ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    --------------------------------------------------------- */

    function normalizeBranch(name) {
        if (!name) return "";
        return String(name).replace("ì§€ì‚¬", "").trim();
    }
    function cleanContractNumber(raw) {
        if (!raw) return "";
        return String(raw).replace(/\D/g, "").slice(0, 8);
    }
    function toThousandWon(raw) {
        if (!raw) return 0;
        const num = parseFloat(String(raw).replace(/,/g, ""));
        return isNaN(num) ? 0 : Math.round(num / 1000);
    }
    function formatNumber(num) {
        return num.toLocaleString();
    }
    function checkRisk(value, selected) {
        if (selected === "ALL") return true;
        const v = parseFloat(value);
        if (isNaN(v)) return false;
        const s = parseInt(selected);
        if (s === 0) return v >= 0 && v < 25;
        if (s === 25) return v >= 25 && v < 50;
        if (s === 50) return v >= 50 && v < 75;
        if (s === 75) return v >= 75 && v <= 100;
        return true;
    }
    async function loadCsv(url) {
        const res = await fetch(url);
        const text = await res.text();
        return new Promise(resolve => {
            Papa.parse(text, {
                header: true,
                skipEmptyLines: true,
                complete: r => resolve(r.data)
            });
        });
    }
    
    // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬
    function destroyChart(id) {
        if (chartInstances[id]) {
            chartInstances[id].destroy();
            chartInstances[id] = null;
        }
    }

    /* ---------------------------------------------------------
        ğŸ“Œ ë·° ì „í™˜ ë¡œì§
    --------------------------------------------------------- */
    function switchView(view) {
        currentView = view;

        // ë²„íŠ¼ í™œì„±í™”
        document.querySelectorAll('.view-switcher button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`show${view.charAt(0).toUpperCase() + view.slice(1)}Btn`).classList.add('active');

        // ë·° ì „í™˜
        document.querySelectorAll('.dashboard-view').forEach(v => {
            v.classList.remove('active');
        });
        document.getElementById(`${view}View`).classList.add('active');

        // í•„í„° ì „í™˜
        document.getElementById('pipelineFilters').style.display = view === 'pipeline' ? 'block' : 'none';
        document.getElementById('vocFilters').style.display = view === 'voc' ? 'block' : 'none';

        // í•´ë‹¹ ë·°ì˜ ë°ì´í„° ì—…ë°ì´íŠ¸
        if (view === 'pipeline') {
            updatePipelineDashboard();
        } else {
            updateVocDashboard();
        }
    }

    /* ---------------------------------------------------------
        ğŸ“Œ PIPELINE - í•„í„°ë§ ë° ì—…ë°ì´íŠ¸ ë¡œì§
    --------------------------------------------------------- */

    function getPipelineSelectedChannel() { return document.getElementById("channelFilter").value; }
    function getPipelineSelectedRisk() { return document.querySelector('#pipelineFilters input[name="risk"]:checked').value; }

    function setMode(m, button) {
        pipelineMode = m;
        document.querySelectorAll("#pipelineFilters .mode-btn").forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");
        updatePipelineDashboard();
    }

    function filterPipelineData() {
        const channel = getPipelineSelectedChannel();
        const risk = getPipelineSelectedRisk();

        filteredPipelineData = pipelineData.filter(row => {
            if (!cleanContractNumber(row["ê³„ì•½ë²ˆí˜¸"])) return false;
            if (channel !== "ALL" && row["ë‹´ë‹¹ì˜ì—…ì±„ë„"] !== channel) return false;
            if (!checkRisk(row["í•´ì§€ìœ„í—˜ë„"], risk)) return false;

            const head = (row["ê´€ë¦¬ë³¸ë¶€"] || "").trim();
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);

            if (pipelineSelectedHQ !== "ALL" && head !== pipelineSelectedHQ) return false;
            if (pipelineSelectedBranch !== "ALL" && branch !== pipelineSelectedBranch) return false;
            return true;
        });
    }

    function renderPipelineHQButtons() {
        const container = document.getElementById("hqButtons");
        if (!container || !pipelineData.length) return;

        const heads = Array.from(new Set(pipelineData.map(r => (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim()).filter(Boolean))).sort();

        let html = "";
        html += `<button type="button" class="filter-btn ${pipelineSelectedHQ === "ALL" ? "active" : ""}" data-value="ALL">ì „ì²´</button>`;
        heads.forEach(hq => {
            html += `<button type="button" class="filter-btn ${pipelineSelectedHQ === hq ? "active" : ""}" data-value="${hq}">${hq}</button>`;
        });
        container.innerHTML = html;

        container.querySelectorAll(".filter-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const val = btn.getAttribute("data-value");
                pipelineSelectedHQ = val;
                pipelineSelectedBranch = "ALL";
                renderPipelineHQButtons();
                renderPipelineBranchButtons();
                updatePipelineDashboard();
            });
        });
    }

    function renderPipelineBranchButtons() {
        const container = document.getElementById("branchButtons");
        if (!container || !pipelineData.length) return;

        let filtered = pipelineData;
        if (pipelineSelectedHQ !== "ALL") {
            filtered = filtered.filter(r => (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim() === pipelineSelectedHQ);
        }

        const branches = Array.from(new Set(
            filtered.map(r => normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])).filter(Boolean)
        )).sort();

        let html = "";
        html += `<button type="button" class="filter-btn ${pipelineSelectedBranch === "ALL" ? "active" : ""}" data-value="ALL">ì „ì²´</button>`;
        branches.forEach(br => {
            html += `<button type="button" class="filter-btn ${pipelineSelectedBranch === br ? "active" : ""}" data-value="${br}">${br}</button>`;
        });
        container.innerHTML = html;

        container.querySelectorAll(".filter-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const val = btn.getAttribute("data-value");
                pipelineSelectedBranch = val;
                renderPipelineBranchButtons();
                updatePipelineDashboard();
            });
        });
    }

    function updatePipelineKPIs() {
        if (!filteredPipelineData.length) {
            document.getElementById("kpi-pipeline-count").innerText = "0";
            document.getElementById("kpi-pipeline-amount").innerText = "0";
            document.getElementById("kpi-defense-success-rate").innerText = "0%";
            document.getElementById("kpi-high-risk-count").innerText = "0";
            return;
        }

        const totalCount = filteredPipelineData.length;
        const totalAmount = filteredPipelineData.reduce((sum, row) => sum + toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]), 0);
        
        const defenseSuccess = filteredPipelineData.filter(row => row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] === "ë°©ì–´ì„±ê³µ").length;
        const totalDefenseAttempt = filteredPipelineData.filter(row => 
            ["ë°©ì–´ì„±ê³µ", "ë°©ì–´ì‹¤íŒ¨", "ì§„í–‰ì¤‘"].includes(row["ë°©ì–´ì§„í–‰ë‹¨ê³„"])
        ).length;
        const defenseSuccessRate = totalDefenseAttempt > 0 ? (defenseSuccess / totalDefenseAttempt) * 100 : 0;
        
        const highRiskCount = filteredPipelineData.filter(row => parseFloat(row["í•´ì§€ìœ„í—˜ë„"]) >= 75).length;

        document.getElementById("kpi-pipeline-count").innerText = formatNumber(totalCount);
        document.getElementById("kpi-pipeline-amount").innerText = formatNumber(totalAmount);
        document.getElementById("kpi-defense-success-rate").innerText = `${defenseSuccessRate.toFixed(1)}%`;
        document.getElementById("kpi-high-risk-count").innerText = formatNumber(highRiskCount);
    }
    
    function drawPipelineBranchChart() {
        const agg = {};
        filteredPipelineData.forEach(row => {
            const key = `${(row["ê´€ë¦¬ë³¸ë¶€"] || "").trim()} / ${normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"])}`;
            if (!agg[key]) agg[key] = { count: 0, amount: 0 };
            agg[key].count++;
            agg[key].amount += toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
        });
        const entries = Object.entries(agg).sort((a, b) => {
            const av = pipelineMode === "count" ? a[1].count : a[1].amount;
            const bv = pipelineMode === "count" ? b[1].count : b[1].amount;
            return bv - av;
        }).slice(0, 20);
        
        const labels = entries.map(e => e[0]);
        const dataArray = pipelineMode === "count" ? entries.map(e => e[1].count) : entries.map(e => e[1].amount);
        const unit = pipelineMode === "count" ? "ê±´" : "ì²œì›";

        destroyChart("pipelineBranchChart");

        chartInstances.pipelineBranchChart = new Chart(document.getElementById("pipelineBranchChart").getContext("2d"), {
            type: "bar",
            data: { labels, datasets: [{ label: pipelineMode === "count" ? "ê±´ìˆ˜" : "ê¸ˆì•¡(ì²œì›)", data: dataArray, backgroundColor: '#3b82f6' }] },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    datalabels: { anchor: 'end', align: 'top', formatter: formatNumber, color: '#333' }
                },
                scales: { 
                    y: { beginAtZero: true, title: { display: true, text: unit } },
                    x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    function drawPipelineStageChart() {
        const stages = ["ì§„í–‰ì¤‘", "ë°©ì–´ì‹¤íŒ¨", "ë°©ì–´ì„±ê³µ"];
        const agg = {};
        filteredPipelineData.forEach(row => {
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (!branch) return;
            const stage = (row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] || "").trim();
            if (!agg[branch]) agg[branch] = { ì§„í–‰ì¤‘: 0, ë°©ì–´ì‹¤íŒ¨: 0, ë°©ì–´ì„±ê³µ: 0 };
            if (stages.includes(stage)) agg[branch][stage]++;
        });

        const labels = Object.keys(agg);
        labels.sort((a, b) => (agg[b].ì§„í–‰ì¤‘ + agg[b].ë°©ì–´ì‹¤íŒ¨ + agg[b].ë°©ì–´ì„±ê³µ) - (agg[a].ì§„í–‰ì¤‘ + agg[a].ë°©ì–´ì‹¤íŒ¨ + agg[a].ë°©ì–´ì„±ê³µ));
        const slicedLabels = labels.slice(0, 20);

        destroyChart("pipelineStageChart");

        chartInstances.pipelineStageChart = new Chart(document.getElementById("pipelineStageChart").getContext("2d"), {
            type: "bar",
            data: {
                labels: slicedLabels,
                datasets: [
                    { label: "ë°©ì–´ì„±ê³µ", data: slicedLabels.map(b => agg[b]["ë°©ì–´ì„±ê³µ"] || 0), stack: "s", backgroundColor: '#10b981' },
                    { label: "ì§„í–‰ì¤‘", data: slicedLabels.map(b => agg[b]["ì§„í–‰ì¤‘"] || 0), stack: "s", backgroundColor: '#f59e0b' },
                    { label: "ë°©ì–´ì‹¤íŒ¨", data: slicedLabels.map(b => agg[b]["ë°©ì–´ì‹¤íŒ¨"] || 0), stack: "s", backgroundColor: '#ef4444' },
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { stacked: true, ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } },
                    y: { stacked: true, beginAtZero: true, title: { display: true, text: "ê±´ìˆ˜" } }
                }
            }
        });
    }

    function renderPipelineList() {
        const tableBody = document.querySelector("#pipelineListTable tbody");
        tableBody.innerHTML = "";
        let sortedData = [...filteredPipelineData];

        const sortField = pipelineListSortField;
        const direction = pipelineListSortDirection === 'asc' ? 1 : -1;
        
        sortedData.sort((a, b) => {
            let valA = a[sortField];
            let valB = b[sortField];
            
            if (sortField === "í•´ì§€ìœ„í—˜ë„" || sortField === "KTTì›”ì •ë£Œ(ì¡°ì •)") {
                valA = parseFloat(String(valA).replace(/,/g, "")) || 0;
                valB = parseFloat(String(valB).replace(/,/g, "")) || 0;
            }
            
            if (valA < valB) return -1 * direction;
            if (valA > valB) return 1 * direction;
            return 0;
        });

        sortedData.slice(0, 100).forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${cleanContractNumber(row["ê³„ì•½ë²ˆí˜¸"])}</td>
                <td>${(row["ê´€ë¦¬ë³¸ë¶€"] || "").trim()}</td>
                <td>${normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"])}</td>
                <td>${(parseFloat(row["í•´ì§€ìœ„í—˜ë„"]) || 0).toFixed(1)}</td>
                <td>${row["ë‹´ë‹¹ì˜ì—…ì±„ë„"]}</td>
                <td>${formatNumber(toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]))}</td>
                <td>${row["ë°©ì–´ì§„í–‰ë‹¨ê³„"]}</td>
                <td>${row["ë°©ì–´ë‹´ë‹¹ì"]}</td>
            `;
            tableBody.appendChild(tr);
        });

        document.querySelectorAll("#pipelineListTable th").forEach(th => {
            th.innerHTML = th.getAttribute("data-field");
            if (th.getAttribute("data-field") === pipelineListSortField) {
                const icon = pipelineListSortDirection === 'asc' ? ' â–²' : ' â–¼';
                th.innerHTML += icon;
            }
        });
    }

    function attachPipelineSortEvents() {
        document.querySelectorAll("#pipelineListTable th").forEach(th => {
            th.addEventListener('click', function() {
                const field = this.getAttribute('data-field');
                if (field === pipelineListSortField) {
                    pipelineListSortDirection = pipelineListSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    pipelineListSortField = field;
                    pipelineListSortDirection = 'desc';
                }
                renderPipelineList();
            });
        });
    }

    function updatePipelineDashboard() {
        filterPipelineData();
        updatePipelineKPIs();
        drawPipelineBranchChart();
        drawPipelineStageChart();
        renderPipelineList();
    }


    /* ---------------------------------------------------------
        ğŸ“Œ VOC - í•„í„°ë§ ë° ì—…ë°ì´íŠ¸ ë¡œì§
    --------------------------------------------------------- */
    
    function setVocType(value, button) {
        vocSelectedType = value;
        document.querySelectorAll('#vocTypeFilter option').forEach(opt => {
             opt.selected = opt.value === value;
        });
        updateVocDashboard();
    }

    function setVocStatus(value, button) {
        vocSelectedStatus = value;
        document.querySelectorAll('#vocStatusButtons .filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        button.classList.add('active');
        updateVocDashboard();
    }

    function filterVocData() {
        filteredVocData = vocData.filter(row => {
            const type = (row["VOCìœ í˜•ëŒ€"] || "").trim();
            const status = (row["ìƒíƒœ"] || "").trim();

            if (vocSelectedType !== "ALL" && type !== vocSelectedType) return false;
            if (vocSelectedStatus !== "ALL" && status !== vocSelectedStatus) return false;
            return true;
        });
    }

    function updateVocKPIs() {
        if (!filteredVocData.length) {
            document.getElementById("kpi-voc-total").innerText = "0";
            document.getElementById("kpi-voc-complete").innerText = "0";
            document.getElementById("kpi-voc-complete-rate").innerText = "0%";
            document.getElementById("kpi-voc-unassigned").innerText = "0";
            return;
        }

        const totalVoc = filteredVocData.length;
        const completedVoc = filteredVocData.filter(row => (row["ìƒíƒœ"] || "").trim() === "ì²˜ë¦¬ì™„ë£Œ").length;
        const unassignedVoc = filteredVocData.filter(row => (row["ìƒíƒœ"] || "").trim() === "ë¯¸ì ‘ìˆ˜").length;
        const vocCompleteRate = totalVoc > 0 ? (completedVoc / totalVoc) * 100 : 0;

        document.getElementById("kpi-voc-total").innerText = formatNumber(totalVoc);
        document.getElementById("kpi-voc-complete").innerText = formatNumber(completedVoc);
        document.getElementById("kpi-voc-complete-rate").innerText = `${vocCompleteRate.toFixed(1)}%`;
        document.getElementById("kpi-voc-unassigned").innerText = formatNumber(unassignedVoc);
    }
    
    function renderVocTypeFilter() {
        const select = document.getElementById("vocTypeFilter");
        select.innerHTML = '<option value="ALL">ì „ì²´</option>';
        const types = Array.from(new Set(vocData.map(r => (r["VOCìœ í˜•ëŒ€"] || "").trim()).filter(Boolean))).sort();
        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            select.appendChild(option);
        });
        select.addEventListener('change', (e) => setVocType(e.target.value));
    }

    function aggregateVocBy(field, limit = 20) {
        const agg = {};
        const statuses = ["ì²˜ë¦¬ì™„ë£Œ", "ì ‘ìˆ˜", "ë¯¸ì ‘ìˆ˜"];

        filteredVocData.forEach(row => {
            let key = field === "ê´€ë¦¬ì§€ì‚¬"
                ? normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"])
                : (row[field] || "").trim();

            if (!key) return;

            const st = (row["ìƒíƒœ"] || "").trim();

            if (!agg[key]) agg[key] = { ì²˜ë¦¬ì™„ë£Œ: 0, ì ‘ìˆ˜: 0, ë¯¸ì ‘ìˆ˜: 0 };
            if (statuses.includes(st)) agg[key][st]++;
        });

        const entries = Object.entries(agg);
        entries.sort((a, b) =>
            (b[1].ì²˜ë¦¬ì™„ë£Œ + b[1].ì ‘ìˆ˜ + b[1].ë¯¸ì ‘ìˆ˜) -
            (a[1].ì²˜ë¦¬ì™„ë£Œ + a[1].ì ‘ìˆ˜ + a[1].ë¯¸ì ‘ìˆ˜)
        );

        const sliced = entries.slice(0, limit);

        return {
            labels: sliced.map(e => e[0]),
            ì²˜ë¦¬ì™„ë£Œ: sliced.map(e => e[1].ì²˜ë¦¬ì™„ë£Œ),
            ì ‘ìˆ˜: sliced.map(e => e[1].ì ‘ìˆ˜),
            ë¯¸ì ‘ìˆ˜: sliced.map(e => e[1].ë¯¸ì ‘ìˆ˜),
        };
    }

    function drawVocBranchChart() {
        const { labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜ } = aggregateVocBy("ê´€ë¦¬ì§€ì‚¬", 30);
        destroyChart("vocBranchChart");

        chartInstances.vocBranchChart = new Chart(document.getElementById("vocBranchChart").getContext("2d"), {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "ì²˜ë¦¬ì™„ë£Œ", data: ì²˜ë¦¬ì™„ë£Œ, stack: "v", backgroundColor: '#3b82f6' },
                    { label: "ì ‘ìˆ˜", data: ì ‘ìˆ˜, stack: "v", backgroundColor: '#f59e0b' },
                    { label: "ë¯¸ì ‘ìˆ˜", data: ë¯¸ì ‘ìˆ˜, stack: "v", backgroundColor: '#ef4444' },
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { stacked: true, ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } },
                    y: { stacked: true, beginAtZero: true, title: { display: true, text: "ê±´ìˆ˜" } }
                }
            }
        });
    }

    function drawVocAgentChart() {
        const { labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜ } = aggregateVocBy("ë‹´ë‹¹ì", 20);
        destroyChart("vocAgentChart");

        chartInstances.vocAgentChart = new Chart(document.getElementById("vocAgentChart").getContext("2d"), {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "ì²˜ë¦¬ì™„ë£Œ", data: ì²˜ë¦¬ì™„ë£Œ, stack: "va", backgroundColor: '#3b82f6' },
                    { label: "ì ‘ìˆ˜", data: ì ‘ìˆ˜, stack: "va", backgroundColor: '#f59e0b' },
                    { label: "ë¯¸ì ‘ìˆ˜", data: ë¯¸ì ‘ìˆ˜, stack: "va", backgroundColor: '#ef4444' },
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: { stacked: true, beginAtZero: true, title: { display: true, text: "ê±´ìˆ˜" } },
                    y: { stacked: true, }
                }
            }
        });
    }

    function renderVocList() {
        const tableBody = document.querySelector("#vocListTable tbody");
        tableBody.innerHTML = "";
        let sortedData = [...filteredVocData];

        const sortField = vocListSortField;
        const direction = vocListSortDirection === 'asc' ? 1 : -1;
        
        sortedData.sort((a, b) => {
            let valA = a[sortField];
            let valB = b[sortField];
            
            if (valA < valB) return -1 * direction;
            if (valA > valB) return 1 * direction;
            return 0;
        });

        sortedData.slice(0, 100).forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${(row["ì ‘ìˆ˜ë²ˆí˜¸"] || "-").trim()}</td>
                <td>${(row["ìƒíƒœ"] || "-").trim()}</td>
                <td>${(row["VOCìœ í˜•ëŒ€"] || "-").trim()}</td>
                <td>${(row["VOCìœ í˜•ì¤‘"] || "-").trim()}</td>
                <td>${(row["VOCìœ í˜•ì†Œ"] || "-").trim()}</td>
                <td>${(row["ê´€ë¦¬ë³¸ë¶€"] || "-").trim()}</td>
                <td>${normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"])}</td>
                <td>${(row["ë‹´ë‹¹ì"] || "-").trim()}</td>
            `;
            tableBody.appendChild(tr);
        });

        document.querySelectorAll("#vocListTable th").forEach(th => {
            th.innerHTML = th.getAttribute("data-field");
            if (th.getAttribute("data-field") === vocListSortField) {
                const icon = vocListSortDirection === 'asc' ? ' â–²' : ' â–¼';
                th.innerHTML += icon;
            }
        });
    }

    function attachVocSortEvents() {
        document.querySelectorAll("#vocListTable th").forEach(th => {
            th.addEventListener('click', function() {
                const field = this.getAttribute('data-field');
                if (field === vocListSortField) {
                    vocListSortDirection = vocListSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    vocListSortField = field;
                    vocListSortDirection = 'desc';
                }
                renderVocList();
            });
        });
    }

    function updateVocDashboard() {
        filterVocData();
        updateVocKPIs();
        drawVocBranchChart();
        drawVocAgentChart();
        renderVocList();
    }


    /* ---------------------------------------------------------
        ğŸ“Œ ì´ˆê¸° ë¡œë“œ
    --------------------------------------------------------- */
    async function initDashboard() {
        vocData = await loadCsv(VOC_CSV_URL);
        pipelineData = await loadCsv(PIPELINE_CSV_URL);

        // PIPELINE ì´ˆê¸° ì„¤ì •
        renderPipelineHQButtons();
        renderPipelineBranchButtons();

        // VOC ì´ˆê¸° ì„¤ì •
        renderVocTypeFilter();

        // í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.getElementById("channelFilter").addEventListener("change", updatePipelineDashboard);
        document.querySelectorAll('#pipelineFilters input[name="risk"]').forEach(r => r.addEventListener("change", updatePipelineDashboard));
            
        // ë¦¬ìŠ¤íŠ¸ ì •ë ¬ ì´ë²¤íŠ¸ ë“±ë¡
        attachPipelineSortEvents();
        attachVocSortEvents();

        // ì´ˆê¸° ë·° ì—…ë°ì´íŠ¸ (ê¸°ë³¸: Pipeline)
        updatePipelineDashboard();
    }

    window.addEventListener("load", initDashboard);
</script>

</body>
</html>
