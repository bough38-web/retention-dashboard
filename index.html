<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>KTT í†µí•© ëŒ€ì‹œë³´ë“œ (VOC + í•´ì§€íŒŒì´í”„ë¼ì¸)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- DataLabels í”ŒëŸ¬ê·¸ì¸ -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <!-- PapaParse (CSV íŒŒì„œ) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body {
      margin: 0;
      display: flex;
      background: #f5f5f7;
      font-family: "Apple SD Gothic Neo", -apple-system, BlinkMacSystemFont, system-ui, "Segoe UI", sans-serif;
    }

    /* ì¢Œì¸¡ í•„í„° íŒ¨ë„ */
    .sidebar {
      width: 260px;
      background: #ffffff;
      padding: 18px;
      border-right: 1px solid #e5e7eb;
      height: 100vh;
      overflow-y: auto;
      box-shadow: 4px 0 12px rgba(0,0,0,0.03);
    }

    .sidebar h2 {
      font-size: 18px;
      margin: 0 0 6px;
      font-weight: 700;
      color: #111827;
    }

    .subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .filter-title {
      margin-top: 14px;
      margin-bottom: 4px;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
    }

    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .filter-btn {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
    }

    .filter-btn.active {
      background: #111827;
      color: #fff;
      border-color: #111827;
    }

    .filter-btn.small {
      font-size: 10px;
      padding: 3px 7px;
    }

    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 12px;
      color: #4b5563;
    }

    .radio-group label {
      cursor: pointer;
    }

    /* ìš°ì¸¡ ì½˜í…ì¸  ì˜ì—­ */
    .content {
      flex: 1;
      padding: 18px 20px;
      overflow-y: auto;
    }

    .section-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 16px 18px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      margin-bottom: 18px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
    }

    .section-header h1 {
      font-size: 20px;
      margin: 0;
      font-weight: 700;
      color: #111827;
    }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .view-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      overflow: hidden;
    }

    .view-toggle button {
      padding: 6px 10px;
      border: none;
      background: #f9fafb;
      font-size: 12px;
      cursor: pointer;
      color: #4b5563;
    }

    .view-toggle button.active {
      background: #111827;
      color: #f9fafb;
      font-weight: 600;
    }

    /* KPI */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    .kpi-card {
      border-radius: 12px;
      padding: 10px 12px;
      background: linear-gradient(135deg,#f9fafb,#eef2ff);
      border: 1px solid #e5e7eb;
    }

    .kpi-title {
      font-size: 11px;
      color: #6b7280;
    }

    .kpi-value {
      margin-top: 4px;
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }

    .kpi-sub {
      margin-top: 2px;
      font-size: 11px;
      color: #94a3b8;
    }

    /* ì°¨íŠ¸ ê·¸ë¦¬ë“œ */
    .chart-grid {
      display: grid;
      grid-template-columns: 1.5fr 1.3fr;
      gap: 18px;
    }

    .chart-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 14px 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      margin-bottom: 16px;
    }

    .chart-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .chart-header h3 {
      margin: 0;
      font-size: 15px;
      font-weight: 700;
      color: #111827;
    }

    .chart-header p {
      margin: 0;
      font-size: 11px;
      color: #9ca3af;
    }

    .chart-wrapper {
      height: 260px;
    }

    /* í…Œì´ë¸” */
    .list-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 12px 14px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      margin-top: 16px;
    }

    .list-title {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      margin: 0 0 3px;
    }

    .list-sub {
      font-size: 11px;
      color: #9ca3af;
      margin: 0 0 6px;
    }

    .list-container {
      max-height: 320px;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #f3f4f6;
      text-align: left;
    }

    th {
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
      cursor: pointer;
      font-weight: 600;
      color: #4b5563;
    }

    tr:nth-child(even) {
      background: #f9fafb;
    }

    tr:hover {
      background: #e5f3ff;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
    }

    .status-complete {
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-pending {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .status-none {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }

    .risk-high { color:#b91c1c;font-weight:700; }
    .risk-mid  { color:#d97706;font-weight:600; }
    .risk-low  { color:#047857;font-weight:600; }

    .ellipsis {
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 1100px) {
      .chart-grid {
        grid-template-columns: 1fr;
      }
      .kpi-grid {
        grid-template-columns: repeat(2,minmax(0,1fr));
      }
    }
    @media (max-width: 800px) {
      body {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
      }
      .content {
        padding: 12px;
      }
    }
  </style>
</head>

<body>
  <!-- ì‚¬ì´ë“œë°” -->
  <div class="sidebar">
    <h2>ğŸ“Œ í•„í„°</h2>
    <div class="subtitle">VOC & í•´ì§€íŒŒì´í”„ë¼ì¸ ë°ì´í„°ë¥¼ í•¨ê»˜ ë³´ëŠ” ëŒ€ì‹œë³´ë“œ</div>

    <div class="filter-title">ë³´ê¸° ì „í™˜</div>
    <div class="view-toggle">
      <button id="btnViewPipeline" class="active" onclick="switchView('pipeline')">í•´ì§€ íŒŒì´í”„ë¼ì¸</button>
      <button id="btnViewVoc" onclick="switchView('voc')">VOC</button>
    </div>

    <div class="filter-title">ë‹´ë‹¹ì˜ì—…ì±„ë„ (íŒŒì´í”„ë¼ì¸)</div>
    <select id="channelFilter">
      <option value="ALL">ì „ì²´</option>
      <option value="SP">SP</option>
      <option value="SC">SC</option>
      <option value="AM">AM</option>
    </select>

    <div class="filter-title">í•´ì§€ìœ„í—˜ë„ (%)</div>
    <div class="radio-group">
      <label><input type="radio" name="risk" value="ALL" checked> ì „ì²´</label>
      <label><input type="radio" name="risk" value="0"> 0 ~ 25%</label>
      <label><input type="radio" name="risk" value="25"> 25 ~ 50%</label>
      <label><input type="radio" name="risk" value="50"> 50 ~ 75%</label>
      <label><input type="radio" name="risk" value="75"> 75 ~ 100%</label>
    </div>

    <div class="filter-title">í‘œì‹œ ê¸°ì¤€ (í•´ì§€íŒŒì´í”„ë¼ì¸)</div>
    <div class="filter-buttons">
      <button class="filter-btn small mode-btn active" data-mode="count" onclick="setMode('count', this)">ê±´ìˆ˜</button>
      <button class="filter-btn small mode-btn" data-mode="amount" onclick="setMode('amount', this)">ê¸ˆì•¡(ì²œì›)</button>
    </div>

    <div class="filter-title">ê´€ë¦¬ë³¸ë¶€ (íŒŒì´í”„ë¼ì¸)</div>
    <div id="hqButtons" class="filter-buttons"></div>

    <div class="filter-title">ê´€ë¦¬ì§€ì‚¬ (íŒŒì´í”„ë¼ì¸)</div>
    <div id="branchButtons" class="filter-buttons"></div>

    <div class="filter-title">ë°©ì–´ë‹´ë‹¹ì (íŒŒì´í”„ë¼ì¸)</div>
    <div id="agentButtons" class="filter-buttons"></div>

    <hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb;">

    <div class="filter-title">VOC ê´€ë¦¬ì§€ì‚¬</div>
    <div id="vocBranchButtons" class="filter-buttons"></div>

    <div class="filter-title">VOC ë‹´ë‹¹ì</div>
    <div id="vocAgentButtons" class="filter-buttons"></div>
  </div>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <div class="content">
    <!-- ìƒë‹¨ KPI -->
    <div class="section-card">
      <div class="section-header">
        <h1 id="mainTitle">í•´ì§€ íŒŒì´í”„ë¼ì¸ í˜„í™©</h1>
        <span class="badge" id="viewBadge">Pipeline View</span>
      </div>

      <!-- íŒŒì´í”„ë¼ì¸ KPI -->
      <div id="pipelineKpiRow" class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-title">ì´ í•´ì§€ íŒŒì´í”„ë¼ì¸ ê±´ìˆ˜</div>
          <div class="kpi-value" id="kpi-pipeline-count">-</div>
          <div class="kpi-sub">í•„í„° ê¸°ì¤€ ì „ì²´ ê±´ìˆ˜</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">ì›”ì •ë£Œ í•©ê³„ (ì²œì›)</div>
          <div class="kpi-value" id="kpi-pipeline-amount">-</div>
          <div class="kpi-sub">KTTì›”ì •ë£Œ(ì¡°ì •) ê¸°ì¤€</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">ë°©ì–´ì„±ê³µë¥ </div>
          <div class="kpi-value" id="kpi-defense-success-rate">-</div>
          <div class="kpi-sub">ì§„í–‰ì¤‘/ì„±ê³µ/ì‹¤íŒ¨ ê±´ ê¸°ì¤€</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">ê³ ìœ„í—˜(â‰¥75%) ê±´ìˆ˜</div>
          <div class="kpi-value" id="kpi-high-risk-count">-</div>
          <div class="kpi-sub">í•´ì§€ìœ„í—˜ë„ ê¸°ì¤€</div>
        </div>
      </div>

      <!-- VOC KPI -->
      <div id="vocKpiRow" class="kpi-grid" style="display:none;">
        <div class="kpi-card">
          <div class="kpi-title">ì´ VOC ê±´ìˆ˜</div>
          <div class="kpi-value" id="kpi-voc-total">-</div>
          <div class="kpi-sub">í•„í„° ê¸°ì¤€ ì „ì²´ ê±´ìˆ˜</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">ì²˜ë¦¬ì™„ë£Œ ë¹„ìœ¨</div>
          <div class="kpi-value" id="kpi-voc-complete-rate">-</div>
          <div class="kpi-sub">ì²˜ë¦¬ì™„ë£Œ / ì „ì²´</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">ë¯¸ì ‘ìˆ˜ ê±´ìˆ˜</div>
          <div class="kpi-value" id="kpi-voc-not-received">-</div>
          <div class="kpi-sub">ìƒíƒœ = ë¯¸ì ‘ìˆ˜</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">VOC ìµœë‹¤ ê´€ë¦¬ì§€ì‚¬</div>
          <div class="kpi-value" id="kpi-voc-top-branch">-</div>
          <div class="kpi-sub">ê±´ìˆ˜ ê¸°ì¤€</div>
        </div>
      </div>
    </div>

    <!-- íŒŒì´í”„ë¼ì¸ ë·° -->
    <div id="pipelineView">
      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-header">
            <h3>ê´€ë¦¬ë³¸ë¶€ / ê´€ë¦¬ì§€ì‚¬ë³„ í•´ì§€ í˜„í™©</h3>
            <p>ê±´ìˆ˜ ë˜ëŠ” ê¸ˆì•¡(ì²œì›)</p>
          </div>
          <div class="chart-wrapper">
            <canvas id="pipelineBranchChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <h3>ë°©ì–´ì§„í–‰ë‹¨ê³„ (ì§„í–‰ì¤‘ / ë°©ì–´ì‹¤íŒ¨ / ë°©ì–´ì„±ê³µ)</h3>
            <p>ê´€ë¦¬ì§€ì‚¬ ê¸°ì¤€ ì ì¸µ ë§‰ëŒ€</p>
          </div>
          <div class="chart-wrapper">
            <canvas id="pipelineStageChart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <h3>í•´ì§€ìœ„í—˜ë„ vs ì›”ì •ë£Œ (ë²„ë¸” ì°¨íŠ¸)</h3>
          <p>ê´€ë¦¬ì§€ì‚¬ë³„ í‰ê·  ìœ„í—˜ë„/ì›”ì •ë£Œ/ê±´ìˆ˜</p>
        </div>
        <div class="chart-wrapper" style="height:280px;">
          <canvas id="pipelineRiskBubbleChart"></canvas>
        </div>
      </div>

      <div class="list-card">
        <p class="list-title">ğŸ“ í•´ì§€íŒŒì´í”„ë¼ì¸ ìƒì„¸ ë¦¬ìŠ¤íŠ¸</p>
        <p class="list-sub">í—¤ë”ë¥¼ í´ë¦­í•˜ë©´ ì •ë ¬ë©ë‹ˆë‹¤.</p>
        <div class="list-container">
          <table id="pipelineListTable">
            <thead>
              <tr>
                <th data-field="ê³„ì•½ë²ˆí˜¸">ê³„ì•½ë²ˆí˜¸</th>
                <th data-field="ê´€ë¦¬ì§€ì‚¬">ê´€ë¦¬ì§€ì‚¬</th>
                <th data-field="í•´ì§€ìœ„í—˜ë„">ìœ„í—˜ë„(%)</th>
                <th data-field="ë‹´ë‹¹ì˜ì—…ì±„ë„">ì±„ë„</th>
                <th data-field="KTTì›”ì •ë£Œ(ì¡°ì •)">ì›”ì •ë£Œ(ì²œì›)</th>
                <th data-field="ë°©ì–´ì§„í–‰ë‹¨ê³„">ë°©ì–´ì§„í–‰ë‹¨ê³„</th>
                <th data-field="ë‹´ë‹¹ì">ë‹´ë‹¹ì</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- VOC ë·° -->
    <div id="vocView" style="display:none;">
      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-header">
            <h3>VOC ê´€ë¦¬ì§€ì‚¬ë³„ ìƒíƒœ</h3>
            <p>ì²˜ë¦¬ì™„ë£Œ / ì ‘ìˆ˜ / ë¯¸ì ‘ìˆ˜</p>
          </div>
          <div class="chart-wrapper">
            <canvas id="vocBranchChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <h3>VOC ë‹´ë‹¹ìë³„ ìƒíƒœ (Top 20)</h3>
            <p>ì²˜ë¦¬ì™„ë£Œ / ì ‘ìˆ˜ / ë¯¸ì ‘ìˆ˜</p>
          </div>
          <div class="chart-wrapper">
            <canvas id="vocAgentChart"></canvas>
          </div>
        </div>
      </div>

      <div class="list-card">
        <p class="list-title">ğŸ“ VOC ìƒì„¸ ë¦¬ìŠ¤íŠ¸</p>
        <p class="list-sub">í—¤ë”ë¥¼ í´ë¦­í•˜ë©´ ì •ë ¬ë©ë‹ˆë‹¤.</p>
        <div class="list-container">
          <table id="vocListTable">
            <thead>
              <tr>
                <th data-field="ìƒíƒœ">ìƒíƒœ</th>
                <th data-field="ê´€ë¦¬ì§€ì‚¬">ê´€ë¦¬ì§€ì‚¬</th>
                <th data-field="ë‹´ë‹¹ì">ë‹´ë‹¹ì</th>
                <th data-field="VOCìœ í˜•ëŒ€">VOCìœ í˜•(ëŒ€)</th>
                <th data-field="VOCìœ í˜•ì¤‘">VOCìœ í˜•(ì¤‘)</th>
                <th data-field="VOCìœ í˜•ì†Œ">VOCìœ í˜•(ì†Œ)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  /* ==============================
     ì „ì—­ ì„¤ì • & ìœ í‹¸
  =============================== */
  Chart.register(ChartDataLabels);

  const VOC_CSV_URL =
    "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv";
  const PIPELINE_CSV_URL =
    "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv";

  // ê´€ë¦¬ì§€ì‚¬ ì •ë ¬ ìš°ì„  ìˆœìœ„
  const BRANCH_ORDER = ["ì¤‘ì•™ì§€ì‚¬","ê°•ë¶ì§€ì‚¬","ì„œëŒ€ë¬¸ì§€ì‚¬","ê³ ì–‘ì§€ì‚¬","ì˜ì •ë¶€ì§€ì‚¬","ë‚¨ì–‘ì£¼ì§€ì‚¬","ê°•ë¦‰ì§€ì‚¬","ì›ì£¼ì§€ì‚¬","ê¸°íƒ€"];

  let mode = "count"; // íŒŒì´í”„ë¼ì¸ í‘œì‹œ ê¸°ì¤€: count / amount
  let vocData = [];
  let pipelineData = [];

  let filteredVocData = [];
  let filteredPipelineData = [];

  // íŒŒì´í”„ë¼ì¸ í•„í„° ìƒíƒœ
  let selectedHQ = "ALL";
  let selectedBranch = "ALL";
  let selectedAgent = "ALL";

  // VOC í•„í„° ìƒíƒœ
  let vocSelectedBranch = "ALL";
  let vocSelectedAgent = "ALL";

  // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
  let pipelineBranchChart = null;
  let pipelineStageChart = null;
  let pipelineRiskBubbleChart = null;
  let vocBranchChart = null;
  let vocAgentChart = null;

  // ë¦¬ìŠ¤íŠ¸ ì •ë ¬ ìƒíƒœ
  let pipelineSortField = "ê³„ì•½ë²ˆí˜¸";
  let pipelineSortAsc = true;
  let vocSortField = "ìƒíƒœ";
  let vocSortAsc = true;

  function normalizeBranch(name) {
    if (!name) return "";
    return String(name).replace("ì§€ì‚¬","").trim();
  }

  function cleanContractNumber(raw) {
    if (!raw) return "";
    return String(raw).replace(/\D/g,"").slice(0,8);
  }

  function toThousandWon(raw) {
    if (!raw) return 0;
    const n = parseFloat(String(raw).replace(/,/g,""));
    if (isNaN(n)) return 0;
    return Math.round(n / 1000);
  }

  function parseRisk(value) {
    if (value === null || value === undefined || value === "") return NaN;
    const v = parseFloat(String(value).replace("%",""));
    return isNaN(v) ? NaN : v;
  }

  function checkRisk(value, selected) {
    if (selected === "ALL") return true;
    const v = parseRisk(value);
    if (isNaN(v)) return false;
    const s = parseInt(selected);
    if (s === 0) return v >= 0 && v < 25;
    if (s === 25) return v >= 25 && v < 50;
    if (s === 50) return v >= 50 && v < 75;
    if (s === 75) return v >= 75 && v <= 100;
    return true;
  }

  async function loadCsv(url) {
    const res = await fetch(url);
    const text = await res.text();
    return new Promise((resolve) => {
      Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        complete: (r) => resolve(r.data),
      });
    });
  }

  function safeText(v) {
    if (v === null || v === undefined || v === "") return "-";
    return String(v);
  }

  function sortBranches(labels) {
    return labels.sort((a,b) => {
      const fullA = a + "ì§€ì‚¬";
      const fullB = b + "ì§€ì‚¬";
      const ia = BRANCH_ORDER.indexOf(fullA);
      const ib = BRANCH_ORDER.indexOf(fullB);
      return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
    });
  }

  function destroyChart(name) {
    if (name === "pipelineBranch" && pipelineBranchChart) {
      pipelineBranchChart.destroy();
      pipelineBranchChart = null;
    }
    if (name === "pipelineStage" && pipelineStageChart) {
      pipelineStageChart.destroy();
      pipelineStageChart = null;
    }
    if (name === "pipelineRisk" && pipelineRiskBubbleChart) {
      pipelineRiskBubbleChart.destroy();
      pipelineRiskBubbleChart = null;
    }
    if (name === "vocBranch" && vocBranchChart) {
      vocBranchChart.destroy();
      vocBranchChart = null;
    }
    if (name === "vocAgent" && vocAgentChart) {
      vocAgentChart.destroy();
      vocAgentChart = null;
    }
  }

  /* ==============================
     ë·° ì „í™˜
  =============================== */
  function switchView(view) {
    const pipelineView = document.getElementById("pipelineView");
    const vocView = document.getElementById("vocView");
    const mainTitle = document.getElementById("mainTitle");
    const badge = document.getElementById("viewBadge");
    const pipelineKpi = document.getElementById("pipelineKpiRow");
    const vocKpi = document.getElementById("vocKpiRow");
    const btnPipeline = document.getElementById("btnViewPipeline");
    const btnVoc = document.getElementById("btnViewVoc");

    if (view === "pipeline") {
      pipelineView.style.display = "block";
      vocView.style.display = "none";
      pipelineKpi.style.display = "grid";
      vocKpi.style.display = "none";
      mainTitle.textContent = "í•´ì§€ íŒŒì´í”„ë¼ì¸ í˜„í™©";
      badge.textContent = "Pipeline View";
      btnPipeline.classList.add("active");
      btnVoc.classList.remove("active");
      updatePipelineDashboard();
    } else {
      pipelineView.style.display = "none";
      vocView.style.display = "block";
      pipelineKpi.style.display = "none";
      vocKpi.style.display = "grid";
      mainTitle.textContent = "VOC í˜„í™©";
      badge.textContent = "VOC View";
      btnPipeline.classList.remove("active");
      btnVoc.classList.add("active");
      updateVocDashboard();
    }
  }

  function setMode(m, button) {
    mode = m;
    document.querySelectorAll(".mode-btn").forEach(btn => btn.classList.remove("active"));
    if (button) button.classList.add("active");
    updatePipelineDashboard();
  }

  /* ==============================
     í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸°
  =============================== */
  function getSelectedChannel() {
    const sel = document.getElementById("channelFilter");
    return sel ? sel.value : "ALL";
  }

  function getSelectedRisk() {
    const r = document.querySelector("input[name='risk']:checked");
    return r ? r.value : "ALL";
  }

  /* ==============================
     íŒŒì´í”„ë¼ì¸ ë²„íŠ¼ ë Œë”ë§
  =============================== */
  function renderHqButtons() {
    const container = document.getElementById("hqButtons");
    const hqSet = new Set();
    pipelineData.forEach(row => {
      const hq = (row["ê´€ë¦¬ë³¸ë¶€"] || "").trim();
      if (hq) hqSet.add(hq);
    });

    const list = Array.from(hqSet).sort();
    let html = `<button class="filter-btn small ${selectedHQ === "ALL" ? "active" : ""}" onclick="setHQ('ALL', this)">ì „ì²´</button>`;
    list.forEach(hq => {
      const active = selectedHQ === hq ? "active" : "";
      html += `<button class="filter-btn small ${active}" onclick="setHQ('${hq}', this)">${hq}</button>`;
    });
    container.innerHTML = html;
  }

  function renderBranchButtons() {
    const container = document.getElementById("branchButtons");
    let rows = pipelineData;
    if (selectedHQ !== "ALL") {
      rows = rows.filter(r => (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim() === selectedHQ);
    }

    const branchSet = new Set();
    rows.forEach(r => {
      const b = normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]);
      if (b) branchSet.add(b);
    });

    let list = Array.from(branchSet);
    list = sortBranches(list);

    let html = `<button class="filter-btn small ${selectedBranch === "ALL" ? "active" : ""}" onclick="setBranch('ALL', this)">ì „ì²´</button>`;
    list.forEach(b => {
      const active = selectedBranch === b ? "active" : "";
      html += `<button class="filter-btn small ${active}" onclick="setBranch('${b}', this)">${b}</button>`;
    });
    container.innerHTML = html;
  }

  function renderAgentButtons() {
    const container = document.getElementById("agentButtons");
    let rows = filteredPipelineData;
    if (!rows || rows.length === 0) rows = pipelineData;

    const setA = new Set();
    rows.forEach(r => {
      const a = (r["ë‹´ë‹¹ì"] || "").trim();
      if (a) setA.add(a);
    });

    const list = Array.from(setA).sort();
    let html = `<button class="filter-btn small ${selectedAgent === "ALL" ? "active" : ""}" onclick="setAgent('ALL', this)">ì „ì²´</button>`;
    list.forEach(a => {
      const safe = a.replace(/'/g,"\\'");
      const active = selectedAgent === a ? "active" : "";
      html += `<button class="filter-btn small ${active}" onclick="setAgent('${safe}', this)">${a}</button>`;
    });
    container.innerHTML = html;
  }

  function setHQ(hq, button) {
    selectedHQ = hq;
    selectedBranch = "ALL";
    selectedAgent = "ALL";
    document.querySelectorAll("#hqButtons .filter-btn").forEach(b => b.classList.remove("active"));
    if (button) button.classList.add("active");
    renderBranchButtons();
    renderAgentButtons();
    updatePipelineDashboard();
  }

  function setBranch(branch, button) {
    selectedBranch = branch;
    selectedAgent = "ALL";
    document.querySelectorAll("#branchButtons .filter-btn").forEach(b => b.classList.remove("active"));
    if (button) button.classList.add("active");
    renderAgentButtons();
    updatePipelineDashboard();
  }

  function setAgent(agent, button) {
    selectedAgent = agent;
    document.querySelectorAll("#agentButtons .filter-btn").forEach(b => b.classList.remove("active"));
    if (button) button.classList.add("active");
    updatePipelineDashboard();
  }

  /* ==============================
     VOC ë²„íŠ¼ ë Œë”ë§
  =============================== */
  function renderVocBranchButtons() {
    const container = document.getElementById("vocBranchButtons");
    const setB = new Set();
    vocData.forEach(r => {
      const b = normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]);
      if (b) setB.add(b);
    });
    let list = Array.from(setB);
    list = sortBranches(list);

    let html = `<button class="filter-btn small ${vocSelectedBranch === "ALL" ? "active" : ""}" onclick="setVocBranch('ALL', this)">ì „ì²´</button>`;
    list.forEach(b => {
      const active = vocSelectedBranch === b ? "active" : "";
      html += `<button class="filter-btn small ${active}" onclick="setVocBranch('${b}', this)">${b}</button>`;
    });
    container.innerHTML = html;
  }

  function renderVocAgentButtons() {
    const container = document.getElementById("vocAgentButtons");
    let rows = filteredVocData;
    if (!rows || rows.length === 0) rows = vocData;

    const setA = new Set();
    rows.forEach(r => {
      const a = (r["ë‹´ë‹¹ì"] || "").trim();
      if (a) setA.add(a);
    });

    const list = Array.from(setA).sort();
    let html = `<button class="filter-btn small ${vocSelectedAgent === "ALL" ? "active" : ""}" onclick="setVocAgent('ALL', this)">ì „ì²´</button>`;
    list.forEach(a => {
      const safe = a.replace(/'/g,"\\'");
      const active = vocSelectedAgent === a ? "active" : "";
      html += `<button class="filter-btn small ${active}" onclick="setVocAgent('${safe}', this)">${a}</button>`;
    });
    container.innerHTML = html;
  }

  function setVocBranch(branch, button) {
    vocSelectedBranch = branch;
    vocSelectedAgent = "ALL";
    document.querySelectorAll("#vocBranchButtons .filter-btn").forEach(b => b.classList.remove("active"));
    if (button) button.classList.add("active");
    renderVocAgentButtons();
    updateVocDashboard();
  }

  function setVocAgent(agent, button) {
    vocSelectedAgent = agent;
    document.querySelectorAll("#vocAgentButtons .filter-btn").forEach(b => b.classList.remove("active"));
    if (button) button.classList.add("active");
    updateVocDashboard();
  }

  /* ==============================
     íŒŒì´í”„ë¼ì¸ í•„í„°ë§ & KPI
  =============================== */
  function filterPipelineData() {
    const ch = getSelectedChannel();
    const risk = getSelectedRisk();

    filteredPipelineData = pipelineData.filter(row => {
      if (ch !== "ALL" && (row["ë‹´ë‹¹ì˜ì—…ì±„ë„"] || "").trim() !== ch) return false;
      if (!checkRisk(row["í•´ì§€ìœ„í—˜ë„"], risk)) return false;

      const hq = (row["ê´€ë¦¬ë³¸ë¶€"] || "").trim();
      const b = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
      const a = (row["ë‹´ë‹¹ì"] || "").trim();

      if (selectedHQ !== "ALL" && hq !== selectedHQ) return false;
      if (selectedBranch !== "ALL" && b !== selectedBranch) return false;
      if (selectedAgent !== "ALL" && a !== selectedAgent) return false;
      return true;
    });
  }

  function updatePipelineKpi() {
    const rows = filteredPipelineData;
    if (!rows || rows.length === 0) {
      document.getElementById("kpi-pipeline-count").innerText = "0ê±´";
      document.getElementById("kpi-pipeline-amount").innerText = "0ì²œì›";
      document.getElementById("kpi-defense-success-rate").innerText = "0%";
      document.getElementById("kpi-high-risk-count").innerText = "0";
      return;
    }

    const totalCount = rows.length;
    const totalAmount = rows.reduce((sum,r) => sum + toThousandWon(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]), 0);

    const defenseRows = rows.filter(r => ["ë°©ì–´ì„±ê³µ","ë°©ì–´ì‹¤íŒ¨","ì§„í–‰ì¤‘"].includes(r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]));
    const successCnt = defenseRows.filter(r => r["ë°©ì–´ì§„í–‰ë‹¨ê³„"] === "ë°©ì–´ì„±ê³µ").length;
    const defenseRate = defenseRows.length > 0 ? (successCnt / defenseRows.length) * 100 : 0;

    const highRisk = rows.filter(r => {
      const v = parseRisk(r["í•´ì§€ìœ„í—˜ë„"]);
      return !isNaN(v) && v >= 75;
    }).length;

    document.getElementById("kpi-pipeline-count").innerText = totalCount.toLocaleString("ko-KR") + "ê±´";
    document.getElementById("kpi-pipeline-amount").innerText = totalAmount.toLocaleString("ko-KR") + "ì²œì›";
    document.getElementById("kpi-defense-success-rate").innerText = defenseRate.toFixed(1) + "%";
    document.getElementById("kpi-high-risk-count").innerText = highRisk.toLocaleString("ko-KR");
  }

  /* ==============================
     íŒŒì´í”„ë¼ì¸ ì°¨íŠ¸
  =============================== */
  function drawPipelineBranchChart() {
    const agg = {};
    filteredPipelineData.forEach(r => {
      const hq = (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim();
      const bShort = normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]);
      if (!hq || !bShort) return;
      const key = `${hq} / ${bShort}`;
      if (!agg[key]) agg[key] = { count:0, amount:0 };
      if (cleanContractNumber(r["ê³„ì•½ë²ˆí˜¸"])) agg[key].count++;
      agg[key].amount += toThousandWon(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
    });

    const entries = Object.entries(agg);
    entries.sort((a,b) => {
      const av = mode === "count" ? a[1].count : a[1].amount;
      const bv = mode === "count" ? b[1].count : b[1].amount;
      return bv - av;
    });

    const labels = entries.map(e => e[0]);
    const values = mode === "count" ? entries.map(e => e[1].count) : entries.map(e => e[1].amount);

    destroyChart("pipelineBranch");
    const ctx = document.getElementById("pipelineBranchChart").getContext("2d");
    pipelineBranchChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: mode === "count" ? "ê±´ìˆ˜" : "ê¸ˆì•¡(ì²œì›)",
          data: values,
          backgroundColor: "#3b82f6aa",
          borderRadius: 6,
          maxBarThickness: 32,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display:false },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const v = ctx.parsed.y;
                return mode === "count" ? `${v} ê±´` : `${v.toLocaleString("ko-KR")} ì²œì›`;
              }
            }
          },
          datalabels: {
            anchor: "end",
            align: "end",
            color: "#111827",
            font: { size: 10, weight: "600" },
            formatter: (v) => v > 0 ? v.toLocaleString("ko-KR") : ""
          }
        },
        scales: {
          x: {
            ticks: { autoSkip:false, maxRotation:60, minRotation:20 }
          },
          y: { beginAtZero: true }
        }
      }
    });
  }

  function drawPipelineStageChart() {
    const agg = {};
    const stages = ["ì§„í–‰ì¤‘","ë°©ì–´ì‹¤íŒ¨","ë°©ì–´ì„±ê³µ"];

    filteredPipelineData.forEach(r => {
      const b = normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]);
      if (!b) return;
      const st = (r["ë°©ì–´ì§„í–‰ë‹¨ê³„"] || "").trim();
      if (!agg[b]) agg[b] = { "ì§„í–‰ì¤‘":0,"ë°©ì–´ì‹¤íŒ¨":0,"ë°©ì–´ì„±ê³µ":0 };
      if (stages.includes(st)) agg[b][st]++;
    });

    let labels = Object.keys(agg);
    labels = sortBranches(labels);
    const ì§„í–‰ì¤‘ = labels.map(b => agg[b]["ì§„í–‰ì¤‘"]);
    const ë°©ì–´ì‹¤íŒ¨ = labels.map(b => agg[b]["ë°©ì–´ì‹¤íŒ¨"]);
    const ë°©ì–´ì„±ê³µ = labels.map(b => agg[b]["ë°©ì–´ì„±ê³µ"]);

    destroyChart("pipelineStage");
    const ctx = document.getElementById("pipelineStageChart").getContext("2d");
    pipelineStageChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label:"ì§„í–‰ì¤‘", data:ì§„í–‰ì¤‘, stack:"s", backgroundColor:"#38bdf8cc" },
          { label:"ë°©ì–´ì‹¤íŒ¨", data:ë°©ì–´ì‹¤íŒ¨, stack:"s", backgroundColor:"#f97373cc" },
          { label:"ë°©ì–´ì„±ê³µ", data:ë°©ì–´ì„±ê³µ, stack:"s", backgroundColor:"#4ade80cc" },
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend:{ display:true },
          tooltip:{
            callbacks:{
              label:(ctx)=>`${ctx.dataset.label}: ${ctx.parsed.y} ê±´`
            }
          },
          datalabels:{
            anchor:"center",
            align:"center",
            color:"#111827",
            font:{ size:9, weight:"600" },
            formatter:(v)=>v>0 ? v : ""
          }
        },
        scales:{
          x:{ stacked:true },
          y:{ stacked:true, beginAtZero:true }
        }
      }
    });
  }

  function randomColor() {
    const c = Math.floor(Math.random()*16777215).toString(16).padStart(6,"0");
    return `#${c}99`;
  }

  function drawPipelineRiskBubbleChart() {
    const agg = {};

    filteredPipelineData.forEach(r => {
      const b = normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]);
      if (!b) return;
      const risk = parseRisk(r["í•´ì§€ìœ„í—˜ë„"]);
      const amt = toThousandWon(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
      if (!agg[b]) agg[b] = { riskSum:0, amtSum:0, count:0 };
      if (!isNaN(risk)) agg[b].riskSum += risk;
      agg[b].amtSum += amt;
      agg[b].count++;
    });

    const labels = Object.keys(agg);
    const datasets = labels.map(b => {
      const v = agg[b];
      const avgRisk = v.count > 0 ? v.riskSum / v.count : 0;
      const avgAmt = v.count > 0 ? v.amtSum / v.count : 0;
      const base = mode === "amount" ? v.amtSum : v.count;
      let radius = Math.sqrt(base) * (mode === "amount" ? 0.05 : 2);
      if (radius < 5) radius = 5;
      if (radius > 40) radius = 40;
      return {
        label: b,
        data: [{ x: avgRisk, y: avgAmt, r: radius }],
        backgroundColor: randomColor()
      };
    });

    destroyChart("pipelineRisk");
    const ctx = document.getElementById("pipelineRiskBubbleChart").getContext("2d");
    pipelineRiskBubbleChart = new Chart(ctx, {
      type: "bubble",
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend:{ display:false },
          tooltip:{
            callbacks:{
              label:(ctx)=>{
                const l = ctx.dataset.label || "";
                const x = ctx.parsed.x;
                const y = ctx.parsed.y;
                return `${l}: ìœ„í—˜ë„ ${x.toFixed(1)}%, í‰ê·  ì›”ì •ë£Œ ${y.toLocaleString("ko-KR")}ì²œì›`;
              }
            }
          }
        },
        scales:{
          x:{
            title:{ display:true, text:"í‰ê·  í•´ì§€ìœ„í—˜ë„(%)" },
            min:0, max:100
          },
          y:{
            title:{ display:true, text:"í‰ê·  ì›”ì •ë£Œ(ì²œì›)" },
            beginAtZero:true
          }
        }
      }
    });
  }

  /* ==============================
     íŒŒì´í”„ë¼ì¸ ë¦¬ìŠ¤íŠ¸
  =============================== */
  function renderPipelineList() {
    const tbody = document.querySelector("#pipelineListTable tbody");
    tbody.innerHTML = "";
    let rows = [...filteredPipelineData];

    const field = pipelineSortField;

    rows.sort((a,b)=>{
      if (field === "í•´ì§€ìœ„í—˜ë„") {
        const av = parseRisk(a["í•´ì§€ìœ„í—˜ë„"]);
        const bv = parseRisk(b["í•´ì§€ìœ„í—˜ë„"]);
        if (isNaN(av) && isNaN(bv)) return 0;
        if (isNaN(av)) return 1;
        if (isNaN(bv)) return -1;
        return pipelineSortAsc ? av - bv : bv - av;
      } else if (field === "KTTì›”ì •ë£Œ(ì¡°ì •)") {
        const av = toThousandWon(a["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
        const bv = toThousandWon(b["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
        return pipelineSortAsc ? av - bv : bv - av;
      } else if (field === "ê³„ì•½ë²ˆí˜¸") {
        const av = cleanContractNumber(a["ê³„ì•½ë²ˆí˜¸"]);
        const bv = cleanContractNumber(b["ê³„ì•½ë²ˆí˜¸"]);
        return pipelineSortAsc ? av.localeCompare(bv) : bv.localeCompare(av);
      } else {
        const av = (a[field] || "").toString();
        const bv = (b[field] || "").toString();
        return pipelineSortAsc ?
          av.localeCompare(bv,"ko-KR") :
          bv.localeCompare(av,"ko-KR");
      }
    });

    rows.forEach(r => {
      const riskVal = parseRisk(r["í•´ì§€ìœ„í—˜ë„"]);
      let riskClass = "";
      if (!isNaN(riskVal)) {
        if (riskVal >= 75) riskClass = "risk-high";
        else if (riskVal >= 50) riskClass = "risk-mid";
        else riskClass = "risk-low";
      }
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${cleanContractNumber(r["ê³„ì•½ë²ˆí˜¸"]) || "-"}</td>
        <td>${normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]) || "-"}</td>
        <td class="${riskClass}">${isNaN(riskVal) ? "-" : riskVal.toFixed(1)}</td>
        <td>${safeText(r["ë‹´ë‹¹ì˜ì—…ì±„ë„"])}</td>
        <td>${toThousandWon(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]).toLocaleString("ko-KR")}</td>
        <td>${safeText(r["ë°©ì–´ì§„í–‰ë‹¨ê³„"])}</td>
        <td>${safeText(r["ë‹´ë‹¹ì"])}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function attachPipelineSortEvents() {
    const ths = document.querySelectorAll("#pipelineListTable thead th");
    ths.forEach(th => {
      th.addEventListener("click", () => {
        const field = th.getAttribute("data-field");
        if (!field) return;
        if (pipelineSortField === field) {
          pipelineSortAsc = !pipelineSortAsc;
        } else {
          pipelineSortField = field;
          pipelineSortAsc = true;
        }
        ths.forEach(t => t.removeAttribute("data-sort"));
        th.setAttribute("data-sort", pipelineSortAsc ? "asc" : "desc");
        renderPipelineList();
      });
    });
  }

  /* ==============================
     VOC í•„í„°ë§ & KPI & ì°¨íŠ¸ & ë¦¬ìŠ¤íŠ¸
  =============================== */
  function filterVocData() {
    filteredVocData = vocData.filter(r => {
      const b = normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]);
      const a = (r["ë‹´ë‹¹ì"] || "").trim();
      if (vocSelectedBranch !== "ALL" && b !== vocSelectedBranch) return false;
      if (vocSelectedAgent !== "ALL" && a !== vocSelectedAgent) return false;
      return true;
    });
  }

  function updateVocKpi() {
    const rows = filteredVocData;
    if (!rows || rows.length === 0) {
      document.getElementById("kpi-voc-total").innerText = "0ê±´";
      document.getElementById("kpi-voc-complete-rate").innerText = "0%";
      document.getElementById("kpi-voc-not-received").innerText = "0";
      document.getElementById("kpi-voc-top-branch").innerText = "-";
      return;
    }
    const total = rows.length;
    const complete = rows.filter(r => (r["ìƒíƒœ"] || "").trim() === "ì²˜ë¦¬ì™„ë£Œ").length;
    const notReceive = rows.filter(r => (r["ìƒíƒœ"] || "").trim() === "ë¯¸ì ‘ìˆ˜").length;
    const rate = total > 0 ? (complete / total) * 100 : 0;

    const branchAgg = {};
    rows.forEach(r => {
      const b = normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]);
      if (!b) return;
      if (!branchAgg[b]) branchAgg[b] = 0;
      branchAgg[b]++;
    });
    let topBranch = "-";
    let maxCnt = 0;
    Object.entries(branchAgg).forEach(([b,c]) => {
      if (c > maxCnt) {
        maxCnt = c;
        topBranch = b;
      }
    });

    document.getElementById("kpi-voc-total").innerText = total.toLocaleString("ko-KR") + "ê±´";
    document.getElementById("kpi-voc-complete-rate").innerText = rate.toFixed(1) + "%";
    document.getElementById("kpi-voc-not-received").innerText = notReceive.toLocaleString("ko-KR");
    document.getElementById("kpi-voc-top-branch").innerText = topBranch;
  }

  function aggregateVocBy(field, limit=20) {
    const agg = {};
    const statuses = ["ì²˜ë¦¬ì™„ë£Œ","ì ‘ìˆ˜","ë¯¸ì ‘ìˆ˜"];

    filteredVocData.forEach(r => {
      let key = field === "ê´€ë¦¬ì§€ì‚¬"
        ? normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])
        : (r[field] || "").trim();
      if (!key) return;
      const st = (r["ìƒíƒœ"] || "").trim();
      if (!agg[key]) agg[key] = { "ì²˜ë¦¬ì™„ë£Œ":0,"ì ‘ìˆ˜":0,"ë¯¸ì ‘ìˆ˜":0 };
      if (statuses.includes(st)) agg[key][st]++;
    });

    const entries = Object.entries(agg);
    entries.sort((a,b)=>{
      const at = a[1]["ì²˜ë¦¬ì™„ë£Œ"]+a[1]["ì ‘ìˆ˜"]+a[1]["ë¯¸ì ‘ìˆ˜"];
      const bt = b[1]["ì²˜ë¦¬ì™„ë£Œ"]+b[1]["ì ‘ìˆ˜"]+b[1]["ë¯¸ì ‘ìˆ˜"];
      return bt - at;
    });

    const sliced = entries.slice(0,limit);
    const labels = sliced.map(e=>e[0]);
    const ì²˜ë¦¬ì™„ë£Œ = sliced.map(e=>e[1]["ì²˜ë¦¬ì™„ë£Œ"]);
    const ì ‘ìˆ˜   = sliced.map(e=>e[1]["ì ‘ìˆ˜"]);
    const ë¯¸ì ‘ìˆ˜ = sliced.map(e=>e[1]["ë¯¸ì ‘ìˆ˜"]);
    return {labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜};
  }

  function drawVocBranchChart() {
    const {labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜} = aggregateVocBy("ê´€ë¦¬ì§€ì‚¬",30);
    destroyChart("vocBranch");
    const ctx = document.getElementById("vocBranchChart").getContext("2d");
    vocBranchChart = new Chart(ctx,{
      type:"bar",
      data:{
        labels,
        datasets:[
          { label:"ì²˜ë¦¬ì™„ë£Œ", data:ì²˜ë¦¬ì™„ë£Œ, stack:"voc", backgroundColor:"#4ade80cc" },
          { label:"ì ‘ìˆ˜", data:ì ‘ìˆ˜, stack:"voc", backgroundColor:"#60a5facc" },
          { label:"ë¯¸ì ‘ìˆ˜", data:ë¯¸ì ‘ìˆ˜, stack:"voc", backgroundColor:"#facc15cc" },
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:true },
          tooltip:{
            callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${ctx.parsed.y} ê±´` }
          },
          datalabels:{
            anchor:"end",
            align:"end",
            color:"#111827",
            font:{ size:9, weight:"600" },
            formatter:(v)=>v>0 ? v : ""
          }
        },
        scales:{
          x:{ stacked:true },
          y:{ stacked:true, beginAtZero:true }
        }
      }
    });
  }

  function drawVocAgentChart() {
    const {labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜} = aggregateVocBy("ë‹´ë‹¹ì",20);
    destroyChart("vocAgent");
    const ctx = document.getElementById("vocAgentChart").getContext("2d");
    vocAgentChart = new Chart(ctx,{
      type:"bar",
      data:{
        labels,
        datasets:[
          { label:"ì²˜ë¦¬ì™„ë£Œ", data:ì²˜ë¦¬ì™„ë£Œ, stack:"vocA", backgroundColor:"#4ade80cc" },
          { label:"ì ‘ìˆ˜", data:ì ‘ìˆ˜, stack:"vocA", backgroundColor:"#60a5facc" },
          { label:"ë¯¸ì ‘ìˆ˜", data:ë¯¸ì ‘ìˆ˜, stack:"vocA", backgroundColor:"#facc15cc" },
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:true },
          tooltip:{
            callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${ctx.parsed.y} ê±´` }
          },
          datalabels:{
            anchor:"end",
            align:"end",
            color:"#111827",
            font:{ size:9, weight:"600" },
            formatter:(v)=>v>0 ? v : ""
          }
        },
        scales:{
          x:{ stacked:true },
          y:{ stacked:true, beginAtZero:true }
        }
      }
    });
  }

  function renderVocList() {
    const tbody = document.querySelector("#vocListTable tbody");
    tbody.innerHTML = "";
    let rows = [...filteredVocData];

    const field = vocSortField;
    rows.sort((a,b)=>{
      const av = (a[field] || "").toString();
      const bv = (b[field] || "").toString();
      return vocSortAsc ? av.localeCompare(bv,"ko-KR") : bv.localeCompare(av,"ko-KR");
    });

    rows.forEach(r=>{
      const st = (r["ìƒíƒœ"] || "").trim();
      let cls = "status-none";
      if (st === "ì²˜ë¦¬ì™„ë£Œ") cls = "status-complete";
      else if (st === "ì ‘ìˆ˜") cls = "status-pending";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="status-badge ${cls}">${st || "-"}</span></td>
        <td>${normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]) || "-"}</td>
        <td>${safeText(r["ë‹´ë‹¹ì"])}</td>
        <td class="ellipsis" title="${safeText(r["VOCìœ í˜•ëŒ€"])}">${safeText(r["VOCìœ í˜•ëŒ€"])}</td>
        <td class="ellipsis" title="${safeText(r["VOCìœ í˜•ì¤‘"])}">${safeText(r["VOCìœ í˜•ì¤‘"])}</td>
        <td class="ellipsis" title="${safeText(r["VOCìœ í˜•ì†Œ"])}">${safeText(r["VOCìœ í˜•ì†Œ"])}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function attachVocSortEvents() {
    const ths = document.querySelectorAll("#vocListTable thead th");
    ths.forEach(th=>{
      th.addEventListener("click",()=>{
        const field = th.getAttribute("data-field");
        if (!field) return;
        if (vocSortField === field) {
          vocSortAsc = !vocSortAsc;
        } else {
          vocSortField = field;
          vocSortAsc = true;
        }
        ths.forEach(t=>t.removeAttribute("data-sort"));
        th.setAttribute("data-sort", vocSortAsc ? "asc" : "desc");
        renderVocList();
      });
    });
  }

  /* ==============================
     ì „ì²´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  =============================== */
  function updatePipelineDashboard() {
    filterPipelineData();
    updatePipelineKpi();
    drawPipelineBranchChart();
    drawPipelineStageChart();
    drawPipelineRiskBubbleChart();
    renderPipelineList();
    renderAgentButtons();
  }

  function updateVocDashboard() {
    filterVocData();
    updateVocKpi();
    drawVocBranchChart();
    drawVocAgentChart();
    renderVocList();
    renderVocAgentButtons();
  }

  /* ==============================
     ì´ˆê¸°í™”
  =============================== */
  async function initDashboard() {
    vocData = await loadCsv(VOC_CSV_URL);
    pipelineData = await loadCsv(PIPELINE_CSV_URL);

    // ë²„íŠ¼ ë Œë”ë§
    renderHqButtons();
    renderBranchButtons();
    renderAgentButtons();
    renderVocBranchButtons();
    renderVocAgentButtons();

    // í•„í„° ì´ë²¤íŠ¸
    document.getElementById("channelFilter").addEventListener("change", updatePipelineDashboard);
    document.querySelectorAll("input[name='risk']").forEach(r=>{
      r.addEventListener("change",updatePipelineDashboard);
    });

    attachPipelineSortEvents();
    attachVocSortEvents();

    updatePipelineDashboard();
    updateVocDashboard();
    switchView("pipeline");
  }

  window.addEventListener("load", initDashboard);
</script>

</body>
</html>
