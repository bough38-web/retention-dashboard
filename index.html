<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>KTT í†µí•© ëŒ€ì‹œë³´ë“œ (ê³ ê¸‰í™”)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        /* í°íŠ¸, ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì • */
        body {
            margin: 0;
            display: flex;
            background: #f5f5f7;
            font-family: "Apple SD Gothic Neo", "Segoe UI", sans-serif;
            color: #333;
        }

        /* ì¢Œì¸¡ í•„í„° íŒ¨ë„ */
        .sidebar {
            width: 280px;
            background: #ffffff;
            padding: 20px;
            border-right: 1px solid #ddd;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 6px rgba(0,0,0,0.02);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sidebar h2 {
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #1f2937;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* KPI ì¹´ë“œ ì„¹ì…˜ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 5px solid #3b82f6; /* ê°•ì¡° ì»¬ëŸ¬ */
        }

        .kpi-title {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }

        /* ì°¨íŠ¸ ë° ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .chart-card, .list-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f3f4f6;
        }

        .card-header h3 {
            font-size: 18px;
            margin: 0;
            color: #1f2937;
        }

        /* ì°¨íŠ¸ ê·¸ë¦¬ë“œ */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2ê°œ ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ */
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        /* í¼ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
        button, select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #ffffff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        label {
            display: block;
            padding: 8px 0 4px;
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
        }

        /* ë²„íŠ¼ì‹ í•„í„° ìŠ¤íƒ€ì¼ */
        .filter-group {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px dotted #ddd;
        }

        .filter-group-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .filter-btn {
            flex: 0 0 auto;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            font-size: 12px;
            width: auto;
        }

        .filter-btn.active {
            background: #3b82f6; /* Primary Color */
            color: #fff;
            border-color: #2563eb;
            font-weight: 600;
        }
        
        .mode-btn.active {
            background: #10b981; /* Secondary Color */
            color: #fff;
            border-color: #059669;
        }

        /* ë°ì´í„° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .data-table th {
            background-color: #f9fafb;
            font-weight: 700;
            color: #4b5563;
            cursor: pointer;
        }
        
        .data-table tbody tr:hover {
            background-color: #f3f4f6;
        }

        .list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }
    </style>
</head>

<body>

<div class="sidebar">
    <h2>ğŸ“Š í†µí•© ëŒ€ì‹œë³´ë“œ í•„í„°</h2>

    <label for="channelFilter">ë‹´ë‹¹ì˜ì—…ì±„ë„</label>
    <select id="channelFilter">
        <option value="ALL">ì „ì²´</option>
        <option value="SP">SP</option>
        <option value="SC">SC</option>
        <option value="AM">AM</option>
    </select>

    <label>í•´ì§€ìœ„í—˜ë„ (%)</label>
    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
        <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="ALL" checked> ì „ì²´</label>
        <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="0"> 0 ~ 25%</label>
        <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="25"> 25 ~ 50%</label>
        <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="50"> 50 ~ 75%</label>
        <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="75"> 75 ~ 100%</label>
    </div>

    <label>í‘œì‹œ ê¸°ì¤€ (í•´ì§€íŒŒì´í”„ë¼ì¸)</label>
    <div class="filter-buttons">
        <button class="mode-btn active" data-mode="count" onclick="setMode('count', this)">ê±´ìˆ˜</button>
        <button class="mode-btn" data-mode="amount" onclick="setMode('amount', this)">ê¸ˆì•¡(ì²œì›)</button>
    </div>

    <div class="filter-group">
        <div class="filter-group-title">ê´€ë¦¬ë³¸ë¶€</div>
        <div id="hqButtons" class="filter-buttons">
            </div>
    </div>

    <div class="filter-group">
        <div class="filter-group-title">ê´€ë¦¬ì§€ì‚¬</div>
        <div id="branchButtons" class="filter-buttons">
            </div>
    </div>
</div>

<div class="content">

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-title">í•´ì§€íŒŒì´í”„ë¼ì¸ ì´ ê±´ìˆ˜</div>
            <div id="kpi-pipeline-count" class="kpi-value">0</div>
        </div>
        <div class="kpi-card" style="border-left-color: #10b981;">
            <div class="kpi-title">ì´ ì›”ì •ë£Œ ê¸ˆì•¡ (ì²œì›)</div>
            <div id="kpi-pipeline-amount" class="kpi-value">0</div>
        </div>
        <div class="kpi-card" style="border-left-color: #f59e0b;">
            <div class="kpi-title">VOC ì´ ì²˜ë¦¬ìœ¨ (%)</div>
            <div id="kpi-voc-complete-rate" class="kpi-value">0%</div>
        </div>
        <div class="kpi-card" style="border-left-color: #ef4444;">
            <div class="kpi-title">ë°©ì–´ ì„±ê³µë¥  (%)</div>
            <div id="kpi-defense-success-rate" class="kpi-value">0%</div>
        </div>
    </div>

    <div class="chart-grid">
        <div class="chart-card">
            <div class="card-header">
                <h3>ğŸ“ˆ ê´€ë¦¬ë³¸ë¶€ / ê´€ë¦¬ì§€ì‚¬ë³„ í•´ì§€ í˜„í™©</h3>
            </div>
            <canvas id="pipelineBranchChart"></canvas>
        </div>

        <div class="chart-card">
            <div class="card-header">
                <h3>ğŸ“Š ë°©ì–´ì§„í–‰ë‹¨ê³„ (ì§€ì‚¬ë³„ ì ì¸µ)</h3>
            </div>
            <canvas id="pipelineStageChart"></canvas>
        </div>
        
        <div class="chart-card">
            <div class="card-header">
                <h3>ğŸ’¬ VOC ê´€ë¦¬ì§€ì‚¬ë³„ ìƒíƒœ (ì ì¸µ)</h3>
            </div>
            <canvas id="vocBranchChart"></canvas>
        </div>
        
        <div class="chart-card">
            <div class="card-header">
                <h3>ğŸ‘¨â€ğŸ’¼ VOC ë‹´ë‹¹ìë³„ ìƒíƒœ (Top 20)</h3>
            </div>
            <canvas id="vocAgentChart"></canvas>
        </div>
    </div>

    <div class="list-card">
        <div class="card-header">
            <h3>ğŸ“ í•„í„°ë§ëœ í•´ì§€íŒŒì´í”„ë¼ì¸ ìƒì„¸ ë¦¬ìŠ¤íŠ¸</h3>
            <p style="font-size: 12px; color: #9ca3af; margin: 5px 0 0;">(í…Œì´ë¸” í—¤ë” í´ë¦­ ì‹œ ì •ë ¬)</p>
        </div>
        <div class="list-container">
            <table id="pipelineListTable" class="data-table">
                <thead>
                    <tr>
                        <th data-field="ê³„ì•½ë²ˆí˜¸" data-sort="asc">ê³„ì•½ë²ˆí˜¸</th>
                        <th data-field="ê´€ë¦¬ë³¸ë¶€">ê´€ë¦¬ë³¸ë¶€</th>
                        <th data-field="ê´€ë¦¬ì§€ì‚¬">ê´€ë¦¬ì§€ì‚¬</th>
                        <th data-field="í•´ì§€ìœ„í—˜ë„" data-sort="none">ìœ„í—˜ë„ (%)</th>
                        <th data-field="ë‹´ë‹¹ì˜ì—…ì±„ë„">ì˜ì—…ì±„ë„</th>
                        <th data-field="KTTì›”ì •ë£Œ(ì¡°ì •)" data-sort="none">ì›”ì •ë£Œ (ì²œì›)</th>
                        <th data-field="ë°©ì–´ì§„í–‰ë‹¨ê³„">ë°©ì–´ì§„í–‰ë‹¨ê³„</th>
                        <th data-field="ë°©ì–´ë‹´ë‹¹ì">ë°©ì–´ë‹´ë‹¹ì</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    /* ---------------------------------------------------------
        ğŸ“Œ CSV ë°ì´í„° ê²½ë¡œ
    --------------------------------------------------------- */
    const VOC_CSV_URL =
        "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv";

    const PIPELINE_CSV_URL =
        "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv";

    // Chart.js í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
    Chart.register(ChartDataLabels);

    /* ---------------------------------------------------------
        ğŸ“Œ ì „ì—­ ìƒíƒœê°’
    --------------------------------------------------------- */
    let mode = "count"; // count ë˜ëŠ” amount
    let vocData = [];
    let pipelineData = []; // ì›ë³¸ ë°ì´í„°
    let filteredPipelineData = []; // í•„í„°ë§ëœ ë°ì´í„°

    // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
    let pipelineBranchChart = null;
    let pipelineStageChart = null;
    let vocBranchChart = null;
    let vocAgentChart = null;

    // ê´€ë¦¬ë³¸ë¶€ / ê´€ë¦¬ì§€ì‚¬ ë²„íŠ¼ ìƒíƒœ
    let selectedHQ = "ALL";
    let selectedBranch = "ALL";
    let listSortField = "KTTì›”ì •ë£Œ(ì¡°ì •)";
    let listSortDirection = "desc";

    /* ---------------------------------------------------------
        ğŸ“Œ ê³µí†µ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ í•¨ìˆ˜ ì¬ì‚¬ìš© ë° ê°œì„ )
    --------------------------------------------------------- */

    function normalizeBranch(name) {
        if (!name) return "";
        return String(name).replace("ì§€ì‚¬", "").trim();
    }

    function cleanContractNumber(raw) {
        if (!raw) return "";
        return String(raw).replace(/\D/g, "").slice(0, 8);
    }

    function toThousandWon(raw) {
        if (!raw) return 0;
        const num = parseFloat(String(raw).replace(/,/g, ""));
        return isNaN(num) ? 0 : Math.round(num / 1000);
    }

    function checkRisk(value, selected) {
        if (selected === "ALL") return true;
        const v = parseFloat(value);
        if (isNaN(v)) return false;

        const s = parseInt(selected);
        if (s === 0) return v >= 0 && v < 25;
        if (s === 25) return v >= 25 && v < 50;
        if (s === 50) return v >= 50 && v < 75;
        if (s === 75) return v >= 75 && v <= 100;
        return true;
    }
    
    // ê¸ˆì•¡ í¬ë§· (ì²œë‹¨ìœ„ ì½¤ë§ˆ)
    function formatNumber(num) {
        return num.toLocaleString();
    }
    
    // CSVë¡œë“œ
    async function loadCsv(url) {
        const res = await fetch(url);
        const text = await res.text();
        return new Promise(resolve => {
            Papa.parse(text, {
                header: true,
                skipEmptyLines: true,
                complete: r => resolve(r.data)
            });
        });
    }

    /* ---------------------------------------------------------
        ğŸ“Œ í•„í„°ë§ ë¡œì§
    --------------------------------------------------------- */
    function getSelectedChannel() {
        return document.getElementById("channelFilter").value;
    }

    function getSelectedRisk() {
        return document.querySelector('input[name="risk"]:checked').value;
    }

    function setMode(m, button) {
        mode = m;
        document.querySelectorAll(".mode-btn").forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");
        updatePipelineCharts();
    }

    function filterPipelineData() {
        const channel = getSelectedChannel();
        const risk = getSelectedRisk();

        filteredPipelineData = pipelineData.filter(row => {
            // ê³„ì•½ë²ˆí˜¸ê°€ ì—†ëŠ” í–‰ ì œì™¸
            if (!cleanContractNumber(row["ê³„ì•½ë²ˆí˜¸"])) return false;
            
            // ì±„ë„ í•„í„°
            if (channel !== "ALL" && row["ë‹´ë‹¹ì˜ì—…ì±„ë„"] !== channel) return false;
            
            // ìœ„í—˜ë„ í•„í„°
            if (!checkRisk(row["í•´ì§€ìœ„í—˜ë„"], risk)) return false;

            const head = (row["ê´€ë¦¬ë³¸ë¶€"] || "").trim();
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);

            // ë³¸ë¶€ í•„í„°
            if (selectedHQ !== "ALL" && head !== selectedHQ) return false;
            
            // ì§€ì‚¬ í•„í„°
            if (selectedBranch !== "ALL" && branch !== selectedBranch) return false;

            return true;
        });
    }

    /* ---------------------------------------------------------
        ğŸ“Œ KPI ê³„ì‚° ë° í‘œì‹œ
    --------------------------------------------------------- */
    function updateKPIs() {
        if (!filteredPipelineData.length) {
            document.getElementById("kpi-pipeline-count").innerText = "0";
            document.getElementById("kpi-pipeline-amount").innerText = "0";
            document.getElementById("kpi-voc-complete-rate").innerText = "0%";
            document.getElementById("kpi-defense-success-rate").innerText = "0%";
            return;
        }

        // 1. í•´ì§€íŒŒì´í”„ë¼ì¸ KPI
        const totalCount = filteredPipelineData.length;
        const totalAmount = filteredPipelineData.reduce((sum, row) => 
            sum + toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]), 0
        );
        
        const defenseSuccess = filteredPipelineData.filter(row => row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] === "ë°©ì–´ì„±ê³µ").length;
        const totalDefenseAttempt = filteredPipelineData.filter(row => 
            row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] === "ë°©ì–´ì„±ê³µ" || row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] === "ë°©ì–´ì‹¤íŒ¨" || row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] === "ì§„í–‰ì¤‘"
        ).length;
        const defenseSuccessRate = totalDefenseAttempt > 0 ? (defenseSuccess / totalDefenseAttempt) * 100 : 0;
        
        document.getElementById("kpi-pipeline-count").innerText = formatNumber(totalCount);
        document.getElementById("kpi-pipeline-amount").innerText = formatNumber(totalAmount);
        document.getElementById("kpi-defense-success-rate").innerText = `${defenseSuccessRate.toFixed(1)}%`;


        // 2. VOC KPI
        const totalVoc = vocData.length;
        const completedVoc = vocData.filter(row => (row["ìƒíƒœ"] || "").trim() === "ì²˜ë¦¬ì™„ë£Œ").length;
        const vocCompleteRate = totalVoc > 0 ? (completedVoc / totalVoc) * 100 : 0;

        document.getElementById("kpi-voc-complete-rate").innerText = `${vocCompleteRate.toFixed(1)}%`;
    }

    /* ---------------------------------------------------------
        ğŸ“Œ ê´€ë¦¬ë³¸ë¶€ / ê´€ë¦¬ì§€ì‚¬ ë²„íŠ¼ ìƒì„± (ê¸°ì¡´ í•¨ìˆ˜ ì¬ì‚¬ìš© ë° ê°œì„ )
    --------------------------------------------------------- */
    function renderHQButtons() {
        const container = document.getElementById("hqButtons");
        if (!container || !pipelineData.length) return;

        const heads = Array.from(new Set(
            pipelineData
                .map(r => (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim())
                .filter(Boolean)
        )).sort();

        let html = "";
        html += `<button type="button" class="filter-btn ${selectedHQ === "ALL" ? "active" : ""}" data-value="ALL">ì „ì²´</button>`;
        heads.forEach(hq => {
            html += `<button type="button" class="filter-btn ${selectedHQ === hq ? "active" : ""}" data-value="${hq}">${hq}</button>`;
        });
        container.innerHTML = html;

        container.querySelectorAll(".filter-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const val = btn.getAttribute("data-value");
                selectedHQ = val;
                selectedBranch = "ALL"; // ë³¸ë¶€ ë³€ê²½ ì‹œ ì§€ì‚¬ ì´ˆê¸°í™”
                renderHQButtons();
                renderBranchButtons();
                updateDashboard(); // ì „ì²´ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
            });
        });
    }

    function renderBranchButtons() {
        const container = document.getElementById("branchButtons");
        if (!container || !pipelineData.length) return;

        let filtered = pipelineData;
        if (selectedHQ !== "ALL") {
            filtered = filtered.filter(r => (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim() === selectedHQ);
        }

        const branches = Array.from(new Set(
            filtered
                .map(r => normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]))
                .filter(Boolean)
        )).sort();

        let html = "";
        html += `<button type="button" class="filter-btn ${selectedBranch === "ALL" ? "active" : ""}" data-value="ALL">ì „ì²´</button>`;
        branches.forEach(br => {
            html += `<button type="button" class="filter-btn ${selectedBranch === br ? "active" : ""}" data-value="${br}">${br}</button>`;
        });
        container.innerHTML = html;

        container.querySelectorAll(".filter-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const val = btn.getAttribute("data-value");
                selectedBranch = val;
                renderBranchButtons();
                updateDashboard(); // ì „ì²´ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
            });
        });
    }

    /* ---------------------------------------------------------
        ğŸ“Œ í•´ì§€íŒŒì´í”„ë¼ì¸ â€” ë³¸ë¶€/ì§€ì‚¬ ì§‘ê³„ ë° ì°¨íŠ¸
    --------------------------------------------------------- */
    function getPipelineBranchAgg() {
        const agg = {};

        filteredPipelineData.forEach(row => {
            const head = (row["ê´€ë¦¬ë³¸ë¶€"] || "").trim();
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (!head || !branch) return;

            const key = `${head} / ${branch}`;
            if (!agg[key]) agg[key] = { count: 0, amount: 0 };

            agg[key].count++;
            agg[key].amount += toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
        });

        const entries = Object.entries(agg);
        entries.sort((a, b) => {
            const av = mode === "count" ? a[1].count : a[1].amount;
            const bv = mode === "count" ? b[1].count : b[1].amount;
            return bv - av;
        });
        
        // ìƒìœ„ 20ê°œë§Œ í‘œì‹œ
        const sliced = entries.slice(0, 20);

        return {
            labels: sliced.map(e => e[0]),
            counts: sliced.map(e => e[1].count),
            amounts: sliced.map(e => e[1].amount)
        };
    }

    function drawPipelineBranchChart() {
        const ctx = document.getElementById("pipelineBranchChart").getContext("2d");
        const { labels, counts, amounts } = getPipelineBranchAgg();

        if (pipelineBranchChart) pipelineBranchChart.destroy();

        const dataArray = mode === "count" ? counts : amounts;
        const unit = mode === "count" ? "ê±´" : "ì²œì›";

        pipelineBranchChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [{
                    label: mode === "count" ? "ê±´ìˆ˜" : "ê¸ˆì•¡(ì²œì›)",
                    data: dataArray,
                    backgroundColor: '#3b82f6', // Primary Color
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    datalabels: { // Data Label í”ŒëŸ¬ê·¸ì¸ ì‚¬ìš© (ì „ë¬¸ê°€ ê¸°ë²•)
                        anchor: 'end',
                        align: 'top',
                        formatter: (value) => formatNumber(value),
                        color: '#333'
                    }
                },
                scales: { 
                    y: { 
                        beginAtZero: true,
                        title: { display: true, text: unit }
                    },
                    x: {
                        // ë¼ë²¨ì´ ê¸¸ ê²½ìš° ëŒ€ë¹„
                        ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    /* ---------------------------------------------------------
        ğŸ“Œ í•´ì§€íŒŒì´í”„ë¼ì¸ â€” ë°©ì–´ì§„í–‰ë‹¨ê³„ ì ì¸µ ì°¨íŠ¸
    --------------------------------------------------------- */
    function getPipelineStageAgg() {
        const stages = ["ì§„í–‰ì¤‘", "ë°©ì–´ì‹¤íŒ¨", "ë°©ì–´ì„±ê³µ"];
        const agg = {};

        filteredPipelineData.forEach(row => {
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (!branch) return;

            const stage = (row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] || "").trim();

            if (!agg[branch]) {
                agg[branch] = { ì§„í–‰ì¤‘: 0, ë°©ì–´ì‹¤íŒ¨: 0, ë°©ì–´ì„±ê³µ: 0 };
            }

            if (stages.includes(stage)) agg[branch][stage]++;
        });

        const labels = Object.keys(agg);
        
        // ì§€ì‚¬ë³„ ì´í•© ê³„ì‚° í›„ ìƒìœ„ 20ê°œë§Œ í‘œì‹œ
        labels.sort((a, b) => {
            const sumA = agg[a].ì§„í–‰ì¤‘ + agg[a].ë°©ì–´ì‹¤íŒ¨ + agg[a].ë°©ì–´ì„±ê³µ;
            const sumB = agg[b].ì§„í–‰ì¤‘ + agg[b].ë°©ì–´ì‹¤íŒ¨ + agg[b].ë°©ì–´ì„±ê³µ;
            return sumB - sumA;
        });

        const slicedLabels = labels.slice(0, 20);

        return {
            labels: slicedLabels,
            ì§„í–‰ì¤‘: slicedLabels.map(b => agg[b]["ì§„í–‰ì¤‘"] || 0),
            ë°©ì–´ì‹¤íŒ¨: slicedLabels.map(b => agg[b]["ë°©ì–´ì‹¤íŒ¨"] || 0),
            ë°©ì–´ì„±ê³µ: slicedLabels.map(b => agg[b]["ë°©ì–´ì„±ê³µ"] || 0),
        };
    }

    function drawPipelineStageChart() {
        const ctx = document.getElementById("pipelineStageChart").getContext("2d");
        const { labels, ì§„í–‰ì¤‘, ë°©ì–´ì‹¤íŒ¨, ë°©ì–´ì„±ê³µ } = getPipelineStageAgg();

        if (pipelineStageChart) pipelineStageChart.destroy();

        pipelineStageChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "ë°©ì–´ì„±ê³µ", data: ë°©ì–´ì„±ê³µ, stack: "s", backgroundColor: '#10b981' }, // ì„±ê³µì€ ê°•ì¡°ìƒ‰
                    { label: "ì§„í–‰ì¤‘", data: ì§„í–‰ì¤‘, stack: "s", backgroundColor: '#f59e0b' },
                    { label: "ë°©ì–´ì‹¤íŒ¨", data: ë°©ì–´ì‹¤íŒ¨, stack: "s", backgroundColor: '#ef4444' }, // ì‹¤íŒ¨ëŠ” ê²½ê³ ìƒ‰
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    datalabels: { // Stacked Bar Chartì—ì„œëŠ” í•©ê³„ë§Œ í‘œì‹œí•˜ë„ë¡ ì˜µì…˜ ë³€ê²½ ê°€ëŠ¥
                        display: false, // ì¼ë‹¨ ë¹„í™œì„±í™”í•˜ì—¬ ê¹”ë”í•˜ê²Œ
                    },
                },
                scales: {
                    x: { stacked: true, ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } },
                    y: { stacked: true, beginAtZero: true, title: { display: true, text: "ê±´ìˆ˜" } }
                }
            }
        });
    }

    /* ---------------------------------------------------------
        ğŸ“Œ VOC ì‹œê°í™” (ê¸°ì¡´ í•¨ìˆ˜ ì¬ì‚¬ìš© ë° ê°œì„ )
    --------------------------------------------------------- */
    function aggregateVocBy(field, limit = 20) {
        const agg = {};
        const statuses = ["ì²˜ë¦¬ì™„ë£Œ", "ì ‘ìˆ˜", "ë¯¸ì ‘ìˆ˜"];

        vocData.forEach(row => {
            let key = field === "ê´€ë¦¬ì§€ì‚¬"
                ? normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"])
                : (row[field] || "").trim();

            if (!key) return;

            const st = (row["ìƒíƒœ"] || "").trim();

            if (!agg[key]) agg[key] = { ì²˜ë¦¬ì™„ë£Œ: 0, ì ‘ìˆ˜: 0, ë¯¸ì ‘ìˆ˜: 0 };
            if (statuses.includes(st)) agg[key][st]++;
        });

        const entries = Object.entries(agg);
        entries.sort((a, b) =>
            (b[1].ì²˜ë¦¬ì™„ë£Œ + b[1].ì ‘ìˆ˜ + b[1].ë¯¸ì ‘ìˆ˜) -
            (a[1].ì²˜ë¦¬ì™„ë£Œ + a[1].ì ‘ìˆ˜ + a[1].ë¯¸ì ‘ìˆ˜)
        );

        const sliced = entries.slice(0, limit);

        return {
            labels: sliced.map(e => e[0]),
            ì²˜ë¦¬ì™„ë£Œ: sliced.map(e => e[1].ì²˜ë¦¬ì™„ë£Œ),
            ì ‘ìˆ˜: sliced.map(e => e[1].ì ‘ìˆ˜),
            ë¯¸ì ‘ìˆ˜: sliced.map(e => e[1].ë¯¸ì ‘ìˆ˜),
        };
    }

    function drawVocBranchChart() {
        const ctx = document.getElementById("vocBranchChart").getContext("2d");
        const { labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜ } = aggregateVocBy("ê´€ë¦¬ì§€ì‚¬", 30);

        if (vocBranchChart) vocBranchChart.destroy();

        vocBranchChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "ì²˜ë¦¬ì™„ë£Œ", data: ì²˜ë¦¬ì™„ë£Œ, stack: "v", backgroundColor: '#3b82f6' },
                    { label: "ì ‘ìˆ˜", data: ì ‘ìˆ˜, stack: "v", backgroundColor: '#f59e0b' },
                    { label: "ë¯¸ì ‘ìˆ˜", data: ë¯¸ì ‘ìˆ˜, stack: "v", backgroundColor: '#ef4444' },
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { stacked: true, ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } },
                    y: { stacked: true, beginAtZero: true, title: { display: true, text: "ê±´ìˆ˜" } }
                }
            }
        });
    }

    function drawVocAgentChart() {
        const ctx = document.getElementById("vocAgentChart").getContext("2d");
        const { labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜ } = aggregateVocBy("ë‹´ë‹¹ì", 20);

        if (vocAgentChart) vocAgentChart.destroy();

        vocAgentChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "ì²˜ë¦¬ì™„ë£Œ", data: ì²˜ë¦¬ì™„ë£Œ, stack: "va", backgroundColor: '#3b82f6' },
                    { label: "ì ‘ìˆ˜", data: ì ‘ìˆ˜, stack: "va", backgroundColor: '#f59e0b' },
                    { label: "ë¯¸ì ‘ìˆ˜", data: ë¯¸ì ‘ìˆ˜, stack: "va", backgroundColor: '#ef4444' },
                ]
            },
            options: {
                indexAxis: 'y', // ê°€ë¡œ ë§‰ëŒ€ ì°¨íŠ¸ë¡œ ë³€ê²½í•˜ì—¬ ê°€ë…ì„± ê°œì„ 
                responsive: true,
                scales: {
                    x: { stacked: true, beginAtZero: true, title: { display: true, text: "ê±´ìˆ˜" } },
                    y: { stacked: true, }
                }
            }
        });
    }
    
    /* ---------------------------------------------------------
        ğŸ“Œ ìƒì„¸ ë°ì´í„° ë¦¬ìŠ¤íŠ¸ (ì „ë¬¸ê°€ ê¸°ë²•)
    --------------------------------------------------------- */
    function renderPipelineList() {
        const tableBody = document.querySelector("#pipelineListTable tbody");
        tableBody.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
        
        let sortedData = [...filteredPipelineData];

        // ì •ë ¬ ë¡œì§
        const sortField = listSortField;
        const direction = listSortDirection === 'asc' ? 1 : -1;
        
        sortedData.sort((a, b) => {
            let valA = a[sortField];
            let valB = b[sortField];
            
            // ìˆ«ì í•„ë“œ ì²˜ë¦¬
            if (sortField === "í•´ì§€ìœ„í—˜ë„" || sortField === "KTTì›”ì •ë£Œ(ì¡°ì •)") {
                valA = parseFloat(String(valA).replace(/,/g, "")) || 0;
                valB = parseFloat(String(valB).replace(/,/g, "")) || 0;
            }
            
            if (valA < valB) return -1 * direction;
            if (valA > valB) return 1 * direction;
            return 0;
        });

        // ìƒìœ„ 100ê°œë§Œ í‘œì‹œ (ê³¼ë¶€í•˜ ë°©ì§€)
        sortedData.slice(0, 100).forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${cleanContractNumber(row["ê³„ì•½ë²ˆí˜¸"])}</td>
                <td>${(row["ê´€ë¦¬ë³¸ë¶€"] || "").trim()}</td>
                <td>${normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"])}</td>
                <td>${(parseFloat(row["í•´ì§€ìœ„í—˜ë„"]) || 0).toFixed(1)}</td>
                <td>${row["ë‹´ë‹¹ì˜ì—…ì±„ë„"]}</td>
                <td>${formatNumber(toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]))}</td>
                <td>${row["ë°©ì–´ì§„í–‰ë‹¨ê³„"]}</td>
                <td>${row["ë°©ì–´ë‹´ë‹¹ì"]}</td>
            `;
            tableBody.appendChild(tr);
        });

        // ì •ë ¬ í™”ì‚´í‘œ í‘œì‹œ
        document.querySelectorAll("#pipelineListTable th").forEach(th => {
            th.innerHTML = th.getAttribute("data-field");
            if (th.getAttribute("data-field") === listSortField) {
                const icon = listSortDirection === 'asc' ? ' â–²' : ' â–¼';
                th.innerHTML += icon;
            }
        });
    }
    
    function attachListSortEvents() {
        document.querySelectorAll("#pipelineListTable th").forEach(th => {
            th.addEventListener('click', function() {
                const field = this.getAttribute('data-field');
                if (field === listSortField) {
                    listSortDirection = listSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    listSortField = field;
                    listSortDirection = 'desc'; // ìƒˆ í•„ë“œ ì„ íƒ ì‹œ ê¸°ë³¸ì€ ë‚´ë¦¼ì°¨ìˆœ
                }
                renderPipelineList();
            });
        });
    }

    /* ---------------------------------------------------------
        ğŸ“Œ ì „ì²´ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
    --------------------------------------------------------- */
    function updateDashboard() {
        filterPipelineData(); // 1. ë°ì´í„° í•„í„°ë§
        updateKPIs();         // 2. KPI ì—…ë°ì´íŠ¸
        
        // 3. ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        drawPipelineBranchChart();
        drawPipelineStageChart();
        drawVocBranchChart(); // VOCëŠ” í•„í„° ì—°ë™ì´ ì•½í•˜ë¯€ë¡œ ì¼ë‹¨ VOCë§Œ ì—…ë°ì´íŠ¸
        drawVocAgentChart();
        
        renderPipelineList(); // 4. ìƒì„¸ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    }

    /* ---------------------------------------------------------
        ğŸ“Œ ì´ˆê¸° ë¡œë“œ
    --------------------------------------------------------- */
    async function initDashboard() {
        vocData = await loadCsv(VOC_CSV_URL);
        pipelineData = await loadCsv(PIPELINE_CSV_URL);

        // ê´€ë¦¬ë³¸ë¶€/ì§€ì‚¬ ë²„íŠ¼ ìƒì„±
        renderHQButtons();
        renderBranchButtons();
        
        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° ì—…ë°ì´íŠ¸
        updateDashboard();

        // í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.getElementById("channelFilter")
            .addEventListener("change", updateDashboard);

        document.querySelectorAll('input[name="risk"]')
            .forEach(r => r.addEventListener("change", updateDashboard));
            
        // ë¦¬ìŠ¤íŠ¸ ì •ë ¬ ì´ë²¤íŠ¸ ë“±ë¡
        attachListSortEvents();
    }

    window.addEventListener("load", initDashboard);
</script>

</body>
</html>
