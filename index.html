<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>KTT í†µí•© ë¦¬í…ì…˜ ëŒ€ì‹œë³´ë“œ (Premium Map Edition)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbmyeJMsApj38SRzWvaQGrZmpqUQTooMw" defer></script>
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

    <style>
        /* :root ë³€ìˆ˜ (Premium í…Œë§ˆ) */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #eff6ff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --neutral: #64748b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --shadow-card: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --radius: 12px;
        }

        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { margin: 0; display: flex; background: var(--bg-body); font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; color: var(--text-main); height: 100vh; overflow: hidden; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* ë¡œë”© */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--primary-light); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s ease-in-out infinite; margin-bottom: 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ë ˆì´ì•„ì›ƒ */
        .sidebar { width: 280px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; z-index: 10; box-shadow: 2px 0 10px rgba(0,0,0,0.02); }
        .sidebar-header { padding: 24px; border-bottom: 1px solid var(--border); }
        .sidebar-header h2 { margin: 0; font-size: 18px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 24px; }
        
        .content { flex: 1; padding: 32px; overflow-y: auto; position: relative; }

        /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ */
        .file-upload-area { margin-bottom: 20px; padding: 15px; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 8px; text-align: center; }
        .file-upload-area p { margin: 0 0 8px; font-size: 12px; color: var(--text-sub); font-weight: 600; }
        .file-upload-area input { font-size: 11px; width: 100%; }

        /* ë·° ìŠ¤ìœ„ì²˜ */
        .view-switcher { display: flex; background: #f8fafc; padding: 4px; border-radius: 8px; margin-bottom: 24px; border: 1px solid var(--border); }
        .view-switcher button { flex: 1; padding: 10px; border: none; background: transparent; font-size: 13px; font-weight: 600; color: var(--text-sub); cursor: pointer; border-radius: 6px; transition: all 0.2s; }
        .view-switcher button.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* í•„í„° íŒ¨ë„ */
        .filter-panel label { display: block; font-size: 13px; font-weight: 600; color: var(--text-main); margin: 20px 0 8px; }
        select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: #fff; outline: none; }
        .filter-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
        .filter-btn { padding: 6px 12px; font-size: 12px; border: 1px solid var(--border); border-radius: 20px; background: #fff; color: var(--text-sub); cursor: pointer; transition: 0.2s; }
        .filter-btn:hover { background: #f8fafc; border-color: #cbd5e1; }
        .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: 600; box-shadow: 0 2px 4px rgba(37,99,235,0.2); }
        
        .radio-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .radio-group label { margin: 0; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; background: #fff; }
        .radio-group input { margin-right: 6px; accent-color: var(--primary); }

        /* ëŒ€ì‹œë³´ë“œ ë·° */
        .dashboard-view { display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .dashboard-view.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .view-header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: flex-end; }
        .view-header h2 { margin: 0; font-size: 24px; font-weight: 700; color: var(--text-main); }
        .view-header p { margin: 6px 0 0; color: var(--text-sub); font-size: 14px; }

        /* KPI ì¹´ë“œ */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .kpi-card { 
            background: var(--bg-card); padding: 20px; border-radius: var(--radius); 
            box-shadow: var(--shadow-card); border-left: 4px solid var(--primary); 
            position: relative; overflow: hidden; transition: transform 0.2s;
            display: flex; flex-direction: column; justify-content: center;
        }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        .kpi-card h3 { margin: 0 0 8px; font-size: 12px; color: var(--text-sub); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-card .value { font-size: 28px; font-weight: 800; color: var(--text-main); line-height: 1.2; letter-spacing: -0.5px; }
        .kpi-card .icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 32px; opacity: 0.08; color: var(--text-main); }

        /* ì§€ë„ & ì°¨íŠ¸ ì˜ì—­ */
        .map-section { margin-bottom: 24px; }
        #vocMap { width: 100%; height: 500px; border-radius: var(--radius); border: 1px solid var(--border); }

        .chart-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 24px; }
        .chart-grid.three-cols { grid-template-columns: 2fr 1fr; }
        @media (max-width: 1400px) { .chart-grid, .chart-grid.three-cols { grid-template-columns: 1fr; } }

        .chart-card { background: var(--bg-card); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow-card); height: 420px; display: flex; flex-direction: column; }
        .card-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { margin: 0; font-size: 16px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .card-header span { font-size: 11px; color: var(--text-sub); background: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-weight: 600; }
        .chart-wrapper { flex: 1; position: relative; width: 100%; overflow: hidden; }

        /* í…Œì´ë¸” */
        .list-card { background: var(--bg-card); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow-card); }
        .table-container { overflow-x: auto; min-height: 300px; max-height: 500px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
        .data-table th { background: #f8fafc; padding: 14px 16px; font-weight: 600; color: var(--text-sub); border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; text-align: center; position: sticky; top: 0; z-index: 5; }
        .data-table th:hover { background: #f1f5f9; color: var(--primary); }
        .data-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-main); vertical-align: middle; text-align: center; cursor: pointer; }
        .data-table tr:hover td { background: #f8fafc; }
        /* í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ */
        tr.highlight td { background: #eff6ff !important; border-top: 1px solid var(--primary); border-bottom: 1px solid var(--primary); }
        tr.highlight td:first-child { border-left: 4px solid var(--primary); }

        .list-footer { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .pagination { display: flex; gap: 6px; }
        .pagination button { padding: 6px 14px; border: 1px solid var(--border); background: #fff; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: 0.2s; }
        .pagination button:hover:not(:disabled) { background: #f1f5f9; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-action { padding: 8px 16px; background: var(--success); color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; box-shadow: 0 2px 4px rgba(16,185,129,0.2); }
        .btn-action:hover { background: #059669; transform: translateY(-1px); }

        /* Badges */
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .badge.risk-high { background: #fef2f2; color: #991b1b; border: 1px solid #fee2e2; }
        .badge.stage-success { background: #f0fdf4; color: #166534; border: 1px solid #dcfce7; }
        .badge.stage-fail { background: #fef2f2; color: #991b1b; border: 1px solid #fee2e2; }
        .badge.stage-ing { background: #fff7ed; color: #9a3412; border: 1px solid #ffedd5; }
        .badge.voc-done { background: #eff6ff; color: #1e40af; border: 1px solid #dbeafe; }
        .badge.voc-receipt { background: #fffbeb; color: #b45309; border: 1px solid #fde68a; }
        .badge.voc-yet { background: #fef2f2; color: #991b1b; border: 1px solid #fee2e2; }
        
        /* ì•Œë¦¼ ë©”ì‹œì§€ */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 13px; opacity: 0; transition: 0.3s; z-index: 9999; pointer-events: none; }
        .toast.show { opacity: 1; bottom: 40px; }
    </style>
</head>

<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="font-weight: 600; color: #1e293b; font-size: 14px;">ë°ì´í„° ë¡œë“œ ë° ì§€ë„ ì´ˆê¸°í™” ì¤‘...</div>
</div>

<div id="toast" class="toast">ì§€ë„ë¥¼ ì›€ì§ì´ë©´ í…Œì´ë¸”ê³¼ ì°¨íŠ¸ê°€ ìë™ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.</div>

<div class="sidebar">
    <div class="sidebar-header">
        <h2><i class="ph ph-chart-polar" style="color:var(--primary);"></i> KTT ê°•ë¶/ê°•ì›ë³¸ë¶€</h2>
    </div>
    <div class="sidebar-content">
        <div class="file-upload-area">
            <p><i class="ph ph-upload-simple"></i> íŒŒì¼ ì§ì ‘ ì—…ë¡œë“œ (csv)</p>
            <input type="file" id="localFileInput" accept=".csv" />
        </div>

        <div class="view-switcher">
            <button id="showVocBtn" class="active" onclick="switchView('voc')">VOC í™œë™í˜„í™©</button>
            <button id="showPipelineBtn" onclick="switchView('pipeline')">íŒŒì´í”„ë¼ì¸ ë¶„ì„</button>
        </div>

        <div id="vocFilters" class="filter-panel">
            <label>VOC ìœ í˜•</label><select id="vocTypeFilter"></select>
            <label>ì²˜ë¦¬ ìƒíƒœ</label>
            <div id="vocStatusButtons" class="filter-buttons">
                <button class="filter-btn active" data-value="ALL" onclick="setVocStatus('ALL', this)">ì „ì²´</button>
                <button class="filter-btn" data-value="ì²˜ë¦¬ì™„ë£Œ" onclick="setVocStatus('ì²˜ë¦¬ì™„ë£Œ', this)">ì™„ë£Œ</button>
                <button class="filter-btn" data-value="ì ‘ìˆ˜" onclick="setVocStatus('ì ‘ìˆ˜', this)">ì ‘ìˆ˜</button>
                <button class="filter-btn" data-value="ë¯¸ì ‘ìˆ˜" onclick="setVocStatus('ë¯¸ì ‘ìˆ˜', this)">ë¯¸ì ‘ìˆ˜</button>
            </div>
            <hr style="border: 0; border-top: 1px dashed #e2e8f0; margin: 20px 0;">
            <label>ê´€ë¦¬ ì§€ì‚¬</label><div id="vocBranchButtons" class="filter-buttons"></div>
            
            <label>ë‹´ë‹¹ì</label>
            <select id="vocAgentFilter">
                <option value="ALL">ì „ì²´ ë‹´ë‹¹ì</option>
            </select>
            <div style="margin-top:20px; font-size:12px; color:var(--text-sub); background:#f8fafc; padding:10px; border-radius:6px;">
                <i class="ph ph-info"></i> <b>Tip:</b> ì§€ë„ë¥¼ ì›€ì§ì´ë©´<br/>í™”ë©´ì— ë³´ì´ëŠ” ì§€ì—­ ë°ì´í„°ë§Œ<br/>ì°¨íŠ¸ì™€ ëª©ë¡ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
            </div>
        </div>

        <div id="pipelineFilters" class="filter-panel" style="display:none;">
            <label>ì˜ì—… ì±„ë„</label>
            <select id="channelFilter">
                <option value="ALL">ì „ì²´ ì±„ë„</option>
                <option value="SP" selected>SP</option><option value="SC">SC</option><option value="AM">AM</option>
            </select>
            <label>í•´ì§€ ìœ„í—˜ë„</label>
            <div class="radio-group">
                <label><input type="radio" name="risk" value="ALL" checked>ì „ì²´</label>
                <label><input type="radio" name="risk" value="0">0~25%</label>
                <label><input type="radio" name="risk" value="25">25~50%</label>
                <label><input type="radio" name="risk" value="50">50~75%</label>
                <label><input type="radio" name="risk" value="75">75%~</label>
            </div>
            <label>ë°ì´í„° ê¸°ì¤€</label>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="setMode('count', this)">ê±´ìˆ˜</button>
                <button class="filter-btn" onclick="setMode('amount', this)">ê¸ˆì•¡</button>
            </div>
            <hr style="border: 0; border-top: 1px dashed #e2e8f0; margin: 20px 0;">
            <label>ê´€ë¦¬ ì§€ì‚¬</label><div id="pipelineBranchButtons" class="filter-buttons"></div>
            <label>ë‹´ë‹¹ì</label><select id="pipelineAgentFilter"><option value="ALL">ì „ì²´ ë‹´ë‹¹ì</option></select>
        </div>
    </div>
</div>

<div class="content">

    <div id="vocView" class="dashboard-view active">
        <div class="view-header">
            <div>
                <h2>ê´€ë¦¬ê³ ê°(VOC) í™œë™ í˜„í™©</h2>
                <p>ì§€ë„ ê¸°ë°˜ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</p>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card" style="border-left-color: #3b82f6;"><h3>í™”ë©´ ë‚´ VOC</h3><div id="kpi-voc-total" class="value">0</div><i class="ph ph-map-pin icon"></i></div>
            <div class="kpi-card" style="border-left-color: #10b981;"><h3>ì²˜ë¦¬ ì™„ë£Œ</h3><div id="kpi-voc-complete" class="value">0</div><i class="ph ph-check-circle icon"></i></div>
            <div class="kpi-card" style="border-left-color: #f59e0b;"><h3>ì²˜ë¦¬ìœ¨</h3><div id="kpi-voc-complete-rate" class="value">0%</div><i class="ph ph-chart-pie-slice icon"></i></div>
            <div class="kpi-card" style="border-left-color: #ef4444;"><h3>ë¯¸ì ‘ìˆ˜ ê±´</h3><div id="kpi-voc-unassigned" class="value">0</div><i class="ph ph-warning-circle icon"></i></div>
        </div>

        <div class="map-section">
            <div class="chart-card" style="height:auto;">
                <div class="card-header">
                    <h3><i class="ph ph-map-trifold"></i> VOC ì§€ë¦¬ì  ë¶„í¬</h3>
                    <span>ë“œë˜ê·¸/ì¤Œ ì‹œ í•˜ë‹¨ ë°ì´í„° ìë™ ì—°ë™</span>
                </div>
                <div id="vocMap"></div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <div class="card-header"><h3>ğŸ“‰ ì¡°ì¹˜ í•„ìš” ë‹´ë‹¹ì (í™”ë©´ ë‚´)</h3><span>ë¯¸ì ‘ìˆ˜/ì ‘ìˆ˜ ìƒìœ„</span></div>
                <div class="chart-wrapper"><canvas id="vocActivityChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="card-header"><h3>ì§€ì‚¬ë³„ ì²˜ë¦¬ í˜„í™© (í™”ë©´ ë‚´)</h3><span>ê±´ìˆ˜ ê¸°ì¤€</span></div>
                <div class="chart-wrapper"><canvas id="vocBranchChart"></canvas></div>
            </div>
        </div>

        <div class="list-card">
            <div class="card-header">
                <h3>ìƒì„¸ ë°ì´í„° ë¦¬ìŠ¤íŠ¸ (ì§€ë„ ì˜ì—­)</h3>
                <button class="btn-action" onclick="exportToCSV('voc')"><i class="ph ph-download-simple"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <div class="table-container">
                <table id="vocListTable" class="data-table">
                    <thead>
                        <tr>
                            <th data-field="ê´€ë¦¬ì§€ì‚¬">ì§€ì‚¬</th><th data-field="ë‹´ë‹¹ì">ë‹´ë‹¹ì</th><th data-field="ê³„ì•½ë²ˆí˜¸">ê³„ì•½ë²ˆí˜¸</th>
                            <th data-field="ìƒí˜¸">ìƒí˜¸ëª…</th><th data-field="ìƒíƒœ">ìƒíƒœ</th><th data-field="VOCìœ í˜•ì†Œ">ì„œë¹„ìŠ¤(ì†Œ)</th>
                            <th data-field="í•©ì‚°ì›”ì •ë£Œ">í•©ì‚°ì›”ì •ë£Œ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="list-footer">
                <div id="vocPaginationInfo" style="font-size:13px; color:#64748b;"></div>
                <div class="pagination"><button onclick="changePage('voc', -1)">ì´ì „</button><button onclick="changePage('voc', 1)">ë‹¤ìŒ</button></div>
            </div>
        </div>
    </div>

    <div id="pipelineView" class="dashboard-view">
        <div class="view-header">
            <div>
                <h2>í•´ì§€ íŒŒì´í”„ë¼ì¸ ë¶„ì„</h2>
                <p>ê³ ìœ„í—˜ ê³ ê° ë°©ì–´ ì„±ê³¼ ë° í•´ì§€ ì‚¬ìœ  ì‹¬ì¸µ ë¶„ì„</p>
            </div>
        </div>
        
        <div class="kpi-grid">
            <div class="kpi-card" style="border-left-color: #2563eb;"><h3>ëŒ€ìƒ ì´ ê±´ìˆ˜</h3><div id="kpi-pipeline-count" class="value">0</div><i class="ph ph-funnel icon"></i></div>
            <div class="kpi-card" style="border-left-color: #10b981;"><h3>ì›”ì •ë£Œ ê·œëª¨</h3><div id="kpi-pipeline-amount" class="value">0</div><i class="ph ph-currency-krw icon"></i></div>
            <div class="kpi-card" style="border-left-color: #ef4444;"><h3>ê³ ìœ„í—˜êµ° (75%â†‘)</h3><div id="kpi-high-risk-count" class="value">0</div><i class="ph ph-siren icon"></i></div>
            <div class="kpi-card" style="border-left-color: #f59e0b;"><h3>ë°©ì–´ ì„±ê³µë¥ </h3><div id="kpi-defense-success-rate" class="value">0%</div><i class="ph ph-shield-check icon"></i></div>
        </div>
        
        <div class="chart-grid">
            <div class="chart-card">
                <div class="card-header"><h3><i class="ph ph-chart-bar"></i> ì§€ì‚¬ë³„ ë°©ì–´ ë‹¨ê³„</h3><span>ë§‰ëŒ€ë¥¼ í´ë¦­í•˜ì—¬ í•„í„°ë§</span></div>
                <div class="chart-wrapper"><canvas id="pipelineBranchStageChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="card-header"><h3><i class="ph ph-chart-line-up"></i> ì›”ë³„ ë°©ì–´ í˜„í™©</h3><span>ë‹¨ê³„ë³„ ê±´ìˆ˜ + ì„±ê³µë¥ </span></div>
                <div class="chart-wrapper"><canvas id="pipelineTrendChart"></canvas></div>
            </div>
        </div>

        <div class="chart-grid three-cols">
            <div class="chart-card">
                <div class="card-header"><h3><i class="ph ph-crosshair"></i> ìœ„í—˜ë„ vs ì›”ì •ë£Œ</h3><span>ì „ëµì  ì¤‘ìš”êµ° ì‹ë³„</span></div>
                <div class="chart-wrapper"><canvas id="pipelineRiskBubbleChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="card-header"><h3><i class="ph ph-chart-donut"></i> í•´ì§€ ì‚¬ìœ  ë¶„ì„</h3><span>Top 5 Reasons</span></div>
                <div class="chart-wrapper"><canvas id="pipelineReasonChart"></canvas></div>
            </div>
        </div>

        <div class="list-card">
            <div class="card-header">
                <h3>ìƒì„¸ íŒŒì´í”„ë¼ì¸ ë¦¬ìŠ¤íŠ¸</h3>
                <button class="btn-action" onclick="exportToCSV('pipeline')"><i class="ph ph-download-simple"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <div class="table-container">
                <table id="pipelineListTable" class="data-table">
                    <thead>
                        <tr>
                            <th data-field="ê´€ë¦¬ì§€ì‚¬">ì§€ì‚¬</th><th data-field="ë‹´ë‹¹ì">ë‹´ë‹¹ì</th><th data-field="ê³„ì•½ë²ˆí˜¸">ê³„ì•½ë²ˆí˜¸</th>
                            <th data-field="ìƒí˜¸">ìƒí˜¸ëª…</th><th data-field="ë‹´ë‹¹ì˜ì—…ì±„ë„">ì±„ë„</th><th data-field="KTTì›”ì •ë£Œ(ì¡°ì •)">ì›”ì •ë£Œ(ì²œì›)</th>
                            <th data-field="ì¬ê³„ì•½ì—¬ë¶€">ì¬ê³„ì•½ì—¬ë¶€</th><th data-field="ë°©ì–´ì§„í–‰ë‹¨ê³„">ë‹¨ê³„</th><th data-field="í•´ì§€ìœ„í—˜ë„">ìœ„í—˜ë„</th>
                            <th data-field="í•´ì§€ì˜ˆì •ì¼">í•´ì§€ì˜ˆì •ì¼</th><th data-field="ë“±ë¡ì¼ì">ë“±ë¡ì¼ì</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="list-footer">
                <div id="pipelinePaginationInfo" style="font-size:13px; color:#64748b;"></div>
                <div class="pagination"><button onclick="changePage('pipeline', -1)">ì´ì „</button><button onclick="changePage('pipeline', 1)">ë‹¤ìŒ</button></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Config
    const VOC_CSV_URL = "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv";
    const PIPELINE_CSV_URL = "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv";
    
    Chart.register(ChartDataLabels);
    Chart.defaults.font.family = "'Pretendard', sans-serif";
    Chart.defaults.color = "#64748b";
    
    // Helpers
    const util = {
        normalizeBranch: (n) => String(n||"").replace("ì§€ì‚¬","").trim(),
        cleanContract: (r) => String(r||"").replace(/\D/g,"").slice(0,8),
        toThousand: (r) => { const n=parseFloat(String(r).replace(/,/g,"")); return isNaN(n)?0:Math.round(n/1000); },
        formatNum: (n) => n.toLocaleString(),
        excelDateToJSDate: (s) => {
            if(!s) return "-"; if(isNaN(s) && String(s).includes('-')) return s;
            const c=parseFloat(String(s).replace(/,/g,'')); if(isNaN(c)) return s;
            const d=new Date((c-25569)*86400*1000);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        },
        sortBranches: (a,b)=>{ const o=["ì¤‘ì•™","ê°•ë¶","ì„œëŒ€ë¬¸","ê³ ì–‘","ì˜ì •ë¶€","ë‚¨ì–‘ì£¼","ê°•ë¦‰","ì›ì£¼"]; const ia=o.indexOf(a),ib=o.indexOf(b); if(ia===-1&&ib===-1)return a.localeCompare(b); if(ia===-1)return 1; if(ib===-1)return -1; return ia-ib; }
    };

    // State
    const state = {
        currentView: 'voc',
        voc: { 
            data: [], 
            filtered: [], // ì‚¬ì´ë“œë°” í•„í„° ê²°ê³¼
            viewData: [], // ì§€ë„ ë°”ìš´ìŠ¤ í•„í„°ê¹Œì§€ ì ìš©ëœ ìµœì¢… ë°ì´í„°
            page: 1, limit: 10, sortField: 'VOCìœ í˜•ëŒ€', sortDir: 'desc', branch: 'ALL', agent: 'ALL' 
        },
        pipeline: { 
            data: [], filtered: [], 
            page: 1, limit: 15, sortField: 'KTTì›”ì •ë£Œ(ì¡°ì •)', sortDir: 'desc', mode: 'count', hq: 'ALL', branch: 'ALL', agent: 'ALL', channel: 'SP' 
        }
    };
    
    const chartInstances = {};
    
    // Map Variables
    let vocMap, vocInfo, vocClusterer;
    let vocMarkers = []; // í˜„ì¬ ì§€ë„ì— ì°íŒ ë§ˆì»¤ë“¤
    let markerMap = new Map(); // Data Row -> Marker ë§¤í•‘

    // Init
    window.addEventListener("load", async () => {
        try {
            await loadDefaultData();
        } catch(e) { console.error(e); }
    });

    async function loadDefaultData() {
        const [v, p] = await Promise.all([loadCsv(VOC_CSV_URL), loadCsv(PIPELINE_CSV_URL)]);
        
        // â˜… ì „ì²˜ë¦¬ ì ìš©: "ìœ„ì¹˜ì¢Œí‘œ(ìœ„ë„,ê²½ë„)" -> "ìœ„ë„", "ê²½ë„"
        state.voc.data = preprocessVocData(v); 
        state.pipeline.data = preprocessPipelineData(p);
        
        initVocMap(); // ì§€ë„ ì´ˆê¸°í™”
        initializeApp(); // ì•± ë¡œì§ ì‹œì‘
    }

    async function loadCsv(url) {
        const res = await fetch(url); const text = await res.text();
        return new Promise(r => Papa.parse(text, { header: true, skipEmptyLines: true, complete: res => r(res.data) }));
    }

    // â˜… NEW: VOC ë°ì´í„° ì „ì²˜ë¦¬ (ìœ„ì¹˜ì¢Œí‘œ ë¶„ë¦¬)
    function preprocessVocData(data) {
        return data.map(row => {
            // "ìœ„ì¹˜ì¢Œí‘œ(ìœ„ë„,ê²½ë„)" ì»¬ëŸ¼ì´ ìˆê³  ì½¤ë§ˆê°€ í¬í•¨ëœ ê²½ìš°
            const rawLoc = row["ìœ„ì¹˜ì¢Œí‘œ(ìœ„ë„,ê²½ë„)"];
            if (rawLoc && typeof rawLoc === 'string' && rawLoc.includes(',')) {
                const parts = rawLoc.split(',');
                if (parts.length >= 2) {
                    row["ìœ„ë„"] = parts[0].trim();
                    row["ê²½ë„"] = parts[1].trim();
                }
            }
            // ì´ë¯¸ "ìœ„ë„", "ê²½ë„"ê°€ ìˆê±°ë‚˜ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì•ˆì „ì¥ì¹˜
            // (ìœ„ì—ì„œ í• ë‹¹ë˜ì§€ ì•Šì•˜ë‹¤ë©´ 0 ì²˜ë¦¬ or ì›ë³¸ ìœ ì§€)
            return row;
        });
    }

    function preprocessPipelineData(data) {
        return data.map(row => {
            if (row["KTTì›”ì •ë£Œ(ì¡°ì •)"]) {
                const val = parseFloat(String(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]).replace(/,/g, ""));
                if (!isNaN(val)) row["KTTì›”ì •ë£Œ(ì¡°ì •)"] = String(Math.round(val));
            }
            let risk = row['í•´ì§€ìœ„í—˜ë„'];
            if (risk) {
                let riskNum = parseFloat(risk);
                if (!isNaN(riskNum) && riskNum <= 1.0 && riskNum > 0) row['í•´ì§€ìœ„í—˜ë„'] = (riskNum * 100).toFixed(0);
            }
            return row;
        });
    }

    function initializeApp() {
        // Pipeline Init
        const hqs = [...new Set(state.pipeline.data.map(r=>(r["ê´€ë¦¬ë³¸ë¶€"]||"").trim()).filter(Boolean))];
        state.pipeline.hq = hqs.includes('ê°•ë¶/ê°•ì›') ? 'ê°•ë¶/ê°•ì›' : 'ALL';
        
        initFilters(); // í•„í„° ë Œë”ë§
        
        // Initial Rendering
        filterData('voc'); 
        filterData('pipeline');
        
        // Render View
        renderVocMarkers(); // ì§€ë„ ë§ˆì»¤ ì°ê¸° -> ì´ê²Œ ì™„ë£Œë˜ë©´ idle ì´ë²¤íŠ¸ ë°œìƒ -> updateDashboard('voc') ì‹¤í–‰ë¨
        updateDashboard('pipeline');
        
        document.getElementById("loadingOverlay").style.display = "none";
        showToast();
    }

    // --- MAP FUNCTIONS (NEW) ---
    function initVocMap(){
        vocMap = new google.maps.Map(document.getElementById("vocMap"),{
            center:{lat:37.5665,lng:126.9780}, zoom:9,
            mapTypeControl: false, fullscreenControl: false
        });
        vocInfo = new google.maps.InfoWindow();

        // ì§€ë„ ì›€ì§ì„ ë©ˆì¶”ë©´ ë°ì´í„° í•„í„°ë§ íŠ¸ë¦¬ê±°
        vocMap.addListener("idle", () => {
            applyMapBoundsFilter();
        });
    }

    function getVocIcon(row){
        const statusColor = { "ì²˜ë¦¬ì™„ë£Œ":"blue", "ì ‘ìˆ˜":"orange", "ë¯¸ì ‘ìˆ˜":"red" }[row["ìƒíƒœ"]] || "gray";
        // ê°„í¸ ì•„ì´ì½˜ ì‚¬ìš©
        return `https://maps.google.com/mapfiles/ms/icons/${statusColor}-dot.png`;
    }

    function renderVocMarkers(){
        if(!vocMap) return;
        if(vocClusterer) vocClusterer.clearMarkers();
        vocMarkers = [];
        markerMap.clear();

        // ì‚¬ì´ë“œë°” í•„í„°ê°€ ì ìš©ëœ state.voc.filtered ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ë§ˆì»¤ ìƒì„±
        state.voc.filtered.forEach((r) => {
            const lat = parseFloat(r["ìœ„ë„"]);
            const lng = parseFloat(r["ê²½ë„"]);
            if(isNaN(lat) || isNaN(lng)) return;

            const marker = new google.maps.Marker({
                position: {lat, lng},
                title: r["ìƒí˜¸"],
                icon: { url: getVocIcon(r), scaledSize: new google.maps.Size(32,32) }
            });

            // ë§ˆì»¤ í´ë¦­ ì‹œ
            marker.addListener("click", () => {
                vocInfo.setContent(`
                    <div style="padding:5px; min-width:150px;">
                        <b>${r["ìƒí˜¸"] || "ê³ ê°"}</b><br/>
                        <span style="color:#666">${r["ê´€ë¦¬ì§€ì‚¬"]} / ${r["ë‹´ë‹¹ì"]}</span><br/>
                        <span style="font-weight:bold; color:${r["ìƒíƒœ"]==='ì²˜ë¦¬ì™„ë£Œ'?'blue':'red'}">${r["ìƒíƒœ"]}</span> (${r["VOCìœ í˜•ëŒ€"]})
                    </div>
                `);
                vocInfo.open(vocMap, marker);
                highlightRowInTable(r);
            });

            vocMarkers.push(marker);
            markerMap.set(r, marker);
        });

        // í´ëŸ¬ìŠ¤í„°ë§ ì ìš©
        vocClusterer = new markerClusterer.MarkerClusterer({
            map: vocMap,
            markers: vocMarkers,
            renderer: {
                render: ({ count, position }) => {
                    return new google.maps.Marker({
                        label: { text: String(count), color: "white", fontSize: "12px", fontWeight: "bold" },
                        position,
                        zIndex: Number(google.maps.Marker.MAX_ZINDEX) + count,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 16,
                            fillColor: "#2563eb",
                            fillOpacity: 0.9,
                            strokeWeight: 2,
                            strokeColor: "#fff"
                        }
                    });
                }
            }
        });
    }

    function applyMapBoundsFilter() {
        if(!vocMap) return;
        const bounds = vocMap.getBounds();
        if (!bounds) {
            state.voc.viewData = state.voc.filtered;
        } else {
            // í˜„ì¬ í™”ë©´(Bounds) ì•ˆì— ìˆëŠ” ë°ì´í„°ë§Œ ì¶”ì¶œ
            state.voc.viewData = state.voc.filtered.filter(r => {
                const lat = parseFloat(r["ìœ„ë„"]);
                const lng = parseFloat(r["ê²½ë„"]);
                if(isNaN(lat)||isNaN(lng)) return false;
                return bounds.contains({lat, lng});
            });
        }
        
        // ë·° ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        updateVocDashboardComponents();
    }

    function updateVocDashboardComponents() {
        updateVocKPIs();
        drawVocCharts();
        state.voc.page = 1;
        renderTable('voc');
    }

    // --- FILTERS & UPDATE LOGIC ---
    function initFilters() {
        // VOC
        const vt = [...new Set(state.voc.data.map(r=>(r["VOCìœ í˜•ëŒ€"]||"").trim()).filter(Boolean))].sort();
        const sel = document.getElementById("vocTypeFilter");
        sel.innerHTML = '<option value="ALL">ì „ì²´ ìœ í˜•</option>' + vt.map(t=>`<option value="${t}">${t}</option>`).join('');
        sel.addEventListener('change', () => updateDashboard('voc'));
        
        renderVocFilters('branch');
        renderAgentOptions('voc');

        // Pipeline
        document.getElementById("channelFilter").addEventListener("change", (e)=>{ state.pipeline.channel=e.target.value; updateDashboard('pipeline'); });
        document.querySelectorAll('input[name="risk"]').forEach(e=>e.addEventListener("change", ()=>updateDashboard('pipeline')));
        renderPipelineFilters('branch');
        renderAgentOptions('pipeline');

        // Agent Listeners
        document.getElementById("vocAgentFilter").addEventListener("change", (e) => { state.voc.agent = e.target.value; updateDashboard('voc'); });
        document.getElementById("pipelineAgentFilter").addEventListener("change", (e) => { state.pipeline.agent = e.target.value; updateDashboard('pipeline'); });

        setupSortEvents('pipelineListTable','pipeline'); setupSortEvents('vocListTable','voc');
    }

    // í†µí•© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateDashboard(v) {
        filterData(v);
        if(v === 'pipeline') {
            updatePipelineKPIs();
            drawPipelineCharts();
            renderTable('pipeline');
        } else {
            // VOCì˜ ê²½ìš°: ë°ì´í„° í•„í„°ë§ -> ë§ˆì»¤ ë Œë”ë§ -> (ì§€ë„ê°€ idleë˜ë©´ applyMapBoundsFilter í˜¸ì¶œë¨) -> ì°¨íŠ¸/í…Œì´ë¸” ì—…ë°ì´íŠ¸
            renderVocMarkers();
            // í˜¹ì‹œ ì§€ë„ê°€ ì›€ì§ì´ì§€ ì•Šì•„ idle ì´ë²¤íŠ¸ê°€ ì•ˆ ìƒê¸¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê°•ì œ í˜¸ì¶œ (ì•½ê°„ ë”œë ˆì´)
            setTimeout(applyMapBoundsFilter, 100);
        }
    }

    function filterData(v) {
        if(v === 'pipeline') {
            // ê¸°ì¡´ Pipeline ë¡œì§ ìœ ì§€
            const ch = state.pipeline.channel;
            const rVal = document.querySelector('input[name="risk"]:checked').value;
            state.pipeline.filtered = state.pipeline.data.filter(r => {
                if(ch!=='ALL' && r["ë‹´ë‹¹ì˜ì—…ì±„ë„"]!==ch) return false;
                const risk = parseFloat(r["í•´ì§€ìœ„í—˜ë„"]);
                if(rVal!=='ALL') {
                    const rv = parseInt(rVal);
                    if(rv===75 && risk<75) return false;
                    if(rv!==75 && (risk<rv || risk>=rv+25)) return false;
                }
                if(state.pipeline.hq!=='ALL' && (r["ê´€ë¦¬ë³¸ë¶€"]||"").trim()!==state.pipeline.hq) return false;
                if(state.pipeline.branch!=='ALL' && util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])!==state.pipeline.branch) return false;
                if(state.pipeline.agent!=='ALL' && (r["ë‹´ë‹¹ì"]||"").trim()!==state.pipeline.agent) return false;
                return true;
            });
            state.pipeline.page = 1;
        } else {
            // VOC í•„í„°ë§ (ì‚¬ì´ë“œë°” ì¡°ê±´ë§Œ ì ìš©)
            const t = document.getElementById("vocTypeFilter").value;
            const s = document.querySelector('#vocStatusButtons .active').dataset.value;
            state.voc.filtered = state.voc.data.filter(r => {
                if(t!=='ALL' && (r["VOCìœ í˜•ëŒ€"]||"").trim()!==t) return false;
                if(s!=='ALL' && (r["ìƒíƒœ"]||"").trim()!==s) return false;
                if(state.voc.branch!=='ALL' && util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])!==state.voc.branch) return false;
                if(state.voc.agent!=='ALL' && (r["ë‹´ë‹¹ì"]||"").trim()!==state.voc.agent) return false;
                return true;
            });
            // VOCëŠ” ì—¬ê¸°ì„œ page ì´ˆê¸°í™” í•˜ì§€ ì•ŠìŒ (ì§€ë„ ë°”ìš´ìŠ¤ ì²´í¬ í›„ viewData ìƒì„± ì‹œ í•¨)
        }
    }

    // --- CHART & KPI ---
    function updateVocKPIs() {
        const d = state.voc.viewData; // í™”ë©´ ë‚´ ë°ì´í„° ê¸°ì¤€
        const comp = d.filter(r=>(r["ìƒíƒœ"]||"").trim()==='ì²˜ë¦¬ì™„ë£Œ').length;
        document.getElementById("kpi-voc-total").innerText = util.formatNum(d.length);
        document.getElementById("kpi-voc-complete").innerText = util.formatNum(comp);
        document.getElementById("kpi-voc-complete-rate").innerText = d.length>0 ? (comp/d.length*100).toFixed(1)+'%' : '0%';
        document.getElementById("kpi-voc-unassigned").innerText = util.formatNum(d.filter(r=>(r["ìƒíƒœ"]||"").trim()==='ë¯¸ì ‘ìˆ˜').length);
    }
    
    function updatePipelineKPIs() {
        const d = state.pipeline.filtered;
        const amt = d.reduce((s,r)=>s+util.toThousand(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]),0);
        const suc = d.filter(r=>r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]==='ë°©ì–´ì„±ê³µ').length;
        const att = d.filter(r=>['ë°©ì–´ì„±ê³µ','ë°©ì–´ì‹¤íŒ¨','ì§„í–‰ì¤‘'].includes(r["ë°©ì–´ì§„í–‰ë‹¨ê³„"])).length;
        const high = d.filter(r=>parseFloat(r["í•´ì§€ìœ„í—˜ë„"])>=75).length;
        document.getElementById("kpi-pipeline-count").innerText = util.formatNum(d.length);
        document.getElementById("kpi-pipeline-amount").innerText = util.formatNum(amt);
        document.getElementById("kpi-high-risk-count").innerText = util.formatNum(high);
        document.getElementById("kpi-defense-success-rate").innerText = att>0 ? (suc/att*100).toFixed(1)+'%' : '0%';
    }

    function newChart(id, conf) {
        if(chartInstances[id]) chartInstances[id].destroy();
        chartInstances[id] = new Chart(document.getElementById(id), conf);
    }

    function drawVocCharts() {
        const d = state.voc.viewData; // í™”ë©´ ë‚´ ë°ì´í„° ì‚¬ìš©
        
        // 1. Activity
        const act={}; d.forEach(r=>{const a=(r["ë‹´ë‹¹ì"]||"").trim();const s=(r["ìƒíƒœ"]||"").trim();if(a&&(s==='ë¯¸ì ‘ìˆ˜'||s==='ì ‘ìˆ˜')){if(!act[a])act[a]={y:0,r:0,t:0};if(s==='ë¯¸ì ‘ìˆ˜')act[a].y++;else act[a].r++;act[a].t++;}});
        const sAct = Object.entries(act).sort((a,b)=>b[1].t-a[1].t).slice(0,10);
        newChart('vocActivityChart', {
            type:'bar', data:{labels:sAct.map(e=>e[0]),datasets:[{label:'ë¯¸ì ‘ìˆ˜',data:sAct.map(e=>e[1].y),backgroundColor:'#ef4444',borderRadius:4},{label:'ì ‘ìˆ˜',data:sAct.map(e=>e[1].r),backgroundColor:'#f59e0b',borderRadius:4}]},
            options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,grid:{display:false}},y:{stacked:true,grid:{display:false}}},plugins:{legend:{position:'top'},datalabels:{display:c=>c.dataset.data[c.dataIndex]>0,color:'#fff'}}}
        });
        
        // 2. Branch
        const br={}; d.forEach(r=>{const b=util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]);if(!b)return;if(!br[b])br[b]={d:0,r:0,y:0};const s=(r["ìƒíƒœ"]||"").trim();if(s==='ì²˜ë¦¬ì™„ë£Œ')br[b].d++;else if(s==='ì ‘ìˆ˜')br[b].r++;else br[b].y++;});
        const lBr = Object.keys(br).sort(util.sortBranches);
        newChart('vocBranchChart', {
            type:'bar', data:{labels:lBr,datasets:[{label:'ì™„ë£Œ',data:lBr.map(k=>br[k].d),backgroundColor:'#3b82f6',borderRadius:4,stack:'s'},{label:'ì ‘ìˆ˜',data:lBr.map(k=>br[k].r),backgroundColor:'#fbbf24',borderRadius:4,stack:'s'},{label:'ë¯¸ì ‘ìˆ˜',data:lBr.map(k=>br[k].y),backgroundColor:'#f87171',borderRadius:4,stack:'s'}]},
            options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,grid:{display:false}},y:{stacked:true}},plugins:{legend:{position:'bottom'},datalabels:{display:false}}}
        });
    }

    function drawPipelineCharts() {
        const d = state.pipeline.filtered;
        const m = state.pipeline.mode;

        // Branch Stage
        const br={}; d.forEach(r=>{
            const b = util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]); if(!b)return;
            if(!br[b]) br[b]={suc:0,fail:0,ing:0,tot:0};
            const v = m==='amount'?util.toThousand(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]):1;
            const s = r["ë°©ì–´ì§„í–‰ë‹¨ê³„"];
            if(s==='ë°©ì–´ì„±ê³µ')br[b].suc+=v; else if(s==='ë°©ì–´ì‹¤íŒ¨')br[b].fail+=v; else if(s==='ì§„í–‰ì¤‘')br[b].ing+=v;
            if(['ë°©ì–´ì„±ê³µ','ë°©ì–´ì‹¤íŒ¨','ì§„í–‰ì¤‘'].includes(s)) br[b].tot+=v;
        });
        const sBr = Object.entries(br).filter(e=>e[1].tot>0).sort((a,b)=>b[1].tot-a[1].tot).slice(0,10);
        newChart('pipelineBranchStageChart', {
            type: 'bar',
            data: { labels: sBr.map(e=>e[0]), datasets: [
                {label:'ì„±ê³µ', data:sBr.map(e=>e[1].suc), backgroundColor:'#34d399', stack:'s', borderRadius:4},
                {label:'ì§„í–‰', data:sBr.map(e=>e[1].ing), backgroundColor:'#fbbf24', stack:'s', borderRadius:4},
                {label:'ì‹¤íŒ¨', data:sBr.map(e=>e[1].fail), backgroundColor:'#f87171', stack:'s', borderRadius:4}
            ]},
            options: { responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true, grid:{display:false}}, y:{stacked:true}}, plugins:{legend:{position:'bottom'}, datalabels:{display:false}}, onClick: (e, el) => { if(el.length>0) setPipelineFilter('branch', sBr.map(e=>e[0])[el[0].index]); } }
        });

        // Trend
        const trend = {}; d.forEach(r => {
            let dateStr = util.excelDateToJSDate(r["ë“±ë¡ì¼ì"]); let month = dateStr.slice(0, 7); if(month.length < 7) return;
            if(!trend[month]) trend[month] = { tot: 0, suc: 0, ing: 0, fail: 0 };
            trend[month].tot += 1;
            const s = (r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]||"").trim();
            if(s === 'ë°©ì–´ì„±ê³µ') trend[month].suc += 1; else if(s === 'ì§„í–‰ì¤‘') trend[month].ing += 1; else if(s === 'ë°©ì–´ì‹¤íŒ¨') trend[month].fail += 1;
        });
        const sortedMonths = Object.keys(trend).sort();
        newChart('pipelineTrendChart', {
            type: 'bar',
            data: { labels: sortedMonths, datasets: [
                { type: 'line', label: 'ì„±ê³µë¥ (%)', data: sortedMonths.map(m => (trend[m].tot===0 ? 0 : (trend[m].suc/trend[m].tot*100).toFixed(1))), borderColor: '#10b981', borderWidth: 2, tension:0.3, yAxisID: 'y_rate', order:1 },
                { label: 'ë°©ì–´ì„±ê³µ', data: sortedMonths.map(m => trend[m].suc), backgroundColor: '#34d399', stack: 'combined', yAxisID: 'y_count', order:2 },
                { label: 'ì§„í–‰ì¤‘', data: sortedMonths.map(m => trend[m].ing), backgroundColor: '#fbbf24', stack: 'combined', yAxisID: 'y_count', order:3 },
                { label: 'ë°©ì–´ì‹¤íŒ¨', data: sortedMonths.map(m => trend[m].fail), backgroundColor: '#f87171', stack: 'combined', yAxisID: 'y_count', order:4 }
            ]},
            options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x: { grid: {display: false} }, y_count: { position: 'left', stacked:true, grid:{borderDash:[4,4]} }, y_rate: { position: 'right', min: 0, max: 100, grid: {drawOnChartArea: false} } }, plugins: { legend: {display: true}, datalabels: {display: false} } }
        });

        // Bubble
        const bub = Object.entries(br).map(([b,v])=>{
            const sub = d.filter(r=>util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])===b);
            const risk = sub.reduce((s,r)=>s+parseFloat(r["í•´ì§€ìœ„í—˜ë„"]||0),0)/sub.length;
            const amtTotal = sub.reduce((s,r)=>s+util.toThousand(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]),0);
            return { label:b, data:[{x:risk, y:amtTotal/sub.length, r:Math.sqrt(amtTotal)*0.4}], backgroundColor:'rgba(37,99,235,0.6)', borderColor:'#2563eb' };
        }).filter(b=>b.data[0].r>0);
        newChart('pipelineRiskBubbleChart', { type: 'bubble', data: { datasets: bub }, options: { responsive:true, maintainAspectRatio:false, plugins: { legend:{display:false}, datalabels: { display: true, align: 'top', formatter: v=>Math.round(v.y).toLocaleString() } }, scales: { x:{title:{display:true,text:'ìœ„í—˜ë„'}, min:0, max:100}, y:{title:{display:true,text:'í‰ê· ì›”ì •ë£Œ'}} } } });
        
        // Reason
        const reasons = {}; d.forEach(r => { let re = (r["í•´ì§€ì‚¬ìœ "] || "ë¯¸ì…ë ¥").trim(); reasons[re] = (reasons[re] || 0) + 1; });
        const top5 = Object.entries(reasons).sort((a,b) => b[1] - a[1]).slice(0, 5);
        newChart('pipelineReasonChart', { type: 'doughnut', data: { labels: top5.map(e => e[0]), datasets: [{ data: top5.map(e => e[1]), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, datalabels: { color: '#fff', formatter: (v, c) => (v/c.chart._metasets[c.datasetIndex].total*100).toFixed(0)+"%" } } } });
    }

    // --- TABLE ---
    function renderTable(t) {
        const s = state[t];
        const dataSrc = t === 'voc' ? s.viewData : s.filtered;
        const tb = document.querySelector(`#${t}ListTable tbody`);
        tb.innerHTML = "";
        
        const sorted = [...dataSrc].sort((a,b)=>{
            let va = a[s.sortField], vb = b[s.sortField];
            if(s.sortField.includes('ì›”ì •ë£Œ')||s.sortField.includes('ìœ„í—˜ë„')) { va=parseFloat(String(va).replace(/,/g,''))||0; vb=parseFloat(String(vb).replace(/,/g,''))||0; }
            if(va<vb) return s.sortDir==='asc'?-1:1; if(va>vb) return s.sortDir==='asc'?1:-1; return 0;
        });

        const start = (s.page-1)*s.limit;
        const pageData = sorted.slice(start, start+s.limit);
        const totalPages = Math.max(1, Math.ceil(sorted.length/s.limit)); 
        document.getElementById(`${t}PaginationInfo`).innerText = `ì´ ${util.formatNum(sorted.length)}ê±´ ì¤‘ ${sorted.length > 0 ? start+1 : 0}-${Math.min(start+s.limit, sorted.length)}`;

        pageData.forEach(r => {
            const tr = document.createElement("tr");
            const companyName = r["ìƒí˜¸"] || r["ìƒí˜¸ëª…"] || '-';
            
            // Interaction: Row Click -> Map Pan (VOC Only)
            if(t === 'voc') {
                tr.onclick = () => {
                    const marker = markerMap.get(r);
                    if(marker) {
                        vocMap.panTo(marker.getPosition());
                        vocMap.setZoom(14);
                        google.maps.event.trigger(marker, "click");
                    }
                };
                tr.dataset.ref = JSON.stringify({lat: r["ìœ„ë„"], lng: r["ê²½ë„"], name: r["ìƒí˜¸"]});
            }

            if(t === 'pipeline') {
                let bc = '', st = (r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]||"").trim();
                if(st==='ë°©ì–´ì„±ê³µ') bc='stage-success'; else if(st==='ë°©ì–´ì‹¤íŒ¨') bc='stage-fail'; else bc='stage-ing';
                tr.innerHTML = `<td>${util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])}</td><td>${r["ë‹´ë‹¹ì"]}</td><td>${util.cleanContract(r["ê³„ì•½ë²ˆí˜¸"])}</td><td style="text-align:left;">${companyName}</td><td>${r["ë‹´ë‹¹ì˜ì—…ì±„ë„"]}</td><td>${util.formatNum(util.toThousand(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]))}</td><td>${r["ì¬ê³„ì•½ì—¬ë¶€"]||'-'}</td><td><span class="badge ${bc}">${st}</span></td><td>${r["í•´ì§€ìœ„í—˜ë„"]}%</td><td>${r["í•´ì§€ì˜ˆì •ì¼"]||'-'}</td><td>${util.excelDateToJSDate(r["ë“±ë¡ì¼ì"])}</td>`;
            } else {
                let bc = '', st = (r["ìƒíƒœ"]||"").trim();
                if(st==='ì²˜ë¦¬ì™„ë£Œ') bc='voc-done'; else if(st==='ì ‘ìˆ˜') bc='voc-receipt'; else bc='voc-yet';
                tr.innerHTML = `<td>${util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])}</td><td>${r["ë‹´ë‹¹ì"]}</td><td>${util.cleanContract(r["ê³„ì•½ë²ˆí˜¸"])}</td><td style="text-align:left;">${companyName}</td><td><span class="badge ${bc}">${st}</span></td><td>${r["VOCìœ í˜•ì†Œ"]||'-'}</td><td>${r["í•©ì‚°ì›”ì •ë£Œ"]?util.formatNum(util.toThousand(r["í•©ì‚°ì›”ì •ë£Œ"])):'-'}</td>`;
            }
            tb.appendChild(tr);
        });

        const btns = document.querySelectorAll(`#${t}View .pagination button`);
        if(btns.length >= 2) { btns[0].disabled = s.page <= 1; btns[1].disabled = s.page >= totalPages; }
    }

    function highlightRowInTable(r) {
        const rows = document.querySelectorAll("#vocListTable tbody tr");
        rows.forEach(row => row.classList.remove("highlight"));
        const targetStr = JSON.stringify({lat: r["ìœ„ë„"], lng: r["ê²½ë„"], name: r["ìƒí˜¸"]});
        for(let tr of rows) {
            if(tr.dataset.ref === targetStr) {
                tr.classList.add("highlight");
                tr.scrollIntoView({behavior: "smooth", block: "center"});
                break;
            }
        }
    }

    window.changePage = (t, d) => { state[t].page += d; renderTable(t); };
    function setupSortEvents(id, t) {
        document.querySelectorAll(`#${id} th[data-field]`).forEach(th => {
            th.addEventListener('click', () => {
                const f = th.dataset.field;
                if(state[t].sortField===f) state[t].sortDir = state[t].sortDir==='asc'?'desc':'asc';
                else { state[t].sortField=f; state[t].sortDir='desc'; }
                document.querySelectorAll(`#${id} th`).forEach(x=>x.innerText=x.innerText.replace(/ [â–²â–¼]/,''));
                th.innerText += state[t].sortDir==='asc'?' â–²':' â–¼';
                renderTable(t);
            });
        });
    }
    
    // UI Helpers
    window.switchView = (v) => {
        state.currentView = v;
        document.querySelectorAll('.view-switcher button').forEach(b=>b.classList.remove('active'));
        document.getElementById(v==='voc'?'showVocBtn':'showPipelineBtn').classList.add('active');
        document.querySelectorAll('.dashboard-view').forEach(e=>e.classList.remove('active'));
        document.getElementById(v+'View').classList.add('active');
        document.getElementById('pipelineFilters').style.display = v==='pipeline'?'block':'none';
        document.getElementById('vocFilters').style.display = v==='voc'?'block':'none';
        setTimeout(()=>{
            Object.values(chartInstances).forEach(c=>c&&c.resize());
            if(v==='voc' && vocMap) {
                google.maps.event.trigger(vocMap, "resize"); 
                vocMap.setCenter(vocMap.getCenter());
            }
        }, 100);
    };

    window.setPipelineFilter = (t,v) => { state.pipeline[t]=v; if(t==='branch') renderAgentOptions('pipeline'); renderPipelineFilters('branch'); updateDashboard('pipeline'); };
    window.setVocFilter = (t,v) => { state.voc[t]=v; if(t==='branch') renderAgentOptions('voc'); updateDashboard('voc'); };
    window.setVocStatus = (v,b) => { document.querySelectorAll('#vocStatusButtons .filter-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); updateDashboard('voc'); };
    window.setMode = (m,b) => { state.pipeline.mode=m; document.querySelectorAll('#pipelineFilters .filter-buttons button').forEach(e=>e.classList.remove('active')); b.classList.add('active'); updateDashboard('pipeline'); };
    
    window.exportToCSV = (t) => {
        const d = t === 'voc' ? state.voc.viewData : state.pipeline.filtered;
        if(!d.length) return alert("ë°ì´í„° ì—†ìŒ");
        const blob = new Blob(["\uFEFF"+Papa.unparse(d)], {type:'text/csv;charset=utf-8;'});
        const link = document.createElement("a"); link.href=URL.createObjectURL(blob); link.download=`ktt_${t}_${new Date().toISOString().slice(0,10)}.csv`; link.click();
    };
    
    function renderVocFilters(type) {
        const c = document.getElementById(`voc${type.charAt(0).toUpperCase()+type.slice(1)}Buttons`);
        let s = state.voc.data;
        let items = [...new Set(s.map(r=>util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])).filter(Boolean))].sort(util.sortBranches);
        c.innerHTML = `<button class="filter-btn ${state.voc[type]==='ALL'?'active':''}" onclick="setVocFilter('${type}','ALL')">ì „ì²´</button>` + items.map(i=>`<button class="filter-btn ${state.voc[type]===i?'active':''}" onclick="setVocFilter('${type}','${i.replace(/'/g,"\\'")}')">${i}</button>`).join('');
    }
    function renderPipelineFilters(type) {
        if(type!=='branch') return;
        const c = document.getElementById(`pipelineBranchButtons`);
        let s = state.pipeline.data; if(state.pipeline.hq!=='ALL') s = s.filter(r=>(r["ê´€ë¦¬ë³¸ë¶€"]||"").trim()===state.pipeline.hq);
        let items = [...new Set(s.map(r=>util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])).filter(Boolean))].sort(util.sortBranches);
        c.innerHTML = `<button class="filter-btn ${state.pipeline[type]==='ALL'?'active':''}" onclick="setPipelineFilter('${type}','ALL')">ì „ì²´</button>` + items.map(i=>`<button class="filter-btn ${state.pipeline[type]===i?'active':''}" onclick="setPipelineFilter('${type}','${i.replace(/'/g,"\\'")}')">${i}</button>`).join('');
    }
    function renderAgentOptions(view) {
        const s = state[view];
        let filteredAgents = s.data;
        if(s.branch !== 'ALL') filteredAgents = filteredAgents.filter(r => util.normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]) === s.branch);
        if(view === 'pipeline' && s.hq !== 'ALL') filteredAgents = filteredAgents.filter(r => (r["ê´€ë¦¬ë³¸ë¶€"]||"").trim() === s.hq);
        const agents = [...new Set(filteredAgents.map(r=>(r["ë‹´ë‹¹ì"]||"").trim()).filter(Boolean))].sort();
        const selectEl = document.getElementById(view === 'voc' ? 'vocAgentFilter' : 'pipelineAgentFilter');
        selectEl.innerHTML = `<option value="ALL">ì „ì²´ ë‹´ë‹¹ì (${agents.length})</option>` + agents.map(a => `<option value="${a}">${a}</option>`).join('');
        selectEl.value = agents.includes(s.agent) ? s.agent : 'ALL';
        if(selectEl.value === 'ALL') s.agent = 'ALL';
    }
    
    function showToast() { const t = document.getElementById("toast"); t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 3000); }

    // File Upload (Local) with preprocessing
    document.getElementById('localFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            Papa.parse(evt.target.result, { header: true, skipEmptyLines: true, complete: function(results) {
                // íŒŒì´í”„ë¼ì¸ ë°ì´í„°ë¼ê³  ê°€ì •í•˜ê³  ì „ì²˜ë¦¬
                state.pipeline.data = preprocessPipelineData(results.data); 
                initializeApp(); 
                switchView('pipeline'); 
                alert("ë°ì´í„° ê°±ì‹  ì™„ë£Œ");
            }});
        };
        reader.readAsText(file, 'UTF-8');
    });
</script>
</body>
</html>
