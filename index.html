<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>KTT í†µí•© ëŒ€ì‹œë³´ë“œ (ìµœì¢… ì™„ì„±ë³¸)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        /* ---------------------------------------------------------
           ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° ë ˆì´ì•„ì›ƒ
        --------------------------------------------------------- */
        body {
            margin: 0;
            display: flex;
            background: #f5f5f7;
            font-family: "Apple SD Gothic Neo", "Segoe UI", sans-serif;
            color: #333;
        }

        /* ì¢Œì¸¡ ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 280px;
            background: #ffffff;
            padding: 20px;
            border-right: 1px solid #ddd;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 6px rgba(0,0,0,0.02);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sidebar h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1f2937;
            border-bottom: 2px solid #f3f4f6;
            padding-bottom: 10px;
        }

        /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ */
        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            height: 100vh;
        }

        /* ë·° ì „í™˜ íƒ­ */
        .view-switcher {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .view-switcher button {
            flex: 1;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-switcher button.active {
            background: #3b82f6;
            color: #fff;
            border-color: #2563eb;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
        }

        /* KPI ì¹´ë“œ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 5px solid #3b82f6;
            transition: transform 0.2s;
        }
        
        .kpi-card:hover { transform: translateY(-3px); }

        .kpi-title { font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 600; }
        .kpi-value { font-size: 26px; font-weight: 800; color: #111; }

        /* ì°¨íŠ¸ ë° ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ */
        .chart-card, .list-card {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }

        .card-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 { margin: 0; font-size: 17px; color: #1f2937; }
        .card-header p { margin: 0; font-size: 12px; color: #9ca3af; }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1200px) {
            .chart-grid { grid-template-columns: 1fr; }
        }

        /* í¼ ìš”ì†Œ & í•„í„° */
        label { display: block; margin: 15px 0 5px; font-size: 13px; font-weight: 700; color: #374151; }
        
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #fff;
            font-size: 14px;
        }

        /* ë¼ë””ì˜¤ ê·¸ë£¹ */
        .radio-group { display: flex; flex-wrap: wrap; gap: 5px; }
        .radio-group label {
            margin: 0;
            padding: 6px 10px;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .radio-group input { margin-right: 6px; }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .filter-buttons { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px; }
        
        .filter-btn, .mode-btn {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            background: #fff;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover, .mode-btn:hover { background: #f9fafb; }
        
        .filter-btn.active {
            background: #eff6ff;
            color: #2563eb;
            border-color: #bfdbfe;
            font-weight: 700;
        }
        
        .mode-btn.active {
            background: #ecfdf5;
            color: #059669;
            border-color: #a7f3d0;
            font-weight: 700;
        }

        .filter-group-title {
            font-size: 12px;
            font-weight: 700;
            color: #9ca3af;
            margin-top: 15px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        /* í…Œì´ë¸” */
        .list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th { 
            position: sticky; top: 0; 
            background: #f9fafb; 
            padding: 12px 15px; 
            text-align: left; 
            font-weight: 700; 
            color: #4b5563;
            border-bottom: 2px solid #e5e7eb;
            cursor: pointer;
        }
        .data-table td { padding: 10px 15px; border-bottom: 1px solid #f3f4f6; color: #374151; }
        .data-table tr:hover { background: #f9fafb; }

        /* ë·° ì œì–´ */
        .dashboard-view { display: none; }
        .dashboard-view.active { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>

<body>

<div class="sidebar">
    <h2>ğŸ“Š ëŒ€ì‹œë³´ë“œ í•„í„°</h2>

    <div class="view-switcher">
        <button id="showVocBtn" onclick="switchView('voc')">VOC í™œë™</button>
        <button id="showPipelineBtn" class="active" onclick="switchView('pipeline')">í•´ì§€íŒŒì´í”„ë¼ì¸</button>
    </div>
    
    <div id="vocFilters" class="filter-panel" style="display:none;">
        <label>VOC ìœ í˜• (ëŒ€)</label>
        <select id="vocTypeFilter">
            <option value="ALL">ì „ì²´</option>
            </select>
        
        <label>ì§„í–‰ ìƒíƒœ</label>
        <div id="vocStatusButtons" class="filter-buttons">
            <button class="filter-btn active" onclick="setVocStatus('ALL', this)">ì „ì²´</button>
            <button class="filter-btn" onclick="setVocStatus('ì²˜ë¦¬ì™„ë£Œ', this)">ì²˜ë¦¬ì™„ë£Œ</button>
            <button class="filter-btn" onclick="setVocStatus('ì ‘ìˆ˜', this)">ì ‘ìˆ˜</button>
            <button class="filter-btn" onclick="setVocStatus('ë¯¸ì ‘ìˆ˜', this)">ë¯¸ì ‘ìˆ˜</button>
        </div>
    </div>
    
    <div id="pipelineFilters" class="filter-panel">
        <label>ë‹´ë‹¹ì˜ì—…ì±„ë„</label>
        <select id="channelFilter">
            <option value="ALL">ì „ì²´</option>
            <option value="SP" selected>SP</option> <option value="SC">SC</option>
            <option value="AM">AM</option>
        </select>

        <label>í•´ì§€ìœ„í—˜ë„ êµ¬ê°„</label>
        <div class="radio-group">
            <label><input type="radio" name="risk" value="ALL" checked> ì „ì²´</label>
            <label><input type="radio" name="risk" value="0"> 0~25%</label>
            <label><input type="radio" name="risk" value="25"> 25~50%</label>
            <label><input type="radio" name="risk" value="50"> 50~75%</label>
            <label><input type="radio" name="risk" value="75"> 75~100%</label>
        </div>

        <label>ì§‘ê³„ ê¸°ì¤€</label>
        <div class="filter-buttons">
            <button class="mode-btn active" onclick="setMode('count', this)">ê±´ìˆ˜</button>
            <button class="mode-btn" onclick="setMode('amount', this)">ê¸ˆì•¡(ì²œì›)</button>
        </div>
        
        <div class="filter-group-title">ê´€ë¦¬ë³¸ë¶€</div>
        <div id="pipelineHqButtons" class="filter-buttons">
            </div>

        <div class="filter-group-title">ê´€ë¦¬ì§€ì‚¬</div>
        <div id="pipelineBranchButtons" class="filter-buttons">
            </div>

        <div class="filter-group-title">ë‹´ë‹¹ì</div>
        <div id="pipelineAgentButtons" class="filter-buttons">
            </div>
    </div>
</div>

<div class="content">

    <div id="vocView" class="dashboard-view">
        <div class="card-header" style="border:none; padding:0; margin-bottom:20px;">
            <h3>ğŸ’¬ ê´€ë¦¬ê³ ê° í•´ì§€ê³ ìœ„í—˜ ì¬ê³„ì•½ í™œë™ í˜„í™©</h3>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">ì´ VOC ê±´ìˆ˜</div>
                <div id="kpi-voc-total" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #10b981;">
                <div class="kpi-title">ì²˜ë¦¬ì™„ë£Œ</div>
                <div id="kpi-voc-complete" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #f59e0b;">
                <div class="kpi-title">ì²˜ë¦¬ ì™„ë£Œìœ¨</div>
                <div id="kpi-voc-complete-rate" class="kpi-value">0%</div>
            </div>
            <div class="kpi-card" style="border-left-color: #ef4444;">
                <div class="kpi-title">ë¯¸ì ‘ìˆ˜</div>
                <div id="kpi-voc-unassigned" class="kpi-value">0</div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <div class="card-header"><h3>ì§€ì‚¬ë³„ VOC ìƒíƒœ (ì ì¸µ)</h3></div>
                <canvas id="vocBranchChart"></canvas>
            </div>
            <div class="chart-card">
                <div class="card-header"><h3>ë‹´ë‹¹ìë³„ VOC ìƒíƒœ (Top 20)</h3></div>
                <canvas id="vocAgentChart"></canvas>
            </div>
        </div>

        <div class="list-card">
            <div class="card-header">
                <h3>ìƒì„¸ ë¦¬ìŠ¤íŠ¸</h3>
                <p>í—¤ë” í´ë¦­ ì‹œ ì •ë ¬</p>
            </div>
            <div class="list-container">
                <table id="vocListTable" class="data-table">
                    <thead>
                        <tr>
                            <th data-field="ìƒíƒœ">ìƒíƒœ</th>
                            <th data-field="VOCìœ í˜•ëŒ€">ìœ í˜•(ëŒ€)</th>
                            <th data-field="VOCìœ í˜•ì¤‘">ìœ í˜•(ì¤‘)</th>
                            <th data-field="ê´€ë¦¬ë³¸ë¶€">ê´€ë¦¬ë³¸ë¶€</th>
                            <th data-field="ê´€ë¦¬ì§€ì‚¬">ê´€ë¦¬ì§€ì‚¬</th>
                            <th data-field="ë‹´ë‹¹ì">ë‹´ë‹¹ì</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="pipelineView" class="dashboard-view active">
        <div class="card-header" style="border:none; padding:0; margin-bottom:20px;">
            <h3>ğŸ”¥ í•´ì§€íŒŒì´í”„ë¼ì¸ ë“±ë¡ í˜„í™©</h3>
        </div>
        
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">ì´ ê±´ìˆ˜</div>
                <div id="kpi-pipeline-count" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #10b981;">
                <div class="kpi-title">ì´ ì›”ì •ë£Œ (ì²œì›)</div>
                <div id="kpi-pipeline-amount" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #ef4444;">
                <div class="kpi-title">ê³ ìœ„í—˜êµ° (75%â†‘)</div>
                <div id="kpi-high-risk-count" class="kpi-value">0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #f59e0b;">
                <div class="kpi-title">ë°©ì–´ ì„±ê³µë¥ </div>
                <div id="kpi-defense-success-rate" class="kpi-value">0%</div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <div class="card-header">
                    <h3>ì§€ì‚¬ë³„ ì§„í–‰ ë‹¨ê³„ (Top 10)</h3>
                    <p id="branchChartModeText">(ê±´ìˆ˜ ê¸°ì¤€)</p>
                </div>
                <canvas id="pipelineBranchStageChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="card-header">
                    <h3>ìœ„í—˜ë„ vs ì›”ì •ë£Œ ë¶„í¬ (Bubble)</h3>
                </div>
                <canvas id="pipelineRiskBubbleChart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="card-header">
                    <h3>Top 5 ì§€ì‚¬ ë°©ì–´ ì„±ê³µë¥ </h3>
                </div>
                <canvas id="pipelineDefenseSuccessRateChart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="card-header">
                    <h3>ë‹´ë‹¹ìë³„ ë°©ì–´ ì‹¤íŒ¨ (Top 10)</h3>
                </div>
                <canvas id="pipelineAgentFailChart"></canvas>
            </div>
        </div>

        <div class="list-card">
            <div class="card-header">
                <h3>ìƒì„¸ ë¦¬ìŠ¤íŠ¸</h3>
                <p>í—¤ë” í´ë¦­ ì‹œ ì •ë ¬</p>
            </div>
            <div class="list-container">
                <table id="pipelineListTable" class="data-table">
                    <thead>
                        <tr>
                            <th data-field="ê³„ì•½ë²ˆí˜¸">ê³„ì•½ë²ˆí˜¸</th>
                            <th data-field="ê´€ë¦¬ì§€ì‚¬">ê´€ë¦¬ì§€ì‚¬</th>
                            <th data-field="í•´ì§€ìœ„í—˜ë„">ìœ„í—˜ë„(%)</th>
                            <th data-field="ë‹´ë‹¹ì˜ì—…ì±„ë„">ì±„ë„</th>
                            <th data-field="KTTì›”ì •ë£Œ(ì¡°ì •)">ì›”ì •ë£Œ(ì²œì›)</th>
                            <th data-field="ë°©ì–´ì§„í–‰ë‹¨ê³„">ë‹¨ê³„</th>
                            <th data-field="ë°©ì–´ë‹´ë‹¹ì">ë‹´ë‹¹ì</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    /* ==========================================================================
       1. ë°ì´í„° ë° ì „ì—­ ì„¤ì •
       ========================================================================== */
    const VOC_CSV_URL = "uploaded:voc.csv";
    const PIPELINE_CSV_URL = "uploaded:pipeline.csv";

    Chart.register(ChartDataLabels);

    const BRANCH_SORT_ORDER = ["ì¤‘ì•™", "ê°•ë¶", "ì„œëŒ€ë¬¸", "ê³ ì–‘", "ì˜ì •ë¶€", "ë‚¨ì–‘ì£¼", "ê°•ë¦‰", "ì›ì£¼"];

    // Pipeline State
    let pipelineMode = "count"; // 'count' or 'amount'
    let pipelineData = [], filteredPipelineData = [];
    let pipelineSelectedChannel = "SP"; // [ìš”ì²­] ë””í´íŠ¸ SP
    let pipelineSelectedHQ = "ê°•ë¶/ê°•ì›"; // [ìš”ì²­] ë””í´íŠ¸ ê°•ë¶/ê°•ì›
    let pipelineSelectedBranch = "ALL";
    let pipelineSelectedAgent = "ALL";
    let pipelineListSortField = "KTTì›”ì •ë£Œ(ì¡°ì •)", pipelineListSortDirection = "desc";

    // VOC State
    let vocData = [], filteredVocData = [];
    let vocSelectedType = "ë¦¬í…ì…˜"; // [ìš”ì²­] ë””í´íŠ¸ ë¦¬í…ì…˜
    let vocSelectedStatus = "ALL";
    let vocListSortField = "VOCìœ í˜•ëŒ€", vocListSortDirection = "desc";

    let chartInstances = {};

    /* ==========================================================================
       2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
       ========================================================================== */
    function normalizeBranch(name) { return name ? String(name).replace("ì§€ì‚¬", "").trim() : ""; }
    function cleanContractNumber(raw) { return raw ? String(raw).replace(/\D/g, "").slice(0, 8) : ""; }
    function toThousandWon(raw) {
        if (!raw) return 0;
        const num = parseFloat(String(raw).replace(/,/g, ""));
        return isNaN(num) ? 0 : Math.round(num / 1000);
    }
    function formatNumber(num) { return num.toLocaleString(); }
    
    function sortBranches(a, b) {
        const idxA = BRANCH_SORT_ORDER.indexOf(a), idxB = BRANCH_SORT_ORDER.indexOf(b);
        if (idxA === -1 && idxB === -1) return a.localeCompare(b);
        if (idxA === -1) return 1;
        if (idxB === -1) return -1;
        return idxA - idxB;
    }

    function checkRisk(value, selected) {
        if (selected === "ALL") return true;
        const v = parseFloat(value);
        if (isNaN(v)) return false;
        const s = parseInt(selected);
        if (s === 0) return v >= 0 && v < 25;
        if (s === 25) return v >= 25 && v < 50;
        if (s === 50) return v >= 50 && v < 75;
        if (s === 75) return v >= 75 && v <= 100;
        return true;
    }

    // [í•µì‹¬] CSV ë¡œë“œ í•¨ìˆ˜: VOCëŠ” 1í–‰ ìŠ¤í‚µ(2í–‰ë¶€í„° í—¤ë”)
    async function loadCsv(url, skipRows = 1) {
        const res = await fetch(url);
        let text = await res.text();
        if (skipRows > 0) {
            const lines = text.split('\n');
            text = lines.slice(skipRows).join('\n');
        }
        return new Promise(resolve => {
            Papa.parse(text, { header: true, skipEmptyLines: true, complete: r => resolve(r.data) });
        });
    }

    function destroyChart(id) {
        if (chartInstances[id]) { chartInstances[id].destroy(); chartInstances[id] = null; }
    }

    /* ==========================================================================
       3. ë·° ì œì–´
       ========================================================================== */
    function switchView(view) {
        document.querySelectorAll('.view-switcher button').forEach(b => b.classList.remove('active'));
        document.getElementById(view === 'voc' ? 'showVocBtn' : 'showPipelineBtn').classList.add('active');
        
        document.querySelectorAll('.dashboard-view').forEach(v => v.classList.remove('active'));
        document.getElementById(view + 'View').classList.add('active');

        document.getElementById('pipelineFilters').style.display = view === 'pipeline' ? 'block' : 'none';
        document.getElementById('vocFilters').style.display = view === 'voc' ? 'block' : 'none';

        if (view === 'pipeline') updatePipelineDashboard();
        else updateVocDashboard();
    }

    /* ==========================================================================
       4. [Pipeline] ë¡œì§
       ========================================================================== */
    function setMode(m, btn) {
        pipelineMode = m;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById("branchChartModeText").innerText = `(${m === 'count' ? 'ê±´ìˆ˜' : 'ê¸ˆì•¡(ì²œì›)'} ê¸°ì¤€, Top 10)`;
        updatePipelineDashboard();
    }

    function setPipelineHQ(hq, btn) {
        pipelineSelectedHQ = hq;
        pipelineSelectedBranch = "ALL"; pipelineSelectedAgent = "ALL";
        renderPipelineButtons(); // í•˜ìœ„ í•„í„° ì¬ìƒì„±
        updatePipelineDashboard();
    }
    
    function setPipelineBranch(br, btn) {
        pipelineSelectedBranch = br;
        pipelineSelectedAgent = "ALL";
        renderPipelineButtons();
        updatePipelineDashboard();
    }

    function setPipelineAgent(ag, btn) {
        pipelineSelectedAgent = ag;
        renderPipelineButtons(); // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ìš©
        updatePipelineDashboard();
    }

    // Pipeline ë°ì´í„° í•„í„°ë§
    function filterPipelineData() {
        const risk = document.querySelector('input[name="risk"]:checked').value;
        const channel = document.getElementById("channelFilter").value;

        filteredPipelineData = pipelineData.filter(row => {
            if (!cleanContractNumber(row["ê³„ì•½ë²ˆí˜¸"])) return false;
            if (channel !== "ALL" && row["ë‹´ë‹¹ì˜ì—…ì±„ë„"] !== channel) return false;
            if (!checkRisk(row["í•´ì§€ìœ„í—˜ë„"], risk)) return false;

            // ê³„ì¸µ êµ¬ì¡° í•„í„°
            const head = (row["ê´€ë¦¬ë³¸ë¶€"] || "").trim();
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            const agent = (row["ë‹´ë‹¹ì"] || "").trim();

            if (pipelineSelectedHQ !== "ALL" && head !== pipelineSelectedHQ) return false;
            if (pipelineSelectedBranch !== "ALL" && branch !== pipelineSelectedBranch) return false;
            if (pipelineSelectedAgent !== "ALL" && agent !== pipelineSelectedAgent) return false;
            
            return true;
        });
    }

    // Pipeline ë²„íŠ¼ ë Œë”ë§ (HQ -> Branch -> Agent)
    function renderPipelineButtons() {
        // 1. HQ Buttons
        const hqSet = new Set(pipelineData.map(r => (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim()).filter(Boolean));
        let html = `<button class="filter-btn ${pipelineSelectedHQ === 'ALL' ? 'active' : ''}" onclick="setPipelineHQ('ALL', this)">ì „ì²´</button>`;
        Array.from(hqSet).sort().forEach(hq => {
            html += `<button class="filter-btn ${pipelineSelectedHQ === hq ? 'active' : ''}" onclick="setPipelineHQ('${hq}', this)">${hq}</button>`;
        });
        document.getElementById("pipelineHqButtons").innerHTML = html;

        // 2. Branch Buttons (HQ ì¢…ì†)
        let branchData = pipelineData;
        if (pipelineSelectedHQ !== 'ALL') branchData = branchData.filter(r => (r["ê´€ë¦¬ë³¸ë¶€"] || "").trim() === pipelineSelectedHQ);
        const branchSet = new Set(branchData.map(r => normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"])).filter(Boolean));
        
        html = `<button class="filter-btn ${pipelineSelectedBranch === 'ALL' ? 'active' : ''}" onclick="setPipelineBranch('ALL', this)">ì „ì²´</button>`;
        Array.from(branchSet).sort(sortBranches).forEach(br => {
            html += `<button class="filter-btn ${pipelineSelectedBranch === br ? 'active' : ''}" onclick="setPipelineBranch('${br}', this)">${br}</button>`;
        });
        document.getElementById("pipelineBranchButtons").innerHTML = html;

        // 3. Agent Buttons (Branch ì¢…ì†)
        let agentData = branchData;
        if (pipelineSelectedBranch !== 'ALL') agentData = agentData.filter(r => normalizeBranch(r["ê´€ë¦¬ì§€ì‚¬"]) === pipelineSelectedBranch);
        const agentSet = new Set(agentData.map(r => (r["ë‹´ë‹¹ì"] || "").trim()).filter(Boolean));

        html = `<button class="filter-btn ${pipelineSelectedAgent === 'ALL' ? 'active' : ''}" onclick="setPipelineAgent('ALL', this)">ì „ì²´</button>`;
        Array.from(agentSet).sort().forEach(ag => {
            const safeAg = ag.replace(/'/g, "\\'");
            html += `<button class="filter-btn ${pipelineSelectedAgent === ag ? 'active' : ''}" onclick="setPipelineAgent('${safeAg}', this)">${ag}</button>`;
        });
        document.getElementById("pipelineAgentButtons").innerHTML = html;
    }

    // Pipeline ì‹œê°í™” & KPI
    function updatePipelineKPIs() {
        const count = filteredPipelineData.length;
        const amount = filteredPipelineData.reduce((acc, r) => acc + toThousandWon(r["KTTì›”ì •ë£Œ(ì¡°ì •)"]), 0);
        const highRisk = filteredPipelineData.filter(r => parseFloat(r["í•´ì§€ìœ„í—˜ë„"]) >= 75).length;
        
        const success = filteredPipelineData.filter(r => r["ë°©ì–´ì§„í–‰ë‹¨ê³„"] === "ë°©ì–´ì„±ê³µ").length;
        const totalTry = filteredPipelineData.filter(r => ["ë°©ì–´ì„±ê³µ","ë°©ì–´ì‹¤íŒ¨","ì§„í–‰ì¤‘"].includes(r["ë°©ì–´ì§„í–‰ë‹¨ê³„"])).length;
        const rate = totalTry > 0 ? (success / totalTry * 100) : 0;

        document.getElementById("kpi-pipeline-count").innerText = formatNumber(count);
        document.getElementById("kpi-pipeline-amount").innerText = formatNumber(amount);
        document.getElementById("kpi-high-risk-count").innerText = formatNumber(highRisk);
        document.getElementById("kpi-defense-success-rate").innerText = rate.toFixed(1) + "%";
    }

    function drawPipelineBranchStageChart() {
        // [ìš”ì²­ ë°˜ì˜] ê¸ˆì•¡ ëª¨ë“œ ì‹œ ì‹œê°í™” ë°˜ì˜
        const agg = {};
        const stages = ["ì§„í–‰ì¤‘", "ë°©ì–´ì‹¤íŒ¨", "ë°©ì–´ì„±ê³µ"];
        
        filteredPipelineData.forEach(row => {
            const br = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (!br) return;
            if (!agg[br]) agg[br] = { "ì§„í–‰ì¤‘":0, "ë°©ì–´ì‹¤íŒ¨":0, "ë°©ì–´ì„±ê³µ":0, total:0 };
            
            const st = (row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] || "").trim();
            if (stages.includes(st)) {
                // ê¸ˆì•¡ ëª¨ë“œì¼ ê²½ìš° ì›”ì •ë£Œ í•©ì‚°, ì•„ë‹ˆë©´ 1
                const val = pipelineMode === 'amount' ? toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]) : 1;
                agg[br][st] += val;
                agg[br].total += val;
            }
        });

        const sorted = Object.entries(agg).sort((a,b) => b[1].total - a[1].total).slice(0, 10);
        const labels = sorted.map(e => e[0]);
        
        destroyChart("pipelineBranchStageChart");
        chartInstances.pipelineBranchStageChart = new Chart(document.getElementById("pipelineBranchStageChart"), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'ë°©ì–´ì„±ê³µ', data: sorted.map(e=>e[1]['ë°©ì–´ì„±ê³µ']), backgroundColor: '#10b981', stack: 's' },
                    { label: 'ì§„í–‰ì¤‘', data: sorted.map(e=>e[1]['ì§„í–‰ì¤‘']), backgroundColor: '#f59e0b', stack: 's' },
                    { label: 'ë°©ì–´ì‹¤íŒ¨', data: sorted.map(e=>e[1]['ë°©ì–´ì‹¤íŒ¨']), backgroundColor: '#ef4444', stack: 's' }
                ]
            },
            options: {
                responsive: true,
                animation: { duration: 800 },
                plugins: { legend: { position:'bottom' } },
                scales: { 
                    x: { stacked: true }, 
                    y: { 
                        stacked: true, 
                        title: { display: true, text: pipelineMode === 'amount' ? 'ê¸ˆì•¡(ì²œì›)' : 'ê±´ìˆ˜' } 
                    } 
                }
            }
        });
    }

    function drawPipelineRiskBubbleChart() {
        // [ìš”ì²­ ë°˜ì˜] ê¸ˆì•¡ ëª¨ë“œ ì‹œ Bubble í¬ê¸° ë° Yì¶• ë°˜ì˜ ë¡œì§ ìˆ˜ì •
        const agg = {};
        filteredPipelineData.forEach(row => {
            const br = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (!agg[br]) agg[br] = { count:0, riskSum:0, amtSum:0 };
            
            agg[br].count++;
            agg[br].riskSum += (parseFloat(row["í•´ì§€ìœ„í—˜ë„"])||0);
            agg[br].amtSum += toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
        });

        const data = Object.entries(agg).map(([br, val]) => {
            const avgRisk = val.riskSum / val.count;
            const avgAmt = val.amtSum / val.count;
            // Bubble Size: ê¸ˆì•¡ ëª¨ë“œë©´ ì´ê¸ˆì•¡, ê±´ìˆ˜ ëª¨ë“œë©´ ì´ê±´ìˆ˜ ë¹„ë¡€
            const sizeMetric = pipelineMode === 'amount' ? val.amtSum : val.count;
            const r = Math.sqrt(sizeMetric) * (pipelineMode === 'amount' ? 0.05 : 1.5);
            return { x: avgRisk, y: avgAmt, r: Math.max(3, Math.min(r, 40)), label: br };
        });

        destroyChart("pipelineRiskBubbleChart");
        chartInstances.pipelineRiskBubbleChart = new Chart(document.getElementById("pipelineRiskBubbleChart"), {
            type: 'bubble',
            data: {
                datasets: [{
                    label: 'ì§€ì‚¬ ë¶„í¬',
                    data: data,
                    backgroundColor: 'rgba(59, 130, 246, 0.6)',
                    borderColor: '#2563eb'
                }]
            },
            options: {
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (ctx) => `${ctx.raw.label}: ìœ„í—˜ ${ctx.raw.x.toFixed(1)}%, ì›”ì •ë£Œ ${Math.round(ctx.raw.y)}ì²œì›` } }
                },
                scales: {
                    x: { title: { display:true, text:'í‰ê·  í•´ì§€ìœ„í—˜ë„(%)' }, min: 0, max: 100 },
                    y: { title: { display:true, text:'í‰ê·  ì›”ì •ë£Œ(ì²œì›)' }, beginAtZero: true }
                }
            }
        });
    }

    function drawPipelineDefenseSuccessRateChart() {
        const agg = {};
        filteredPipelineData.forEach(row => {
            const br = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (!br) return;
            if (!agg[br]) agg[br] = { try:0, ok:0 };
            
            const st = row["ë°©ì–´ì§„í–‰ë‹¨ê³„"];
            if (["ë°©ì–´ì„±ê³µ","ë°©ì–´ì‹¤íŒ¨","ì§„í–‰ì¤‘"].includes(st)) {
                agg[br].try++;
                if (st === "ë°©ì–´ì„±ê³µ") agg[br].ok++;
            }
        });

        const sorted = Object.entries(agg)
            .filter(e => e[1].try >= 5) // ìœ ì˜ë¯¸í•œ ë°ì´í„°ë§Œ
            .map(e => ({ br: e[0], rate: (e[1].ok / e[1].try * 100) }))
            .sort((a,b) => b.rate - a.rate)
            .slice(0, 5);

        destroyChart("pipelineDefenseSuccessRateChart");
        chartInstances.pipelineDefenseSuccessRateChart = new Chart(document.getElementById("pipelineDefenseSuccessRateChart"), {
            type: 'line',
            data: {
                labels: sorted.map(d => d.br),
                datasets: [{
                    label: 'ì„±ê³µë¥ (%)',
                    data: sorted.map(d => d.rate),
                    borderColor: '#059669',
                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                scales: { y: { beginAtZero:true, max:100 } },
                plugins: { legend: { display:false } }
            }
        });
    }

    function drawPipelineAgentFailChart() {
        const agg = {};
        filteredPipelineData.filter(r => r["ë°©ì–´ì§„í–‰ë‹¨ê³„"]==="ë°©ì–´ì‹¤íŒ¨").forEach(row => {
            const ag = (row["ë‹´ë‹¹ì"]||"ë¯¸ì§€ì •").trim();
            agg[ag] = (agg[ag] || 0) + 1;
        });
        
        const sorted = Object.entries(agg).sort((a,b) => b[1] - a[1]).slice(0, 10);
        
        destroyChart("pipelineAgentFailChart");
        chartInstances.pipelineAgentFailChart = new Chart(document.getElementById("pipelineAgentFailChart"), {
            type: 'bar',
            indexAxis: 'y',
            data: {
                labels: sorted.map(e=>e[0]),
                datasets: [{
                    label: 'ì‹¤íŒ¨ ê±´ìˆ˜',
                    data: sorted.map(e=>e[1]),
                    backgroundColor: '#ef4444'
                }]
            },
            options: { plugins: { legend: { display:false } } }
        });
    }

    function renderPipelineList() {
        const tbody = document.querySelector("#pipelineListTable tbody");
        tbody.innerHTML = "";
        
        const sorted = [...filteredPipelineData].sort((a, b) => {
            let va = a[pipelineListSortField], vb = b[pipelineListSortField];
            if (pipelineListSortField === "KTTì›”ì •ë£Œ(ì¡°ì •)" || pipelineListSortField === "í•´ì§€ìœ„í—˜ë„") {
                va = parseFloat(String(va).replace(/,/g, "")) || 0;
                vb = parseFloat(String(vb).replace(/,/g, "")) || 0;
            }
            return (va < vb ? -1 : 1) * (pipelineListSortDirection === 'asc' ? 1 : -1);
        });

        sorted.slice(0, 100).forEach(row => {
            tbody.innerHTML += `
                <tr>
                    <td>${cleanContractNumber(row["ê³„ì•½ë²ˆí˜¸"])}</td>
                    <td>${normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"])}</td>
                    <td>${Number(row["í•´ì§€ìœ„í—˜ë„"]).toFixed(1)}</td>
                    <td>${row["ë‹´ë‹¹ì˜ì—…ì±„ë„"]}</td>
                    <td>${formatNumber(toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]))}</td>
                    <td>${row["ë°©ì–´ì§„í–‰ë‹¨ê³„"]}</td>
                    <td>${row["ë‹´ë‹¹ì"]}</td>
                </tr>
            `;
        });
        
        // í—¤ë” ì´ë²¤íŠ¸ ë°”ì¸ë”©
        document.querySelectorAll("#pipelineListTable th").forEach(th => {
            th.onclick = () => {
                const f = th.getAttribute("data-field");
                if (pipelineListSortField === f) pipelineListSortDirection = pipelineListSortDirection==='asc'?'desc':'asc';
                else { pipelineListSortField = f; pipelineListSortDirection = 'desc'; }
                renderPipelineList();
            };
        });
    }

    function updatePipelineDashboard() {
        filterPipelineData();
        updatePipelineKPIs();
        drawPipelineBranchStageChart();
        drawPipelineRiskBubbleChart();
        drawPipelineDefenseSuccessRateChart();
        drawPipelineAgentFailChart();
        renderPipelineList();
    }

    /* ==========================================================================
       5. [VOC] ë¡œì§
       ========================================================================== */
    function setVocStatus(st, btn) {
        vocSelectedStatus = st;
        document.querySelectorAll('#vocStatusButtons .filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateVocDashboard();
    }

    function filterVocData() {
        const typeFilter = document.getElementById("vocTypeFilter").value;
        filteredVocData = vocData.filter(row => {
            const t = (row["VOCìœ í˜•ëŒ€"] || "").trim();
            const s = (row["ìƒíƒœ"] || "").trim();
            if (typeFilter !== "ALL" && t !== typeFilter) return false;
            if (vocSelectedStatus !== "ALL" && s !== vocSelectedStatus) return false;
            return true;
        });
    }

    function updateVocDashboard() {
        filterVocData();
        
        // KPI
        const total = filteredVocData.length;
        const done = filteredVocData.filter(r => r["ìƒíƒœ"]==="ì²˜ë¦¬ì™„ë£Œ").length;
        const none = filteredVocData.filter(r => r["ìƒíƒœ"]==="ë¯¸ì ‘ìˆ˜").length;
        const rate = total > 0 ? (done/total*100) : 0;
        
        document.getElementById("kpi-voc-total").innerText = formatNumber(total);
        document.getElementById("kpi-voc-complete").innerText = formatNumber(done);
        document.getElementById("kpi-voc-unassigned").innerText = formatNumber(none);
        document.getElementById("kpi-voc-complete-rate").innerText = rate.toFixed(1) + "%";

        // Charts
        drawVocBranchChart();
        drawVocAgentChart();
        renderVocList();
    }

    function drawVocBranchChart() {
        const agg = {};
        const stats = ["ì²˜ë¦¬ì™„ë£Œ", "ì ‘ìˆ˜", "ë¯¸ì ‘ìˆ˜"];
        
        filteredVocData.forEach(row => {
            const br = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (!br) return;
            if (!agg[br]) agg[br] = { "ì²˜ë¦¬ì™„ë£Œ":0, "ì ‘ìˆ˜":0, "ë¯¸ì ‘ìˆ˜":0 };
            const s = (row["ìƒíƒœ"]||"").trim();
            if (stats.includes(s)) agg[br][s]++;
        });

        // ì§€ì‚¬ ì •ë ¬ (ê³ ì • ìˆœì„œ)
        const labels = Object.keys(agg).sort(sortBranches);
        
        destroyChart("vocBranchChart");
        chartInstances.vocBranchChart = new Chart(document.getElementById("vocBranchChart"), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'ì²˜ë¦¬ì™„ë£Œ', data: labels.map(l=>agg[l]['ì²˜ë¦¬ì™„ë£Œ']), backgroundColor: '#3b82f6', stack:'v' },
                    { label: 'ì ‘ìˆ˜', data: labels.map(l=>agg[l]['ì ‘ìˆ˜']), backgroundColor: '#f59e0b', stack:'v' },
                    { label: 'ë¯¸ì ‘ìˆ˜', data: labels.map(l=>agg[l]['ë¯¸ì ‘ìˆ˜']), backgroundColor: '#ef4444', stack:'v' }
                ]
            },
            options: {
                scales: { x:{stacked:true}, y:{stacked:true} },
                plugins: { legend: { position:'bottom' } }
            }
        });
    }

    function drawVocAgentChart() {
        const agg = {};
        filteredVocData.forEach(row => {
            const ag = (row["ë‹´ë‹¹ì"]||"").trim();
            if (!ag) return;
            if (!agg[ag]) agg[ag] = { done:0, total:0 };
            agg[ag].total++;
            if (row["ìƒíƒœ"]==="ì²˜ë¦¬ì™„ë£Œ") agg[ag].done++;
        });

        const sorted = Object.entries(agg).sort((a,b) => b[1].total - a[1].total).slice(0, 20);
        
        destroyChart("vocAgentChart");
        chartInstances.vocAgentChart = new Chart(document.getElementById("vocAgentChart"), {
            type: 'bar',
            indexAxis: 'y',
            data: {
                labels: sorted.map(e=>e[0]),
                datasets: [
                    { label: 'ì²˜ë¦¬ì™„ë£Œ', data: sorted.map(e=>e[1].done), backgroundColor: '#3b82f6', stack:'va' },
                    { label: 'ë¯¸ì™„ë£Œ', data: sorted.map(e=>e[1].total - e[1].done), backgroundColor: '#e5e7eb', stack:'va' }
                ]
            },
            options: {
                scales: { x:{stacked:true}, y:{stacked:true} },
                plugins: { legend: { position:'bottom' } }
            }
        });
    }

    function renderVocList() {
        const tbody = document.querySelector("#vocListTable tbody");
        tbody.innerHTML = "";
        const sorted = [...filteredVocData].sort((a,b) => {
            const va = a[vocListSortField]||"", vb = b[vocListSortField]||"";
            return va.localeCompare(vb) * (vocListSortDirection==='asc'?1:-1);
        });

        sorted.slice(0, 100).forEach(row => {
            tbody.innerHTML += `
                <tr>
                    <td>${row["ìƒíƒœ"]}</td>
                    <td>${row["VOCìœ í˜•ëŒ€"]}</td>
                    <td>${row["VOCìœ í˜•ì¤‘"]}</td>
                    <td>${row["ê´€ë¦¬ë³¸ë¶€"]}</td>
                    <td>${normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"])}</td>
                    <td>${row["ë‹´ë‹¹ì"]}</td>
                </tr>
            `;
        });

        document.querySelectorAll("#vocListTable th").forEach(th => {
            th.onclick = () => {
                const f = th.getAttribute("data-field");
                if (vocListSortField === f) vocListSortDirection = vocListSortDirection==='asc'?'desc':'asc';
                else { vocListSortField = f; vocListSortDirection = 'desc'; }
                renderVocList();
            };
        });
    }

    /* ==========================================================================
       6. ì´ˆê¸°í™”
       ========================================================================== */
    async function initDashboard() {
        // 1. ë°ì´í„° ë¡œë“œ (VOCëŠ” 1í–‰ ìŠ¤í‚µ)
        vocData = await loadCsv(VOC_CSV_URL, 1);
        pipelineData = await loadCsv(PIPELINE_CSV_URL, 0);

        // 2. Pipeline ë²„íŠ¼ ìƒì„± (ë””í´íŠ¸ê°’ ë°˜ì˜)
        // ê°•ë¶/ê°•ì›ì´ ì‹¤ì œ ë°ì´í„°ì— ì—†ìœ¼ë©´ 'ALL'ë¡œ fallback
        const hqCheck = pipelineData.some(r => (r["ê´€ë¦¬ë³¸ë¶€"]||"").trim() === pipelineSelectedHQ);
        if (!hqCheck) pipelineSelectedHQ = 'ALL';
        
        renderPipelineButtons();

        // 3. VOC í•„í„° ìƒì„± (ë””í´íŠ¸: ë¦¬í…ì…˜)
        const vocTypeSet = new Set(vocData.map(r => (r["VOCìœ í˜•ëŒ€"]||"").trim()).filter(Boolean));
        const vSelect = document.getElementById("vocTypeFilter");
        Array.from(vocTypeSet).sort().forEach(t => {
            const opt = document.createElement("option");
            opt.value = t; opt.text = t;
            if (t === vocSelectedType) opt.selected = true;
            vSelect.appendChild(opt);
        });
        vSelect.onchange = () => updateVocDashboard();

        // 4. ì´ë²¤íŠ¸ ë°”ì¸ë”©
        document.getElementById("channelFilter").onchange = () => { updatePipelineDashboard(); };
        document.querySelectorAll('input[name="risk"]').forEach(r => r.onchange = () => updatePipelineDashboard());

        // 5. ì´ˆê¸° ë Œë”ë§
        updatePipelineDashboard();
        updateVocDashboard(); // ìˆ¨ê²¨ì ¸ ìˆì–´ë„ ë¯¸ë¦¬ ë Œë”ë§

        // 6. ë·° ë””í´íŠ¸ ì„¤ì • (Pipeline)
        switchView('pipeline');
    }

    window.addEventListener("load", initDashboard);
</script>

</body>
</html>
