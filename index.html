<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>KTT í†µí•© ëŒ€ì‹œë³´ë“œ (ê³ ê¸‰í™” ê°œì„ )</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì • */
        body {
            margin: 0;
            display: flex;
            background: #f5f5f7;
            font-family: "Apple SD Gothic Neo", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        .sidebar {
            width: 280px;
            background: #ffffff;
            padding: 20px;
            border-right: 1px solid #e5e7eb;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.03);
        }

        .content {
            flex: 1;
            padding: 20px 24px;
            overflow-y: auto;
        }

        h1 {
            font-size: 22px;
            margin: 0 0 4px;
            font-weight: 700;
            color: #111827;
        }

        .subtitle {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 16px;
        }

        /* ì„¹ì…˜ ì¹´ë“œ */
        .section-card {
            background: #ffffff;
            border-radius: 18px;
            padding: 18px 20px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .section-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        .section-header .badge {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 999px;
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }

        /* KPI ì¹´ë“œ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 10px;
        }

        .kpi-card {
            padding: 10px 12px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f9fafb, #eef2ff);
            border: 1px solid #e5e7eb;
        }

        .kpi-title {
            font-size: 11px;
            color: #6b7280;
        }

        .kpi-value {
            margin-top: 4px;
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        .kpi-sub {
            margin-top: 2px;
            font-size: 11px;
            color: #9ca3af;
        }

        /* í•„í„° êµ¬ì—­ */
        .sidebar h2 {
            font-size: 20px;
            margin: 0 0 8px;
            font-weight: 700;
            color: #111827;
        }

        .filter-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #4b5563;
            margin-top: 16px;
            margin-bottom: 4px;
        }

        .view-toggle {
            display: flex;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .view-toggle button {
            flex: 1;
            padding: 8px 0;
            font-size: 13px;
            border: none;
            background: #f9fafb;
            color: #6b7280;
            cursor: pointer;
        }

        .view-toggle button.active {
            background: #111827;
            color: #f9fafb;
            font-weight: 600;
        }

        .filter-group {
            margin-top: 10px;
            margin-bottom: 4px;
        }

        .filter-group-title {
            font-size: 12px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 4px;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .filter-btn {
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 11px;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .filter-btn.active {
            background: #111827;
            color: #ffffff;
            border-color: #111827;
        }

        .filter-btn.small {
            font-size: 10px;
            padding: 3px 6px;
        }

        .filter-select {
            width: 100%;
            padding: 9px 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
            background-color: #ffffff;
            color: #111827;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .radio-group label {
            display: inline-flex;
            align-items: center;
            font-size: 12px;
            color: #4b5563;
            cursor: pointer;
        }

        .radio-group input {
            margin-right: 6px;
        }

        /* ì°¨íŠ¸ ì˜ì—­ ë ˆì´ì•„ì›ƒ */
        .chart-grid {
            display: grid;
            grid-template-columns: 1.8fr 1.5fr;
            gap: 20px;
        }

        .chart-card {
            background: #ffffff;
            border-radius: 18px;
            padding: 16px 18px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
        }

        .chart-header h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 700;
            color: #111827;
        }

        .chart-header p {
            margin: 0;
            font-size: 11px;
            color: #9ca3af;
        }

        .chart-wrapper {
            height: 260px;
        }

        /* ë¦¬ìŠ¤íŠ¸ ë° í‘œ ì˜ì—­ */
        .list-card {
            margin-top: 20px;
            background: #ffffff;
            border-radius: 18px;
            padding: 14px 16px 10px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.07);
        }

        .list-container {
            max-height: 360px;
            overflow-y: auto;
            margin-top: 5px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        table.data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        table.data-table th,
        table.data-table td {
            text-align: left;
            padding: 6px 8px;
            border-bottom: 1px solid #f3f4f6;
        }

        table.data-table th {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 1;
            cursor: pointer;
            font-weight: 600;
            color: #4b5563;
            border-bottom: 1px solid #e5e7eb;
        }

        table.data-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        table.data-table tbody tr:hover {
            background: #e5f3ff;
        }

        /* ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 600;
        }

        .status-complete {
            background: #ecfdf3;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status-pending {
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }

        .status-none {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .risk-high {
            color: #b91c1c;
            font-weight: 700;
        }

        .risk-mid {
            color: #d97706;
            font-weight: 600;
        }

        .risk-low {
            color: #047857;
            font-weight: 600;
        }

        .ellipsis {
            max-width: 140px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 900px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }

            .content {
                padding: 12px;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h2>ğŸ“Š í•„í„° & ë³´ê¸° ì „í™˜</h2>
        <p class="subtitle">CSV ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ VOC / í•´ì§€ íŒŒì´í”„ë¼ì¸ì„ ë¶„ì„í•©ë‹ˆë‹¤.</p>

        <div class="view-toggle">
            <button id="btnViewPipeline" class="active" onclick="switchView('pipeline')">í•´ì§€ íŒŒì´í”„ë¼ì¸</button>
            <button id="btnViewVoc" onclick="switchView('voc')">VOC</button>
        </div>

        <div class="filter-group">
            <div class="filter-group-title">ë‹´ë‹¹ì˜ì—…ì±„ë„</div>
            <select id="channelFilter" class="filter-select">
                <option value="ALL">ì „ì²´</option>
                <option value="SP">SP</option>
                <option value="SC">SC</option>
                <option value="AM">AM</option>
            </select>
        </div>

        <div class="filter-group">
            <div class="filter-group-title">í•´ì§€ìœ„í—˜ë„ (%)</div>
            <div class="radio-group" id="riskRadioGroup">
                <label><input type="radio" name="risk" value="ALL" checked> ì „ì²´</label>
                <label><input type="radio" name="risk" value="0"> 0 ~ 25%</label>
                <label><input type="radio" name="risk" value="25"> 25 ~ 50%</label>
                <label><input type="radio" name="risk" value="50"> 50 ~ 75%</label>
                <label><input type="radio" name="risk" value="75"> 75 ~ 100%</label>
            </div>
        </div>

        <label class="filter-section-title">í‘œì‹œ ê¸°ì¤€ (í•´ì§€íŒŒì´í”„ë¼ì¸)</label>
        <div class="filter-buttons">
            <button class="mode-btn filter-btn active" data-mode="count" onclick="setMode('count', this)">ê±´ìˆ˜</button>
            <button class="mode-btn filter-btn" data-mode="amount" onclick="setMode('amount', this)">ê¸ˆì•¡(ì²œì›)</button>
        </div>

        <div class="filter-group">
            <div class="filter-group-title">ê´€ë¦¬ë³¸ë¶€</div>
            <div id="pipelineHqButtons" class="filter-buttons"></div>
        </div>

        <div class="filter-group">
            <div class="filter-group-title">ê´€ë¦¬ì§€ì‚¬</div>
            <div id="pipelineBranchButtons" class="filter-buttons"></div>
        </div>

        <div class="filter-group">
            <div class="filter-group-title">ë‹´ë‹¹ì</div>
            <div id="pipelineAgentButtons" class="filter-buttons"></div>
        </div>

        <hr style="margin: 12px 0; border: none; border-top: 1px solid #e5e7eb;">

        <div class="filter-group">
            <div class="filter-group-title">VOC ê´€ë¦¬ì§€ì‚¬</div>
            <div id="vocBranchButtons" class="filter-buttons"></div>
        </div>

        <div class="filter-group">
            <div class="filter-group-title">VOC ë‹´ë‹¹ì</div>
            <div id="vocAgentButtons" class="filter-buttons"></div>
        </div>
    </div>

    <div class="content">
        <div class="section-card">
            <div class="section-header">
                <h2 id="mainTitle">í•´ì§€ íŒŒì´í”„ë¼ì¸ í˜„í™©</h2>
                <span class="badge" id="subTitleBadge">Pipeline View</span>
            </div>

            <div id="pipelineKpiRow" class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-title">ì´ í•´ì§€ íŒŒì´í”„ë¼ì¸ ê±´ìˆ˜</div>
                    <div class="kpi-value" id="kpi-pipeline-count">-</div>
                    <div class="kpi-sub">(ì„ íƒëœ í•„í„° ê¸°ì¤€)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">ì›”ì •ë£Œ (ì²œì›) í•©ê³„</div>
                    <div class="kpi-value" id="kpi-pipeline-amount">-</div>
                    <div class="kpi-sub">KTTì›”ì •ë£Œ(ì¡°ì •) ì²œì› ë‹¨ìœ„ í•©ê³„</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">ë°©ì–´ ì„±ê³µë¥ </div>
                    <div class="kpi-value" id="kpi-defense-success-rate">-</div>
                    <div class="kpi-sub">ì§„í–‰ì¤‘/ì„±ê³µ/ì‹¤íŒ¨ ê¸°ì¤€</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">ê³ ìœ„í—˜(75% ì´ìƒ) ê±´ìˆ˜</div>
                    <div class="kpi-value" id="kpi-high-risk-count">-</div>
                    <div class="kpi-sub">í•´ì§€ìœ„í—˜ë„ê°€ 75% ì´ìƒ</div>
                </div>
            </div>

            <div id="vocKpiRow" class="kpi-grid" style="display:none;">
                <div class="kpi-card">
                    <div class="kpi-title">ì´ VOC ê±´ìˆ˜</div>
                    <div class="kpi-value" id="kpi-voc-total">-</div>
                    <div class="kpi-sub">(ì„ íƒëœ í•„í„° ê¸°ì¤€)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">ì²˜ë¦¬ì™„ë£Œ ë¹„ìœ¨</div>
                    <div class="kpi-value" id="kpi-voc-complete-rate">-</div>
                    <div class="kpi-sub">ì²˜ë¦¬ì™„ë£Œ / ì „ì²´</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">ë¯¸ì ‘ìˆ˜ ê±´ìˆ˜</div>
                    <div class="kpi-value" id="kpi-voc-not-received">-</div>
                    <div class="kpi-sub">ìƒíƒœê°€ "ë¯¸ì ‘ìˆ˜"</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Top ê´€ë¦¬ì§€ì‚¬ (VOC)</div>
                    <div class="kpi-value" id="kpi-voc-top-branch">-</div>
                    <div class="kpi-sub">ê±´ìˆ˜ ê¸°ì¤€</div>
                </div>
            </div>
        </div>

        <div id="pipelineView">
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>ê´€ë¦¬ë³¸ë¶€ / ê´€ë¦¬ì§€ì‚¬ë³„ í•´ì§€ í˜„í™©</h3>
                        <p>ê±´ìˆ˜ ë˜ëŠ” ê¸ˆì•¡(ì²œì›) ê¸°ì¤€</p>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="pipelineBranchChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3>ë°©ì–´ì§„í–‰ë‹¨ê³„ ë¶„í¬</h3>
                        <p>ê´€ë¦¬ì§€ì‚¬ë³„ ì§„í–‰ì¤‘/ì„±ê³µ/ì‹¤íŒ¨</p>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="pipelineStageChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-card" style="margin-top: 20px;">
                <div class="chart-header">
                    <h3>ìœ„í—˜ë„ vs ì›”ì •ë£Œ ë²„ë¸” ì°¨íŠ¸</h3>
                    <p>ê´€ë¦¬ì§€ì‚¬ë³„ í‰ê·  ìœ„í—˜ë„ / í‰ê·  ì›”ì •ë£Œ / ê±´ìˆ˜(í¬ê¸°)</p>
                </div>
                <div class="chart-wrapper" style="height: 280px;">
                    <canvas id="pipelineRiskBubbleChart"></canvas>
                </div>
            </div>

            <div class="list-card">
                <div class="card-header">
                    <h3>ğŸ“ í•„í„°ë§ëœ í•´ì§€íŒŒì´í”„ë¼ì¸ ìƒì„¸ ë¦¬ìŠ¤íŠ¸</h3>
                    <p style="font-size: 12px; color: #9ca3af; margin: 5px 0 0;">(í…Œì´ë¸” í—¤ë” í´ë¦­ ì‹œ ì •ë ¬)</p>
                </div>
                <div class="list-container">
                    <table id="pipelineListTable" class="data-table">
                        <thead>
                            <tr>
                                <th data-field="ê³„ì•½ë²ˆí˜¸" data-sort="asc">ê³„ì•½ë²ˆí˜¸</th>
                                <th data-field="ê´€ë¦¬ì§€ì‚¬">ê´€ë¦¬ì§€ì‚¬</th>
                                <th data-field="í•´ì§€ìœ„í—˜ë„" data-sort="none">ìœ„í—˜ë„ (%)</th>
                                <th data-field="ë‹´ë‹¹ì˜ì—…ì±„ë„">ì˜ì—…ì±„ë„</th>
                                <th data-field="KTTì›”ì •ë£Œ(ì¡°ì •)" data-sort="none">ì›”ì •ë£Œ (ì²œì›)</th>
                                <th data-field="ë°©ì–´ì§„í–‰ë‹¨ê³„">ë°©ì–´ì§„í–‰ë‹¨ê³„</th>
                                <th data-field="ë°©ì–´ë‹´ë‹¹ì">ë°©ì–´ë‹´ë‹¹ì</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="vocView" style="display:none;">
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>VOC ê´€ë¦¬ì§€ì‚¬ë³„ ìƒíƒœ (ì ì¸µ ë§‰ëŒ€)</h3>
                        <p>ì²˜ë¦¬ì™„ë£Œ / ì ‘ìˆ˜ / ë¯¸ì ‘ìˆ˜</p>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="vocBranchChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3>VOC ë‹´ë‹¹ìë³„ ìƒíƒœ (ìƒìœ„ 20ëª…)</h3>
                        <p>ì²˜ë¦¬ì™„ë£Œ / ì ‘ìˆ˜ / ë¯¸ì ‘ìˆ˜</p>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="vocAgentChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="list-card">
                <div class="card-header">
                    <h3>ğŸ“ í•„í„°ë§ëœ VOC ìƒì„¸ ë¦¬ìŠ¤íŠ¸</h3>
                    <p style="font-size: 12px; color: #9ca3af; margin: 5px 0 0;">(í…Œì´ë¸” í—¤ë” í´ë¦­ ì‹œ ì •ë ¬)</p>
                </div>
                <div class="list-container">
                    <table id="vocListTable" class="data-table">
                        <thead>
                            <tr>
                                <th data-field="ìƒíƒœ" data-sort="asc">ìƒíƒœ</th>
                                <th data-field="ê´€ë¦¬ì§€ì‚¬" data-sort="none">ê´€ë¦¬ì§€ì‚¬</th>
                                <th data-field="ë‹´ë‹¹ì" data-sort="none">ë‹´ë‹¹ì</th>
                                <th data-field="VOCìœ í˜•ëŒ€ë¶„ë¥˜" data-sort="none">VOCìœ í˜•(ëŒ€)</th>
                                <th data-field="VOCìœ í˜•ì¤‘ë¶„ë¥˜" data-sort="none">VOCìœ í˜•(ì¤‘)</th>
                                <th data-field="VOCìœ í˜•ì†Œë¶„ë¥˜" data-sort="none">VOCìœ í˜•(ì†Œ)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    /* ---------------------------------------------------------
        ğŸ“Œ CSV ë°ì´í„° ê²½ë¡œ (GitHub Raw ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ì •ë¨)
    --------------------------------------------------------- */
    const VOC_CSV_URL = "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv";
    const PIPELINE_CSV_URL = "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv";

    // Chart.js í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
    Chart.register(ChartDataLabels);

    /* ---------------------------------------------------------
        ğŸ“Œ ì „ì—­ ìƒíƒœê°’ ë° ì§€ì‚¬ ì •ë ¬ ê¸°ì¤€
    --------------------------------------------------------- */
    const VOC_BRANCH_ORDER = ["ì¤‘ì•™ì§€ì‚¬", "ê°•ë¶ì§€ì‚¬", "ì„œëŒ€ë¬¸ì§€ì‚¬", "ê³ ì–‘ì§€ì‚¬", "ì˜ì •ë¶€ì§€ì‚¬", "ë‚¨ì–‘ì£¼ì§€ì‚¬", "ê°•ë¦‰ì§€ì‚¬", "ì›ì£¼ì§€ì‚¬"];
    const VOC_BRANCH_ORDER_SHORT = ["ì¤‘ì•™", "ê°•ë¶", "ì„œëŒ€ë¬¸", "ê³ ì–‘", "ì˜ì •ë¶€", "ë‚¨ì–‘ì£¼", "ê°•ë¦‰", "ì›ì£¼"];

    const PIPELINE_BRANCH_ORDER = ["ì¤‘ì•™ì§€ì‚¬", "ê°•ë¶ì§€ì‚¬", "ì„œëŒ€ë¬¸ì§€ì‚¬", "ê³ ì–‘ì§€ì‚¬", "ì˜ì •ë¶€ì§€ì‚¬", "ë‚¨ì–‘ì£¼ì§€ì‚¬", "ê°•ë¦‰ì§€ì‚¬", "ì›ì£¼ì§€ì‚¬", "ê¸°íƒ€"];
    const PIPELINE_BRANCH_ORDER_SHORT = ["ì¤‘ì•™", "ê°•ë¶", "ì„œëŒ€ë¬¸", "ê³ ì–‘", "ì˜ì •ë¶€", "ë‚¨ì–‘ì£¼", "ê°•ë¦‰", "ì›ì£¼", "ê¸°íƒ€"];

    // PIPELINE ìƒíƒœ
    let pipelineMode = "count"; 
    let pipelineData = []; 
    let filteredPipelineData = []; 
    let pipelineSelectedHQ = "ALL"; 
    let pipelineSelectedBranch = "ALL"; 
    let pipelineSelectedAgent = "ALL"; 

    // VOC ìƒíƒœ
    let vocData = [];
    let filteredVocData = [];
    let vocSelectedBranch = "ALL";
    let vocSelectedAgent = "ALL";

    // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
    let pipelineBranchChartInstance = null;
    let pipelineStageChartInstance = null;
    let pipelineRiskBubbleChartInstance = null;
    let vocBranchChartInstance = null;
    let vocAgentChartInstance = null;

    // ì •ë ¬ ìƒíƒœ
    let pipelineListSortField = "ê³„ì•½ë²ˆí˜¸";
    let pipelineListSortAsc = true;
    let vocListSortField = "ìƒíƒœ";
    let vocListSortAsc = true;

    /* ---------------------------------------------------------
        ğŸ“Œ ìœ í‹¸ í•¨ìˆ˜ë“¤
    --------------------------------------------------------- */
    function normalizeBranch(name) {
        if (!name) return "";
        return String(name).replace("ì§€ì‚¬", "").trim();
    }

    function cleanContractNumber(raw) {
        if (!raw) return "";
        return String(raw).replace(/\D/g, "").slice(0, 8);
    }

    function toThousandWon(raw) {
        if (!raw) return 0;
        const num = parseFloat(String(raw).replace(/,/g, ""));
        return isNaN(num) ? 0 : Math.round(num / 1000);
    }

    function parseRisk(value) {
        if (value === null || value === undefined || value === "") return NaN;
        const v = parseFloat(String(value).replace("%", "").trim());
        return isNaN(v) ? NaN : v;
    }

    function checkRisk(value, selected) {
        if (selected === "ALL") return true;
        const v = parseRisk(value);
        if (isNaN(v)) return false;

        const s = parseInt(selected);
        if (s === 0) return v >= 0 && v < 25;
        if (s === 25) return v >= 25 && v < 50;
        if (s === 50) return v >= 50 && v < 75;
        if (s === 75) return v >= 75 && v <= 100;
        return true;
    }

    async function loadCsv(url) {
        const res = await fetch(url);
        const text = await res.text();
        return new Promise((resolve) => {
            Papa.parse(text, {
                header: true,
                skipEmptyLines: true,
                complete: (r) => resolve(r.data),
            });
        });
    }

    function sortByCustomBranchOrder(labels, dataMap, orderArray, useShortName = false) {
        return labels.sort((a, b) => {
            const longA = useShortName ? a + "ì§€ì‚¬" : a;
            const longB = useShortName ? b + "ì§€ì‚¬" : b;
            const idxA = orderArray.indexOf(longA);
            const idxB = orderArray.indexOf(longB);
            return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
        });
    }

    function destroyChart(id) {
        if (id === "pipelineBranchChart" && pipelineBranchChartInstance) {
            pipelineBranchChartInstance.destroy();
            pipelineBranchChartInstance = null;
        }
        if (id === "pipelineStageChart" && pipelineStageChartInstance) {
            pipelineStageChartInstance.destroy();
            pipelineStageChartInstance = null;
        }
        if (id === "pipelineRiskBubbleChart" && pipelineRiskBubbleChartInstance) {
            pipelineRiskBubbleChartInstance.destroy();
            pipelineRiskBubbleChartInstance = null;
        }
        if (id === "vocBranchChart" && vocBranchChartInstance) {
            vocBranchChartInstance.destroy();
            vocBranchChartInstance = null;
        }
        if (id === "vocAgentChart" && vocAgentChartInstance) {
            vocAgentChartInstance.destroy();
            vocAgentChartInstance = null;
        }
    }

    function safeText(str) {
        if (!str && str !== 0) return "-";
        return String(str);
    }

    function safeNumberStr(num, decimals = 0) {
        if (num === null || num === undefined || isNaN(num)) return "-";
        return num.toLocaleString("ko-KR", {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
        });
    }

    /* ---------------------------------------------------------
        ğŸ“Œ ë·° ì „í™˜ (Pipeline / VOC)
    --------------------------------------------------------- */
    function switchView(view) {
        const pipelineViewEl = document.getElementById("pipelineView");
        const vocViewEl = document.getElementById("vocView");
        const mainTitleEl = document.getElementById("mainTitle");
        const badgeEl = document.getElementById("subTitleBadge");
        const pipelineKpiRowEl = document.getElementById("pipelineKpiRow");
        const vocKpiRowEl = document.getElementById("vocKpiRow");
        const btnPipeline = document.getElementById("btnViewPipeline");
        const btnVoc = document.getElementById("btnViewVoc");

        if (view === "pipeline") {
            pipelineViewEl.style.display = "block";
            vocViewEl.style.display = "none";
            pipelineKpiRowEl.style.display = "grid";
            vocKpiRowEl.style.display = "none";
            mainTitleEl.textContent = "í•´ì§€ íŒŒì´í”„ë¼ì¸ í˜„í™©";
            badgeEl.textContent = "Pipeline View";
            btnPipeline.classList.add("active");
            btnVoc.classList.remove("active");
            updatePipelineDashboard();
        } else {
            pipelineViewEl.style.display = "none";
            vocViewEl.style.display = "block";
            pipelineKpiRowEl.style.display = "none";
            vocKpiRowEl.style.display = "grid";
            mainTitleEl.textContent = "VOC í˜„í™©";
            badgeEl.textContent = "VOC View";
            btnPipeline.classList.remove("active");
            btnVoc.classList.add("active");
            updateVocDashboard();
        }
    }

    function setMode(m, button) {
        pipelineMode = m;
        const modeButtons = document.querySelectorAll(".mode-btn");
        modeButtons.forEach(btn => btn.classList.remove("active"));
        if (button) {
            button.classList.add("active");
        } else {
            modeButtons.forEach(btn => {
                if (btn.dataset.mode === m) btn.classList.add("active");
            });
        }
        updatePipelineDashboard();
    }

    /* ---------------------------------------------------------
        ğŸ“Œ í•„í„°ê°’ ê°€ì ¸ì˜¤ê¸°
    --------------------------------------------------------- */
    function getSelectedChannel() {
        const el = document.getElementById("channelFilter");
        return el ? el.value : "ALL";
    }

    function getSelectedRisk() {
        const checked = document.querySelector('input[name="risk"]:checked');
        return checked ? checked.value : "ALL";
    }

    /* ---------------------------------------------------------
        ğŸ“Œ ê´€ë¦¬ë³¸ë¶€ / ê´€ë¦¬ì§€ì‚¬ / ë‹´ë‹¹ì ë²„íŠ¼ ë Œë”ë§ (PIPELINE)
    --------------------------------------------------------- */
    function renderPipelineHqButtons() {
        const container = document.getElementById("pipelineHqButtons");
        if (!container) return;

        const hqSet = new Set();
        pipelineData.forEach(row => {
            const hq = (row["ê´€ë¦¬ë³¸ë¶€"] || "").trim();
            if (hq) hqSet.add(hq);
        });

        const list = Array.from(hqSet).sort();
        let html = `<button class="filter-btn small ${pipelineSelectedHQ === "ALL" ? "active" : ""}" onclick="setPipelineHQ('ALL', this)">ì „ì²´</button>`;
        list.forEach(hq => {
            html += `<button class="filter-btn small ${pipelineSelectedHQ === hq ? "active" : ""}" onclick="setPipelineHQ('${hq}', this)">${hq}</button>`;
        });
        container.innerHTML = html;
    }

    function renderPipelineBranchButtons() {
        const container = document.getElementById("pipelineBranchButtons");
        if (!container) return;

        let filtered = pipelineData;
        if (pipelineSelectedHQ !== "ALL") {
            filtered = filtered.filter(row => (row["ê´€ë¦¬ë³¸ë¶€"] || "").trim() === pipelineSelectedHQ);
        }

        const branchSet = new Set();
        filtered.forEach(row => {
            const b = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (b) branchSet.add(b);
        });

        let branches = Array.from(branchSet);
        branches = sortByCustomBranchOrder(branches, null, PIPELINE_BRANCH_ORDER, true);

        let html = `<button class="filter-btn small ${pipelineSelectedBranch === "ALL" ? "active" : ""}" onclick="setPipelineBranch('ALL', this)">ì „ì²´</button>`;
        branches.forEach(branch => {
            html += `<button class="filter-btn small ${pipelineSelectedBranch === branch ? "active" : ""}" onclick="setPipelineBranch('${branch}', this)">${branch}</button>`;
        });
        container.innerHTML = html;
    }

    function renderPipelineAgentButtons() {
        const container = document.getElementById("pipelineAgentButtons");
        if (!container) return;

        let filtered = filteredPipelineData;
        if (!filtered || filtered.length === 0) filtered = pipelineData;

        const agentSet = new Set();
        filtered.forEach(row => {
            const agent = (row["ë°©ì–´ë‹´ë‹¹ì"] || "").trim();
            if (agent) agentSet.add(agent);
        });

        const agents = Array.from(agentSet).sort();
        let html = `<button class="filter-btn small ${pipelineSelectedAgent === "ALL" ? "active" : ""}" onclick="setPipelineAgent('ALL', this)">ì „ì²´</button>`;
        agents.forEach(agent => {
            const safeAgent = agent.replace(/'/g, "\\'");
            html += `<button class="filter-btn small ${pipelineSelectedAgent === agent ? "active" : ""}" onclick="setPipelineAgent('${safeAgent}', this)">${agent}</button>`;
        });
        container.innerHTML = html;
    }

    function setPipelineHQ(hq, button) {
        pipelineSelectedHQ = hq;
        const btns = document.querySelectorAll("#pipelineHqButtons .filter-btn");
        btns.forEach(b => b.classList.remove("active"));
        if (button) button.classList.add("active");

        pipelineSelectedBranch = "ALL";
        pipelineSelectedAgent = "ALL";
        renderPipelineBranchButtons();
        updatePipelineDashboard();
    }

    function setPipelineBranch(branch, button) {
        pipelineSelectedBranch = branch;
        document.querySelectorAll("#pipelineBranchButtons .filter-btn").forEach(btn => btn.classList.remove("active"));
        if (button) button.classList.add("active");
        pipelineSelectedAgent = "ALL";
        renderPipelineAgentButtons();
        updatePipelineDashboard();
    }

    function setPipelineAgent(agent, button) {
        pipelineSelectedAgent = agent;
        document.querySelectorAll("#pipelineAgentButtons .filter-btn").forEach(btn => btn.classList.remove("active"));
        if (button) button.classList.add("active");
        updatePipelineDashboard();
    }

    /* ---------------------------------------------------------
        ğŸ“Œ VOC ê´€ë¦¬ì§€ì‚¬ / ë‹´ë‹¹ì ë²„íŠ¼ ë Œë”ë§
    --------------------------------------------------------- */
    function renderVocBranchButtons() {
        const container = document.getElementById("vocBranchButtons");
        if (!container) return;

        const branchSet = new Set();
        vocData.forEach(row => {
            const b = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (b) branchSet.add(b);
        });

        let branches = Array.from(branchSet);
        branches = sortByCustomBranchOrder(branches, null, VOC_BRANCH_ORDER, true);

        let html = `<button class="filter-btn small ${vocSelectedBranch === "ALL" ? "active" : ""}" onclick="setVocBranch('ALL', this)">ì „ì²´</button>`;
        branches.forEach(branch => {
            html += `<button class="filter-btn small ${vocSelectedBranch === branch ? "active" : ""}" onclick="setVocBranch('${branch}', this)">${branch}</button>`;
        });
        container.innerHTML = html;
    }

    function renderVocAgentButtons() {
        const container = document.getElementById("vocAgentButtons");
        if (!container) return;

        let filtered = filteredVocData;
        if (!filtered || filtered.length === 0) filtered = vocData;

        const agentSet = new Set();
        filtered.forEach(row => {
            const agent = (row["ë‹´ë‹¹ì"] || "").trim();
            if (agent) agentSet.add(agent);
        });

        const agents = Array.from(agentSet).sort();
        let html = `<button class="filter-btn small ${vocSelectedAgent === "ALL" ? "active" : ""}" onclick="setVocAgent('ALL', this)">ì „ì²´</button>`;
        agents.forEach(agent => {
            const safeAgent = agent.replace(/'/g, "\\'");
            html += `<button class="filter-btn small ${vocSelectedAgent === agent ? "active" : ""}" onclick="setVocAgent('${safeAgent}', this)">${agent}</button>`;
        });
        container.innerHTML = html;
    }

    function setVocBranch(branch, button) {
        vocSelectedBranch = branch;
        document.querySelectorAll("#vocBranchButtons .filter-btn").forEach(btn => btn.classList.remove("active"));
        if (button) button.classList.add("active");
        vocSelectedAgent = "ALL";
        renderVocAgentButtons();
        updateVocDashboard();
    }

    function setVocAgent(agent, button) {
        vocSelectedAgent = agent;
        document.querySelectorAll("#vocAgentButtons .filter-btn").forEach(btn => btn.classList.remove("active"));
        if (button) button.classList.add("active");
        updateVocDashboard();
    }

    /* ---------------------------------------------------------
        ğŸ“Œ Pipeline í•„í„°ë§ ë° KPI ê³„ì‚°
    --------------------------------------------------------- */
    function filterPipelineData() {
        const channel = getSelectedChannel();
        const risk = getSelectedRisk();

        filteredPipelineData = pipelineData.filter((row) => {
            if (channel !== "ALL" && (row["ë‹´ë‹¹ì˜ì—…ì±„ë„"] || "").trim() !== channel) return false;
            if (!checkRisk(row["í•´ì§€ìœ„í—˜ë„"], risk)) return false;

            const hq = (row["ê´€ë¦¬ë³¸ë¶€"] || "").trim();
            const branchLong = (row["ê´€ë¦¬ì§€ì‚¬"] || "").trim();
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            const agent = (row["ë°©ì–´ë‹´ë‹¹ì"] || "").trim();

            if (pipelineSelectedHQ !== "ALL" && hq !== pipelineSelectedHQ) return false;
            if (pipelineSelectedBranch !== "ALL" && branch !== pipelineSelectedBranch) return false;
            if (pipelineSelectedAgent !== "ALL" && agent !== pipelineSelectedAgent) return false;

            return true;
        });
    }

    function updatePipelineKpi() {
        if (!filteredPipelineData || filteredPipelineData.length === 0) {
            document.getElementById("kpi-pipeline-count").innerText = "0ê±´";
            document.getElementById("kpi-pipeline-amount").innerText = "0ì²œì›";
            document.getElementById("kpi-defense-success-rate").innerText = "0%";
            document.getElementById("kpi-high-risk-count").innerText = "0";
            return;
        }

        const totalCount = filteredPipelineData.length;
        const totalAmount = filteredPipelineData.reduce((sum, row) => sum + toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]), 0);

        const defenseSuccess = filteredPipelineData.filter(row => row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] === "ë°©ì–´ì„±ê³µ").length;
        const totalDefenseAttempt = filteredPipelineData.filter(row =>
            ["ë°©ì–´ì„±ê³µ", "ë°©ì–´ì‹¤íŒ¨", "ì§„í–‰ì¤‘"].includes(row["ë°©ì–´ì§„í–‰ë‹¨ê³„"])
        ).length;
        const defenseSuccessRate = totalDefenseAttempt > 0 ? (defenseSuccess / totalDefenseAttempt) * 100 : 0;

        const highRiskCount = filteredPipelineData.filter(row => {
            const r = parseRisk(row["í•´ì§€ìœ„í—˜ë„"]);
            return !isNaN(r) && r >= 75;
        }).length;

        document.getElementById("kpi-pipeline-count").innerText = totalCount.toLocaleString("ko-KR") + "ê±´";
        document.getElementById("kpi-pipeline-amount").innerText = totalAmount.toLocaleString("ko-KR") + "ì²œì›";
        document.getElementById("kpi-defense-success-rate").innerText = defenseSuccessRate.toFixed(1) + "%";
        document.getElementById("kpi-high-risk-count").innerText = highRiskCount.toLocaleString("ko-KR");
    }

    /* ---------------------------------------------------------
        ğŸ“Œ Pipeline ì°¨íŠ¸ë“¤ (Branch, Stage, Bubble)
    --------------------------------------------------------- */
    function drawPipelineBranchChart() {
        const agg = {};

        filteredPipelineData.forEach(row => {
            const hq = (row["ê´€ë¦¬ë³¸ë¶€"] || "").trim();
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (!hq || !branch) return;

            const key = `${hq} / ${branch}`;
            if (!agg[key]) {
                agg[key] = { count: 0, amount: 0 };
            }
            if (cleanContractNumber(row["ê³„ì•½ë²ˆí˜¸"])) {
                agg[key].count++;
            }
            agg[key].amount += toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
        });

        const entries = Object.entries(agg);
        entries.sort((a, b) => {
            const av = pipelineMode === "count" ? a[1].count : a[1].amount;
            const bv = pipelineMode === "count" ? b[1].count : b[1].amount;
            return bv - av;
        });

        const labels = entries.map(e => e[0]);
        const dataArr = pipelineMode === "count"
            ? entries.map(e => e[1].count)
            : entries.map(e => e[1].amount);

        destroyChart("pipelineBranchChart");

        const ctx = document.getElementById("pipelineBranchChart").getContext("2d");
        pipelineBranchChartInstance = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    {
                        label: pipelineMode === "count" ? "ê±´ìˆ˜" : "ê¸ˆì•¡(ì²œì›)",
                        data: dataArr,
                        backgroundColor: "#3b82f6aa",
                        borderRadius: 6,
                        maxBarThickness: 32,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => pipelineMode === "count"
                                ? `${ctx.parsed.y} ê±´`
                                : `${ctx.parsed.y.toLocaleString("ko-KR")} ì²œì›`,
                        },
                    },
                    datalabels: {
                        anchor: "end",
                        align: "end",
                        color: "#374151",
                        font: { size: 10, weight: "600" },
                        formatter: (val) => (val > 0 ? val.toLocaleString("ko-KR") : ""),
                    },
                },
                scales: {
                    x: {
                        ticks: {
                            font: { size: 10 },
                            autoSkip: false,
                            maxRotation: 60,
                            minRotation: 20,
                        },
                    },
                    y: {
                        beginAtZero: true,
                    },
                },
            },
        });
    }

    function drawPipelineStageChart() {
        const agg = {};
        const stages = ["ì§„í–‰ì¤‘", "ë°©ì–´ì‹¤íŒ¨", "ë°©ì–´ì„±ê³µ"];

        filteredPipelineData.forEach(row => {
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (!branch) return;
            const stage = (row["ë°©ì–´ì§„í–‰ë‹¨ê³„"] || "").trim();
            if (!agg[branch]) {
                agg[branch] = { "ì§„í–‰ì¤‘": 0, "ë°©ì–´ì‹¤íŒ¨": 0, "ë°©ì–´ì„±ê³µ": 0 };
            }
            if (stages.includes(stage)) {
                agg[branch][stage]++;
            }
        });

        let labels = Object.keys(agg);
        labels = sortByCustomBranchOrder(labels, null, PIPELINE_BRANCH_ORDER, true);

        const ì§„í–‰ì¤‘ = labels.map(b => agg[b]["ì§„í–‰ì¤‘"]);
        const ë°©ì–´ì‹¤íŒ¨ = labels.map(b => agg[b]["ë°©ì–´ì‹¤íŒ¨"]);
        const ë°©ì–´ì„±ê³µ = labels.map(b => agg[b]["ë°©ì–´ì„±ê³µ"]);

        destroyChart("pipelineStageChart");

        const ctx = document.getElementById("pipelineStageChart").getContext("2d");
        pipelineStageChartInstance = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "ì§„í–‰ì¤‘", data: ì§„í–‰ì¤‘, stack: "stage", backgroundColor: "#38bdf8aa" },
                    { label: "ë°©ì–´ì‹¤íŒ¨", data: ë°©ì–´ì‹¤íŒ¨, stack: "stage", backgroundColor: "#f97373cc" },
                    { label: "ë°©ì–´ì„±ê³µ", data: ë°©ì–´ì„±ê³µ, stack: "stage", backgroundColor: "#4ade80cc" },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y} ê±´`,
                        },
                    },
                    datalabels: {
                        anchor: "center",
                        align: "center",
                        color: "#111827",
                        font: { size: 9, weight: "600" },
                        formatter: (val) => (val > 0 ? val : ""),
                    },
                },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true },
                },
            },
        });
    }

    function drawPipelineRiskBubbleChart() {
        const agg = {};

        filteredPipelineData.forEach(row => {
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (!branch) return;

            const risk = parseRisk(row["í•´ì§€ìœ„í—˜ë„"]);
            const amount = toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
            if (!agg[branch]) {
                agg[branch] = { totalRisk: 0, totalAmount: 0, count: 0 };
            }
            if (!isNaN(risk)) {
                agg[branch].totalRisk += risk;
            }
            agg[branch].totalAmount += amount;
            agg[branch].count++;
        });

        let labels = Object.keys(agg);
        labels = sortByCustomBranchOrder(labels, null, PIPELINE_BRANCH_ORDER, true);

        const datasets = labels.map((branch, i) => {
            const val = agg[branch];
            const avgRisk = val.count > 0 ? val.totalRisk / val.count : 0;
            const avgAmount = val.count > 0 ? val.totalAmount / val.count : 0;
            const sizeBase = pipelineMode === "amount" ? val.totalAmount : val.count;
            const bubbleSize = Math.sqrt(sizeBase) * (pipelineMode === "amount" ? 0.05 : 2);

            return {
                label: branch,
                data: [{
                    x: avgRisk.toFixed(1),
                    y: avgAmount.toFixed(0),
                    r: bubbleSize < 5 ? 5 : (bubbleSize > 40 ? 40 : bubbleSize),
                }],
                backgroundColor: `#${Math.floor(Math.random() * 16777215).toString(16)}66`,
                borderColor: "#333",
            };
        });

        destroyChart("pipelineRiskBubbleChart");

        const ctx = document.getElementById("pipelineRiskBubbleChart").getContext("2d");
        pipelineRiskBubbleChartInstance = new Chart(ctx, {
            type: "bubble",
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const label = ctx.dataset.label || "";
                                const x = ctx.parsed.x;
                                const y = ctx.parsed.y;
                                return `${label}: ìœ„í—˜ë„ ${x}%, í‰ê·  ì›”ì •ë£Œ ${Number(y).toLocaleString("ko-KR")}ì²œì›`;
                            },
                        },
                    },
                },
                scales: {
                    x: {
                        title: { display: true, text: "í‰ê·  í•´ì§€ìœ„í—˜ë„ (%)" },
                        min: 0,
                        max: 100,
                    },
                    y: {
                        title: { display: true, text: "í‰ê·  ì›”ì •ë£Œ (ì²œì›)" },
                        beginAtZero: true,
                    },
                },
            },
        });
    }

    /* ---------------------------------------------------------
        ğŸ“Œ Pipeline ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ë° ì •ë ¬
    --------------------------------------------------------- */
    function renderPipelineList() {
        const tableBody = document.querySelector("#pipelineListTable tbody");
        tableBody.innerHTML = "";
        let sortedData = [...filteredPipelineData];

        const sortField = pipelineListSortField;

        if (pipelineListSortField === "í•´ì§€ìœ„í—˜ë„") {
            sortedData.sort((a, b) => {
                const av = parseRisk(a["í•´ì§€ìœ„í—˜ë„"]);
                const bv = parseRisk(b["í•´ì§€ìœ„í—˜ë„"]);
                if (isNaN(av) && isNaN(bv)) return 0;
                if (isNaN(av)) return 1;
                if (isNaN(bv)) return -1;
                return pipelineListSortAsc ? av - bv : bv - av;
            });
        } else if (pipelineListSortField === "KTTì›”ì •ë£Œ(ì¡°ì •)") {
            sortedData.sort((a, b) => {
                const av = toThousandWon(a["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
                const bv = toThousandWon(b["KTTì›”ì •ë£Œ(ì¡°ì •)"]);
                return pipelineListSortAsc ? av - bv : bv - av;
            });
        } else if (pipelineListSortField === "ê³„ì•½ë²ˆí˜¸") {
            sortedData.sort((a, b) => {
                const av = cleanContractNumber(a["ê³„ì•½ë²ˆí˜¸"]) || "";
                const bv = cleanContractNumber(b["ê³„ì•½ë²ˆí˜¸"]) || "";
                return pipelineListSortAsc ? av.localeCompare(bv) : bv.localeCompare(av);
            });
        } else {
            sortedData.sort((a, b) => {
                const av = (a[sortField] || "").toString();
                const bv = (b[sortField] || "").toString();
                return pipelineListSortAsc ? av.localeCompare(bv, "ko-KR") : bv.localeCompare(av, "ko-KR");
            });
        }

        sortedData.forEach(row => {
            const riskValue = parseRisk(row["í•´ì§€ìœ„í—˜ë„"]);
            let riskClass = "";
            if (!isNaN(riskValue)) {
                if (riskValue >= 75) riskClass = "risk-high";
                else if (riskValue >= 50) riskClass = "risk-mid";
                else riskClass = "risk-low";
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${cleanContractNumber(row["ê³„ì•½ë²ˆí˜¸"]) || "-"}</td>
                <td>${normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]) || "-"}</td>
                <td class="${riskClass}">${isNaN(riskValue) ? "-" : riskValue.toFixed(1)}</td>
                <td>${safeText(row["ë‹´ë‹¹ì˜ì—…ì±„ë„"])}</td>
                <td>${toThousandWon(row["KTTì›”ì •ë£Œ(ì¡°ì •)"]).toLocaleString("ko-KR")}</td>
                <td>${safeText(row["ë°©ì–´ì§„í–‰ë‹¨ê³„"])}</td>
                <td>${safeText(row["ë°©ì–´ë‹´ë‹¹ì"])}</td>
            `;
            tableBody.appendChild(tr);
        });
    }

    function attachPipelineSortEvents() {
        const headers = document.querySelectorAll("#pipelineListTable thead th");
        headers.forEach(th => {
            th.addEventListener("click", () => {
                const field = th.getAttribute("data-field");
                if (!field) return;

                if (pipelineListSortField === field) {
                    pipelineListSortAsc = !pipelineListSortAsc;
                } else {
                    pipelineListSortField = field;
                    pipelineListSortAsc = true;
                }

                headers.forEach(h => h.removeAttribute("data-sort"));
                th.setAttribute("data-sort", pipelineListSortAsc ? "asc" : "desc");

                renderPipelineList();
            });
        });
    }

    /* ---------------------------------------------------------
        ğŸ“Œ Pipeline ì „ì²´ ì—…ë°ì´íŠ¸
    --------------------------------------------------------- */
    function updatePipelineDashboard() {
        filterPipelineData();
        updatePipelineKpi();
        drawPipelineBranchChart();
        drawPipelineStageChart();
        drawPipelineRiskBubbleChart();
        renderPipelineList();
        renderPipelineAgentButtons();
    }

    /* ---------------------------------------------------------
        ğŸ“Œ VOC í•„í„°ë§ ë° KPI/ì°¨íŠ¸/ë¦¬ìŠ¤íŠ¸
    --------------------------------------------------------- */
    function filterVocData() {
        filteredVocData = vocData.filter(row => {
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            const agent = (row["ë‹´ë‹¹ì"] || "").trim();

            if (vocSelectedBranch !== "ALL" && branch !== vocSelectedBranch) return false;
            if (vocSelectedAgent !== "ALL" && agent !== vocSelectedAgent) return false;

            return true;
        });
    }

    function updateVocKpi() {
        if (!filteredVocData || filteredVocData.length === 0) {
            document.getElementById("kpi-voc-total").innerText = "0ê±´";
            document.getElementById("kpi-voc-complete-rate").innerText = "0%";
            document.getElementById("kpi-voc-not-received").innerText = "0";
            document.getElementById("kpi-voc-top-branch").innerText = "-";
            return;
        }

        const totalVoc = filteredVocData.length;
        const completedVoc = filteredVocData.filter(row => (row["ìƒíƒœ"] || "").trim() === "ì²˜ë¦¬ì™„ë£Œ").length;
        const notReceivedVoc = filteredVocData.filter(row => (row["ìƒíƒœ"] || "").trim() === "ë¯¸ì ‘ìˆ˜").length;
        const vocCompleteRate = totalVoc > 0 ? (completedVoc / totalVoc) * 100 : 0;

        const branchAgg = {};
        filteredVocData.forEach(row => {
            const branch = normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]);
            if (!branch) return;
            if (!branchAgg[branch]) branchAgg[branch] = 0;
            branchAgg[branch]++;
        });
        let topBranch = "-";
        let topCount = 0;
        Object.entries(branchAgg).forEach(([b, cnt]) => {
            if (cnt > topCount) {
                topCount = cnt;
                topBranch = b;
            }
        });

        document.getElementById("kpi-voc-total").innerText = totalVoc.toLocaleString("ko-KR") + "ê±´";
        document.getElementById("kpi-voc-complete-rate").innerText = vocCompleteRate.toFixed(1) + "%";
        document.getElementById("kpi-voc-not-received").innerText = notReceivedVoc.toLocaleString("ko-KR");
        document.getElementById("kpi-voc-top-branch").innerText = topBranch;
    }

    function aggregateVocBy(field, limit = 20) {
        const agg = {};
        const statuses = ["ì²˜ë¦¬ì™„ë£Œ", "ì ‘ìˆ˜", "ë¯¸ì ‘ìˆ˜"];

        filteredVocData.forEach(row => {
            let key = field === "ê´€ë¦¬ì§€ì‚¬"
                ? normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"])
                : (row[field] || "").trim();

            if (!key) return;

            const st = (row["ìƒíƒœ"] || "").trim();
            if (!agg[key]) {
                agg[key] = { "ì²˜ë¦¬ì™„ë£Œ": 0, "ì ‘ìˆ˜": 0, "ë¯¸ì ‘ìˆ˜": 0 };
            }
            if (statuses.includes(st)) {
                agg[key][st]++;
            }
        });

        const entries = Object.entries(agg);
        entries.sort((a, b) =>
            (b[1]["ì²˜ë¦¬ì™„ë£Œ"] + b[1]["ì ‘ìˆ˜"] + b[1]["ë¯¸ì ‘ìˆ˜"]) -
            (a[1]["ì²˜ë¦¬ì™„ë£Œ"] + a[1]["ì ‘ìˆ˜"] + a[1]["ë¯¸ì ‘ìˆ˜"])
        );

        const sliced = entries.slice(0, limit);
        const labels = sliced.map(e => e[0]);
        const ì²˜ë¦¬ì™„ë£Œ = sliced.map(e => e[1]["ì²˜ë¦¬ì™„ë£Œ"]);
        const ì ‘ìˆ˜ = sliced.map(e => e[1]["ì ‘ìˆ˜"]);
        const ë¯¸ì ‘ìˆ˜ = sliced.map(e => e[1]["ë¯¸ì ‘ìˆ˜"]);

        return { labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜ };
    }

    function drawVocBranchChart() {
        const { labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜ } = aggregateVocBy("ê´€ë¦¬ì§€ì‚¬", 30);

        destroyChart("vocBranchChart");

        const ctx = document.getElementById("vocBranchChart").getContext("2d");
        vocBranchChartInstance = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "ì²˜ë¦¬ì™„ë£Œ", data: ì²˜ë¦¬ì™„ë£Œ, stack: "voc", backgroundColor: "#4ade80cc" },
                    { label: "ì ‘ìˆ˜", data: ì ‘ìˆ˜, stack: "voc", backgroundColor: "#60a5facc" },
                    { label: "ë¯¸ì ‘ìˆ˜", data: ë¯¸ì ‘ìˆ˜, stack: "voc", backgroundColor: "#facc15cc" },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y} ê±´`,
                        },
                    },
                    datalabels: {
                        anchor: "end",
                        align: "end",
                        color: "#111827",
                        font: { size: 9, weight: "600" },
                        formatter: (val) => (val > 0 ? val : ""),
                    },
                },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true },
                },
            },
        });
    }

    function drawVocAgentChart() {
        const { labels, ì²˜ë¦¬ì™„ë£Œ, ì ‘ìˆ˜, ë¯¸ì ‘ìˆ˜ } = aggregateVocBy("ë‹´ë‹¹ì", 20);

        destroyChart("vocAgentChart");

        const ctx = document.getElementById("vocAgentChart").getContext("2d");
        vocAgentChartInstance = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "ì²˜ë¦¬ì™„ë£Œ", data: ì²˜ë¦¬ì™„ë£Œ, stack: "voc-agent", backgroundColor: "#4ade80cc" },
                    { label: "ì ‘ìˆ˜", data: ì ‘ìˆ˜, stack: "voc-agent", backgroundColor: "#60a5facc" },
                    { label: "ë¯¸ì ‘ìˆ˜", data: ë¯¸ì ‘ìˆ˜, stack: "voc-agent", backgroundColor: "#facc15cc" },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y} ê±´`,
                        },
                    },
                    datalabels: {
                        anchor: "end",
                        align: "end",
                        color: "#111827",
                        font: { size: 9, weight: "600" },
                        formatter: (val) => (val > 0 ? val : ""),
                    },
                },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true },
                },
            },
        });
    }

    function renderVocList() {
        const tableBody = document.querySelector("#vocListTable tbody");
        tableBody.innerHTML = "";
        let sortedData = [...filteredVocData];

        const sortField = vocListSortField;

        sortedData.sort((a, b) => {
            const av = (a[sortField] || "").toString();
            const bv = (b[sortField] || "").toString();
            return vocListSortAsc ? av.localeCompare(bv, "ko-KR") : bv.localeCompare(av, "ko-KR");
        });

        sortedData.forEach(row => {
            const status = (row["ìƒíƒœ"] || "").trim();
            let statusClass = "status-none";
            if (status === "ì²˜ë¦¬ì™„ë£Œ") statusClass = "status-complete";
            else if (status === "ì ‘ìˆ˜") statusClass = "status-pending";

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="status-badge ${statusClass}">${status || "-"}</span></td>
                <td>${normalizeBranch(row["ê´€ë¦¬ì§€ì‚¬"]) || "-"}</td>
                <td>${safeText(row["ë‹´ë‹¹ì"])}</td>
                <td class="ellipsis" title="${safeText(row["VOCìœ í˜•ëŒ€ë¶„ë¥˜"])}">${safeText(row["VOCìœ í˜•ëŒ€ë¶„ë¥˜"])}</td>
                <td class="ellipsis" title="${safeText(row["VOCìœ í˜•ì¤‘ë¶„ë¥˜"])}">${safeText(row["VOCìœ í˜•ì¤‘ë¶„ë¥˜"])}</td>
                <td class="ellipsis" title="${safeText(row["VOCìœ í˜•ì†Œë¶„ë¥˜"])}">${safeText(row["VOCìœ í˜•ì†Œë¶„ë¥˜"])}</td>
            `;
            tableBody.appendChild(tr);
        });
    }

    function attachVocSortEvents() {
        const headers = document.querySelectorAll("#vocListTable thead th");
        headers.forEach(th => {
            th.addEventListener("click", () => {
                const field = th.getAttribute("data-field");
                if (!field) return;

                if (vocListSortField === field) {
                    vocListSortAsc = !vocListSortAsc;
                } else {
                    vocListSortField = field;
                    vocListSortAsc = true;
                }

                headers.forEach(h => h.removeAttribute("data-sort"));
                th.setAttribute("data-sort", vocListSortAsc ? "asc" : "desc");

                renderVocList();
            });
        });
    }

    function updateVocDashboard() {
        filterVocData();
        updateVocKpi();
        drawVocBranchChart();
        drawVocAgentChart();
        renderVocList();
        renderVocAgentButtons();
    }

    /* ---------------------------------------------------------
        ğŸ“Œ ì´ˆê¸°í™”
    --------------------------------------------------------- */
    async function initDashboard() {
        vocData = await loadCsv(VOC_CSV_URL);
        pipelineData = await loadCsv(PIPELINE_CSV_URL);

        renderPipelineHqButtons();
        renderPipelineBranchButtons();
        renderPipelineAgentButtons();
        renderVocBranchButtons();
        renderVocAgentButtons();

        document.getElementById("channelFilter")
            .addEventListener("change", updatePipelineDashboard);

        document.querySelectorAll('input[name="risk"]')
            .forEach(r => r.addEventListener("change", updatePipelineDashboard));

        attachPipelineSortEvents();
        attachVocSortEvents();

        updatePipelineDashboard();
        updateVocDashboard();
        switchView("pipeline");
    }

    window.addEventListener("load", initDashboard);
</script>

</body>
</html>
