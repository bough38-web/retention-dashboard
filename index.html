<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>KTT Premium Retention Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbmyeJMsApj38SRzWvaQGrZmpqUQTooMw" defer></script>
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<style>
    :root {
        --primary: #2563eb; --primary-light: #eff6ff; --primary-dark: #1e40af;
        --secondary: #64748b; --bg: #f1f5f9; --surface: #ffffff;
        --border: #e2e8f0; --text: #0f172a; --text-light: #64748b;
        --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --radius: 12px;
    }

    /* 레이아웃 & 기본 설정 */
    body { margin:0; font-family:'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; overflow:hidden; }
    * { box-sizing:border-box; outline:none; }
    
    /* 스크롤바 커스텀 */
    ::-webkit-scrollbar { width:6px; height:6px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover { background:#94a3b8; }

    /* 사이드바 */
    .sidebar { width:300px; background:var(--surface); border-right:1px solid var(--border); display:flex; flex-direction:column; z-index:20; box-shadow:var(--shadow-md); }
    .logo-area { padding:24px; border-bottom:1px solid var(--border); }
    .logo-area h1 { margin:0; font-size:18px; font-weight:800; color:var(--primary); display:flex; align-items:center; gap:8px; }
    
    .sidebar-scroll { flex:1; overflow-y:auto; padding:20px; }
    
    /* 파일 업로드 박스 */
    .upload-box { background:var(--bg); border:1px dashed #cbd5e1; border-radius:var(--radius); padding:16px; text-align:center; margin-bottom:24px; transition:0.2s; }
    .upload-box:hover { border-color:var(--primary); background:#eff6ff; }
    .upload-box label { cursor:pointer; font-size:13px; font-weight:600; color:var(--secondary); display:block; }
    .upload-box input { display:none; }

    /* 탭 메뉴 */
    .nav-tabs { display:flex; background:var(--bg); padding:4px; border-radius:10px; margin-bottom:24px; }
    .nav-tab { flex:1; padding:10px; border:none; background:none; font-size:13px; font-weight:600; color:var(--text-light); cursor:pointer; border-radius:8px; transition:0.2s; }
    .nav-tab.active { background:var(--surface); color:var(--primary); box-shadow:var(--shadow-sm); }

    /* 필터 섹션 (버튼식) */
    .filter-section { margin-bottom:24px; }
    .filter-label { font-size:12px; font-weight:700; color:var(--text); margin-bottom:8px; display:flex; justify-content:space-between; }
    .chip-container { display:flex; flex-wrap:wrap; gap:6px; max-height:150px; overflow-y:auto; align-content:flex-start; }
    .chip { 
        padding:6px 12px; border:1px solid var(--border); background:var(--surface); 
        border-radius:20px; font-size:12px; color:var(--text-light); cursor:pointer; transition:0.15s; 
    }
    .chip:hover { background:var(--bg); }
    .chip.active { background:var(--primary-light); color:var(--primary); border-color:var(--primary); font-weight:600; }
    .chip.small { padding:4px 10px; font-size:11px; }

    /* 메인 콘텐츠 */
    .main-content { flex:1; padding:30px; overflow-y:auto; position:relative; }
    
    /* 대시보드 뷰 전환 */
    .view-panel { display:none; animation:fadeIn 0.3s ease-out; }
    .view-panel.active { display:block; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    /* KPI 카드 */
    .kpi-row { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:20px; margin-bottom:24px; }
    .kpi-card { background:var(--surface); padding:20px; border-radius:var(--radius); box-shadow:var(--shadow-sm); border-left:4px solid transparent; position:relative; }
    .kpi-title { font-size:13px; color:var(--text-light); font-weight:600; text-transform:uppercase; margin-bottom:4px; }
    .kpi-value { font-size:26px; font-weight:800; color:var(--text); letter-spacing:-0.5px; }
    .kpi-icon { position:absolute; right:20px; top:20px; font-size:32px; opacity:0.1; }

    /* 차트 및 지도 컨테이너 */
    .dashboard-grid { display:grid; grid-template-columns:repeat(2, 1fr); gap:24px; margin-bottom:24px; }
    .card { background:var(--surface); border-radius:var(--radius); padding:24px; box-shadow:var(--shadow-sm); height:100%; display:flex; flex-direction:column; }
    .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .card-title { font-size:16px; font-weight:700; color:var(--text); display:flex; align-items:center; gap:8px; }
    .map-container { width:100%; height:450px; border-radius:12px; overflow:hidden; border:1px solid var(--border); }
    .chart-box { flex:1; position:relative; min-height:300px; }

    /* 테이블 */
    .table-container { overflow-x:auto; margin-top:10px; border:1px solid var(--border); border-radius:8px; }
    table { width:100%; border-collapse:collapse; font-size:13px; white-space:nowrap; }
    th { background:#f8fafc; padding:12px 16px; text-align:left; font-weight:600; color:var(--text-light); border-bottom:1px solid var(--border); position:sticky; top:0; }
    td { padding:12px 16px; border-bottom:1px solid var(--border); color:var(--text); }
    tr:hover td { background:#f8fafc; cursor:pointer; }
    tr.selected td { background:var(--primary-light) !important; }

    /* 뱃지 스타일 */
    .badge { padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; }
    .bg-blue { background:#dbeafe; color:#1e40af; }
    .bg-green { background:#dcfce7; color:#166534; }
    .bg-red { background:#fee2e2; color:#991b1b; }
    .bg-yellow { background:#fef3c7; color:#92400e; }

    /* 로딩 오버레이 */
    #loading { position:fixed; inset:0; background:rgba(255,255,255,0.9); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; backdrop-filter:blur(3px); }
    .loader { width:40px; height:40px; border:4px solid var(--primary-light); border-top-color:var(--primary); border-radius:50%; animation:spin 0.8s linear infinite; }
    @keyframes spin { 100% { transform:rotate(360deg); } }
</style>
</head>
<body>

<div id="loading">
    <div class="loader"></div>
    <p style="margin-top:16px; font-weight:600; color:#475569;">데이터 분석 중...</p>
</div>

<div class="sidebar">
    <div class="logo-area">
        <h1><i class="ph ph-chart-polar"></i> KTT Dashboard</h1>
    </div>
    <div class="sidebar-scroll">
        <div class="upload-box">
            <label>
                <i class="ph ph-upload-simple" style="font-size:24px; margin-bottom:8px;"></i><br/>
                CSV 파일 업로드/교체
                <input type="file" id="fileInput" accept=".csv" />
            </label>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchView('voc')">VOC 현황</button>
            <button class="nav-tab" onclick="switchView('pipeline')">파이프라인</button>
        </div>

        <div class="filter-section">
            <div class="filter-label">
                <span>관리지사</span>
                <span style="font-weight:400; cursor:pointer;" onclick="resetFilter('branch')"><i class="ph ph-arrow-counter-clockwise"></i></span>
            </div>
            <div id="filterBranch" class="chip-container"></div>
        </div>

        <div class="filter-section">
            <div class="filter-label">
                <span>담당자</span>
                <span style="font-weight:400; cursor:pointer;" onclick="resetFilter('agent')"><i class="ph ph-arrow-counter-clockwise"></i></span>
            </div>
            <div id="filterAgent" class="chip-container" style="max-height:200px;"></div>
        </div>

        <div id="vocSpecificFilters" class="filter-section">
            <div class="filter-label">처리상태</div>
            <div id="filterStatus" class="chip-container">
                <button class="chip active" onclick="setStatus('ALL')">전체</button>
                <button class="chip" onclick="setStatus('처리완료')">처리완료</button>
                <button class="chip" onclick="setStatus('접수')">접수</button>
                <button class="chip" onclick="setStatus('미접수')">미접수</button>
            </div>
        </div>
        
        <div id="pipeSpecificFilters" class="filter-section" style="display:none;">
            <div class="filter-label">해지 위험도</div>
            <div id="filterRisk" class="chip-container">
                <button class="chip active" onclick="setRisk('ALL')">전체</button>
                <button class="chip" onclick="setRisk('HIGH')">고위험(75%↑)</button>
                <button class="chip" onclick="setRisk('MID')">중위험(50~75%)</button>
            </div>
        </div>
    </div>
</div>

<div class="main-content">

    <div id="viewVoc" class="view-panel active">
        <div class="card-header">
            <h2 style="margin:0;">VOC 활동 현황 <span style="font-size:14px; font-weight:400; color:#64748b; margin-left:10px;">전체 데이터 기준</span></h2>
            <button class="chip active" onclick="exportCSV('voc')"><i class="ph ph-download-simple"></i> 엑셀 다운로드</button>
        </div>

        <div class="kpi-row">
            <div class="kpi-card" style="border-color:var(--primary);">
                <div class="kpi-title">전체 계약 (Unique)</div>
                <div class="kpi-value" id="kpiVocTotal">0</div>
                <i class="ph ph-users kpi-icon"></i>
            </div>
            <div class="kpi-card" style="border-color:var(--success);">
                <div class="kpi-title">처리 완료</div>
                <div class="kpi-value" style="color:var(--success);" id="kpiVocDone">0</div>
                <i class="ph ph-check-circle kpi-icon"></i>
            </div>
            <div class="kpi-card" style="border-color:var(--warning);">
                <div class="kpi-title">처리율</div>
                <div class="kpi-value" id="kpiVocRate">0%</div>
                <i class="ph ph-chart-pie-slice kpi-icon"></i>
            </div>
            <div class="kpi-card" style="border-color:var(--danger);">
                <div class="kpi-title">미접수 건</div>
                <div class="kpi-value" style="color:var(--danger);" id="kpiVocWait">0</div>
                <i class="ph ph-warning-circle kpi-icon"></i>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card" style="grid-column: span 2;">
                <div class="card-header" style="margin-bottom:10px;">
                    <div class="card-title"><i class="ph ph-map-trifold"></i> 고객 위치 분석</div>
                    <span style="font-size:12px; color:#64748b;">* 좌표가 있는 데이터만 지도에 표시됩니다 (필터 연동)</span>
                </div>
                <div id="vocMap" class="map-container"></div>
            </div>
            
            <div class="card">
                <div class="card-title">지사별 처리 현황</div>
                <div class="chart-box"><canvas id="chartVocBranch"></canvas></div>
            </div>
            <div class="card">
                <div class="card-title">담당자별 미처리(미접수/접수) Top 10</div>
                <div class="chart-box"><canvas id="chartVocAgent"></canvas></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">상세 데이터 리스트</div>
            <div class="table-container">
                <table id="tblVoc">
                    <thead><tr><th>지사</th><th>담당자</th><th>계약번호</th><th>상호명</th><th>VOC유형</th><th>상태</th><th>좌표</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
                <button class="chip" onclick="movePage('voc', -1)">이전</button>
                <span id="pgVoc" style="font-size:13px; line-height:30px;"></span>
                <button class="chip" onclick="movePage('voc', 1)">다음</button>
            </div>
        </div>
    </div>

    <div id="viewPipe" class="view-panel">
        <div class="card-header">
            <h2 style="margin:0;">해지 파이프라인 분석 <span style="font-size:14px; font-weight:400; color:#64748b;">해지 징후 및 방어 활동</span></h2>
            <button class="chip active" onclick="exportCSV('pipe')"><i class="ph ph-download-simple"></i> 엑셀 다운로드</button>
        </div>

        <div class="kpi-row">
            <div class="kpi-card" style="border-color:var(--primary);">
                <div class="kpi-title">대상 총 건수</div>
                <div class="kpi-value" id="kpiPipeTotal">0</div>
                <i class="ph ph-funnel kpi-icon"></i>
            </div>
            <div class="kpi-card" style="border-color:var(--danger);">
                <div class="kpi-title">고위험군 (75%↑)</div>
                <div class="kpi-value" style="color:var(--danger);" id="kpiPipeHigh">0</div>
                <i class="ph ph-siren kpi-icon"></i>
            </div>
            <div class="kpi-card" style="border-color:var(--warning);">
                <div class="kpi-title">예상 손실액(월)</div>
                <div class="kpi-value" id="kpiPipeLoss">0</div>
                <i class="ph ph-currency-krw kpi-icon"></i>
            </div>
            <div class="kpi-card" style="border-color:var(--success);">
                <div class="kpi-title">방어 성공률</div>
                <div class="kpi-value" style="color:var(--success);" id="kpiPipeRate">0%</div>
                <i class="ph ph-shield-check kpi-icon"></i>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-title">지사별 방어 단계 현황</div>
                <div class="chart-box"><canvas id="chartPipeBranch"></canvas></div>
            </div>
            <div class="card">
                <div class="card-title">해지 사유 분석 (Top 5)</div>
                <div class="chart-box"><canvas id="chartPipeReason"></canvas></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">상세 파이프라인 리스트</div>
            <div class="table-container">
                <table id="tblPipe">
                    <thead><tr><th>지사</th><th>담당자</th><th>계약번호</th><th>상호명</th><th>위험도</th><th>방어단계</th><th>해지예정일</th><th>월정료</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
                <button class="chip" onclick="movePage('pipe', -1)">이전</button>
                <span id="pgPipe" style="font-size:13px; line-height:30px;"></span>
                <button class="chip" onclick="movePage('pipe', 1)">다음</button>
            </div>
        </div>
    </div>

</div>

<script>
/* =========================================
   1. GLOBAL STATE & CONFIG
   ========================================= */
const DATA_URLS = {
    voc: "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv",
    pipe: "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv"
};

const app = {
    view: 'voc', // current view
    data: { voc: [], pipe: [] },   // raw data
    filterData: { voc: [], pipe: [] }, // filtered data
    filters: {
        branch: 'ALL',
        agent: 'ALL',
        status: 'ALL', // for VOC
        risk: 'ALL'    // for Pipeline
    },
    pagination: {
        voc: { page: 1, limit: 15 },
        pipe: { page: 1, limit: 15 }
    }
};

let map, clusterer, markers = [];
const charts = {};

/* =========================================
   2. INITIALIZATION & DATA LOADING
   ========================================= */
window.onload = async () => {
    try {
        const [v, p] = await Promise.all([ fetchCsv(DATA_URLS.voc), fetchCsv(DATA_URLS.pipe) ]);
        
        // 데이터 전처리
        app.data.voc = processVocData(v.data);
        app.data.pipe = processPipeData(p.data);
        
        // 초기화
        initMap();
        renderFilters(); // 사이드바 필터 생성
        applyFilter();   // 초기 필터링 및 렌더링
        
    } catch(e) {
        console.error("Init Error:", e);
        alert("데이터 로드 중 오류가 발생했습니다.");
    }
    document.getElementById("loading").style.display = "none";
};

async function fetchCsv(url) {
    const res = await fetch(url);
    const txt = await res.text();
    return Papa.parse(txt, { header: true, skipEmptyLines: true });
}

/* =========================================
   3. DATA PROCESSING (ROBUST)
   ========================================= */
function processVocData(rows) {
    if (!rows.length) return [];
    // 좌표 컬럼 찾기 (특수문자/BOM 포함 대응)
    const keys = Object.keys(rows[0]);
    const coordKey = keys.find(k => k.includes("위치좌표")) || "위치좌표(위도,경도)";

    return rows.map(r => {
        let lat = null, lng = null;
        // 1. "37.xxx, 127.xxx" 포맷 파싱
        if (r[coordKey] && r[coordKey].includes(',')) {
            const parts = r[coordKey].split(',');
            lat = parseFloat(parts[0].trim());
            lng = parseFloat(parts[1].trim());
        } 
        // 2. 별도 컬럼 파싱
        if (isNaN(lat) && r["위도"] && r["경도"]) {
            lat = parseFloat(r["위도"]);
            lng = parseFloat(r["경도"]);
        }

        return {
            ...r,
            _branch: (r["관리지사"] || "기타").replace("지사","").trim(),
            _agent: (r["담당자"] || "미지정").trim(),
            _status: (r["상태"] || "").trim(),
            _lat: (!isNaN(lat) && lat) ? lat : null,
            _lng: (!isNaN(lng) && lng) ? lng : null,
            _fee: parseMoney(r["합산월정료"] || r["월정료"])
        };
    });
}

function processPipeData(rows) {
    return rows.map(r => ({
        ...r,
        _branch: (r["관리지사"] || "기타").replace("지사","").trim(),
        _agent: (r["담당자"] || "미지정").trim(),
        _risk: parseFloat(r["해지위험도"] || 0),
        _step: (r["방어진행단계"] || "").trim(),
        _fee: parseMoney(r["KTT월정료(조정)"] || r["월정료"])
    }));
}

function parseMoney(str) {
    if (!str) return 0;
    return parseInt(String(str).replace(/,/g, '')) || 0;
}

/* =========================================
   4. FILTER LOGIC (CHIP STYLE)
   ========================================= */
function renderFilters() {
    // 1. Branch Chips (Common)
    // 두 데이터셋에서 지사 목록 합치기
    const branches = new Set([
        ...app.data.voc.map(d => d._branch),
        ...app.data.pipe.map(d => d._branch)
    ]);
    const sortedBranches = Array.from(branches).filter(b=>b).sort();
    
    const branchContainer = document.getElementById("filterBranch");
    branchContainer.innerHTML = `<button class="chip active" onclick="setCommonFilter('branch', 'ALL', this)">전체</button>`;
    sortedBranches.forEach(b => {
        branchContainer.innerHTML += `<button class="chip" onclick="setCommonFilter('branch', '${b}', this)">${b}</button>`;
    });

    // 2. Agent Chips (Common, initially ALL)
    updateAgentChips('ALL');
}

function updateAgentChips(selectedBranch) {
    // 선택된 지사에 해당하는 담당자만 추출
    let agents = new Set();
    const targetData = app.view === 'voc' ? app.data.voc : app.data.pipe;
    
    targetData.forEach(d => {
        if (selectedBranch === 'ALL' || d._branch === selectedBranch) {
            if(d._agent) agents.add(d._agent);
        }
    });
    
    const sortedAgents = Array.from(agents).sort();
    const agentContainer = document.getElementById("filterAgent");
    
    // 담당자가 너무 많으면 UX상 검색이 낫지만, 요청대로 버튼식(Chip) 구현 + 스크롤 처리
    let html = `<button class="chip active" onclick="setCommonFilter('agent', 'ALL', this)">전체</button>`;
    sortedAgents.forEach(a => {
        html += `<button class="chip small" onclick="setCommonFilter('agent', '${a}', this)">${a}</button>`;
    });
    agentContainer.innerHTML = html;
}

// 필터 상태 변경 함수들
window.setCommonFilter = (type, val, btn) => {
    app.filters[type] = val;
    // UI Active Update
    const container = btn.parentElement;
    Array.from(container.children).forEach(c => c.classList.remove('active'));
    btn.classList.add('active');

    // 지사가 바뀌면 담당자 목록도 갱신
    if (type === 'branch') {
        app.filters.agent = 'ALL'; // 담당자 초기화
        updateAgentChips(val);
    }
    applyFilter();
};

window.setStatus = (val) => {
    app.filters.status = val;
    updateChipActive("filterStatus", val);
    applyFilter();
};

window.setRisk = (val) => {
    app.filters.risk = val;
    updateChipActive("filterRisk", val);
    applyFilter();
};

function updateChipActive(parentId, val) {
    const btns = document.querySelectorAll(`#${parentId} .chip`);
    btns.forEach(b => {
        if (b.textContent.includes(val) || (val==='ALL' && b.textContent==='전체')) b.classList.add('active');
        else b.classList.remove('active');
    });
}

window.resetFilter = (type) => {
    // 초기화 로직 (전체 선택으로 복귀)
    const btn = document.querySelector(`#filter${type.charAt(0).toUpperCase()+type.slice(1)} .chip`);
    if(btn) btn.click();
};

/* =========================================
   5. CORE RENDER LOGIC
   ========================================= */
function applyFilter() {
    // 1. VOC Filtering
    app.filterData.voc = app.data.voc.filter(d => {
        if (app.filters.branch !== 'ALL' && d._branch !== app.filters.branch) return false;
        if (app.filters.agent !== 'ALL' && d._agent !== app.filters.agent) return false;
        if (app.filters.status !== 'ALL' && d._status !== app.filters.status) return false;
        return true;
    });

    // 2. Pipeline Filtering
    app.filterData.pipe = app.data.pipe.filter(d => {
        if (app.filters.branch !== 'ALL' && d._branch !== app.filters.branch) return false;
        if (app.filters.agent !== 'ALL' && d._agent !== app.filters.agent) return false;
        if (app.filters.risk !== 'ALL') {
            if (app.filters.risk === 'HIGH' && d._risk < 75) return false;
            if (app.filters.risk === 'MID' && (d._risk < 50 || d._risk >= 75)) return false;
        }
        return true;
    });

    // 페이지 초기화
    app.pagination.voc.page = 1;
    app.pagination.pipe.page = 1;

    // 현재 뷰 렌더링
    if (app.view === 'voc') renderVocView();
    else renderPipeView();
}

function renderVocView() {
    const data = app.filterData.voc;
    
    // KPI
    const unique = new Set(data.map(d=>d["계약번호"])).size;
    const done = data.filter(d=>d._status==='처리완료').length;
    const wait = data.filter(d=>d._status==='미접수').length;
    
    document.getElementById("kpiVocTotal").innerText = unique.toLocaleString();
    document.getElementById("kpiVocDone").innerText = done.toLocaleString();
    document.getElementById("kpiVocRate").innerText = unique ? ((done/data.length)*100).toFixed(1)+"%" : "0%";
    document.getElementById("kpiVocWait").innerText = wait.toLocaleString();

    // Map (좌표 있는 것만)
    updateMap(data);

    // Charts
    updateVocCharts(data);

    // Table
    renderTable(data, 'tblVoc', app.pagination.voc);
}

function renderPipeView() {
    const data = app.filterData.pipe;

    // KPI
    const total = data.length;
    const highRisk = data.filter(d=>d._risk >= 75).length;
    const loss = data.filter(d=>d._risk >= 75).reduce((acc,cur) => acc + cur._fee, 0);
    const success = data.filter(d=>d._step === '방어성공').length;
    
    document.getElementById("kpiPipeTotal").innerText = total.toLocaleString();
    document.getElementById("kpiPipeHigh").innerText = highRisk.toLocaleString();
    document.getElementById("kpiPipeLoss").innerText = (loss/10000).toFixed(0) + "만";
    document.getElementById("kpiPipeRate").innerText = total ? ((success/total)*100).toFixed(1)+"%" : "0%";

    // Charts
    updatePipeCharts(data);

    // Table
    renderTable(data, 'tblPipe', app.pagination.pipe);
}

/* =========================================
   6. VISUALIZATION (MAP & CHARTS)
   ========================================= */
function initMap() {
    map = new google.maps.Map(document.getElementById("vocMap"), {
        center: { lat: 37.5665, lng: 126.9780 },
        zoom: 9,
        fullscreenControl: false, mapTypeControl: false,
        styles: [ {featureType:"poi", stylers:[{visibility:"off"}]} ] // 깔끔한 지도 스타일
    });
}

function updateMap(data) {
    if (!map) return;
    if (clusterer) clusterer.clearMarkers();
    markers = [];

    const mapData = data.filter(d => d._lat && d._lng);
    
    mapData.forEach(d => {
        const marker = new google.maps.Marker({
            position: { lat: d._lat, lng: d._lng },
            title: d["상호"],
            // 상태별 마커 색상 (구글 기본 아이콘 활용)
            icon: `http://maps.google.com/mapfiles/ms/icons/${d._status==='처리완료'?'blue':(d._status==='미접수'?'red':'yellow')}-dot.png`
        });

        // 고급 InfoWindow
        const infoContent = `
            <div style="padding:8px; width:200px;">
                <h4 style="margin:0 0 5px 0; color:#1e293b;">${d["상호"] || "고객명 미상"}</h4>
                <div style="font-size:12px; color:#64748b; line-height:1.5;">
                    <span style="display:inline-block; padding:2px 6px; border-radius:4px; background:${d._status==='처리완료'?'#dbeafe':'#fee2e2'}; color:${d._status==='처리완료'?'#1e40af':'#991b1b'}; font-weight:bold;">${d._status}</span>
                    <br/>지사: ${d._branch} | 담당: ${d._agent}
                    <br/>유형: ${d["VOC유형소"] || "-"}
                </div>
            </div>
        `;
        const infowindow = new google.maps.InfoWindow({ content: infoContent });
        marker.addListener("click", () => infowindow.open(map, marker));
        markers.push(marker);
    });

    clusterer = new markerClusterer.MarkerClusterer({ 
        map, 
        markers,
        renderer: {
            render: ({ count, position }) => {
                return new google.maps.Marker({
                    label: { text: String(count), color: "white", fontSize: "12px", fontWeight: "bold" },
                    position,
                    zIndex: Number(google.maps.Marker.MAX_ZINDEX) + count,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 18,
                        fillColor: "#3b82f6",
                        fillOpacity: 0.9,
                        strokeWeight: 2,
                        strokeColor: "#ffffff"
                    }
                });
            }
        }
    });
}

function updateVocCharts(data) {
    // 1. Branch Chart
    const brCounts = {};
    data.forEach(d => brCounts[d._branch] = (brCounts[d._branch]||0) + 1);
    renderChart("chartVocBranch", "bar", Object.keys(brCounts), Object.values(brCounts), "지사별 건수", "#60a5fa");

    // 2. Agent Chart (Bottom performing or High volume) -> 미접수/접수 많은 순
    const agCounts = {};
    data.filter(d=>d._status!=='처리완료').forEach(d => agCounts[d._agent] = (agCounts[d._agent]||0) + 1);
    const sorted = Object.entries(agCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
    renderChart("chartVocAgent", "bar", sorted.map(s=>s[0]), sorted.map(s=>s[1]), "미처리 건수", "#f87171");
}

function updatePipeCharts(data) {
    // 1. Branch Defense Status
    // Stacked Bar Chart 로직 복잡하므로 간단히 '고위험군 수'로 대체하거나 단순화
    const brRisk = {};
    data.filter(d=>d._risk>=75).forEach(d => brRisk[d._branch] = (brRisk[d._branch]||0) + 1);
    renderChart("chartPipeBranch", "bar", Object.keys(brRisk), Object.values(brRisk), "고위험 고객 수", "#f43f5e");

    // 2. Reason Chart (Doughnut)
    const reasons = {};
    data.forEach(d => {
        const r = d["해지사유"] || "미입력";
        reasons[r] = (reasons[r]||0) + 1;
    });
    const sortedR = Object.entries(reasons).sort((a,b)=>b[1]-a[1]).slice(0,5);
    renderChart("chartPipeReason", "doughnut", sortedR.map(s=>s[0]), sortedR.map(s=>s[1]), "건수", ["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6"]);
}

function renderChart(id, type, labels, data, label, color) {
    const ctx = document.getElementById(id).getContext('2d');
    if (charts[id]) charts[id].destroy();
    
    const config = {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                backgroundColor: color,
                borderRadius: 4,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: type === 'doughnut' },
                datalabels: { display: data.length < 20, color: type==='doughnut'?'#fff':'#64748b', anchor:'end', align:'top' }
            },
            scales: type !== 'doughnut' ? {
                y: { beginAtZero: true, grid: { display: false } },
                x: { grid: { display: false } }
            } : {}
        }
    };
    charts[id] = new Chart(ctx, config);
}

/* =========================================
   7. TABLE & PAGINATION
   ========================================= */
function renderTable(data, tableId, pageInfo) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    tbody.innerHTML = "";
    
    const start = (pageInfo.page - 1) * pageInfo.limit;
    const end = start + pageInfo.limit;
    const pageData = data.slice(start, end);
    
    const pgSpan = document.getElementById(tableId === 'tblVoc' ? 'pgVoc' : 'pgPipe');
    pgSpan.innerText = `${data.length}건 중 ${start+1}~${Math.min(end, data.length)}`;

    pageData.forEach(r => {
        const tr = document.createElement("tr");
        if (tableId === 'tblVoc') {
            const badge = r._status === '처리완료' ? 'bg-blue' : (r._status === '접수' ? 'bg-yellow' : 'bg-red');
            const hasLoc = r._lat ? '<i class="ph ph-map-pin" style="color:var(--primary)"></i>' : '<span style="color:#ccc">-</span>';
            tr.innerHTML = `
                <td>${r._branch}</td>
                <td>${r._agent}</td>
                <td>${r["계약번호"]}</td>
                <td style="font-weight:bold; text-align:left;">${r["상호"]||"-"}</td>
                <td>${r["VOC유형소"]||"-"}</td>
                <td><span class="badge ${badge}">${r._status}</span></td>
                <td style="text-align:center;">${hasLoc}</td>
            `;
            if(r._lat) {
                tr.onclick = () => {
                    map.panTo({lat:r._lat, lng:r._lng});
                    map.setZoom(14);
                    tr.classList.add("selected");
                    setTimeout(()=>tr.classList.remove("selected"), 2000);
                };
            }
        } else {
            const riskBadge = r._risk >= 75 ? 'bg-red' : (r._risk >= 50 ? 'bg-yellow' : 'bg-green');
            tr.innerHTML = `
                <td>${r._branch}</td>
                <td>${r._agent}</td>
                <td>${r["계약번호"]}</td>
                <td style="font-weight:bold; text-align:left;">${r["상호"]||"-"}</td>
                <td><span class="badge ${riskBadge}">${r._risk}%</span></td>
                <td>${r._step}</td>
                <td>${util.excelDateToJSDate(r["해지예정일"])}</td>
                <td>${r._fee.toLocaleString()}</td>
            `;
        }
        tbody.appendChild(tr);
    });
}

window.movePage = (view, dir) => {
    const p = app.pagination[view];
    const total = app.filterData[view].length;
    const max = Math.ceil(total / p.limit);
    const next = p.page + dir;
    if(next > 0 && next <= max) {
        p.page = next;
        if(view === 'voc') renderTable(app.filterData.voc, 'tblVoc', p);
        else renderTable(app.filterData.pipe, 'tblPipe', p);
    }
};

window.exportCSV = (view) => {
    const data = app.filterData[view];
    if(!data.length) return alert("데이터가 없습니다.");
    const blob = new Blob(["\uFEFF"+Papa.unparse(data)], {type:'text/csv;charset=utf-8;'});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `KTT_${view.toUpperCase()}_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
};

/* =========================================
   8. VIEW SWITCHING
   ========================================= */
window.switchView = (view) => {
    app.view = view;
    // Tab Style
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    
    // View Panel
    document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
    document.getElementById(view === 'voc' ? 'viewVoc' : 'viewPipe').classList.add('active');
    
    // Filter Visibility
    document.getElementById('vocSpecificFilters').style.display = view === 'voc' ? 'block' : 'none';
    document.getElementById('pipeSpecificFilters').style.display = view === 'pipeline' ? 'block' : 'none';
    
    // Resize Charts/Map
    setTimeout(() => {
        if(view === 'voc' && map) google.maps.event.trigger(map, 'resize');
        Object.values(charts).forEach(c => c.resize());
    }, 100);
    
    // Re-apply filter to current view data
    applyFilter();
    updateAgentChips(app.filters.branch); // Reset agent chips based on branch
};

// 파일 업로드 이벤트
document.getElementById('fileInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
        const parsed = Papa.parse(evt.target.result, {header:true, skipEmptyLines:true});
        const headers = parsed.meta.fields || [];
        
        // 간단한 컬럼명 검사로 파일 타입 추론
        if(headers.some(h => h.includes("위치좌표") || h.includes("VOC"))) {
            app.data.voc = processVocData(parsed.data);
            alert("VOC 데이터가 업데이트되었습니다.");
            switchView('voc');
        } else if(headers.some(h => h.includes("해지위험도") || h.includes("방어진행단계"))) {
            app.data.pipe = processPipeData(parsed.data);
            alert("파이프라인 데이터가 업데이트되었습니다.");
            switchView('pipeline');
        } else {
            alert("알 수 없는 데이터 형식입니다.");
        }
        renderFilters();
        applyFilter();
    };
    reader.readAsText(file, 'UTF-8');
});

</script>
</body>
</html>
