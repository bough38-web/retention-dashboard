<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>KTT 통합 대시보드 (고급화)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        /* 폰트, 기본 스타일 설정 */
        body {
            margin: 0;
            display: flex;
            background: #f5f5f7;
            font-family: "Apple SD Gothic Neo", "Segoe UI", sans-serif;
            color: #333;
        }

        /* 좌측 필터 패널 */
        .sidebar {
            width: 280px;
            background: #ffffff;
            padding: 20px;
            border-right: 1px solid #ddd;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 6px rgba(0,0,0,0.02);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sidebar h2 {
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #1f2937;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* KPI 카드 섹션 */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 5px solid #3b82f6; /* 강조 컬러 */
        }

        .kpi-title {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }

        /* 차트 및 리스트 카드 공통 스타일 */
        .chart-card, .list-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f3f4f6;
        }

        .card-header h3 {
            font-size: 18px;
            margin: 0;
            color: #1f2937;
        }

        /* 차트 그리드 */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2개 컬럼 레이아웃 */
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 폼 요소 스타일 */
        button, select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #ffffff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        label {
            display: block;
            padding: 8px 0 4px;
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
        }

        /* 버튼식 필터 스타일 */
        .filter-group {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px dotted #ddd;
        }

        .filter-group-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .filter-btn {
            flex: 0 0 auto;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            font-size: 12px;
            width: auto;
        }

        .filter-btn.active {
            background: #3b82f6; /* Primary Color */
            color: #fff;
            border-color: #2563eb;
            font-weight: 600;
        }
        
        .mode-btn.active {
            background: #10b981; /* Secondary Color */
            color: #fff;
            border-color: #059669;
        }

        /* 데이터 리스트 스타일 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .data-table th {
            background-color: #f9fafb;
            font-weight: 700;
            color: #4b5563;
            cursor: pointer;
        }
        
        .data-table tbody tr:hover {
            background-color: #f3f4f6;
        }

        .list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }
    </style>
</head>

<body>

<div class="sidebar">
    <h2>📊 통합 대시보드 필터</h2>

    <label for="channelFilter">담당영업채널</label>
    <select id="channelFilter">
        <option value="ALL">전체</option>
        <option value="SP">SP</option>
        <option value="SC">SC</option>
        <option value="AM">AM</option>
    </select>

    <label>해지위험도 (%)</label>
    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
        <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="ALL" checked> 전체</label>
        <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="0"> 0 ~ 25%</label>
        <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="25"> 25 ~ 50%</label>
        <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="50"> 50 ~ 75%</label>
        <label style="flex: 1; min-width: 110px;"><input type="radio" name="risk" value="75"> 75 ~ 100%</label>
    </div>

    <label>표시 기준 (해지파이프라인)</label>
    <div class="filter-buttons">
        <button class="mode-btn active" data-mode="count" onclick="setMode('count', this)">건수</button>
        <button class="mode-btn" data-mode="amount" onclick="setMode('amount', this)">금액(천원)</button>
    </div>

    <div class="filter-group">
        <div class="filter-group-title">관리본부</div>
        <div id="hqButtons" class="filter-buttons">
            </div>
    </div>

    <div class="filter-group">
        <div class="filter-group-title">관리지사</div>
        <div id="branchButtons" class="filter-buttons">
            </div>
    </div>
</div>

<div class="content">

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-title">해지파이프라인 총 건수</div>
            <div id="kpi-pipeline-count" class="kpi-value">0</div>
        </div>
        <div class="kpi-card" style="border-left-color: #10b981;">
            <div class="kpi-title">총 월정료 금액 (천원)</div>
            <div id="kpi-pipeline-amount" class="kpi-value">0</div>
                    </div>
        <div class="kpi-card" style="border-left-color: #f59e0b;">
            <div class="kpi-title">VOC 총 처리율 (%)</div>
            <div id="kpi-voc-complete-rate" class="kpi-value">0%</div>
        </div>
        <div class="kpi-card" style="border-left-color: #ef4444;">
            <div class="kpi-title">방어 성공률 (%)</div>
            <div id="kpi-defense-success-rate" class="kpi-value">0%</div>
        </div>
    </div>

    <div class="chart-grid">
        <div class="chart-card">
            <div class="card-header">
                <h3>📈 관리본부 / 관리지사별 해지 현황</h3>
            </div>
            <canvas id="pipelineBranchChart"></canvas>
        </div>

        <div class="chart-card">
            <div class="card-header">
                <h3>📊 방어진행단계 (지사별 적층)</h3>
            </div>
            <canvas id="pipelineStageChart"></canvas>
        </div>
        
        <div class="chart-card">
            <div class="card-header">
                <h3>💬 VOC 관리지사별 상태 (적층)</h3>
            </div>
            <canvas id="vocBranchChart"></canvas>
        </div>
        
        <div class="chart-card">
            <div class="card-header">
                <h3>👨‍💼 VOC 담당자별 상태 (Top 20)</h3>
            </div>
            <canvas id="vocAgentChart"></canvas>
        </div>
    </div>

    <div class="list-card">
        <div class="card-header">
            <h3>📝 필터링된 해지파이프라인 상세 리스트</h3>
            <p style="font-size: 12px; color: #9ca3af; margin: 5px 0 0;">(테이블 헤더 클릭 시 정렬)</p>
        </div>
        <div class="list-container">
            <table id="pipelineListTable" class="data-table">
                <thead>
                    <tr>
                        <th data-field="계약번호" data-sort="asc">계약번호</th>
                        <th data-field="관리본부">관리본부</th>
                        <th data-field="관리지사">관리지사</th>
                        <th data-field="해지위험도" data-sort="none">위험도 (%)</th>
                        <th data-field="담당영업채널">영업채널</th>
                        <th data-field="KTT월정료(조정)" data-sort="none">월정료 (천원)</th>
                        <th data-field="방어진행단계">방어진행단계</th>
                        <th data-field="방어담당자">방어담당자</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    /* ---------------------------------------------------------
        📌 CSV 데이터 경로
    --------------------------------------------------------- */
    const VOC_CSV_URL =
        "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/voc.csv";

    const PIPELINE_CSV_URL =
        "https://raw.githubusercontent.com/bough38-web/retention-dashboard/main/pipeline.csv";

    // Chart.js 플러그인 등록
    Chart.register(ChartDataLabels);

    /* ---------------------------------------------------------
        📌 전역 상태값
    --------------------------------------------------------- */
    let mode = "count"; // count 또는 amount
    let vocData = [];
    let pipelineData = []; // 원본 데이터
    let filteredPipelineData = []; // 필터링된 데이터

    // 차트 인스턴스
    let pipelineBranchChart = null;
    let pipelineStageChart = null;
    let vocBranchChart = null;
    let vocAgentChart = null;

    // 관리본부 / 관리지사 버튼 상태
    let selectedHQ = "ALL";
    let selectedBranch = "ALL";
    let listSortField = "KTT월정료(조정)";
    let listSortDirection = "desc";

    /* ---------------------------------------------------------
        📌 공통 함수들 (기존 함수 재사용 및 개선)
    --------------------------------------------------------- */

    function normalizeBranch(name) {
        if (!name) return "";
        return String(name).replace("지사", "").trim();
    }

    function cleanContractNumber(raw) {
        if (!raw) return "";
        return String(raw).replace(/\D/g, "").slice(0, 8);
    }

    function toThousandWon(raw) {
        if (!raw) return 0;
        const num = parseFloat(String(raw).replace(/,/g, ""));
        return isNaN(num) ? 0 : Math.round(num / 1000);
    }

    function checkRisk(value, selected) {
        if (selected === "ALL") return true;
        const v = parseFloat(value);
        if (isNaN(v)) return false;

        const s = parseInt(selected);
        if (s === 0) return v >= 0 && v < 25;
        if (s === 25) return v >= 25 && v < 50;
        if (s === 50) return v >= 50 && v < 75;
        if (s === 75) return v >= 75 && v <= 100;
        return true;
    }
    
    // 금액 포맷 (천단위 콤마)
    function formatNumber(num) {
        return num.toLocaleString();
    }
    
    // CSV로드 (skipRows 파라미터 추가)
    async function loadCsv(url, skipRows = 0) {
        const res = await fetch(url);
        let text = await res.text();
        
        // 요청된 수만큼 상위 행을 건너뜁니다.
        if (skipRows > 0) {
            const lines = text.split('\n');
            // skipRows를 사용하여 첫 N개의 줄을 제거합니다.
            text = lines.slice(skipRows).join('\n');
        }

        return new Promise(resolve => {
            Papa.parse(text, {
                header: true,
                skipEmptyLines: true,
                complete: r => resolve(r.data)
            });
        });
    }

    /* ---------------------------------------------------------
        📌 필터링 로직
    --------------------------------------------------------- */
    function getSelectedChannel() {
        return document.getElementById("channelFilter").value;
    }

    function getSelectedRisk() {
        return document.querySelector('input[name="risk"]:checked').value;
    }

    function setMode(m, button) {
        mode = m;
        document.querySelectorAll(".mode-btn").forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");
        updatePipelineCharts();
    }

    function filterPipelineData() {
        const channel = getSelectedChannel();
        const risk = getSelectedRisk();

        filteredPipelineData = pipelineData.filter(row => {
            // 계약번호가 없는 행 제외
            if (!cleanContractNumber(row["계약번호"])) return false;
            
            // 채널 필터
            if (channel !== "ALL" && row["담당영업채널"] !== channel) return false;
            
            // 위험도 필터
            if (!checkRisk(row["해지위험도"], risk)) return false;

            const head = (row["관리본부"] || "").trim();
            const branch = normalizeBranch(row["관리지사"]);

            // 본부 필터
            if (selectedHQ !== "ALL" && head !== selectedHQ) return false;
            
            // 지사 필터
            if (selectedBranch !== "ALL" && branch !== selectedBranch) return false;

            return true;
        });
    }

    /* ---------------------------------------------------------
        📌 KPI 계산 및 표시
    --------------------------------------------------------- */
    function updateKPIs() {
        if (!filteredPipelineData.length) {
            document.getElementById("kpi-pipeline-count").innerText = "0";
            document.getElementById("kpi-pipeline-amount").innerText = "0";
            document.getElementById("kpi-voc-complete-rate").innerText = "0%";
            document.getElementById("kpi-defense-success-rate").innerText = "0%";
            return;
        }

        // 1. 해지파이프라인 KPI
        const totalCount = filteredPipelineData.length;
        const totalAmount = filteredPipelineData.reduce((sum, row) => 
            sum + toThousandWon(row["KTT월정료(조정)"]), 0
        );
        
        const defenseSuccess = filteredPipelineData.filter(row => row["방어진행단계"] === "방어성공").length;
        const totalDefenseAttempt = filteredPipelineData.filter(row => 
            row["방어진행단계"] === "방어성공" || row["방어진행단계"] === "방어실패" || row["방어진행단계"] === "진행중"
        ).length;
        const defenseSuccessRate = totalDefenseAttempt > 0 ? (defenseSuccess / totalDefenseAttempt) * 100 : 0;
        
        document.getElementById("kpi-pipeline-count").innerText = formatNumber(totalCount);
        document.getElementById("kpi-pipeline-amount").innerText = formatNumber(totalAmount);
        document.getElementById("kpi-defense-success-rate").innerText = `${defenseSuccessRate.toFixed(1)}%`;


        // 2. VOC KPI
        const totalVoc = vocData.length;
        const completedVoc = vocData.filter(row => (row["상태"] || "").trim() === "처리완료").length;
        const vocCompleteRate = totalVoc > 0 ? (completedVoc / totalVoc) * 100 : 0;

        document.getElementById("kpi-voc-complete-rate").innerText = `${vocCompleteRate.toFixed(1)}%`;
    }

    /* ---------------------------------------------------------
        📌 관리본부 / 관리지사 버튼 생성 (기존 함수 재사용 및 개선)
    --------------------------------------------------------- */
    function renderHQButtons() {
        const container = document.getElementById("hqButtons");
        if (!container || !pipelineData.length) return;

        const heads = Array.from(new Set(
            pipelineData
                .map(r => (r["관리본부"] || "").trim())
                .filter(Boolean)
        )).sort();

        let html = "";
        html += `<button type="button" class="filter-btn ${selectedHQ === "ALL" ? "active" : ""}" data-value="ALL">전체</button>`;
        heads.forEach(hq => {
            html += `<button type="button" class="filter-btn ${selectedHQ === hq ? "active" : ""}" data-value="${hq}">${hq}</button>`;
        });
        container.innerHTML = html;

        container.querySelectorAll(".filter-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const val = btn.getAttribute("data-value");
                selectedHQ = val;
                selectedBranch = "ALL"; // 본부 변경 시 지사 초기화
                renderHQButtons();
                renderBranchButtons();
                updateDashboard(); // 전체 대시보드 업데이트
            });
        });
    }

    function renderBranchButtons() {
        const container = document.getElementById("branchButtons");
        if (!container || !pipelineData.length) return;

        let filtered = pipelineData;
        if (selectedHQ !== "ALL") {
            filtered = filtered.filter(r => (r["관리본부"] || "").trim() === selectedHQ);
        }

        const branches = Array.from(new Set(
            filtered
                .map(r => normalizeBranch(r["관리지사"]))
                .filter(Boolean)
        )).sort();

        let html = "";
        html += `<button type="button" class="filter-btn ${selectedBranch === "ALL" ? "active" : ""}" data-value="ALL">전체</button>`;
        branches.forEach(br => {
            html += `<button type="button" class="filter-btn ${selectedBranch === br ? "active" : ""}" data-value="${br}">${br}</button>`;
        });
        container.innerHTML = html;

        container.querySelectorAll(".filter-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const val = btn.getAttribute("data-value");
                selectedBranch = val;
                renderBranchButtons();
                updateDashboard(); // 전체 대시보드 업데이트
            });
        });
    }

    /* ---------------------------------------------------------
        📌 해지파이프라인 — 본부/지사 집계 및 차트
    --------------------------------------------------------- */
    function getPipelineBranchAgg() {
        const agg = {};

        filteredPipelineData.forEach(row => {
            const head = (row["관리본부"] || "").trim();
            const branch = normalizeBranch(row["관리지사"]);
            if (!head || !branch) return;

            const key = `${head} / ${branch}`;
            if (!agg[key]) agg[key] = { count: 0, amount: 0 };

            agg[key].count++;
            agg[key].amount += toThousandWon(row["KTT월정료(조정)"]);
        });

        const entries = Object.entries(agg);
        entries.sort((a, b) => {
            const av = mode === "count" ? a[1].count : a[1].amount;
            const bv = mode === "count" ? b[1].count : b[1].amount;
            return bv - av;
        });
        
        // 상위 20개만 표시
        const sliced = entries.slice(0, 20);

        return {
            labels: sliced.map(e => e[0]),
            counts: sliced.map(e => e[1].count),
            amounts: sliced.map(e => e[1].amount)
        };
    }

    function drawPipelineBranchChart() {
        const ctx = document.getElementById("pipelineBranchChart").getContext("2d");
        const { labels, counts, amounts } = getPipelineBranchAgg();

        if (pipelineBranchChart) pipelineBranchChart.destroy();

        const dataArray = mode === "count" ? counts : amounts;
        const unit = mode === "count" ? "건" : "천원";

        pipelineBranchChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [{
                    label: mode === "count" ? "건수" : "금액(천원)",
                    data: dataArray,
                    backgroundColor: '#3b82f6', // Primary Color
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    datalabels: { // Data Label 플러그인 사용 (전문가 기법)
                        anchor: 'end',
                        align: 'top',
                        formatter: (value) => formatNumber(value),
                        color: '#333'
                    }
                },
                scales: { 
                    y: { 
                        beginAtZero: true,
                        title: { display: true, text: unit }
                    },
                    x: {
                        // 라벨이 길 경우 대비
                        ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    /* ---------------------------------------------------------
        📌 해지파이프라인 — 방어진행단계 적층 차트
    --------------------------------------------------------- */
    function getPipelineStageAgg() {
        const stages = ["진행중", "방어실패", "방어성공"];
        const agg = {};

        filteredPipelineData.forEach(row => {
            const branch = normalizeBranch(row["관리지사"]);
            if (!branch) return;

            const stage = (row["방어진행단계"] || "").trim();

            if (!agg[branch]) {
                agg[branch] = { 진행중: 0, 방어실패: 0, 방어성공: 0 };
            }

            if (stages.includes(stage)) agg[branch][stage]++;
        });

        const labels = Object.keys(agg);
        
        // 지사별 총합 계산 후 상위 20개만 표시
        labels.sort((a, b) => {
            const sumA = agg[a].진행중 + agg[a].방어실패 + agg[a].방어성공;
            const sumB = agg[b].진행중 + agg[b].방어실패 + agg[b].방어성공;
            return sumB - sumA;
        });

        const slicedLabels = labels.slice(0, 20);

        return {
            labels: slicedLabels,
            진행중: slicedLabels.map(b => agg[b]["진행중"] || 0),
            방어실패: slicedLabels.map(b => agg[b]["방어실패"] || 0),
            방어성공: slicedLabels.map(b => agg[b]["방어성공"] || 0),
        };
    }

    function drawPipelineStageChart() {
        const ctx = document.getElementById("pipelineStageChart").getContext("2d");
        const { labels, 진행중, 방어실패, 방어성공 } = getPipelineStageAgg();

        if (pipelineStageChart) pipelineStageChart.destroy();

        pipelineStageChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "방어성공", data: 방어성공, stack: "s", backgroundColor: '#10b981' }, // 성공은 강조색
                    { label: "진행중", data: 진행중, stack: "s", backgroundColor: '#f59e0b' },
                    { label: "방어실패", data: 방어실패, stack: "s", backgroundColor: '#ef4444' }, // 실패는 경고색
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    datalabels: { // Stacked Bar Chart에서는 합계만 표시하도록 옵션 변경 가능
                        display: false, // 일단 비활성화하여 깔끔하게
                    },
                },
                scales: {
                    x: { stacked: true, ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } },
                    y: { stacked: true, beginAtZero: true, title: { display: true, text: "건수" } }
                }
            }
        });
    }

    /* ---------------------------------------------------------
        📌 VOC 시각화 (기존 함수 재사용 및 개선)
    --------------------------------------------------------- */
    function aggregateVocBy(field, limit = 20) {
        const agg = {};
        const statuses = ["처리완료", "접수", "미접수"];

        vocData.forEach(row => {
            let key = field === "관리지사"
                ? normalizeBranch(row["관리지사"])
                : (row[field] || "").trim();

            if (!key) return;

            const st = (row["상태"] || "").trim();

            if (!agg[key]) agg[key] = { 처리완료: 0, 접수: 0, 미접수: 0 };
            if (statuses.includes(st)) agg[key][st]++;
        });

        const entries = Object.entries(agg);
        entries.sort((a, b) =>
            (b[1].처리완료 + b[1].접수 + b[1].미접수) -
            (a[1].처리완료 + a[1].접수 + a[1].미접수)
        );

        const sliced = entries.slice(0, limit);

        return {
            labels: sliced.map(e => e[0]),
            처리완료: sliced.map(e => e[1].처리완료),
            접수: sliced.map(e => e[1].접수),
            미접수: sliced.map(e => e[1].미접수),
        };
    }

    function drawVocBranchChart() {
        const ctx = document.getElementById("vocBranchChart").getContext("2d");
        const { labels, 처리완료, 접수, 미접수 } = aggregateVocBy("관리지사", 30);

        if (vocBranchChart) vocBranchChart.destroy();

        vocBranchChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "처리완료", data: 처리완료, stack: "v", backgroundColor: '#3b82f6' },
                    { label: "접수", data: 접수, stack: "v", backgroundColor: '#f59e0b' },
                    { label: "미접수", data: 미접수, stack: "v", backgroundColor: '#ef4444' },
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { stacked: true, ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } },
                    y: { stacked: true, beginAtZero: true, title: { display: true, text: "건수" } }
                }
            }
        });
    }

    function drawVocAgentChart() {
        const ctx = document.getElementById("vocAgentChart").getContext("2d");
        const { labels, 처리완료, 접수, 미접수 } = aggregateVocBy("담당자", 20);

        if (vocAgentChart) vocAgentChart.destroy();

        vocAgentChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "처리완료", data: 처리완료, stack: "va", backgroundColor: '#3b82f6' },
                    { label: "접수", data: 접수, stack: "va", backgroundColor: '#f59e0b' },
                    { label: "미접수", data: 미접수, stack: "va", backgroundColor: '#ef4444' },
                ]
            },
            options: {
                indexAxis: 'y', // 가로 막대 차트로 변경하여 가독성 개선
                responsive: true,
                scales: {
                    x: { stacked: true, beginAtZero: true, title: { display: true, text: "건수" } },
                    y: { stacked: true, }
                }
            }
        });
    }
    
    /* ---------------------------------------------------------
        📌 상세 데이터 리스트 (전문가 기법)
    --------------------------------------------------------- */
    function renderPipelineList() {
        const tableBody = document.querySelector("#pipelineListTable tbody");
        tableBody.innerHTML = ""; // 기존 내용 초기화
        
        let sortedData = [...filteredPipelineData];

        // 정렬 로직
        const sortField = listSortField;
        const direction = listSortDirection === 'asc' ? 1 : -1;
        
        sortedData.sort((a, b) => {
            let valA = a[sortField];
            let valB = b[sortField];
            
            // 숫자 필드 처리
            if (sortField === "해지위험도" || sortField === "KTT월정료(조정)") {
                valA = parseFloat(String(valA).replace(/,/g, "")) || 0;
                valB = parseFloat(String(valB).replace(/,/g, "")) || 0;
            }
            
            if (valA < valB) return -1 * direction;
            if (valA > valB) return 1 * direction;
            return 0;
        });

        // 상위 100개만 표시 (과부하 방지)
        sortedData.slice(0, 100).forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${cleanContractNumber(row["계약번호"])}</td>
                <td>${(row["관리본부"] || "").trim()}</td>
                <td>${normalizeBranch(row["관리지사"])}</td>
                <td>${(parseFloat(row["해지위험도"]) || 0).toFixed(1)}</td>
                <td>${row["담당영업채널"]}</td>
                <td>${formatNumber(toThousandWon(row["KTT월정료(조정)"]))}</td>
                <td>${row["방어진행단계"]}</td>
                <td>${row["방어담당자"]}</td>
            `;
            tableBody.appendChild(tr);
        });

        // 정렬 화살표 표시
        document.querySelectorAll("#pipelineListTable th").forEach(th => {
            th.innerHTML = th.getAttribute("data-field");
            if (th.getAttribute("data-field") === listSortField) {
                const icon = listSortDirection === 'asc' ? ' ▲' : ' ▼';
                th.innerHTML += icon;
            }
        });
    }
    
    function attachListSortEvents() {
        document.querySelectorAll("#pipelineListTable th").forEach(th => {
            th.addEventListener('click', function() {
                const field = this.getAttribute('data-field');
                if (field === listSortField) {
                    listSortDirection = listSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    listSortField = field;
                    listSortDirection = 'desc'; // 새 필드 선택 시 기본은 내림차순
                }
                renderPipelineList();
            });
        });
    }

    /* ---------------------------------------------------------
        📌 전체 대시보드 업데이트
    --------------------------------------------------------- */
    function updateDashboard() {
        filterPipelineData(); // 1. 데이터 필터링
        updateKPIs();         // 2. KPI 업데이트
        
        // 3. 차트 업데이트
        drawPipelineBranchChart();
        drawPipelineStageChart();
        drawVocBranchChart(); // VOC는 필터 연동이 약하므로 일단 VOC만 업데이트
        drawVocAgentChart();
        
        renderPipelineList(); // 4. 상세 리스트 업데이트
    }

    /* ---------------------------------------------------------
        📌 초기 로드
    --------------------------------------------------------- */
    async function initDashboard() {
        // VOC CSV는 헤더가 2행부터 시작하므로 첫 1행을 스킵합니다.
        vocData = await loadCsv(VOC_CSV_URL, 1);
        
        // Pipeline CSV는 기존대로 처리합니다.
        pipelineData = await loadCsv(PIPELINE_CSV_URL);

        // 관리본부/지사 버튼 생성
        renderHQButtons();
        renderBranchButtons();
        
        // 초기 데이터 로드 및 업데이트
        updateDashboard();

        // 필터 이벤트 리스너 등록
        document.getElementById("channelFilter")
            .addEventListener("change", updateDashboard);

        document.querySelectorAll('input[name="risk"]')
            .forEach(r => r.addEventListener("change", updateDashboard));
            
        // 리스트 정렬 이벤트 등록
        attachListSortEvents();
    }

    window.addEventListener("load", initDashboard);
</script>

</body>
</html>
